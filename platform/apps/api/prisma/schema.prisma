// Prisma Client Generator - Cache bust: 2025-12-21-v4
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum ReservationStatus {
  pending
  confirmed
  checked_in
  checked_out
  cancelled
}

enum SiteType {
  // Outdoor/Camping
  rv
  tent
  cabin
  group
  glamping

  // Hotel/Lodge Types
  hotel_room
  suite
  lodge_room

  // Glamping Structures
  yurt
  treehouse
  tiny_house
  airstream
  safari_tent
  dome

  // Specialty
  boat_slip
}

enum MaintenanceStatus {
  open
  in_progress
  closed
}

enum MaintenancePriority {
  low
  medium
  high
  critical
}

enum CampaignStatus {
  draft
  scheduled
  sending
  sent
  cancelled
}

enum CampaignSendStatus {
  queued
  sent
  failed
  unsubscribed
}

enum SupportReportStatus {
  new
  triage
  in_progress
  resolved
  closed
}

enum ChannelType {
  email
  sms
  both
}

enum UserRole {
  owner
  manager
  front_desk
  maintenance
  finance
  marketing
  readonly
}

enum SenderType {
  guest
  staff
}

enum TaxRuleType {
  percentage
  flat
  exemption
}

enum RateType {
  nightly
  weekly
  monthly
  seasonal
}

enum StayType {
  standard
  weekly
  monthly
  seasonal
}

enum StayReasonPreset {
  vacation
  family_visit
  event
  work_remote
  stopover
  relocation
  other
}

enum ReferralIncentiveType {
  percent_discount
  amount_discount
  credit
}

enum PaymentSchedule {
  single
  weekly
  monthly
  as_you_stay
  offseason_installments
}

enum PricingStructure {
  per_night
  flat_week
  flat_month
  flat_season
}

enum ChargeStatus {
  pending
  paid
  failed
}

// Phase 2 housekeeping/maintenance/group bookings
enum TaskType {
  // Existing
  turnover
  inspection
  other

  // Hotel-level cleaning
  deep_clean
  touch_up
  make_ready
  checkout_express
  vip_prep
  pet_treatment
  linen_change
  restocking
}

// Hotel-level housekeeping status state machine
enum HousekeepingStatus {
  // Vacant states
  vacant_dirty
  cleaning_in_progress
  pending_inspection
  inspection_failed
  vacant_clean
  vacant_inspected

  // Occupied states
  occupied
  occupied_service     // Can receive housekeeping service
  occupied_dnd         // Do Not Disturb

  // Blocked states
  out_of_order         // Maintenance issue
  out_of_inventory     // Offline (renovations, seasonal)
}

enum TaskState {
  pending
  in_progress
  blocked
  done
  failed
  expired
}

enum SlaStatus {
  on_track
  at_risk
  breached
}

enum TicketState {
  open
  in_progress
  blocked
  resolved
  reopened
  closed
}

enum TicketCategory {
  issue
  question
  feature
  other
}

enum Severity {
  low
  med
  high
  critical
}

enum CheckInStatus {
  not_started
  pending_id
  pending_payment
  pending_waiver
  pending_site_ready
  completed
  failed
}

enum CheckOutStatus {
  not_started
  pending_review
  completed
  failed
}

enum IncidentStatus {
  open
  investigating
  resolved
  closed
}

enum IncidentType {
  injury
  property_damage
  safety
  security
  near_miss
  environmental
  other
}

enum IncidentTaskStatus {
  pending
  in_progress
  done
  cancelled
}

enum EvidenceType {
  photo
  document
  note
  audio
  video
  other
}

enum GroupRole {
  primary
  member
}

// ---------------------------------------------------------------------------
// Social Media Planner enums
// ---------------------------------------------------------------------------

enum SocialPlatform {
  facebook
  instagram
  tiktok
  email
  blog
}

enum SocialPostStatus {
  draft
  scheduled
  needs_image
  needs_approval
  ready
  completed
  dismissed
}

enum SocialContentCategory {
  amenities
  events
  offers
  reviews
  tips
  general
  promo
}

enum SocialTemplateStyle {
  short
  detailed
  story
  carousel
  announce
}

enum SocialAssetType {
  photo
  video
  logo
  template
  other
}

enum SocialSuggestionType {
  idea
  auto
  operator
  occupancy
  event
  deal
  seasonal
}

enum SocialSuggestionStatus {
  new
  accepted
  rejected
  published
}

enum ApprovalStatus {
  pending
  approved
  rejected
}

enum PermissionEffect {
  allow
  deny
}

enum PlatformRole {
  support_agent
  support_lead
  regional_support
  ops_engineer
  platform_admin
}

enum PiiClassification {
  basic
  sensitive
  payment
  secret
}

enum RedactionMode {
  mask
  remove
}

enum ConsentMethod {
  verbal
  written
  digital
}

enum SocialAlertCategory {
  weather
  occupancy
  events
  deals
  reviews
  inactivity
  inventory
}

enum OnboardingStatus {
  pending
  in_progress
  completed
  expired
  cancelled
}

enum OnboardingStep {
  // New step names
  park_profile
  operational_hours
  stripe_connect
  inventory_choice
  data_import
  site_classes
  sites_builder
  rate_periods
  rates_setup
  fees_and_addons
  tax_rules
  booking_rules
  deposit_policy
  cancellation_rules
  waivers_documents
  park_rules
  team_setup
  communication_setup
  integrations
  review_launch
  // Legacy step names (for backwards compatibility)
  account_profile
  payment_gateway
  taxes_and_fees
  inventory_sites
  rates_and_fees
  policies
  communications_templates
  pos_hardware
  imports
}

model User {
  id                 String        @id @default(cuid())
  email              String        @unique
  passwordHash       String
  firstName          String
  lastName           String
  region             String?
  platformRole       PlatformRole?
  platformRegion     String?
  platformActive     Boolean       @default(true)
  ownershipRoles     String[]      @default([])
  isActive           Boolean       @default(true)
  mustChangePassword Boolean       @default(false) // Force password change on first login
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @default(now()) @updatedAt

  memberships                      CampgroundMembership[]
  maintenanceTickets               MaintenanceTicket[]
  internalMessages                 InternalMessage[]
  internalConversationParticipants InternalConversationParticipant[]
  inviteTokens                     InviteToken[]
  auditLogs                        AuditLog[]
  storeOrdersCompleted             StoreOrder[]                      @relation("OrderCompletedBy")
  storeOrdersAssigned              StoreOrder[]                      @relation("OrderAssignedBy")
  supportReportsAuthored           SupportReport[]                   @relation("ReportAuthor")
  supportReportsAssigned           SupportReport[]                   @relation("ReportAssignee")
  uploadedAssets                   SocialContentAsset[]              @relation("AssetUploader")
  xpRulesCreated                   XpRule[]                          @relation("XpRuleCreator")
  xpBalances                       XpBalance[]
  xpEvents                         XpEvent[]
  pushSubscriptions                PushSubscription[]
  integrationExportJobs            IntegrationExportJob[]
  auditExports                     AuditExport[]
  piiFieldTags                     PiiFieldTag[]
  approvalPolicies                 ApprovalPolicy[]
  permissionRules                  PermissionRule[]
  approvedCommunicationTemplates   CommunicationTemplate[]           @relation("CommunicationTemplateApprovedBy")
  onboardingInvites                OnboardingInvite[]
  staffTimeEntries                 StaffTimeEntry[]                  @relation("StaffTimeEntries")
  staffTimeEntriesApproved         StaffTimeEntry[]                  @relation("StaffTimeEntryApprover")
  shiftApprovals                   ShiftApproval[]                   @relation("ShiftApprover")
  overrideRequestsRequested        OverrideRequest[]                 @relation("OverrideRequester")
  overrideRequestsApproved         OverrideRequest[]                 @relation("OverrideApprover")
  payrollExportsRequested          PayrollExport[]                   @relation("PayrollExportRequester")
  payrollExportLines               PayrollExportLine[]               @relation("PayrollExportUser")

  // Phase 3 relations
  staffShifts         StaffShift[]         @relation("StaffShifts")
  staffAvailability   StaffAvailability[]  @relation("StaffAvailability")
  pushNotifications   PushNotification[]   @relation("PushNotifications")
  staffPerformance    StaffPerformance[]   @relation("StaffPerformance")
  savedReports        SavedReport[]        @relation("SavedReports")
  portfolioDashboards PortfolioDashboard[] @relation("PortfolioDashboards")
  tillSessionsOpened  TillSession[]        @relation("TillSessionOpenedBy")
  tillSessionsClosed  TillSession[]        @relation("TillSessionClosedBy")
  tillMovements       TillMovement[]       @relation("TillMovementActor")

  // Multi-location inventory relations
  transfersRequested  InventoryTransfer[]  @relation("TransferRequester")
  transfersApproved   InventoryTransfer[]  @relation("TransferApprover")
  transfersCompleted  InventoryTransfer[]  @relation("TransferCompleter")
  inventoryMovements  InventoryMovement[]

  // Inventory batch tracking relations
  batchMovements               BatchMovement[]    @relation("BatchMovementActor")
  expirationAlertsAcknowledged ExpirationAlert[]  @relation("AlertAcknowledger")

  // Hotel operations relations
  inspectionsPerformed     InspectionResult[]   @relation("InspectionInspector")
  roomMovesRequested       RoomMoveRequest[]    @relation("RoomMoveRequester")
  roomMovesApproved        RoomMoveRequest[]    @relation("RoomMoveApprover")
  roomMovesCompleted       RoomMoveRequest[]    @relation("RoomMoveCompleter")

  // Customizable menu configuration
  menuConfig               UserMenuConfig?
}

// User's customizable sidebar menu configuration
model UserMenuConfig {
  id                String   @id @default(cuid())
  userId            String   @unique
  pinnedPages       String[] @default([])     // hrefs pinned to sidebar
  sidebarCollapsed  Boolean  @default(false)
  migratedFromLocal Boolean  @default(false)  // track localStorage migration
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model GuestEquipment {
  id          String   @id @default(cuid())
  guestId     String
  type        String // rv, trailer, tent, car
  make        String?
  model       String?
  length      Int? // in feet
  plateNumber String?
  plateState  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  guest Guest @relation(fields: [guestId], references: [id], onDelete: Cascade)

  @@index([guestId])
}

model CampgroundMembership {
  id           String   @id @default(cuid())
  userId       String
  campgroundId String
  role         UserRole
  createdAt    DateTime @default(now())

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  xpEvents   XpEvent[]

  @@unique([userId, campgroundId])
  @@index([campgroundId])
}

model SupportReport {
  id             String              @id @default(uuid())
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  description    String
  steps          String?
  contactEmail   String?
  path           String?
  userAgent      String?
  language       String?
  timezone       String?
  viewportWidth  Int?
  viewportHeight Int?
  roleFilter     String?
  pinnedIds      String[]
  recentIds      String[]
  rawContext     Json?
  status         SupportReportStatus @default(new)
  assigneeId     String?
  assignee       User?               @relation("ReportAssignee", fields: [assigneeId], references: [id])
  authorId       String?
  author         User?               @relation("ReportAuthor", fields: [authorId], references: [id])
  campgroundId   String?
  campground     Campground?         @relation("ReportCampground", fields: [campgroundId], references: [id])
}

model SiteClass {
  id                String   @id @default(cuid())
  campgroundId      String
  name              String
  description       String?
  defaultRate       Int      @default(0)
  siteType          SiteType
  maxOccupancy      Int
  rigMaxLength      Int?     // @deprecated - use Site.rigMaxLength instead
  hookupsPower      Boolean  @default(false)
  hookupsWater      Boolean  @default(false)
  hookupsSewer      Boolean  @default(false)
  // RV-specific configuration
  rvOrientation     String?  // "back_in" | "pull_through"
  electricAmps      Int[]    @default([]) // Available amp options: 20, 30, 50, 100
  // Metered utilities defaults for sites in this class
  meteredEnabled    Boolean  @default(false)
  meteredType       String?  // power|water|sewer
  meteredBillingMode String? // cycle|per_reading|annual|manual
  meteredBillTo     String?  // reservation|guest
  meteredMultiplier Decimal? @default(1.0)
  meteredRatePlanId String?
  meteredAutoEmail  Boolean  @default(false)
  tags              String[] @default([])
  glCode            String?
  clientAccount     String?
  minNights         Int?
  maxNights         Int?
  petFriendly       Boolean  @default(true)
  accessible        Boolean  @default(false)
  photos            String[] @default([])
  photoAttributions Json?
  policyVersion     String?
  isActive          Boolean  @default(true)

  // Rental type
  rentalType          String    @default("transient")  // "transient" | "seasonal" | "flexible"

  // Equipment & dimensions
  equipmentTypes      String[]  @default([])
  slideOutsAccepted   String?   // "both_sides" | "driver_side" | "passenger_side" | "none"

  // Guest pricing
  occupantsIncluded   Int       @default(2)
  extraAdultFeeCents  Int?
  extraChildFeeCents  Int?

  // Fees (per site class)
  petFeeEnabled       Boolean   @default(false)
  petFeeCents         Int?
  bookingFeeCents     Int?
  siteLockFeeCents    Int?

  // Monthly/seasonal rates
  monthlyRateCents    Int?
  weeklyRateCents     Int?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @default(now()) @updatedAt

  campground      Campground          @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  sites           Site[]
  pricingRules    PricingRule[]
  pricingRulesV2  PricingRuleV2[]
  seasonalRates   SeasonalRate[]
  otaMappings     OtaListingMapping[] @relation("SiteClassOtaMappings")
  analyticsEvents AnalyticsEvent[]
  demandBands     DemandBand[]
  upsellItems     UpsellItem[]
  depositPolicies DepositPolicy[]
  waitlistEntries WaitlistEntry[]
  documentTemplates DocumentTemplate[]

  @@index([campgroundId])
}

enum SubscriptionTier {
  free
  starter
  professional
  enterprise
}

enum BillingPlan {
  ota_only // OTA-only, per-booking fee (default $3)
  standard // Core product, per-booking fee (default $2)
  enterprise // Flat monthly + low per-booking fee (default $1 + monthly)
}

enum EarlyAccessTier {
  founders_circle // 5 spots, $0/mo forever, $0.75/booking
  pioneer // 15 spots, $0/mo 12mo, $1.00/booking
  trailblazer // 25 spots, $14.50/mo 6mo, $1.25/booking
}

enum PaymentFeeMode {
  absorb // Platform fee is absorbed by campground (reduces payout)
  pass_through // Platform fee added to guest total
}

enum PaymentGatewayProvider {
  stripe
  adyen
  authorize_net
  other
}

enum PaymentGatewayMode {
  test
  prod
}

enum NpsSurveyStatus {
  draft
  active
  paused
  archived
}

enum NpsInviteStatus {
  queued
  sent
  bounced
  opened
  responded
  expired
}

enum ReviewStatus {
  pending
  approved
  rejected
  removed
}

enum ReviewSource {
  onsite
  email
  sms
  kiosk
  import
}

enum ReviewExposure {
  private
  public
}

enum ReviewVoteValue {
  helpful
  not_helpful
}

enum ReviewModerationStatus {
  pending
  approved
  rejected
}

// =============================================================================
// Analytics & Data Intelligence
// =============================================================================

enum AnalyticsEventName {
  page_view
  site_card_view
  image_viewed
  image_hovered
  image_clicked
  site_class_viewed
  availability_check
  add_to_stay
  reservation_start
  reservation_abandoned
  reservation_completed
  deal_viewed
  deal_applied
  email_signup
  review_viewed
  admin_pricing_change
  admin_image_reorder
}

enum AbTestStatus {
  draft
  active
  paused
  stopped
  completed
}

model AnalyticsEvent {
  id             String             @id @default(cuid())
  campgroundId   String?
  organizationId String?
  reservationId  String?
  siteId         String?
  siteClassId    String?
  promotionId    String?
  imageId        String?
  sessionId      String
  eventName      AnalyticsEventName
  page           String?
  referrer       String?
  referrerUrl    String?
  deviceType     String?
  region         String?
  abVariantId    String?
  metadata       Json?
  occurredAt     DateTime           @default(now())
  createdAt      DateTime           @default(now())

  campground   Campground?   @relation(fields: [campgroundId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  reservation  Reservation?  @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  site         Site?         @relation(fields: [siteId], references: [id], onDelete: SetNull)
  siteClass    SiteClass?    @relation(fields: [siteClassId], references: [id], onDelete: SetNull)
  promotion    Promotion?    @relation(fields: [promotionId], references: [id], onDelete: SetNull)
  abVariant    AbVariant?    @relation(fields: [abVariantId], references: [id], onDelete: SetNull)

  @@index([campgroundId, occurredAt])
  @@index([organizationId, occurredAt])
  @@index([sessionId, occurredAt])
  @@index([eventName, occurredAt])
  @@index([siteId])
  @@index([siteClassId])
  @@index([promotionId])
  @@index([abVariantId])
}

model AnalyticsDailyAggregate {
  id             String             @id @default(cuid())
  campgroundId   String?
  organizationId String?
  eventName      AnalyticsEventName
  date           DateTime
  count          Int                @default(0)
  uniqueSessions Int?               @default(0)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @default(now()) @updatedAt

  campground   Campground?   @relation(fields: [campgroundId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  @@unique([campgroundId, eventName, date])
  @@index([organizationId, eventName, date])
}

model AbTest {
  id             String       @id @default(cuid())
  campgroundId   String?
  organizationId String?
  key            String       @unique
  name           String
  description    String?
  status         AbTestStatus @default(draft)
  startedAt      DateTime?
  endedAt        DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now()) @updatedAt

  campground   Campground?    @relation(fields: [campgroundId], references: [id], onDelete: SetNull)
  organization Organization?  @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  variants     AbVariant[]
  enrollments  AbEnrollment[]

  @@index([campgroundId, status])
  @@index([organizationId, status])
}

model AbVariant {
  id          String   @id @default(cuid())
  testId      String
  name        String
  description String?
  weight      Int? // optional rollout weight
  createdAt   DateTime @default(now())

  test        AbTest           @relation(fields: [testId], references: [id], onDelete: Cascade)
  events      AnalyticsEvent[]
  enrollments AbEnrollment[]

  @@index([testId])
}

model AbEnrollment {
  id             String   @id @default(cuid())
  testId         String
  variantId      String
  campgroundId   String?
  organizationId String?
  sessionId      String
  enrolledAt     DateTime @default(now())

  test         AbTest        @relation(fields: [testId], references: [id], onDelete: Cascade)
  variant      AbVariant     @relation(fields: [variantId], references: [id], onDelete: Cascade)
  campground   Campground?   @relation(fields: [campgroundId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  @@unique([testId, sessionId])
  @@index([campgroundId])
  @@index([organizationId])
}

// =============================================================================
// Gamification
// =============================================================================

enum GamificationEventCategory {
  task
  maintenance
  check_in
  reservation_quality
  checklist
  review_mention
  on_time_assignment
  assist
  manual
  other
}

model Organization {
  id   String @id @default(cuid())
  name String

  // Billing & subscription
  subscriptionTier   SubscriptionTier @default(free)
  billingEmail       String?
  billingName        String?
  billingAddress1    String?
  billingAddress2    String?
  billingCity        String?
  billingState       String?
  billingPostalCode  String?
  billingCountry     String?
  stripeCustomerId     String?          @unique
  stripeSubscriptionId String?          @unique
  subscriptionStatus   String? // active, past_due, canceled, trialing
  billingTier          String?          @default("standard") // founders_circle, pioneer, trailblazer, standard
  billingStatus        String?          @default("active") // active, suspended, cancelled
  trialEndsAt          DateTime?
  dataRegion           String   @default("us-east-1")

  campgrounds              Campground[]
  analyticsEvents          AnalyticsEvent[]
  analyticsDailyAggregates AnalyticsDailyAggregate[]
  abTests                  AbTest[]
  abEnrollments            AbEnrollment[]
  integrationConnections   IntegrationConnection[]
  onboardingInvites        OnboardingInvite[]
  onboardingSessions       OnboardingSession[]

  // Phase 3 relations
  portfolioDashboards   PortfolioDashboard[]
  portfolioMetrics      PortfolioMetric[]
  centralizedRatePushes CentralizedRatePush[]

  // Early access program
  earlyAccessEnrollment EarlyAccessEnrollment?

  // Referral program
  referralCode       String?   @unique // Unique code for this org to share
  referralCredits    Int       @default(0) // Total credits earned in cents
  referralsGiven     OrgReferral[] @relation("ReferrerOrg")
  referralsReceived  OrgReferral[] @relation("ReferredOrg")

  // Organization billing (what Camp Everyday charges them)
  billingPeriods OrganizationBillingPeriod[]
  usageEvents    UsageEvent[]
  setupServices  SetupService[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model Campground {
  id                String  @id @default(cuid())
  organizationId    String
  name              String
  slug              String  @unique
  isExternal        Boolean @default(false)
  isBookable        Boolean @default(true)
  externalUrl       String?
  nonBookableReason String?

  // Location
  city       String?
  state      String?
  country    String?
  address1   String?
  address2   String?
  postalCode String?
  latitude   Decimal? @db.Decimal(12, 8)
  longitude  Decimal? @db.Decimal(12, 8)
  timezone   String?  @default("UTC")
  currency   String   @default("USD") // ISO 4217 currency code
  taxId      String?  // e.g. VAT number, EIN
  taxIdName  String   @default("Tax ID") // Label for the tax ID field (e.g. "VAT Reg No")

  // Contact
  phone                String?
  email                String?
  website              String?
  facebookUrl          String?
  instagramUrl         String?
  dataSource           String?
  dataSourceId         String?
  dataSourceUpdatedAt  DateTime?
  dataImportNotes      String?
  provenance           Json?
  gaMeasurementId      String?
  metaPixelId          String?
  // AI Features
  aiEnabled                Boolean   @default(false) // Master toggle for all AI features
  aiReplyAssistEnabled     Boolean   @default(false) // Staff reply suggestions
  aiBookingAssistEnabled   Boolean   @default(false) // Consumer booking assistant
  aiAnalyticsEnabled       Boolean   @default(false) // AI-powered insights
  aiForecastingEnabled     Boolean   @default(false) // Demand forecasting
  aiAnonymizationLevel     String    @default("strict") // strict, moderate, minimal
  aiProvider               String    @default("openai") // openai, anthropic, local
  aiApiKey                 String?   // Encrypted API key for AI provider
  aiConsentCollected       Boolean   @default(false)
  aiConsentCollectedAt     DateTime?
  aiMonthlyBudgetCents     Int?      // Optional spending cap
  aiTotalTokensUsed        Int       @default(0) // Running total for billing

  // NPS/Reviews
  npsAutoSendEnabled   Boolean   @default(false)
  npsSendHour          Int?      @default(7)
  npsTemplateId        String?
  npsSchedule          Json?     @default("[]")

  // Public listing
  description    String?   @db.Text
  tagline        String? // Short marketing tagline
  amenities      String[]  @default([])
  photos         String[]  @default([]) // Array of photo URLs
  photosMeta     Json?
  heroImageUrl   String? // Main hero image for public page
  isPublished    Boolean   @default(false) // Whether visible on public marketplace
  amenitySummary Json?
  faqs           Json?     // Array of { question: string, answer: string, order: number }
  importedAt     DateTime?

  // Operations
  seasonStart           DateTime?
  seasonEnd             DateTime?
  checkInTime           String?   @default("15:00")
  checkOutTime          String?   @default("11:00")
  parkTimeZone          String?
  slaMinutes            Int?      @default(30)
  senderDomain          String?
  senderDomainStatus    String? // verified | failed | pending | unknown
  senderDomainCheckedAt DateTime?
  senderDomainDmarc     String?
  senderDomainSpf       String?
  quietHoursStart       String? // HH:mm
  quietHoursEnd         String? // HH:mm
  routingAssigneeId     String?

  // Long-term settings
  longTermEnabled         Boolean   @default(false)
  longTermMinNights       Int?      @default(28)
  longTermAutoApply       Boolean   @default(true)

  // Booking tracking
  bookingSources          String[]  @default([])
  stayReasons             String[]  @default([])

  // Branding
  logoUrl        String?
  primaryColor   String?
  accentColor    String?
  brandingNote   String?
  secondaryColor String?
  buttonColor    String?
  brandFont      String?
  emailHeader    String?
  receiptFooter  String?

  // Financial
  taxState                    Decimal?       @db.Decimal(10, 4)
  taxLocal                    Decimal?       @db.Decimal(10, 4)
  depositRule                 String? // e.g., none, full, half, first_night, first_night_fees, percentage
  depositPercentage           Int? // For percentage rule (0-100)
  depositConfig               Json?
  defaultDepositPolicyId      String?        @unique
  cancellationPolicyType      String? // flexible, moderate, strict, custom
  cancellationWindowHours     Int? // hours before arrival to allow refund
  cancellationFeeType         String? // flat, percent, first_night
  cancellationFeeFlatCents    Int?
  cancellationFeePercent      Int?
  cancellationNotes           String?        @db.Text
  storeOpenHour               Int? // 0-23
  storeCloseHour              Int? // 0-23
  orderWebhookUrl             String?
  stripeAccountId             String?        @unique
  applicationFeeFlatCents     Int?           @default(300) // Legacy per-booking fee in cents
  billingPlan                 BillingPlan    @default(ota_only)
  perBookingFeeCents          Int?           @default(300) // If null, fall back to plan default
  monthlyFeeCents             Int? // For enterprise plans (e.g., 50000 = $500)
  feeMode                     PaymentFeeMode @default(absorb)
  stripeCapabilities          Json?
  stripeCapabilitiesFetchedAt DateTime?
  reviewScore                 Decimal?       @db.Decimal(4, 2)
  reviewCount                 Int            @default(0)
  reviewSources               Json?
  reviewsUpdatedAt            DateTime?

  // Public booking page settings
  showPublicMap               Boolean        @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  organization              Organization               @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  siteClasses               SiteClass[]
  sites                     Site[]
  reservations              Reservation[]
  maintenance               MaintenanceTicket[]
  incidents                 Incident[]
  certificatesOfInsurance   CertificateOfInsurance[]
  documentTemplates         DocumentTemplate[]
  billingCycles             BillingCycle[]
  invoices                  Invoice[]
  signatureRequests         SignatureRequest[]
  signatureArtifacts        SignatureArtifact[]
  coiUploads                CoiUpload[]
  pricingRules              PricingRule[]
  pricingRulesV2            PricingRuleV2[]
  demandBands               DemandBand[]               @relation("CampgroundDemandBands")
  depositPolicies           DepositPolicy[]            @relation("CampgroundDepositPolicies")
  payments                  Payment[]
  paymentGatewayConfig      CampgroundPaymentGatewayConfig?
  ledgerEntries             LedgerEntry[]
  glPeriods                 GlPeriod[]
  memberships               CampgroundMembership[]
  events                    Event[]
  productCategories         ProductCategory[]
  products                  Product[]
  addOnServices             AddOnService[]
  storeOrders               StoreOrder[]
  blackoutDates             BlackoutDate[]
  messages                  Message[]
  communications            Communication[]
  promotions                Promotion[]
  waitlistEntries           WaitlistEntry[]
  taxRules                  TaxRule[]
  seasonalRates             SeasonalRate[]
  defaultDepositPolicy      DepositPolicy?             @relation("CampgroundDefaultDepositPolicy", fields: [defaultDepositPolicyId], references: [id], onDelete: SetNull)
  activities                Activity[]
  membershipTypes           MembershipType[]
  operationalTasks          OperationalTask[]
  internalConversations     InternalConversation[]
  siteHolds                 SiteHold[]
  siteMapLayouts            SiteMapLayout[]
  siteMapShapes             SiteMapShape[]
  siteMapAssignments        SiteMapAssignment[]
  mapConfig                 CampgroundMapConfig?
  inviteTokens              InviteToken[]
  auditLogs                 AuditLog[]
  campaigns                 Campaign[]
  campaignTemplates         CampaignTemplate[]
  campaignSends             CampaignSend[]             @relation("CampgroundCampaignSends")
  otaChannels               OtaChannel[]               @relation("CampgroundOtaChannels")
  npsSurveys                NpsSurvey[]
  npsInvites                NpsInvite[]
  npsResponses              NpsResponse[]
  reviewRequests            ReviewRequest[]
  reviews                   Review[]
  reviewVotes               ReviewVote[]
  supportReports            SupportReport[]            @relation("ReportCampground")
  formTemplates             FormTemplate[]
  payouts                   Payout[]
  disputes                  Dispute[]
  utilityRatePlans          UtilityRatePlan[]
  utilityMeters             UtilityMeter[]
  smartLocks                SmartLock[]
  qrCodes                   QRCode[]
  lateFeeRules              LateFeeRule[]
  analyticsEvents           AnalyticsEvent[]
  analyticsDailyAggregates  AnalyticsDailyAggregate[]
  abTests                   AbTest[]
  abEnrollments             AbEnrollment[]
  referralPrograms          ReferralProgram[]
  onboardingInvites         OnboardingInvite[]
  onboardingSessions        OnboardingSession[]
  socialPosts               SocialPost[]
  socialTemplates           SocialTemplate[]
  socialContentAssets       SocialContentAsset[]
  socialSuggestions         SocialSuggestion[]
  socialWeeklyIdeas         SocialWeeklyIdea[]
  socialStrategies          SocialStrategy[]
  socialOpportunityAlerts   SocialOpportunityAlert[]
  upsellItems               UpsellItem[]
  upsellBundles             UpsellBundle[]
  socialPerformanceInputs   SocialPerformanceInput[]
  gamificationSetting       GamificationSetting?
  xpRules                   XpRule[]
  xpBalances                XpBalance[]
  xpEvents                  XpEvent[]
  pushSubscriptions         PushSubscription[]
  privacySetting            PrivacySetting?
  consentLogs               ConsentLog[]
  approvalRequests          ApprovalRequest[]
  auditExports              AuditExport[]
  approvalPolicies          ApprovalPolicy[]
  permissionRules           PermissionRule[]
  integrationConnections    IntegrationConnection[]
  integrationExportJobs     IntegrationExportJob[]
  apiClients                ApiClient[]
  webhookEndpoints          WebhookEndpoint[]
  communicationTemplates    CommunicationTemplate[]    @relation("CampgroundCommunicationTemplates")
  communicationPlaybooks    CommunicationPlaybook[]    @relation("CampgroundCommunicationPlaybooks")
  communicationPlaybookJobs CommunicationPlaybookJob[] @relation("CampgroundCommunicationPlaybookJobs")
  storedValueAccounts       StoredValueAccount[]
  storedValueLedgers        StoredValueLedger[]
  posTerminals              PosTerminal[]
  posCarts                  PosCart[]
  posOfflineReplays         PosOfflineReplay[]
  tillSessions              TillSession[]
  vehicles                  Vehicle[]
  accessIntegrations        AccessIntegration[]
  accessGrants              AccessGrant[]
  accessCredentials         AccessCredential[]
  payrollExports            PayrollExport[]
  posProviderIntegrations   PosProviderIntegration[]
  overrideRequests          OverrideRequest[]
  staffRoles                StaffRole[]
  factReservationsDaily     FactReservationsDaily[]
  factPosDaily              FactPosDaily[]
  factStoredValueDaily      FactStoredValueDaily[]

  // Phase 3 relations
  dynamicPricingRules    DynamicPricingRule[]
  occupancySnapshots     OccupancySnapshot[]
  revenueForecasts       RevenueForecast[]
  communicationWorkflows CommunicationWorkflow[]
  digitalWaivers         DigitalWaiver[]
  waiverTemplates        WaiverTemplate[]
  idVerifications        IdVerification[]
  staffShifts            StaffShift[]
  staffAvailability      StaffAvailability[]
  pushNotifications      PushNotification[]
  staffPerformance       StaffPerformance[]
  savedReports           SavedReport[]
  portfolioMetrics       PortfolioMetric[]
  NotificationTrigger    NotificationTrigger[]
  ScheduledNotification  ScheduledNotification[]
  guestSegments          GuestSegment[]
  analyticsShareLinks    AnalyticsShareLink[]
  analyticsExports       AnalyticsExport[]
  platformGoals          PlatformGoal[]
  campgroundAwards       CampgroundAward[]
  charitySettings        CampgroundCharity?
  charityDonations       CharityDonation[]

  // Organization billing relations
  orgBillingLineItems    OrganizationBillingLineItem[]
  usageEvents            UsageEvent[]

  // Multi-location store management
  storeLocations         StoreLocation[]
  inventoryTransfers     InventoryTransfer[]
  inventoryMovements     InventoryMovement[]

  // Hotel operations relations
  cleaningTaskTemplates  CleaningTaskTemplate[]
  cleaningZones          CleaningZone[]
  flexCheckPolicy        FlexCheckPolicy?
  roomMoveRequests       RoomMoveRequest[]
  groupBookings          GroupBooking[]

  // Inventory batch & expiration tracking relations
  inventoryBatches           InventoryBatch[]
  categoryExpirationConfigs  CategoryExpirationConfig[]
  productExpirationConfigs   ProductExpirationConfig[]
  markdownRules              MarkdownRule[]
  markdownApplications       MarkdownApplication[]
  expirationAlerts           ExpirationAlert[]

  // 3rd party POS integration relations
  externalPosSales           ExternalPosSale[]
  productExternalMappings    ProductExternalMapping[]

  // Soft delete
  deletedAt DateTime?
  deletedBy String?

  @@index([dataSource, dataSourceId])
  @@index([deletedAt])
}

model PushSubscription {
  id             String    @id @default(cuid())
  userId         String?
  campgroundId   String?
  endpoint       String    @unique
  keys           Json?
  subscription   Json?
  expirationTime DateTime?
  userAgent      String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user       User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  campground Campground? @relation(fields: [campgroundId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([campgroundId])
}

model FormTemplate {
  id           String           @id @default(cuid())
  campgroundId String
  title        String
  type         FormTemplateType @default(custom)
  description  String?
  fields       Json?
  isActive     Boolean          @default(true)
  version      Int              @default(1)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @default(now()) @updatedAt

  campground  Campground       @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  submissions FormSubmission[]
}

enum FormTemplateType {
  waiver
  vehicle
  intake
  custom
}

model FormSubmission {
  id             String               @id @default(cuid())
  formTemplateId String
  reservationId  String?
  guestId        String?
  status         FormSubmissionStatus @default(pending)
  responses      Json?
  signedAt       DateTime?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @default(now()) @updatedAt

  formTemplate FormTemplate @relation(fields: [formTemplateId], references: [id], onDelete: Cascade)
  reservation  Reservation? @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  guest        Guest?       @relation(fields: [guestId], references: [id], onDelete: Cascade)
}

enum FormSubmissionStatus {
  pending
  completed
  void
}

// Access control providers and credential types
enum AccessProviderType {
  kisi
  brivo
  cloudkey
}

enum AccessGrantStatus {
  pending
  active
  revoked
  blocked
  expired
  failed
}

enum AccessCredentialType {
  pin
  card
  fob
  mobile
  qr
}

model Campaign {
  id              String         @id @default(cuid())
  campgroundId    String
  name            String
  subject         String
  fromEmail       String
  fromName        String?
  html            String         @db.Text
  textBody        String?        @db.Text
  channel         ChannelType    @default(email)
  templateId      String?
  audienceJson    Json?
  suggestedReason String?
  variables       Json?
  status          CampaignStatus @default(draft)
  scheduledAt     DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @default(now()) @updatedAt

  campground Campground        @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  sends      CampaignSend[]
  template   CampaignTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([status])
}

model CampaignSend {
  id                String             @id @default(cuid())
  campaignId        String
  campgroundId      String
  guestId           String?
  email             String
  phone             String?
  channel           ChannelType        @default(email)
  status            CampaignSendStatus @default(queued)
  providerMessageId String?
  error             String?
  sentAt            DateTime?
  createdAt         DateTime           @default(now())

  campaign   Campaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  campground Campground @relation("CampgroundCampaignSends", fields: [campgroundId], references: [id], onDelete: Cascade)
  guest      Guest?     @relation(fields: [guestId], references: [id], onDelete: SetNull)

  @@index([campaignId])
  @@index([campgroundId])
  @@index([guestId])
  @@index([status])
}

model CampaignTemplate {
  id           String      @id @default(cuid())
  campgroundId String
  name         String
  channel      ChannelType @default(email)
  category     String?     @default("general")
  subject      String?
  html         String?     @db.Text
  textBody     String?     @db.Text
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @default(now()) @updatedAt

  campground          Campground            @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  campaigns           Campaign[]
  NotificationTrigger NotificationTrigger[]

  @@index([campgroundId])
  @@index([channel])
}

model TaxRule {
  id             String      @id @default(cuid())
  campgroundId   String
  name           String
  type           TaxRuleType
  rate           Decimal?    @db.Decimal(10, 4)
  minNights      Int?
  maxNights      Int?
  category       String      @default("general") // general, accommodation, goods, services
  requiresWaiver Boolean     @default(false)
  waiverText     String?
  isActive       Boolean     @default(true)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @default(now()) @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
}

// ---------------------------------------------------------------------------
// Social Media Planner models
// ---------------------------------------------------------------------------

model SocialPost {
  id             String                 @id @default(cuid())
  campgroundId   String
  title          String
  platform       SocialPlatform
  status         SocialPostStatus       @default(draft)
  category       SocialContentCategory?
  scheduledFor   DateTime?
  publishedFor   DateTime?
  caption        String?
  hashtags       String[]               @default([])
  imagePrompt    String?
  notes          String?
  templateId     String?
  assetUrls      String[]               @default([])
  tags           String[]               @default([])
  ideaParkingLot Boolean                @default(false)
  suggestionId   String?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt

  campground        Campground               @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  template          SocialTemplate?          @relation(fields: [templateId], references: [id], onDelete: SetNull)
  suggestion        SocialSuggestion?        @relation("PostSuggestion", fields: [suggestionId], references: [id], onDelete: SetNull)
  performanceInputs SocialPerformanceInput[]

  @@index([campgroundId])
  @@index([platform, status])
  @@index([scheduledFor])
}

model SocialTemplate {
  id             String                 @id @default(cuid())
  campgroundId   String
  name           String
  summary        String?
  category       SocialContentCategory?
  style          SocialTemplateStyle?
  defaultCaption String?
  captionFillIns String?
  imageGuidance  String?
  hashtagSet     String[]               @default([])
  bestTime       String?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt

  campground Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  posts      SocialPost[]

  @@index([campgroundId])
}

model SocialContentAsset {
  id           String          @id @default(cuid())
  campgroundId String
  title        String
  type         SocialAssetType
  url          String
  tags         String[]        @default([])
  notes        String?
  uploadedById String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  uploadedBy User?      @relation("AssetUploader", fields: [uploadedById], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([type])
}

model SocialSuggestion {
  id            String                 @id @default(cuid())
  campgroundId  String
  type          SocialSuggestionType
  status        SocialSuggestionStatus @default(new)
  message       String
  reason        Json?
  category      SocialContentCategory?
  platform      SocialPlatform?
  proposedDate  DateTime?
  opportunityAt DateTime?
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt

  campground Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  posts      SocialPost[] @relation("PostSuggestion")

  @@index([campgroundId])
  @@index([type, status])
  @@index([proposedDate])
}

model SocialWeeklyIdea {
  id           String   @id @default(cuid())
  campgroundId String
  generatedFor DateTime // Monday anchor date
  ideas        Json
  cadence      Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, generatedFor])
  @@index([generatedFor])
}

model SocialStrategy {
  id           String   @id @default(cuid())
  campgroundId String
  month        DateTime
  annual       Boolean  @default(false)
  plan         Json
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId, month])
}

model SocialOpportunityAlert {
  id           String              @id @default(cuid())
  campgroundId String
  category     SocialAlertCategory
  message      String
  startsAt     DateTime?
  endsAt       DateTime?
  dismissed    Boolean             @default(false)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([category])
}

model SocialPerformanceInput {
  id           String   @id @default(cuid())
  campgroundId String
  postId       String?
  likes        Int?
  reach        Int?
  comments     Int?
  saves        Int?
  shares       Int?
  notes        String?
  recordedAt   DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground Campground  @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  post       SocialPost? @relation(fields: [postId], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([postId])
  @@index([recordedAt])
}

model SeasonalRate {
  id           String    @id @default(cuid())
  campgroundId String
  siteClassId  String?
  name         String
  rateType     RateType
  amount       Int
  minNights    Int?
  startDate    DateTime?
  endDate      DateTime?
  isActive     Boolean   @default(true)

  // Payment & Pricing controls
  paymentSchedule   PaymentSchedule  @default(single)
  pricingStructure  PricingStructure @default(per_night)
  offseasonInterval Int? // months between payments (1 or 2)
  offseasonAmount   Int? // amount per offseason payment (cents)
  prorateExcess     Boolean          @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  campground   Campground    @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  siteClass    SiteClass?    @relation(fields: [siteClassId], references: [id], onDelete: SetNull)
  reservations Reservation[]

  @@index([campgroundId])
  @@index([siteClassId])
}

model Site {
  id                String   @id @default(cuid())
  campgroundId      String
  siteClassId       String?
  name              String
  siteNumber        String
  siteType          SiteType
  maxOccupancy      Int
  rigMaxLength      Int?
  rigMaxWidth       Int?
  rigMaxHeight      Int?
  pullThrough       Boolean  @default(false)
  hookupsPower      Boolean  @default(false)
  powerAmps         Int?
  hookupsWater      Boolean  @default(false)
  hookupsSewer      Boolean  @default(false)
  petFriendly       Boolean  @default(true)
  accessible        Boolean  @default(false)
  minNights         Int?
  maxNights         Int?
  photos            String[] @default([])
  photoAttributions Json?
  description       String?
  tags              String[] @default([])
  amenityTags       String[] @default([])
  vibeTags          String[] @default([])
  popularityScore   Int      @default(0)
  isActive          Boolean  @default(true)
  status            String? // e.g., available, out_of_service
  latitude          Decimal? @db.Decimal(12, 8)
  longitude         Decimal? @db.Decimal(12, 8)
  surfaceType       String?
  padSlopePercent   Int?
  mapLabel          String?

  // Hotel operations fields
  cleaningMinutes   Int?                // Standard cleaning time for this unit
  zone              String?             // "Building A Floor 2", "Lakeside Loop"

  createdAt         DateTime @default(now())
  updatedAt         DateTime @default(now()) @updatedAt

  campground         Campground          @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  siteClass          SiteClass?          @relation(fields: [siteClassId], references: [id], onDelete: SetNull)
  reservations       Reservation[]
  maintenance        MaintenanceTicket[]
  operationalTasks   OperationalTask[]
  housekeepingStatus String              @default("vacant_clean") // Uses HousekeepingStatus enum values
  blackoutDates      BlackoutDate[]
  structureAttributes StructureAttributes?  // Hotel room/cabin specific attributes
  holds              SiteHold[]
  otaMappings        OtaListingMapping[] @relation("SiteOtaMappings")
  analyticsEvents    AnalyticsEvent[]
  waitlistEntries    WaitlistEntry[]
  mapLayout          SiteMapLayout?
  mapAssignment      SiteMapAssignment?
  utilityMeters      UtilityMeter[]
  accessGrants       AccessGrant[]
  documentTemplates  DocumentTemplate[]
  reservationSegments ReservationSegment[]
  smartLocks          SmartLock[]
  qrCodes             QRCode[]

  // Hotel operations relations
  roomMovesFrom       RoomMoveRequest[]   @relation("RoomMoveFrom")
  roomMovesTo         RoomMoveRequest[]   @relation("RoomMoveTo")

  @@unique([campgroundId, name])
  @@index([campgroundId])
  @@index([siteType])
  @@index([siteClassId])
  @@index([campgroundId, isActive])
}

model SiteHold {
  id            String    @id @default(cuid())
  campgroundId  String
  siteId        String
  arrivalDate   DateTime
  departureDate DateTime
  expiresAt     DateTime?
  status        String    @default("active") // active, released, expired
  note          String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  site       Site       @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([siteId])
  @@index([expiresAt])
}

model SiteMapLayout {
  id           String   @id @default(cuid())
  campgroundId String
  siteId       String   @unique
  geometry     Json
  centroid     Json?
  label        String?
  rotation     Float?
  metadata     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  site       Site       @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
}

model SiteMapShape {
  id           String   @id @default(cuid())
  campgroundId String
  name         String?
  geometry     Json
  centroid     Json?
  metadata     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground  Campground         @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  assignments SiteMapAssignment[]

  @@index([campgroundId])
}

model SiteMapAssignment {
  id           String   @id @default(cuid())
  campgroundId String
  siteId       String   @unique
  shapeId      String   @unique
  label        String?
  rotation     Float?
  metadata     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground Campground  @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  site       Site        @relation(fields: [siteId], references: [id], onDelete: Cascade)
  shape      SiteMapShape @relation(fields: [shapeId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([shapeId])
}

model CampgroundMapConfig {
  campgroundId String   @id
  bounds       Json?
  defaultCenter Json?
  defaultZoom  Float?
  layers       Json?
  legend       Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
}

model Guest {
  id                String           @id @default(cuid())
  primaryFirstName  String
  primaryLastName   String
  email             String
  emailNormalized   String?
  phone             String?
  phoneNormalized   String?
  preferredContact  String?
  preferredLanguage String?
  address1          String?
  address2          String?
  city              String?
  state             String?
  postalCode        String?
  country           String?
  rigType           String?
  rigLength         Int?
  vehiclePlate      String?
  vehicleState      String?
  tags              String[]         @default([])
  vip               Boolean          @default(false)
  leadSource        String?
  marketingOptIn    Boolean          @default(false)
  repeatStays       Int              @default(0)
  notes             String?
  preferences       Json?
  insights          Json?
  equipment         GuestEquipment[]
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @default(now()) @updatedAt

  reservations              Reservation[]
  incidents                 Incident[]
  certificatesOfInsurance   CertificateOfInsurance[]
  storeOrders               StoreOrder[]
  account                   GuestAccount?
  messages                  Message[]
  communications            Communication[]
  campaignSends             CampaignSend[]
  npsInvites                NpsInvite[]
  npsResponses              NpsResponse[]
  reviewRequests            ReviewRequest[]
  reviews                   Review[]
  reviewVotes               ReviewVote[]
  formSubmissions           FormSubmission[]
  communicationPlaybookJobs CommunicationPlaybookJob[] @relation("GuestCommunicationPlaybookJobs")
  waitlistEntries           WaitlistEntry[]
  signatureRequests         SignatureRequest[]
  signatureArtifacts        SignatureArtifact[]
  coiUploads                CoiUpload[]
  storedValueCodes          StoredValueCode[]
  loyaltyProfile            LoyaltyProfile?
  activityBookings          ActivityBooking[]
  memberships               GuestMembership[]
  vehicles                  Vehicle[]

  // Phase 3 relations
  digitalWaivers     DigitalWaiver[]
  idVerifications    IdVerification[]
  segmentMemberships GuestSegmentMembership[]

  // Hotel operations relations
  groupBookings      GroupBooking[]  @relation("GroupPrimaryGuest")

  // Soft delete
  deletedAt DateTime?
  deletedBy String?

  @@unique([email])
  @@index([emailNormalized])
  @@index([phoneNormalized])
  @@index([deletedAt])
}

model LoyaltyProfile {
  id            String   @id @default(cuid())
  guestId       String   @unique
  pointsBalance Int      @default(0)
  tier          String   @default("Bronze") // Bronze, Silver, Gold, Platinum
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt

  guest        Guest               @relation(fields: [guestId], references: [id], onDelete: Cascade)
  transactions PointsTransaction[]

  @@index([guestId])
}

model PointsTransaction {
  id        String   @id @default(cuid())
  profileId String
  amount    Int // Positive for earning, negative for spending
  reason    String // e.g., "Reservation #123", "Redemption"
  createdAt DateTime @default(now())

  profile LoyaltyProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
}

model GuestAccount {
  id             String    @id @default(cuid())
  guestId        String    @unique
  email          String    @unique
  passwordHash   String?
  magicLinkToken String?   @unique
  tokenExpiry    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @default(now()) @updatedAt

  guest Guest @relation(fields: [guestId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([magicLinkToken])
}

model Reservation {
  id                       String            @id @default(cuid())
  campgroundId             String
  siteId                   String
  siteLocked               Boolean           @default(false)
  guestId                  String
  arrivalDate              DateTime
  departureDate            DateTime
  adults                   Int
  children                 Int               @default(0)
  petCount                 Int?              @default(0)
  petTypes                 Json?
  status                   ReservationStatus @default(pending)
  totalAmount              Int               @default(0)
  paidAmount               Int               @default(0)
  balanceAmount            Int               @default(0)
  depositAmount            Int               @default(0)
  depositDueDate           DateTime?
  pricingRuleVersion       String?
  depositPolicyVersion     String?
  nextAutoCollectAttemptAt DateTime?
  paymentStatus            String            @default("unpaid")
  baseSubtotal             Int               @default(0)
  feesAmount               Int               @default(0)
  taxesAmount              Int               @default(0)
  discountsAmount          Int               @default(0)
  promoCode                String?
  source                   String?
  policyVersion            String?
  checkInWindowStart       String?
  checkInWindowEnd         String?
  vehiclePlate             String?
  vehicleState             String?
  rigType                  String?
  rigLength                Int?
  stayReasonPreset         StayReasonPreset?
  stayReasonOther          String?
  referralProgramId        String?
  referralCode             String?
  referralSource           String?
  referralChannel          String?
  referralIncentiveType    ReferralIncentiveType?
  referralIncentiveValue   Int?              @default(0)
  createdBy                String?
  updatedBy                String?
  checkInAt                DateTime?
  checkOutAt               DateTime?
  notes                    String?
  stayType                 StayType          @default(standard)
  taxExempt                Boolean           @default(false)
  taxWaiverSigned          Boolean           @default(false)
  taxWaiverDate            DateTime?
  seasonalRateId           String?
  billingCadence           String            @default("monthly") // weekly|monthly
  billingAnchorDate        DateTime?
  utilityMeterIds          Json?

  // Booking metadata
  leadTimeDays     Int? // Days between booking date and arrival date
  bookedAt         DateTime? // Exact timestamp when booking was made
  additionalGuests Json? // Array of { firstName, lastName, email?, phone? }
  childrenDetails  Json? // Array of { name?, gender?, age? }

  groupId                String?
  groupRole              GroupRole?
  checkInStatus          CheckInStatus  @default(not_started)
  checkOutStatus         CheckOutStatus @default(not_started)
  idVerificationRequired Boolean        @default(false)
  waiverRequired         Boolean        @default(false)
  paymentRequired        Boolean        @default(true)
  lateArrivalFlag        Boolean        @default(false)
  siteReady              Boolean        @default(false)
  siteReadyAt            DateTime?
  selfCheckInAt          DateTime?
  selfCheckOutAt         DateTime?

  // Hotel operations: Flex check-in/check-out
  earlyCheckInRequested  DateTime?
  earlyCheckInApproved   Boolean?
  earlyCheckInCharge     Int?           // Cents charged for early check-in
  lateCheckoutRequested  DateTime?
  lateCheckoutApproved   Boolean?
  lateCheckoutCharge     Int?           // Cents charged for late checkout

  // Hotel operations: Group booking link
  groupBookingId         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  // Soft delete
  deletedAt DateTime?
  deletedBy String?

  campground     Campground      @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  site           Site            @relation(fields: [siteId], references: [id], onDelete: Cascade)
  guest          Guest           @relation(fields: [guestId], references: [id], onDelete: Cascade)
  referralProgram ReferralProgram? @relation(fields: [referralProgramId], references: [id], onDelete: SetNull)
  payments       Payment[]
  ledger         LedgerEntry[]
  storeOrders    StoreOrder[]
  messages       Message[]
  communications Communication[]

  repeatCharges             RepeatCharge[]
  seasonalRate              SeasonalRate?              @relation(fields: [seasonalRateId], references: [id], onDelete: SetNull)
  activityBookings          ActivityBooking[]
  otaImports                OtaReservationImport[]     @relation("ReservationOtaImports")
  formSubmissions           FormSubmission[]
  npsInvites                NpsInvite[]
  npsResponses              NpsResponse[]
  reviewRequests            ReviewRequest[]
  reviews                   Review[]
  payoutLines               PayoutLine[]
  disputes                  Dispute[]
  analyticsEvents           AnalyticsEvent[]
  communicationPlaybookJobs CommunicationPlaybookJob[] @relation("ReservationCommunicationPlaybookJobs")
  upsells                   ReservationUpsell[]
  vehicles                  Vehicle[]
  accessGrants              AccessGrant[]
  accessCredentials         AccessCredential[]
  incidents                 Incident[]
  certificatesOfInsurance   CertificateOfInsurance[]
  billingCycles             BillingCycle[]
  invoices                  Invoice[]

  // Phase 3 relations
  digitalWaivers  DigitalWaiver[]
  idVerifications IdVerification[]
  signatureRequests SignatureRequest[]
  signatureArtifacts SignatureArtifact[]
  coiUploads CoiUpload[]

  // Split booking segments (when a stay spans multiple sites)
  segments ReservationSegment[]

  // Charity donation (if guest opted to round up)
  charityDonation CharityDonation?

  // QR codes for check-in
  qrCodes QRCode[]

  // Hotel operations relations
  roomMoves     RoomMoveRequest[]
  groupBooking  GroupBooking?     @relation(fields: [groupBookingId], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([groupBookingId])
  @@index([siteId])
  @@index([guestId])
  @@index([seasonalRateId])
  @@index([groupId])
  @@index([referralCode])
  @@index([referralProgramId])
  // Critical composite indexes for common queries
  @@index([campgroundId, status])
  @@index([campgroundId, arrivalDate, departureDate])
  @@index([siteId, arrivalDate, departureDate])
  @@index([campgroundId, status, arrivalDate])
  @@index([status, arrivalDate])
  @@index([deletedAt])
}

// Split booking segment - represents a portion of a reservation on a specific site
model ReservationSegment {
  id            String   @id @default(cuid())
  reservationId String
  siteId        String
  startDate     DateTime
  endDate       DateTime
  subtotalCents Int      @default(0) // Price for this segment based on site rates
  sortOrder     Int      @default(0) // Order of segments in the stay
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt

  reservation Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  site        Site        @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([reservationId])
  @@index([siteId])
  @@index([startDate])
}

model MaintenanceTicket {
  id               String              @id @default(cuid())
  campgroundId     String
  siteId           String?
  title            String
  description      String?
  status           MaintenanceStatus   @default(open)
  priority         MaintenancePriority @default(medium)
  dueDate          DateTime?
  assignedTo       String?
  assignedToTeamId String?
  isBlocking       Boolean             @default(false)
  outOfOrder       Boolean             @default(false)
  outOfOrderReason String?
  outOfOrderUntil  DateTime?
  lockId           String?             @unique
  checklist        Json?
  photos           Json?
  notes            String?
  resolvedAt       DateTime?
  reopenedAt       DateTime?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @default(now()) @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  site       Site?      @relation(fields: [siteId], references: [id], onDelete: SetNull)
  assignee   User?      @relation(fields: [assignedTo], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([status])
  @@index([dueDate])
  @@index([assignedTo])
}

model Incident {
  id            String         @id @default(cuid())
  campgroundId  String
  reservationId String?
  guestId       String?
  type          IncidentType
  status        IncidentStatus @default(open)
  severity      Severity?
  notes         String?
  photos        Json?
  witnesses     Json? // [{ name, contact, statement }]
  occurredAt    DateTime?
  closedAt      DateTime?
  claimId       String?
  reminderAt    DateTime?
  metadata      Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  guest       Guest? @relation(fields: [guestId], references: [id], onDelete: SetNull)
  tasks       IncidentTask[]
  evidence    IncidentEvidence[]
  cois        CertificateOfInsurance[]

  @@index([campgroundId])
  @@index([reservationId])
  @@index([guestId])
  @@index([status])
  @@index([type])
}

model IncidentTask {
  id          String            @id @default(cuid())
  incidentId  String
  title       String
  status      IncidentTaskStatus @default(pending)
  dueAt       DateTime?
  reminderAt  DateTime?
  assignedTo  String?
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  incident Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  @@index([incidentId])
  @@index([status])
  @@index([dueAt])
}

model IncidentEvidence {
  id         String       @id @default(cuid())
  incidentId String
  type       EvidenceType @default(photo)
  url        String?
  storageKey String?
  description String?
  uploadedBy String?
  uploadedAt DateTime     @default(now())
  metadata   Json?

  incident Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  @@index([incidentId])
  @@index([type])
}

model CertificateOfInsurance {
  id             String     @id @default(cuid())
  campgroundId   String
  guestId        String?
  reservationId  String?
  incidentId     String?
  provider       String?
  policyNumber   String?
  coverageType   String?
  fileUrl        String
  effectiveDate  DateTime?
  expiresAt      DateTime?
  uploadedBy     String?
  uploadedAt     DateTime   @default(now())
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @default(now()) @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  guest       Guest? @relation(fields: [guestId], references: [id], onDelete: SetNull)
  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  incident    Incident? @relation(fields: [incidentId], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([guestId])
  @@index([reservationId])
  @@index([incidentId])
  @@index([expiresAt])
}

model PricingRule {
  id            String    @id @default(cuid())
  campgroundId  String
  siteClassId   String?
  label         String?
  ruleType      String // flat, percent, seasonal, dow
  startDate     DateTime?
  endDate       DateTime?
  dayOfWeek     Int?
  percentAdjust Decimal?  @db.Decimal(6, 4)
  flatAdjust    Int?
  minNights     Int?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  siteClass  SiteClass? @relation(fields: [siteClassId], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([siteClassId])
}

model GatewayFeePreset {
  id                  String                 @id @default(cuid())
  gateway             PaymentGatewayProvider
  mode                PaymentGatewayMode
  percentBasisPoints  Int                    @default(0)
  flatFeeCents        Int                    @default(0)
  label               String?
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @default(now()) @updatedAt

  campgroundConfigs CampgroundPaymentGatewayConfig[]

  @@unique([gateway, mode])
  @@index([gateway, mode])
}

model CampgroundPaymentGatewayConfig {
  id                        String                 @id @default(cuid())
  campgroundId              String                 @unique
  gateway                   PaymentGatewayProvider
  mode                      PaymentGatewayMode     @default(test)
  feeMode                   PaymentFeeMode         @default(absorb)
  feePercentBasisPoints     Int?
  feeFlatCents              Int?
  feePresetId               String?
  publishableKeySecretId    String?
  secretKeySecretId         String?
  merchantAccountIdSecretId String?
  webhookSecretId           String?
  additionalConfig          Json?
  createdAt                 DateTime               @default(now())
  updatedAt                 DateTime               @default(now()) @updatedAt

  campground Campground         @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  feePreset  GatewayFeePreset?  @relation(fields: [feePresetId], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([gateway, mode])
}

model Payment {
  id                         String    @id @default(cuid())
  campgroundId               String
  reservationId              String
  amountCents                Int
  method                     String    @default("card")
  direction                  String    @default("charge") // charge or refund
  note                       String?
  stripePaymentIntentId      String?
  stripeChargeId             String?
  stripeBalanceTransactionId String?
  stripePayoutId             String?
  applicationFeeCents        Int?
  stripeFeeCents             Int?
  methodType                 String? // card, ach, wallet, etc.
  capturedAt                 DateTime?
  createdAt                  DateTime  @default(now())

  reservation Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  campground  Campground  @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([reservationId])
  @@index([stripePaymentIntentId])
  @@index([stripeChargeId])
  @@index([stripePayoutId])
}

model RepeatCharge {
  id            String       @id @default(cuid())
  reservationId String
  amount        Int // cents
  dueDate       DateTime
  status        ChargeStatus @default(pending)
  paidAt        DateTime?
  failedAt      DateTime?
  failureReason String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @default(now()) @updatedAt

  reservation Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)

  @@index([reservationId])
  @@index([status])
  @@index([dueDate])
}

// ---------------------------------------------------------------------------
// Billing cycles, invoices, utilities, late fees
// ---------------------------------------------------------------------------

model BillingCycle {
  id             String   @id @default(cuid())
  campgroundId   String
  reservationId  String
  cadence        String   // weekly|monthly
  periodStart    DateTime
  periodEnd      DateTime
  status         String   @default("open") // open|closed
  generatedAt    DateTime?
  closedAt       DateTime?

  invoices     Invoice[]
  reservation  Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  campground   Campground  @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId, reservationId, periodStart, periodEnd])
}

model Invoice {
  id             String   @id @default(cuid())
  billingCycleId String
  campgroundId   String
  reservationId  String
  number         String   @unique
  dueDate        DateTime
  status         String   @default("open") // open|paid|void|written_off
  subtotalCents  Int      @default(0)
  taxCents       Int      @default(0)
  totalCents     Int      @default(0)
  balanceCents   Int      @default(0)
  createdAt      DateTime @default(now())
  closedAt       DateTime?

  lines        InvoiceLine[]
  billingCycle BillingCycle @relation(fields: [billingCycleId], references: [id], onDelete: Cascade)
  reservation  Reservation  @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  campground   Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  arLedger     ArLedgerEntry[]

  @@index([reservationId, status])
  @@index([campgroundId])
}

model InvoiceLine {
  id          String   @id @default(cuid())
  invoiceId   String
  type        String   // rent|utility|late_fee|adjustment
  description String
  quantity    Decimal  @default(1)
  unitCents   Int
  amountCents Int
  meta        Json?

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  arLedger ArLedgerEntry[]

  @@index([invoiceId, type])
}

model UtilityRatePlan {
  id             String   @id @default(cuid())
  campgroundId   String
  type           String   // power|water|sewer
  pricingMode    String   // flat|tiered|time_of_use
  baseRateCents  Int
  tiers          Json?
  demandFeeCents Int?
  minimumCents   Int?
  effectiveFrom  DateTime
  effectiveTo    DateTime?

  meters      UtilityMeter[]
  campground  Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId, type, effectiveFrom])
}

model UtilityMeter {
  id             String   @id @default(cuid())
  campgroundId   String
  siteId         String
  type           String   // power|water|sewer
  serialNumber   String?
  active         Boolean  @default(true)
  installedAt    DateTime @default(now())
  removedAt      DateTime?
  ratePlanId     String?
  billingMode    String   @default("cycle") // cycle|per_reading|annual|manual
  billTo         String   @default("reservation") // reservation|guest
  multiplier     Decimal  @default(1.0)
  autoEmail      Boolean  @default(false)
  lastBilledReadAt DateTime?
  metadata         Json?

  reads     UtilityMeterRead[]
  ratePlan  UtilityRatePlan? @relation(fields: [ratePlanId], references: [id], onDelete: SetNull)
  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  site        Site       @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([siteId, type])
}

model SmartLock {
  id           String   @id @default(cuid())
  campgroundId String
  siteId       String?
  name         String?
  vendor       String   // e.g. "kisi", "remotelock"
  externalId   String?  // ID in vendor system
  status       String   @default("locked") // locked, unlocked, offline
  batteryLevel Int?     // 0-100
  metadata     Json?    // Simulation config
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground   Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  site         Site?      @relation(fields: [siteId], references: [id])

  @@index([campgroundId])
  @@index([siteId])
}

// QR Codes for check-in, site identification, amenities, etc.
model QRCode {
  id            String    @id @default(cuid())
  campgroundId  String
  reservationId String?
  siteId        String?
  type          String    // checkin, checkout, site, amenity, store, event, wifi, emergency
  code          String    @unique // The unique code embedded in the QR
  expiresAt     DateTime? // Null for permanent codes (like site QRs)
  usedAt        DateTime? // For single-use codes
  scanCount     Int       @default(0)
  lastScannedAt DateTime?
  metadata      Json?     // Additional data (wifi credentials, event info, etc.)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  campground  Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  site        Site?        @relation(fields: [siteId], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([type])
  @@index([reservationId])
  @@index([siteId])
  @@index([expiresAt])
}

model UtilityMeterRead {
  id           String   @id @default(cuid())
  meterId      String
  readingValue Decimal
  readAt       DateTime
  source       String   // manual|import|api
  note         String?
  readBy       String?
  createdAt    DateTime @default(now())

  meter UtilityMeter @relation(fields: [meterId], references: [id], onDelete: Cascade)

  @@index([meterId, readAt])
}

model LateFeeRule {
  id              String   @id @default(cuid())
  campgroundId    String
  cadence         String   // weekly|monthly
  graceDays       Int      @default(3)
  feeType         String   // flat|percent
  feeCents        Int?
  feePercentBp    Int?
  applyPerInvoice Boolean  @default(true)
  maxOccurrences  Int?
  active          Boolean  @default(true)
  effectiveFrom   DateTime
  effectiveTo     DateTime?

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId, cadence, active])
}

model ArLedgerEntry {
  id            String   @id @default(cuid())
  ledgerEntryId String   @unique
  invoiceId     String?
  invoiceLineId String?
  type          String   // ar_open|ar_settlement|writeoff|reclass
  createdAt     DateTime @default(now())

  ledgerEntry LedgerEntry  @relation(fields: [ledgerEntryId], references: [id], onDelete: Cascade)
  invoice     Invoice?     @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  invoiceLine InvoiceLine? @relation(fields: [invoiceLineId], references: [id], onDelete: SetNull)

  @@index([invoiceId])
  @@index([invoiceLineId])
}

model LedgerEntry {
  id            String   @id @default(cuid())
  campgroundId  String
  reservationId String?
  periodId      String?
  glCode        String?
  account       String?
  description   String?
  amountCents   Int
  direction     String   @default("debit")
  occurredAt    DateTime @default(now())
  createdAt     DateTime @default(now())
  externalRef   String?
  dedupeKey     String?

  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  campground  Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  arLedgerEntry ArLedgerEntry?
  glPeriod    GlPeriod?    @relation(fields: [periodId], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([reservationId])
  @@index([glCode])
  @@index([periodId])
  @@index([dedupeKey])
}

enum GlPeriodStatus {
  open
  closed
  locked
}

model GlPeriod {
  id           String         @id @default(cuid())
  campgroundId String
  name         String?
  startDate    DateTime
  endDate      DateTime
  status       GlPeriodStatus @default(open)
  closedAt     DateTime?
  lockedAt     DateTime?
  closedBy     String?
  lockedBy     String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @default(now()) @updatedAt

  campground  Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  ledgerPosts LedgerEntry[]

  @@index([campgroundId, startDate, endDate])
  @@index([campgroundId, status])
}

enum PayoutStatus {
  pending
  in_transit
  paid
  failed
  canceled
}

model Payout {
  id                  String       @id @default(cuid())
  campgroundId        String
  stripePayoutId      String       @unique
  stripeAccountId     String
  amountCents         Int
  feeCents            Int?
  currency            String       @default("usd")
  status              PayoutStatus @default(pending)
  arrivalDate         DateTime?
  paidAt              DateTime?
  statementDescriptor String?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @default(now()) @updatedAt

  lines    PayoutLine[]
  disputes Dispute[]

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([stripeAccountId])
  @@index([status])
}

model PayoutLine {
  id                   String   @id @default(cuid())
  payoutId             String
  type                 String // charge, refund, fee, adjustment, dispute, payout
  amountCents          Int
  currency             String   @default("usd")
  description          String?
  reservationId        String?
  paymentIntentId      String?
  chargeId             String?
  balanceTransactionId String?
  createdAt            DateTime @default(now())

  payout      Payout       @relation(fields: [payoutId], references: [id], onDelete: Cascade)
  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)

  @@index([payoutId])
  @@index([reservationId])
  @@index([paymentIntentId])
  @@index([chargeId])
  @@index([balanceTransactionId])
}

enum DisputeStatus {
  warning_needs_response
  warning_under_review
  needs_response
  under_review
  charge_refunded
  won
  lost
}

model Dispute {
  id                    String        @id @default(cuid())
  campgroundId          String
  reservationId         String?
  payoutId              String?
  stripeDisputeId       String        @unique
  stripeChargeId        String?
  stripePaymentIntentId String?
  amountCents           Int
  currency              String        @default("usd")
  reason                String?
  status                DisputeStatus @default(needs_response)
  evidenceDueBy         DateTime?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @default(now()) @updatedAt
  notes                 String?

  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  payout      Payout?      @relation(fields: [payoutId], references: [id], onDelete: SetNull)
  campground  Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([reservationId])
  @@index([payoutId])
  @@index([stripeDisputeId])
  @@index([stripeChargeId])
  @@index([stripePaymentIntentId])
  @@index([status])
}

enum EventType {
  activity // Kayaking, hiking tours, etc.
  workshop // Crafts, cooking classes
  entertainment // Live music, movies
  holiday // Special holiday events (parent)
  recurring // Weekly potlucks, etc.
  ongoing // Multi-day continuous (craft station, open swim)
  themed // Themed weekends (Pirate Weekend, Halloween)
}

model Event {
  id           String @id @default(cuid())
  campgroundId String

  // Basic info
  title       String
  description String?   @db.Text
  eventType   EventType @default(activity)

  // Scheduling
  startDate      DateTime
  endDate        DateTime?
  startTime      String? // "14:00"
  endTime        String? // "16:00"
  isAllDay       Boolean   @default(false)
  isRecurring    Boolean   @default(false)
  recurrenceRule String? // iCal RRULE format

  // Location
  location String? // "Main pavilion", "Pool area", etc.

  // Capacity & pricing
  capacity       Int? // Max attendees
  currentSignups Int     @default(0)
  priceCents     Int     @default(0) // 0 = free
  isGuestOnly    Boolean @default(true) // Only campground guests can attend

  // Media
  imageUrl String?

  // Status
  isPublished        Boolean   @default(false)
  isCancelled        Boolean   @default(false)
  cancelledAt        DateTime?
  cancellationReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  // Recurrence enhancements
  recurrenceEndDate DateTime? // When recurring pattern stops
  recurrenceDays    Int[] // [0]=Sun, [5]=Fri, [6]=Sat

  // Parent event (for holiday/themed grouping)
  parentEventId String?
  parent        Event?  @relation("EventChildren", fields: [parentEventId], references: [id], onDelete: SetNull)
  children      Event[] @relation("EventChildren")

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([startDate])
  @@index([eventType])
  @@index([parentEventId])
}

// =============================================================================
// STORE & ADD-ONS
// =============================================================================

enum AddOnPricingType {
  flat // One-time fee (e.g., late checkout)
  per_night // Per night of stay (e.g., extra vehicle)
  per_person // Per person (e.g., extra guest fee)
}

enum OrderStatus {
  pending
  ready
  delivered
  completed
  cancelled
  refunded
}

enum PaymentMethod {
  card
  cash
  charge_to_site
}

enum OrderChannel {
  pos
  online
  kiosk
  portal
  internal
}

enum FulfillmentType {
  pickup
  curbside
  delivery
  table_service
}

enum ChannelInventoryMode {
  shared
  split
}

// Multi-location inventory management
enum ProductInventoryMode {
  shared        // Single stock pool across all locations
  per_location  // Separate stock tracked per location
}

enum StoreLocationType {
  physical      // Physical store location
  virtual       // Virtual location (e.g., online-only warehouse)
}

enum InventoryTransferStatus {
  pending       // Transfer requested
  in_transit    // Items picked up, moving to destination
  completed     // Transfer complete
  cancelled     // Transfer cancelled
}

enum FulfillmentAssignmentStatus {
  unassigned    // No location assigned yet
  assigned      // Assigned to a location
  preparing     // Location is preparing the order
  ready         // Ready for pickup/delivery
  completed     // Fulfilled
}

// ---------------------------------------------------------------------------
// Inventory Batch & Expiration Tracking enums
// ---------------------------------------------------------------------------

enum ExpirationTier {
  fresh         // Beyond warning threshold
  warning       // Within warning threshold
  critical      // Within critical threshold
  expired       // Past expiration date
}

enum MarkdownDiscountType {
  percentage    // Discount as percentage (1-100)
  flat          // Fixed amount off in cents
}

enum MarkdownScope {
  all           // Applies to all products
  category      // Applies to specific category
  product       // Applies to specific product
}

enum BatchDisposalReason {
  expired       // Past expiration date
  damaged       // Physical damage
  quality_issue // Quality degradation
  recall        // Product recall
  theft_loss    // Theft or unexplained loss
  donation      // Donated to charity
  sample        // Used as sample
  other         // Other reason
}

model ProductCategory {
  id           String   @id @default(cuid())
  campgroundId String
  name         String
  description  String?
  sortOrder    Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt

  // Expiration tracking defaults for this category
  defaultWarningDays    Int @default(7)   // Days before expiration for "warning" tier
  defaultCriticalDays   Int @default(2)   // Days before expiration for "critical" tier
  defaultSlowMovingDays Int @default(30)  // Days without sale to flag as slow-moving

  campground        Campground                  @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  products          Product[]
  expirationConfigs CategoryExpirationConfig[]
  markdownRules     MarkdownRule[]

  @@unique([campgroundId, name])
  @@index([campgroundId])
}

model Product {
  id                   String               @id @default(cuid())
  campgroundId         String
  categoryId           String?
  name                 String
  description          String?
  priceCents           Int
  imageUrl             String?
  sku                  String?
  stockQty             Int                  @default(0)
  onlineStockQty       Int? // DEPRECATED: Use LocationInventory instead
  posStockQty          Int? // DEPRECATED: Use LocationInventory instead
  channelInventoryMode ChannelInventoryMode @default(shared) // DEPRECATED
  inventoryMode        ProductInventoryMode @default(shared) // NEW: shared or per_location
  availableLocations   String[]             @default([]) // Location IDs (empty = all locations)
  lowStockAlert        Int? // Alert when stock falls below this
  trackInventory       Boolean              @default(true)
  afterHoursAllowed    Boolean              @default(false)
  isActive             Boolean              @default(true)
  sortOrder            Int                  @default(0)
  glCode               String? // For ledger integration
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @default(now()) @updatedAt

  // Batch tracking & expiration
  useBatchTracking Boolean   @default(false) // Enable FEFO batch tracking for this product
  lastSaleDate     DateTime?                 // Updated on each sale (for slow-moving detection)

  campground        Campground              @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  category          ProductCategory?        @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  orderItems        StoreOrderItem[]
  posCartItems      PosCartItem[]
  locationInventory LocationInventory[]
  priceOverrides    LocationPriceOverride[]
  transferItems     InventoryTransferItem[]
  movements         InventoryMovement[]

  // Batch tracking relations
  inventoryBatches  InventoryBatch[]
  expirationConfigs ProductExpirationConfig[]
  markdownRules     MarkdownRule[]

  // 3rd party POS integration
  externalMappings  ProductExternalMapping[]

  @@index([campgroundId])
  @@index([categoryId])
}

model AddOnService {
  id           String           @id @default(cuid())
  campgroundId String
  name         String // "Late Checkout", "Early Check-in", "Extra Vehicle"
  description  String?
  priceCents   Int
  pricingType  AddOnPricingType @default(flat)
  isActive     Boolean          @default(true)
  sortOrder    Int              @default(0)
  glCode       String? // For ledger integration
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @default(now()) @updatedAt

  campground Campground       @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  orderItems StoreOrderItem[]

  @@index([campgroundId])
}

model StoreOrder {
  id                    String                      @id @default(cuid())
  campgroundId          String
  reservationId         String? // If charged to site
  guestId               String?
  siteNumber            String? // For delivery reference
  channel               OrderChannel                @default(pos)
  fulfillmentType       String? // pickup, delivery, dine_in
  deliveryInstructions  String?
  promisedAt            DateTime?
  prepTimeMinutes       Int?
  status                OrderStatus                 @default(pending)
  paymentMethod         PaymentMethod               @default(card)
  subtotalCents         Int                         @default(0)
  taxCents              Int                         @default(0)
  totalCents            Int                         @default(0)
  notes                 String?
  createdBy             String? // Staff user ID
  completedAt           DateTime?
  completedById         String?
  // Multi-location fulfillment
  fulfillmentLocationId String?
  fulfillmentStatus     FulfillmentAssignmentStatus @default(unassigned)
  assignedAt            DateTime?
  assignedById          String?
  createdAt             DateTime                    @default(now())
  updatedAt             DateTime                    @default(now()) @updatedAt

  campground          Campground       @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  reservation         Reservation?     @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  guest               Guest?           @relation(fields: [guestId], references: [id], onDelete: SetNull)
  completedBy         User?            @relation("OrderCompletedBy", fields: [completedById], references: [id], onDelete: SetNull)
  fulfillmentLocation StoreLocation?   @relation("FulfillmentLocation", fields: [fulfillmentLocationId], references: [id], onDelete: SetNull)
  assignedBy          User?            @relation("OrderAssignedBy", fields: [assignedById], references: [id], onDelete: SetNull)
  items               StoreOrderItem[]

  @@index([campgroundId])
  @@index([reservationId])
  @@index([guestId])
  @@index([status])
  @@index([fulfillmentLocationId])
  @@index([fulfillmentStatus])
}

model StoreOrderItem {
  id         String   @id @default(cuid())
  orderId    String
  productId  String?
  addOnId    String?
  name       String // Snapshot of product/addon name at time of order
  qty        Int      @default(1)
  unitCents  Int
  totalCents Int
  createdAt  DateTime @default(now())

  order   StoreOrder    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product?      @relation(fields: [productId], references: [id], onDelete: SetNull)
  addOn   AddOnService? @relation(fields: [addOnId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([productId])
  @@index([addOnId])
}

model BlackoutDate {
  id           String   @id @default(cuid())
  campgroundId String
  siteId       String? // If null, applies to entire campground
  startDate    DateTime
  endDate      DateTime
  reason       String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  site       Site?      @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([siteId])
  @@index([startDate])
  @@index([endDate])
}

enum PromotionType {
  percentage
  flat
}

model Promotion {
  id           String        @id @default(cuid())
  campgroundId String
  code         String // e.g., "SUMMER20"
  type         PromotionType @default(percentage)
  value        Int // Percentage (0-100) or flat cents
  validFrom    DateTime?
  validTo      DateTime?
  usageLimit   Int? // Max total uses
  usageCount   Int           @default(0)
  isActive     Boolean       @default(true)
  description  String? // Internal note
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @default(now()) @updatedAt

  campground      Campground       @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  analyticsEvents AnalyticsEvent[]

  @@unique([campgroundId, code])
  @@index([campgroundId])
  @@index([code])
}

model ReferralProgram {
  id             String                @id @default(cuid())
  campgroundId   String
  code           String
  linkSlug       String?
  source         String?
  channel        String?
  incentiveType  ReferralIncentiveType @default(percent_discount)
  incentiveValue Int                   @default(0) // percent or cents depending on type
  isActive       Boolean               @default(true)
  notes          String?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @default(now()) @updatedAt

  campground   Campground    @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  reservations Reservation[]

  @@unique([campgroundId, code])
  @@unique([campgroundId, linkSlug])
  @@index([campgroundId, isActive])
}

model Message {
  id            String     @id @default(cuid())
  campgroundId  String
  reservationId String
  guestId       String
  senderType    SenderType
  content       String     @db.Text
  readAt        DateTime?
  createdAt     DateTime   @default(now())

  campground  Campground  @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  reservation Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  guest       Guest       @relation(fields: [guestId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([reservationId])
  @@index([guestId])
}

enum WaitlistStatus {
  active
  fulfilled
  expired
  cancelled
}

enum WaitlistType {
  regular
  seasonal
}

model WaitlistEntry {
  id             String         @id @default(cuid())
  campgroundId   String
  guestId        String? // Optional - can be null for staff-added entries
  siteId         String? // Specific site preference
  siteTypeId     String? // Or just a type preference (e.g. any RV site)
  arrivalDate    DateTime? // Optional for seasonal (just want "next season")
  departureDate  DateTime? // Optional for seasonal
  status         WaitlistStatus @default(active)
  type           WaitlistType   @default(regular)
  // Contact fields for staff-added entries (when no guest profile exists)
  contactName    String?
  contactEmail   String?
  contactPhone   String?
  notes          String? // Staff notes
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @default(now()) @updatedAt
  lastNotifiedAt DateTime?
  notifiedCount  Int            @default(0)

  // Phase 4: Priority and auto-offer fields
  priority               Int       @default(50) // 0-100, higher = more priority
  autoOffer              Boolean   @default(false) // Auto-reserve when match found
  maxPrice               Int? // Max price willing to pay (cents)
  flexibleDates          Boolean   @default(false) // Accept +/- days from requested
  flexibleDays           Int       @default(0) // How many days flexible
  convertedReservationId String? // If converted to a reservation
  convertedAt            DateTime? // When converted
  throttleBucket         String?
  cooldownUntil          DateTime?
  lastOfferSentAt        DateTime?
  lastOfferStatus        String?
  offerCount             Int       @default(0)

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  guest      Guest?     @relation(fields: [guestId], references: [id], onDelete: Cascade)
  site       Site?      @relation(fields: [siteId], references: [id], onDelete: SetNull)
  siteClass  SiteClass? @relation(fields: [siteTypeId], references: [id], onDelete: SetNull)
  offers     WaitlistOffer[]
  holds      WaitlistInventoryHold[]

  @@index([campgroundId])
  @@index([guestId])
  @@index([status])
  @@index([type])
  @@index([arrivalDate])
  @@index([priority])
}

enum WaitlistOfferStatus {
  pending
  sent
  accepted
  declined
  expired
  failed
}

model WaitlistOffer {
  id              String             @id @default(cuid())
  entryId         String
  inventoryRef    String
  offerExpiresAt  DateTime
  sentAt          DateTime?
  acceptedAt      DateTime?
  declinedAt      DateTime?
  autoExpiredAt   DateTime?
  status          WaitlistOfferStatus @default(pending)
  commsTemplateId String?
  idempotencyKey  String
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  entry WaitlistEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)

  @@index([entryId, status])
  @@index([idempotencyKey])
  @@index([inventoryRef])
}

model WaitlistInventoryHold {
  id            String   @id @default(cuid())
  inventoryRef  String
  entryId       String?
  status        String   @default("held") // held, released, captured, expired
  holdExpiresAt DateTime
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  entry WaitlistEntry? @relation(fields: [entryId], references: [id], onDelete: SetNull)

  @@index([inventoryRef, status])
  @@index([entryId])
}

// ---------------------------------------------------------------------------
// Phase 4: Notification Triggers
// ---------------------------------------------------------------------------

model NotificationTrigger {
  id           String   @id @default(cuid())
  campgroundId String
  event        String // reservation_created, payment_received, checkin_reminder, etc.
  channel      String // email, sms, both
  enabled      Boolean  @default(true)
  templateId   String? // Link to a CampaignTemplate
  delayMinutes Int      @default(0) // 0 = immediate, >0 = scheduled
  conditions   Json? // Conditional rules (e.g. { "source": "online" })
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground             Campground              @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  template               CampaignTemplate?       @relation(fields: [templateId], references: [id], onDelete: SetNull)
  scheduledNotifications ScheduledNotification[]

  @@index([campgroundId])
  @@index([event])
  @@index([enabled])
}

model ScheduledNotification {
  id           String    @id @default(cuid())
  campgroundId String
  triggerId    String
  event        String
  channel      String
  payload      Json // TriggerPayload data
  sendAt       DateTime
  status       String    @default("pending") // pending, sent, failed, cancelled
  sentAt       DateTime?
  error        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  campground Campground          @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  trigger    NotificationTrigger @relation(fields: [triggerId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([status, sendAt])
}

model InternalConversation {
  id           String   @id @default(cuid())
  name         String? // Required for Channels, Null for DMs
  type         String // "channel" or "dm"
  campgroundId String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground   Campground                        @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  messages     InternalMessage[]
  participants InternalConversationParticipant[]

  @@index([campgroundId])
}

model InternalConversationParticipant {
  id             String   @id @default(cuid())
  conversationId String
  userId         String
  joinedAt       DateTime @default(now())

  conversation InternalConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
}

model InternalMessage {
  id             String   @id @default(cuid())
  content        String
  senderId       String
  conversationId String
  createdAt      DateTime @default(now())

  sender       User                 @relation(fields: [senderId], references: [id], onDelete: Cascade)
  conversation InternalConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([conversationId])
  @@index([createdAt])
}

model AuditLog {
  id           String    @id @default(cuid())
  campgroundId String
  actorId      String?
  action       String
  entity       String
  entityId     String
  before       Json?
  after        Json?
  ip           String?
  userAgent    String?
  chainHash    String    @default("")
  prevHash     String?
  version      Int       @default(1)
  retentionAt  DateTime?
  createdAt    DateTime  @default(now())

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  actor      User?      @relation(fields: [actorId], references: [id], onDelete: SetNull)

  @@index([campgroundId, createdAt])
  @@index([campgroundId, chainHash])
}

model AuditExport {
  id            String   @id @default(cuid())
  campgroundId  String
  requestedById String
  format        String // csv | json
  filters       Json?
  recordCount   Int
  createdAt     DateTime @default(now())

  campground  Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  requestedBy User       @relation(fields: [requestedById], references: [id], onDelete: Cascade)

  @@index([campgroundId, createdAt])
  @@index([requestedById, createdAt])
}

model PrivacySetting {
  id                  String   @id @default(cuid())
  campgroundId        String   @unique
  redactPII           Boolean  @default(true)
  consentRequired     Boolean  @default(true)
  backupRetentionDays Int      @default(30)
  keyRotationDays     Int      @default(90)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
}

model ConsentLog {
  id           String        @id @default(cuid())
  campgroundId String
  subject      String
  consentType  String
  grantedBy    String
  method       ConsentMethod @default(digital)
  purpose      String?
  expiresAt    DateTime?
  revokedAt    DateTime?
  metadata     Json?
  grantedAt    DateTime      @default(now())

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId, grantedAt])
}

model PiiFieldTag {
  id             String            @id @default(cuid())
  resource       String
  field          String
  classification PiiClassification
  redactionMode  RedactionMode     @default(mask)
  createdById    String?
  createdAt      DateTime          @default(now())

  createdBy User? @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@unique([resource, field])
  @@index([createdById])
  @@index([classification])
}

model ApprovalPolicy {
  id            String     @id @default(cuid())
  campgroundId  String?
  resource      String
  action        String
  approverRoles UserRole[]
  rationale     String?
  createdById   String?
  createdAt     DateTime   @default(now())

  campground Campground?       @relation(fields: [campgroundId], references: [id], onDelete: SetNull)
  createdBy  User?             @relation(fields: [createdById], references: [id], onDelete: SetNull)
  requests   ApprovalRequest[] @relation("ApprovalPolicy_campground_action")

  @@unique([campgroundId, action])
  @@index([campgroundId, action])
}

model ApprovalRequest {
  id            String         @id @default(cuid())
  campgroundId  String?
  action        String
  requestedBy   String
  resource      String?
  targetId      String?
  payload       Json?
  justification String?
  status        ApprovalStatus @default(pending)
  decidedBy     String?
  decidedAt     DateTime?
  createdAt     DateTime       @default(now())

  campground Campground?     @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  policy     ApprovalPolicy? @relation("ApprovalPolicy_campground_action", fields: [campgroundId, action], references: [campgroundId, action], onDelete: SetNull, onUpdate: Cascade, map: "ApprovalPolicy_campground_action")

  @@index([campgroundId, status])
}

model PermissionRule {
  id           String           @id @default(cuid())
  campgroundId String?
  role         UserRole
  resource     String
  action       String
  fields       String[]
  effect       PermissionEffect @default(allow)
  createdById  String?
  createdAt    DateTime         @default(now())

  campground Campground? @relation(fields: [campgroundId], references: [id], onDelete: SetNull)
  createdBy  User?       @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@unique([campgroundId, role, resource, action])
  @@index([resource, action])
}

model InviteToken {
  id           String    @id @default(cuid())
  token        String    @unique
  userId       String
  campgroundId String
  expiresAt    DateTime
  redeemedAt   DateTime?
  createdAt    DateTime  @default(now())

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([userId, campgroundId])
  @@index([campgroundId, createdAt])
}

model OnboardingInvite {
  id              String   @id @default(cuid())
  token           String   @unique
  email           String
  organizationId  String?
  campgroundId    String?
  invitedById     String?
  expiresAt       DateTime
  redeemedAt      DateTime?
  lastSentAt      DateTime?
  createdAt       DateTime @default(now())

  session      OnboardingSession? @relation("InviteSessions")
  organization Organization?      @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  campground   Campground?        @relation(fields: [campgroundId], references: [id], onDelete: SetNull)
  invitedBy    User?              @relation(fields: [invitedById], references: [id], onDelete: SetNull)

  @@index([token])
  @@index([organizationId, createdAt])
  @@index([campgroundId, createdAt])
}

model OnboardingSession {
  id              String           @id @default(cuid())
  inviteId        String           @unique
  organizationId  String?
  campgroundId    String?
  status          OnboardingStatus @default(pending)
  currentStep     OnboardingStep   @default(account_profile)
  completedSteps  OnboardingStep[] @default([])
  data            Json?
  progress        Json?
  expiresAt       DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  invite       OnboardingInvite @relation("InviteSessions", fields: [inviteId], references: [id], onDelete: Cascade)
  organization Organization?    @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  campground   Campground?      @relation(fields: [campgroundId], references: [id], onDelete: SetNull)

  @@index([inviteId])
  @@index([organizationId])
  @@index([campgroundId])
}

model Activity {
  id           String   @id @default(cuid())
  campgroundId String
  name         String
  description  String?
  images       String[] @default([])
  price        Int // in cents
  duration     Int // in minutes
  capacity     Int // max participants per session
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground Campground        @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  sessions   ActivitySession[]
}

model ActivitySession {
  id          String   @id @default(cuid())
  activityId  String
  startTime   DateTime
  endTime     DateTime
  capacity    Int // Override activity capacity if needed
  bookedCount Int      @default(0)
  status      String   @default("scheduled") // scheduled, cancelled, completed

  activity Activity          @relation(fields: [activityId], references: [id], onDelete: Cascade)
  bookings ActivityBooking[]
}

model ActivityBooking {
  id            String   @id @default(cuid())
  sessionId     String
  guestId       String
  reservationId String? // Optional link to a stay
  quantity      Int
  totalAmount   Int
  status        String   @default("confirmed") // confirmed, cancelled
  createdAt     DateTime @default(now())

  session     ActivitySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  guest       Guest           @relation(fields: [guestId], references: [id], onDelete: Cascade)
  reservation Reservation?    @relation(fields: [reservationId], references: [id])
}

model MembershipType {
  id              String  @id @default(cuid())
  campgroundId    String
  name            String
  description     String?
  price           Int // in cents
  durationDays    Int // 365 for annual
  discountPercent Int // e.g., 10 for 10% off
  isActive        Boolean @default(true)

  campground  Campground        @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  memberships GuestMembership[]
}

model GuestMembership {
  id               String   @id @default(cuid())
  membershipTypeId String
  guestId          String
  startDate        DateTime
  endDate          DateTime
  status           String   @default("active") // active, expired, cancelled
  purchaseAmount   Int

  membershipType MembershipType @relation(fields: [membershipTypeId], references: [id])
  guest          Guest          @relation(fields: [guestId], references: [id], onDelete: Cascade)
}

model OperationalTask {
  id           String    @id @default(cuid())
  campgroundId String
  title        String
  description  String?
  type         String // housekeeping, maintenance, inspection
  status       String    @default("pending") // pending, in_progress, completed, verified
  priority     String    @default("medium") // low, medium, high, urgent
  assignedTo   String? // User ID
  dueDate      DateTime?
  completedAt  DateTime?

  // Relations
  siteId     String?
  site       Site?      @relation(fields: [siteId], references: [id])
  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Communication {
  id                String    @id @default(cuid())
  campgroundId      String
  organizationId    String?
  guestId           String?
  reservationId     String?
  type              String // email | sms | note | call
  direction         String // inbound | outbound
  subject           String?
  body              String?
  preview           String?
  status            String // sent | delivered | failed | queued | received
  provider          String?
  providerMessageId String?
  toAddress         String?
  fromAddress       String?
  sentAt            DateTime?
  receivedAt        DateTime?
  metadata          Json?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @default(now()) @updatedAt

  guest       Guest?       @relation(fields: [guestId], references: [id], onDelete: SetNull)
  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  campground  Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId, createdAt])
  @@index([guestId, createdAt])
  @@index([reservationId, createdAt])
  @@index([type, direction])
}

model CommunicationTemplate {
  id           String    @id @default(cuid())
  campgroundId String
  name         String
  subject      String?
  bodyHtml     String?
  status       String    @default("draft") // draft | pending | approved | rejected
  version      Int       @default(1)
  approvedById String?
  approvedAt   DateTime?
  auditLog     Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  campground Campground              @relation("CampgroundCommunicationTemplates", fields: [campgroundId], references: [id], onDelete: Cascade)
  approvedBy User?                   @relation("CommunicationTemplateApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)
  playbooks  CommunicationPlaybook[] @relation("PlaybookTemplate")

  @@index([campgroundId])
  @@index([status])
}

model CommunicationPlaybook {
  id                String   @id @default(cuid())
  campgroundId      String
  type              String // arrival | unpaid | upsell | abandoned_cart
  enabled           Boolean  @default(false)
  templateId        String?
  channel           String? // email | sms
  offsetMinutes     Int? // relative to event (e.g., -120 for arrival-2h)
  quietHoursStart   String? // HH:mm
  quietHoursEnd     String? // HH:mm
  throttlePerMinute Int?
  routingAssigneeId String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  campground Campground                 @relation("CampgroundCommunicationPlaybooks", fields: [campgroundId], references: [id], onDelete: Cascade)
  template   CommunicationTemplate?     @relation("PlaybookTemplate", fields: [templateId], references: [id], onDelete: SetNull)
  jobs       CommunicationPlaybookJob[] @relation("PlaybookJobs")

  @@index([campgroundId, type])
  @@index([templateId])
}

model CommunicationPlaybookJob {
  id            String   @id @default(cuid())
  playbookId    String
  campgroundId  String
  reservationId String?
  guestId       String?
  status        String   @default("pending") // pending | processing | sent | failed | skipped
  scheduledAt   DateTime
  attempts      Int      @default(0)
  lastError     String?
  metadata      Json?    @default("{}")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  playbook    CommunicationPlaybook @relation("PlaybookJobs", fields: [playbookId], references: [id], onDelete: Cascade)
  campground  Campground            @relation("CampgroundCommunicationPlaybookJobs", fields: [campgroundId], references: [id], onDelete: Cascade)
  reservation Reservation?          @relation("ReservationCommunicationPlaybookJobs", fields: [reservationId], references: [id], onDelete: SetNull)
  guest       Guest?                @relation("GuestCommunicationPlaybookJobs", fields: [guestId], references: [id], onDelete: SetNull)

  @@index([playbookId, status, scheduledAt])
  @@index([campgroundId])
  @@index([reservationId])
}

model OtaChannel {
  id                         String    @id @default(cuid())
  campgroundId               String
  name                       String
  provider                   String
  status                     String    @default("disabled") // disabled | pull | two_way
  rateMultiplier             Float     @default(1.0)
  defaultStatus              String    @default("confirmed") // confirmed | pending
  sendEmailNotifications     Boolean   @default(false)
  ignoreSiteRestrictions     Boolean   @default(false)
  ignoreCategoryRestrictions Boolean   @default(false)
  feeMode                    String    @default("absorb") // absorb | pass_through
  webhookSecret              String?
  lastSyncAt                 DateTime?
  createdAt                  DateTime  @default(now())
  updatedAt                  DateTime  @updatedAt

  campground Campground             @relation("CampgroundOtaChannels", fields: [campgroundId], references: [id], onDelete: Cascade)
  mappings   OtaListingMapping[]
  syncLogs   OtaSyncLog[]
  imports    OtaReservationImport[]

  @@index([campgroundId])
  @@index([provider, campgroundId])
}

model OtaListingMapping {
  id          String    @id @default(cuid())
  channelId   String
  siteId      String?
  siteClassId String?
  externalId  String
  status      String    @default("mapped") // mapped | disabled
  lastSyncAt  DateTime?
  lastError   String?
  icalToken   String?   @unique
  icalUrl     String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  channel   OtaChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  site      Site?      @relation("SiteOtaMappings", fields: [siteId], references: [id], onDelete: SetNull)
  siteClass SiteClass? @relation("SiteClassOtaMappings", fields: [siteClassId], references: [id], onDelete: SetNull)

  @@unique([channelId, externalId], name: "channelId_externalId")
  @@index([channelId, siteId])
  @@index([channelId, siteClassId])
}

model OtaSyncLog {
  id        String   @id @default(cuid())
  channelId String
  direction String // push | pull
  eventType String // availability | pricing | reservation
  status    String // success | failed
  message   String?
  payload   Json?
  createdAt DateTime @default(now())

  channel OtaChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([channelId, createdAt])
  @@index([channelId, direction, eventType])
}

model OtaReservationImport {
  id                    String   @id @default(cuid())
  channelId             String
  externalReservationId String
  status                String // pending | imported | failed
  message               String?
  reservationId         String?
  createdAt             DateTime @default(now())

  channel     OtaChannel   @relation(fields: [channelId], references: [id], onDelete: Cascade)
  reservation Reservation? @relation("ReservationOtaImports", fields: [reservationId], references: [id], onDelete: SetNull)

  @@unique([channelId, externalReservationId])
  @@index([reservationId])
}

// =============================================================================
// NPS
// =============================================================================

model NpsSurvey {
  id              String          @id @default(cuid())
  campgroundId    String
  name            String
  question        String?
  status          NpsSurveyStatus @default(draft)
  channels        String[]        @default(["inapp", "email"])
  locales         String[]        @default(["en"])
  cooldownDays    Int? // minimum days between invites per guest
  samplingPercent Int? // 0-100
  metadata        Json?
  activeFrom      DateTime?
  activeTo        DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @default(now()) @updatedAt

  campground Campground    @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  rules      NpsRule[]
  invites    NpsInvite[]
  responses  NpsResponse[]

  @@index([campgroundId, status])
}

model NpsRule {
  id           String   @id @default(cuid())
  surveyId     String
  trigger      String // post_checkout | post_booking | manual
  percentage   Int? // sampling percent override
  cooldownDays Int? // override per rule
  segmentJson  Json?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt

  survey NpsSurvey @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  @@index([surveyId, isActive])
}

model NpsInvite {
  id             String          @id @default(cuid())
  surveyId       String
  campgroundId   String
  organizationId String?
  guestId        String?
  reservationId  String?
  channel        String // email | sms | inapp
  status         NpsInviteStatus @default(queued)
  token          String          @unique
  expiresAt      DateTime?
  sentAt         DateTime?
  openedAt       DateTime?
  respondedAt    DateTime?
  metadata       Json?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @default(now()) @updatedAt

  survey      NpsSurvey    @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  campground  Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  guest       Guest?       @relation(fields: [guestId], references: [id], onDelete: SetNull)
  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  response    NpsResponse?
  events      NpsEvent[]

  @@index([campgroundId, status])
  @@index([guestId])
  @@index([reservationId])
}

model NpsResponse {
  id            String   @id @default(cuid())
  surveyId      String
  inviteId      String?
  campgroundId  String
  guestId       String?
  reservationId String?
  score         Int
  comment       String?
  tags          String[] @default([])
  sentiment     String?
  createdAt     DateTime @default(now())

  survey      NpsSurvey    @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  invite      NpsInvite?   @relation(fields: [inviteId], references: [id], onDelete: SetNull)
  campground  Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  guest       Guest?       @relation(fields: [guestId], references: [id], onDelete: SetNull)
  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)

  @@unique([inviteId])
  @@index([campgroundId, createdAt])
  @@index([surveyId])
  @@index([guestId])
  @@index([reservationId])
}

model NpsEvent {
  id        String   @id @default(cuid())
  inviteId  String
  type      String // open | click | unsub
  payload   Json?
  createdAt DateTime @default(now())

  invite NpsInvite @relation(fields: [inviteId], references: [id], onDelete: Cascade)

  @@index([inviteId, type])
}

// =============================================================================
// Reviews
// =============================================================================

model ReviewRequest {
  id             String    @id @default(cuid())
  campgroundId   String
  organizationId String?
  guestId        String?
  reservationId  String?
  channel        String // email | sms | inapp | kiosk
  status         String    @default("queued")
  token          String    @unique
  expiresAt      DateTime?
  sentAt         DateTime?
  respondedAt    DateTime?
  metadata       Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @default(now()) @updatedAt

  campground  Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  guest       Guest?       @relation(fields: [guestId], references: [id], onDelete: SetNull)
  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  review      Review?

  @@index([campgroundId, status])
  @@index([guestId])
  @@index([reservationId])
}

model Review {
  id             String         @id @default(cuid())
  campgroundId   String
  organizationId String?
  guestId        String?
  reservationId  String?
  requestId      String?
  rating         Int
  title          String?
  body           String?        @db.Text
  photos         String[]       @default([])
  tags           String[]       @default([])
  sentiment      String?
  source         ReviewSource   @default(onsite)
  status         ReviewStatus   @default(pending)
  exposure       ReviewExposure @default(private)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @default(now()) @updatedAt

  campground  Campground        @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  guest       Guest?            @relation(fields: [guestId], references: [id], onDelete: SetNull)
  reservation Reservation?      @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  request     ReviewRequest?    @relation(fields: [requestId], references: [id], onDelete: SetNull)
  moderation  ReviewModeration?
  votes       ReviewVote[]
  replies     ReviewReply[]

  @@unique([requestId])
  @@index([campgroundId, status, createdAt])
  @@index([guestId])
  @@index([reservationId])
  @@index([source])
}

model ReviewModeration {
  id        String                 @id @default(cuid())
  reviewId  String                 @unique
  status    ReviewModerationStatus @default(pending)
  reasons   String[]               @default([])
  decidedBy String?
  decidedAt DateTime?
  notes     String?

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
}

model ReviewVote {
  id           String          @id @default(cuid())
  reviewId     String
  guestId      String?
  ipHash       String?
  value        ReviewVoteValue
  createdAt    DateTime        @default(now())
  campgroundId String

  review     Review     @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  guest      Guest?     @relation(fields: [guestId], references: [id], onDelete: SetNull)
  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@unique([reviewId, guestId])
  @@index([reviewId])
  @@index([ipHash])
  @@index([campgroundId])
}

model ReviewReply {
  id         String   @id @default(cuid())
  reviewId   String
  authorType String // staff | guest
  authorId   String?
  body       String   @db.Text
  createdAt  DateTime @default(now())

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([reviewId])
}

// =============================================================================
// GAMIFICATION
// =============================================================================

model GamificationSetting {
  id           String     @id @default(cuid())
  campgroundId String     @unique
  enabled      Boolean    @default(false)
  enabledRoles UserRole[] @default([])
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
}

model LevelDefinition {
  id        String   @id @default(cuid())
  level     Int      @unique
  name      String
  minXp     Int
  perks     Json?
  createdAt DateTime @default(now())
}

model XpRule {
  id           String                    @id @default(cuid())
  campgroundId String
  category     GamificationEventCategory
  minXp        Int                       @default(0)
  maxXp        Int                       @default(0)
  defaultXp    Int                       @default(0)
  isActive     Boolean                   @default(true)
  createdById  String?
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @default(now()) @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  createdBy  User?      @relation("XpRuleCreator", fields: [createdById], references: [id], onDelete: SetNull)

  @@unique([campgroundId, category])
  @@index([campgroundId])
  @@index([createdById])
}

model XpBalance {
  id           String    @id @default(cuid())
  campgroundId String
  userId       String
  totalXp      Int       @default(0)
  currentLevel Int       @default(1)
  lastEventAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @default(now()) @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, userId])
  @@index([campgroundId])
  @@index([userId])
}

model XpEvent {
  id           String                    @id @default(cuid())
  campgroundId String
  userId       String
  membershipId String?
  category     GamificationEventCategory
  xp           Int
  reason       String?
  sourceType   String?
  sourceId     String?
  eventKey     String?                   @unique
  metadata     Json?
  occurredAt   DateTime                  @default(now())
  createdAt    DateTime                  @default(now())

  campground Campground            @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  user       User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  membership CampgroundMembership? @relation(fields: [membershipId], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([userId])
  @@index([campgroundId, userId])
  @@index([membershipId])
  @@index([category])
}

// =============================================================================
// Integrations & Ecosystem
// =============================================================================

model IntegrationConnection {
  id             String    @id @default(cuid())
  campgroundId   String?
  organizationId String?
  type           String // accounting | access_control | crm | export
  provider       String // qbo | xero | hubspot | intercom | zendesk | sftp | api
  status         String    @default("disconnected") // disconnected | connected | error | pending
  authType       String? // oauth | api_key | basic | sftp
  credentials    Json?
  settings       Json?
  webhookSecret  String?
  lastSyncAt     DateTime?
  lastSyncStatus String?
  lastError      String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  campground   Campground?               @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  organization Organization?             @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  logs         IntegrationSyncLog[]
  webhooks     IntegrationWebhookEvent[]
  exportJobs   IntegrationExportJob[]

  @@unique([campgroundId, type, provider])
  @@index([campgroundId, type, provider])
}

model IntegrationSyncLog {
  id           String   @id @default(cuid())
  connectionId String
  direction    String // pull | push | webhook | export
  scope        String // accounting | access_control | crm | export
  status       String // success | failed | queued
  message      String?
  payload      Json?
  occurredAt   DateTime @default(now())
  createdAt    DateTime @default(now())

  connection IntegrationConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@index([connectionId, occurredAt])
  @@index([status])
}

model IntegrationWebhookEvent {
  id             String   @id @default(cuid())
  connectionId   String?
  provider       String
  eventType      String?
  status         String   @default("received") // received | ignored | failed
  signatureValid Boolean?
  message        String?
  payload        Json?
  receivedAt     DateTime @default(now())

  connection IntegrationConnection? @relation(fields: [connectionId], references: [id], onDelete: SetNull)

  @@index([provider, receivedAt])
  @@index([connectionId, receivedAt])
}

model IntegrationExportJob {
  id            String    @id @default(cuid())
  connectionId  String?
  campgroundId  String?
  type          String // api | sftp
  resource      String? // ledger | reservations | guests | activities
  status        String    @default("queued") // queued | processing | success | failed
  location      String?
  requestedById String?
  filters       Json?
  startedAt     DateTime?
  completedAt   DateTime?
  lastError     String?
  createdAt     DateTime  @default(now())

  connection  IntegrationConnection? @relation(fields: [connectionId], references: [id], onDelete: SetNull)
  campground  Campground?            @relation(fields: [campgroundId], references: [id], onDelete: SetNull)
  requestedBy User?                  @relation(fields: [requestedById], references: [id], onDelete: SetNull)

  @@index([campgroundId, status])
  @@index([connectionId, status])
  @@index([requestedById])
}

// =============================================================================
// Developer Ecosystem: Public API + Webhooks
// =============================================================================

model ApiClient {
  id               String   @id @default(cuid())
  campgroundId     String
  name             String
  clientId         String   @unique
  clientSecretHash String
  scopes           String[]
  isActive         Boolean  @default(true)
  rateLimit        Int      @default(1000) // requests per hour
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  campground       Campground        @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  tokens           ApiToken[]
  webhookEndpoints WebhookEndpoint[]
  apiUsage         ApiUsage[]
  externalPosSales ExternalPosSale[]

  @@index([campgroundId])
}

model ApiToken {
  id               String    @id @default(cuid())
  apiClientId      String
  accessTokenHash  String    @unique
  refreshTokenHash String?
  scopes           String[]
  expiresAt        DateTime
  revokedAt        DateTime?
  createdAt        DateTime  @default(now())

  apiClient ApiClient @relation(fields: [apiClientId], references: [id], onDelete: Cascade)

  @@index([apiClientId])
  @@index([expiresAt])
}

model WebhookEndpoint {
  id           String    @id @default(cuid())
  campgroundId String
  apiClientId  String?
  url          String
  secret       String
  eventTypes   String[] // e.g., reservation.created, payment.created, event.updated
  description  String?
  isActive     Boolean   @default(true)
  disabledAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  campground Campground        @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  apiClient  ApiClient?        @relation(fields: [apiClientId], references: [id], onDelete: SetNull)
  deliveries WebhookDelivery[]

  @@index([campgroundId, isActive])
  @@index([apiClientId])
}

model WebhookDelivery {
  id                String    @id @default(cuid())
  webhookEndpointId String
  eventType         String
  status            String // pending | delivered | failed | retrying
  payload           Json
  responseStatus    Int?
  responseBody      String?
  attempt           Int       @default(1)
  signature         String?
  createdAt         DateTime  @default(now())
  deliveredAt       DateTime?
  errorMessage      String?
  replayOfId        String?
  nextRetryAt       DateTime? // For exponential backoff retry scheduling

  webhookEndpoint WebhookEndpoint @relation(fields: [webhookEndpointId], references: [id], onDelete: Cascade)

  @@index([webhookEndpointId, createdAt])
  @@index([eventType])
  @@index([status])
  @@index([status, nextRetryAt]) // For retry processing
}

// API Usage Tracking - for rate limiting and analytics
model ApiUsage {
  id           String   @id @default(cuid())
  apiClientId  String
  endpoint     String   // e.g., "GET /api/v1/reservations"
  method       String   // GET, POST, PUT, DELETE
  statusCode   Int
  responseTime Int      // milliseconds
  requestSize  Int?     // bytes
  responseSize Int?     // bytes
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())

  apiClient ApiClient @relation(fields: [apiClientId], references: [id], onDelete: Cascade)

  @@index([apiClientId, createdAt])
  @@index([createdAt])
  @@index([endpoint])
}

// =============================================================================
// Phase 1: Dynamic pricing, deposits, upsells, idempotency, audit
// =============================================================================

enum PricingRuleType {
  season
  weekend
  holiday
  event
  demand
}

enum PricingStackMode {
  additive
  max
  override
}

enum AdjustmentType {
  percent
  flat
}

enum DepositStrategy {
  first_night
  percent
  fixed
}

enum DepositApplyTo {
  lodging_only
  lodging_plus_fees
}

enum DepositDueTiming {
  at_booking
  before_arrival
}

enum BackoffStrategy {
  fixed
  linear
  exponential
}

enum UpsellPriceType {
  flat
  per_night
  per_guest
  per_site
}

enum UpsellChargeType {
  pay_now
  add_to_reservation
}

enum UpsellStatus {
  pending_charge
  charged
  canceled
}

enum IdempotencyStatus {
  pending
  inflight
  succeeded
  failed
}

model PricingRuleV2 {
  id              String           @id @default(cuid())
  campgroundId    String
  siteClassId     String?
  name            String
  type            PricingRuleType
  priority        Int
  stackMode       PricingStackMode
  adjustmentType  AdjustmentType
  adjustmentValue Decimal          @db.Decimal(8, 4)
  startDate       DateTime?
  endDate         DateTime?
  dowMask         Int[]
  calendarRefId   String?
  demandBandId    String?
  minRateCap      Int?
  maxRateCap      Int?
  active          Boolean          @default(true)
  createdBy       String?
  updatedBy       String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  siteClass  SiteClass? @relation(fields: [siteClassId], references: [id], onDelete: SetNull)
}

model DemandBand {
  id              String         @id @default(cuid())
  campgroundId    String
  siteClassId     String?
  thresholdPct    Int // 0-100 occupancy threshold
  adjustmentType  AdjustmentType
  adjustmentValue Decimal        @db.Decimal(8, 4)
  priority        Int
  active          Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  campground Campground @relation("CampgroundDemandBands", fields: [campgroundId], references: [id], onDelete: Cascade)
  siteClass  SiteClass? @relation(fields: [siteClassId], references: [id], onDelete: SetNull)
}

model DepositPolicy {
  id           String               @id @default(cuid())
  campgroundId String
  siteClassId  String?
  name         String
  strategy     DepositStrategy
  value        Int
  minCap       Int?
  maxCap       Int?
  applyTo      DepositApplyTo
  dueTiming    DepositDueTiming
  retryPlanId  String?
  active       Boolean              @default(true)
  version      Int                  @default(1)
  createdBy    String?
  updatedBy    String?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  schedule     AutoCollectSchedule?

  campground           Campground  @relation("CampgroundDepositPolicies", fields: [campgroundId], references: [id], onDelete: Cascade)
  siteClass            SiteClass?  @relation(fields: [siteClassId], references: [id], onDelete: SetNull)
  defaultForCampground Campground? @relation("CampgroundDefaultDepositPolicy")
}

model AutoCollectSchedule {
  id                       String          @id @default(cuid())
  depositPolicyId          String          @unique
  attemptOffsetsDays       Int[]
  cutoffHoursBeforeArrival Int
  backoffStrategy          BackoffStrategy
  maxAttempts              Int
  notifyTemplateIds        Json?
  createdAt                DateTime        @default(now())
  updatedAt                DateTime        @updatedAt

  policy DepositPolicy @relation(fields: [depositPolicyId], references: [id], onDelete: Cascade)
}

model UpsellItem {
  id                String             @id @default(cuid())
  campgroundId      String
  siteClassId       String?
  name              String
  description       String?
  priceType         UpsellPriceType
  priceCents        Int
  taxCode           String?
  inventoryTracking Boolean            @default(false)
  active            Boolean            @default(true)
  version           Int                @default(1)
  createdBy         String?
  updatedBy         String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  bundles           UpsellBundleItem[]

  campground         Campground          @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  siteClass          SiteClass?          @relation(fields: [siteClassId], references: [id], onDelete: SetNull)
  reservationUpsells ReservationUpsell[]
}

model UpsellBundle {
  id           String             @id @default(cuid())
  campgroundId String
  name         String
  priceMode    String // "bundle" or "sum"
  bundlePrice  Int?
  active       Boolean            @default(true)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  items        UpsellBundleItem[]

  campground         Campground          @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  reservationUpsells ReservationUpsell[]
}

model UpsellBundleItem {
  id       String       @id @default(cuid())
  bundleId String
  itemId   String
  required Boolean      @default(true)
  quantity Int          @default(1)
  bundle   UpsellBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  item     UpsellItem   @relation(fields: [itemId], references: [id], onDelete: Cascade)
}

model ReservationUpsell {
  id              String           @id @default(cuid())
  reservationId   String
  itemId          String?
  bundleId        String?
  quantity        Int              @default(1)
  priceSnapshot   Json
  taxCodeSnapshot String?
  chargeType      UpsellChargeType
  status          UpsellStatus     @default(pending_charge)
  attemptNo       Int              @default(0)
  idempotencyKey  String?
  createdBy       String?
  updatedBy       String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  reservation Reservation   @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  item        UpsellItem?   @relation(fields: [itemId], references: [id], onDelete: SetNull)
  bundle      UpsellBundle? @relation(fields: [bundleId], references: [id], onDelete: SetNull)
}

model IdempotencyKey {
  id           String            @id @default(cuid())
  campgroundId String?
  key          String            @unique
  requestHash  String
  responseJson Json?
  status       IdempotencyStatus @default(pending)
  resourceRef  String?
  lastSeenAt   DateTime          @default(now())
  createdAt    DateTime          @default(now())
}

// Phase 4: shared idempotency records for POST/replay dedupe
model IdempotencyRecord {
  id             String            @id @default(cuid())
  scope          String
  tenantId       String?
  campgroundId   String?
  endpoint       String
  idempotencyKey String
  requestHash    String
  checksum       String?
  requestBody    Json?
  responseJson   Json?
  status         IdempotencyStatus @default(pending)
  sequence       String?
  expiresAt      DateTime?
  lastSeenAt     DateTime          @default(now())
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  metadata       Json?

  @@unique([scope, idempotencyKey])
  @@index([scope, endpoint, sequence])
  @@index([expiresAt])
}

model AccessIntegration {
  id             String            @id @default(cuid())
  campgroundId   String
  provider       AccessProviderType
  displayName    String?
  status         String?           @default("enabled")
  credentials    Json
  webhookSecret  String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  campground        Campground        @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  grants            AccessGrant[]
  credentialsRecord AccessCredential[]

  @@unique([campgroundId, provider])
  @@index([campgroundId])
}

model Vehicle {
  id             String   @id @default(cuid())
  campgroundId   String
  reservationId  String?
  guestId        String?
  plate          String?
  state          String?
  rigType        String?
  rigLength      Int?
  description    String?
  color          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  campground   Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  reservation  Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  guest        Guest?       @relation(fields: [guestId], references: [id], onDelete: SetNull)
  credentials  AccessCredential[]
  accessGrants AccessGrant[]

  @@unique([reservationId])
  @@index([campgroundId])
  @@index([plate, state])
}

model AccessCredential {
  id             String              @id @default(cuid())
  campgroundId   String
  reservationId  String?
  vehicleId      String?
  integrationId  String?
  provider       AccessProviderType
  type           AccessCredentialType
  maskedValue    String?
  secretHash     String?
  label          String?
  metadata       Json?
  status         AccessGrantStatus   @default(pending)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  campground  Campground         @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  reservation Reservation?       @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  vehicle     Vehicle?           @relation(fields: [vehicleId], references: [id], onDelete: SetNull)
  integration AccessIntegration? @relation(fields: [integrationId], references: [id], onDelete: SetNull)
  grants      AccessGrant[]

  @@index([campgroundId])
  @@index([reservationId])
  @@index([vehicleId])
}

model AccessGrant {
  id               String             @id @default(cuid())
  campgroundId     String
  reservationId    String
  siteId           String?
  vehicleId        String?
  credentialId     String?
  integrationId    String?
  provider         AccessProviderType
  status           AccessGrantStatus  @default(pending)
  providerAccessId String?
  startsAt         DateTime?
  endsAt           DateTime?
  blockedReason    String?
  idempotencyKey   String?
  lastSyncAt       DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  campground  Campground         @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  reservation Reservation        @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  site        Site?              @relation(fields: [siteId], references: [id], onDelete: SetNull)
  vehicle     Vehicle?           @relation(fields: [vehicleId], references: [id], onDelete: SetNull)
  credential  AccessCredential?  @relation(fields: [credentialId], references: [id], onDelete: SetNull)
  integration AccessIntegration? @relation(fields: [integrationId], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([reservationId])
  @@index([siteId])
  @@unique([reservationId, provider])
  @@index([provider, idempotencyKey])
  @@index([endsAt])
}

// Phase 2: housekeeping/maintenance/groups/blocks
model Task {
  id               String    @id @default(cuid())
  tenantId         String
  type             TaskType
  state            TaskState
  priority         String?
  siteId           String
  reservationId    String?
  assignedToUserId String?
  assignedToTeamId String?
  slaDueAt         DateTime?
  slaStatus        SlaStatus @default(on_track)
  checklist        Json?
  photos           Json?
  notes            String?
  source           String?
  createdBy        String
  templateId       String?   // Reference to CleaningTaskTemplate used
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Hotel operations relation
  inspectionResults InspectionResult[]

  @@index([tenantId, siteId, state])
  @@index([tenantId, slaStatus])
}

// Inventory blocks and groups
model InventoryBlock {
  blockId     String   @id @default(cuid())
  tenantId    String
  sites       Json
  windowStart DateTime
  windowEnd   DateTime
  reason      String
  state       String
  lockId      String   @unique
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
}

model Group {
  id                   String   @id @default(cuid())
  tenantId             String
  sharedPayment        Boolean  @default(false)
  sharedComm           Boolean  @default(false)
  primaryReservationId String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

// ============================================================
// PHASE 3: Revenue, Channels, Comms, Staff, Analytics, Portfolio
// ============================================================

// --- Phase 3A: Revenue & Channel Management ---

enum DynamicPricingTrigger {
  occupancy_high
  occupancy_low
  demand_surge
  last_minute
  advance_booking
  event_proximity
  weather
  manual
}

model DynamicPricingRule {
  id              String                @id @default(cuid())
  campgroundId    String
  name            String
  trigger         DynamicPricingTrigger
  conditions      Json // { occupancyMin, occupancyMax, daysOut, etc }
  adjustmentType  String // percent | flat
  adjustmentValue Float
  priority        Int                   @default(100)
  siteClassIds    String[] // empty = all classes
  isActive        Boolean               @default(true)
  validFrom       DateTime?
  validTo         DateTime?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId, isActive])
}

model OccupancySnapshot {
  id           String     @id @default(cuid())
  campgroundId String
  date         DateTime   @db.Date
  totalSites   Int
  occupied     Int
  blocked      Int
  available    Int
  occupancyPct Float
  revenueCents Int        @default(0)
  createdAt    DateTime   @default(now())
  Campground   Campground @relation(fields: [campgroundId], references: [id])

  @@unique([campgroundId, date])
  @@index([campgroundId, date])
}

model RevenueForecast {
  id           String     @id @default(cuid())
  campgroundId String
  forecastDate DateTime   @db.Date
  projectedRev Int // cents
  actualRev    Int? // cents, filled in after the fact
  occupancyPct Float
  confidence   Float? // 0-1
  factors      Json? // what drove the forecast
  createdAt    DateTime   @default(now())
  Campground   Campground @relation(fields: [campgroundId], references: [id])

  @@unique([campgroundId, forecastDate])
  @@index([campgroundId, forecastDate])
}

// --- Phase 3B: Communications & Guest Experience ---

enum WorkflowTrigger {
  reservation_created
  reservation_confirmed
  days_before_arrival
  check_in
  days_after_checkin
  check_out
  days_after_checkout
  payment_received
  payment_failed
  review_received
  birthday
  anniversary
  manual
}

enum WorkflowStatus {
  active
  paused
  draft
  archived
}

model CommunicationWorkflow {
  id           String          @id @default(cuid())
  campgroundId String
  name         String
  description  String?
  trigger      WorkflowTrigger
  triggerValue Int? // e.g., days before/after
  conditions   Json? // additional filters
  status       WorkflowStatus  @default(draft)
  priority     Int             @default(100)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  campground Campground          @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  steps      WorkflowStep[]
  executions WorkflowExecution[]

  @@index([campgroundId, status])
}

model WorkflowStep {
  id         String  @id @default(cuid())
  workflowId String
  stepOrder  Int
  actionType String // send_email | send_sms | wait | condition | webhook
  config     Json // template, delay, conditions, etc.
  isActive   Boolean @default(true)

  workflow CommunicationWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId, stepOrder])
}

enum WorkflowExecutionStatus {
  pending
  running
  completed
  failed
  cancelled
}

model WorkflowExecution {
  id            String                  @id @default(cuid())
  workflowId    String
  reservationId String?
  guestId       String?
  status        WorkflowExecutionStatus @default(pending)
  currentStep   Int                     @default(0)
  context       Json? // runtime data
  startedAt     DateTime?
  completedAt   DateTime?
  error         String?
  createdAt     DateTime                @default(now())

  workflow CommunicationWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId, status])
  @@index([reservationId])
}

enum WaiverStatus {
  pending
  signed
  expired
  declined
}

model DigitalWaiver {
  id            String       @id @default(cuid())
  campgroundId  String
  reservationId String?
  guestId       String
  templateId    String?
  status        WaiverStatus @default(pending)
  signedAt      DateTime?
  signatureData Json? // base64 signature image
  ipAddress     String?
  userAgent     String?
  pdfUrl        String?
  expiresAt     DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  campground  Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  guest       Guest        @relation(fields: [guestId], references: [id], onDelete: Cascade)
  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)

  @@index([campgroundId, status])
  @@index([reservationId])
  @@index([guestId])
}

model WaiverTemplate {
  id           String   @id @default(cuid())
  campgroundId String
  name         String
  content      String   @db.Text
  version      Int      @default(1)
  isDefault    Boolean  @default(false)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
}

// --- Signatures & COI ---

enum SignatureDocumentType {
  long_term_stay
  park_rules
  deposit
  waiver
  coi
  other
}

enum SignatureRequestStatus {
  draft
  sent
  viewed
  signed
  declined
  voided
  expired
}

enum SignatureDeliveryChannel {
  email
  sms
  email_and_sms
}

enum CoiStatus {
  pending
  active
  expired
  voided
}

model DocumentTemplate {
  id           String                @id @default(cuid())
  campgroundId String
  siteClassId  String?
  siteId       String?
  name         String
  description  String?
  type         SignatureDocumentType
  version      Int                   @default(1)
  content      String                @db.Text
  policyConfig Json?
  isActive     Boolean               @default(true)
  autoSend     Boolean               @default(false)
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt

  campground Campground       @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  siteClass  SiteClass?       @relation(fields: [siteClassId], references: [id], onDelete: SetNull)
  site       Site?            @relation(fields: [siteId], references: [id], onDelete: SetNull)
  requests   SignatureRequest[]

  @@index([campgroundId, type])
  @@index([campgroundId, siteClassId])
  @@index([campgroundId, siteId])
  @@unique([campgroundId, name, version])
}

model SignatureRequest {
  id                String                   @id @default(cuid())
  campgroundId      String
  reservationId     String?
  guestId           String?
  templateId        String?
  documentType      SignatureDocumentType
  status            SignatureRequestStatus   @default(draft)
  deliveryChannel   SignatureDeliveryChannel @default(email)
  token             String                   @unique
  subject           String?
  message           String?
  recipientName     String?
  recipientEmail    String?
  recipientPhone    String?
  sentAt            DateTime?
  viewedAt          DateTime?
  signedAt          DateTime?
  declinedAt        DateTime?
  voidedAt          DateTime?
  expiresAt         DateTime?
  reminderAt        DateTime?
  reminderCount     Int                      @default(0)
  metadata          Json?
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt

  campground Campground      @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  reservation Reservation?   @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  guest       Guest?         @relation(fields: [guestId], references: [id], onDelete: SetNull)
  template    DocumentTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  artifact    SignatureArtifact?

  @@index([campgroundId, status])
  @@index([reservationId])
  @@index([guestId])
  @@index([expiresAt])
}

model SignatureArtifact {
  id            String   @id @default(cuid())
  requestId     String   @unique
  campgroundId  String
  reservationId String?
  guestId       String?
  pdfUrl        String
  storageKey    String?
  checksum      String?
  metadata      Json?
  completedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  request     SignatureRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  campground  Campground       @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  reservation Reservation?     @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  guest       Guest?           @relation(fields: [guestId], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([reservationId])
  @@index([guestId])
}

model CoiUpload {
  id             String    @id @default(cuid())
  campgroundId   String
  reservationId  String?
  guestId        String?
  fileUrl        String
  storageKey     String?
  status         CoiStatus @default(active)
  expiresAt      DateTime?
  reminderAt     DateTime?
  reminderCount  Int       @default(0)
  uploadedAt     DateTime  @default(now())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  notes          String?

  campground  Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  guest       Guest?       @relation(fields: [guestId], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([reservationId])
  @@index([guestId])
  @@index([expiresAt])
}

enum IdVerificationStatus {
  pending
  verified
  failed
  expired
}

model IdVerification {
  id            String               @id @default(cuid())
  campgroundId  String
  guestId       String
  reservationId String?
  status        IdVerificationStatus @default(pending)
  provider      String? // e.g., stripe_identity, jumio
  providerRef   String?
  verifiedAt    DateTime?
  expiresAt     DateTime?
  documentType  String? // passport, drivers_license, etc
  metadata      Json?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt

  campground  Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  guest       Guest        @relation(fields: [guestId], references: [id], onDelete: Cascade)
  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([guestId])
  @@index([reservationId])
}

// --- Phase 3C: Staff Operations ---

enum ShiftStatus {
  scheduled
  in_progress
  submitted
  approved
  rejected
}

enum ShiftApprovalStatus {
  pending
  approved
  rejected
}

enum TimeEntryStatus {
  open
  submitted
  approved
  rejected
  corrected
}

enum TimeEntrySource {
  kiosk
  mobile
  web
  manual
}

enum OverrideType {
  comp
  void
  discount
}

enum OverrideStatus {
  pending
  approved
  rejected
  cancelled
}

enum PayrollProvider {
  generic
  onpay
}

enum PayrollExportStatus {
  pending
  generated
  failed
}

enum PayrollExportFormat {
  csv
  json
}

model StaffShift {
  id           String    @id @default(cuid())
  campgroundId String
  userId       String
  roleId       String?
  shiftDate    DateTime  @db.Date
  startTime    DateTime
  endTime      DateTime
  role         String? // legacy friendly label
  status       ShiftStatus  @default(scheduled)
  scheduledMinutes Int?
  actualMinutes    Int?
  notes        String?
  clockedInAt  DateTime?
  clockedOutAt DateTime?
  approvedById String?
  approvedAt   DateTime?
  approvalNote String?
  createdBy    String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  user       User       @relation("StaffShifts", fields: [userId], references: [id], onDelete: Cascade)
  roleRef    StaffRole? @relation(fields: [roleId], references: [id], onDelete: SetNull)
  approvals  ShiftApproval[]
  timeEntries StaffTimeEntry[]
  payrollExportLines PayrollExportLine[]

  @@index([campgroundId, shiftDate])
  @@index([userId, shiftDate])
  @@index([roleId])
  @@index([status])
}

model StaffRole {
  id           String   @id @default(cuid())
  campgroundId String
  code         String
  name         String
  hourlyRate   Decimal? @db.Decimal(10, 2)
  earningCode  String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  shifts     StaffShift[]

  @@unique([campgroundId, code])
  @@index([campgroundId, isActive])
}

model StaffTimeEntry {
  id             String          @id @default(cuid())
  shiftId        String
  campgroundId   String
  userId         String
  clockInAt      DateTime
  clockOutAt     DateTime?
  source         TimeEntrySource @default(web)
  status         TimeEntryStatus @default(open)
  note           String?
  approvedById   String?
  approvedAt     DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  shift      StaffShift @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  user       User       @relation("StaffTimeEntries", fields: [userId], references: [id], onDelete: Cascade)
  approvedBy User?      @relation("StaffTimeEntryApprover", fields: [approvedById], references: [id])
  payrollExportLines PayrollExportLine[]

  @@index([campgroundId, userId, status])
  @@index([shiftId])
}

model ShiftApproval {
  id          String              @id @default(cuid())
  shiftId     String
  approverId  String
  status      ShiftApprovalStatus @default(pending)
  note        String?
  approvedAt  DateTime?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  shift     StaffShift @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  approver  User       @relation("ShiftApprover", fields: [approverId], references: [id])

  @@index([shiftId, status])
  @@index([approverId])
}

model StaffAvailability {
  id           String   @id @default(cuid())
  campgroundId String
  userId       String
  dayOfWeek    Int // 0=Sunday, 6=Saturday
  startTime    String // HH:mm
  endTime      String // HH:mm
  isAvailable  Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  user       User       @relation("StaffAvailability", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, userId, dayOfWeek])
}

model OverrideRequest {
  id            String         @id @default(cuid())
  campgroundId  String
  userId        String
  approverId    String?
  type          OverrideType
  reason        String?
  status        OverrideStatus @default(pending)
  targetEntity  String?
  targetId      String?
  deltaAmount   Decimal?       @db.Decimal(10, 2)
  metadata      Json?
  approvedAt    DateTime?
  rejectedAt    DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  user       User       @relation("OverrideRequester", fields: [userId], references: [id])
  approver   User?      @relation("OverrideApprover", fields: [approverId], references: [id])

  @@index([campgroundId, status, type])
  @@index([targetEntity, targetId])
}

model PayrollEarningCode {
  id           String          @id @default(cuid())
  campgroundId String
  roleCode     String
  provider     PayrollProvider @default(generic)
  earningCode  String
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  @@unique([campgroundId, roleCode, provider])
  @@index([campgroundId, provider])
}

model PayrollExport {
  id             String               @id @default(cuid())
  campgroundId   String
  periodStart    DateTime             @db.Date
  periodEnd      DateTime             @db.Date
  provider       PayrollProvider      @default(generic)
  format         PayrollExportFormat  @default(csv)
  status         PayrollExportStatus  @default(pending)
  requestedById  String
  rowCount       Int?
  totalHours     Float?
  fileKey        String?
  failureReason  String?
  createdAt      DateTime             @default(now())
  completedAt    DateTime?

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  requestedBy User       @relation("PayrollExportRequester", fields: [requestedById], references: [id], onDelete: Cascade)
  lines       PayrollExportLine[]

  @@index([campgroundId, periodStart, periodEnd])
  @@index([provider, status])
}

model PayrollExportLine {
  id           String    @id @default(cuid())
  exportId     String
  userId       String
  shiftId      String?
  timeEntryId  String?
  hours        Float
  earningCode  String?
  rate         Decimal?  @db.Decimal(10, 2)
  roleCode     String?
  notes        String?
  createdAt    DateTime  @default(now())

  export    PayrollExport  @relation(fields: [exportId], references: [id], onDelete: Cascade)
  user      User           @relation("PayrollExportUser", fields: [userId], references: [id], onDelete: Cascade)
  shift     StaffShift?    @relation(fields: [shiftId], references: [id], onDelete: SetNull)
  timeEntry StaffTimeEntry? @relation(fields: [timeEntryId], references: [id], onDelete: SetNull)

  @@index([exportId])
  @@index([userId])
}
enum PushNotificationType {
  arrival
  departure
  task_assigned
  task_sla_warning
  maintenance_urgent
  payment_received
  payment_failed
  message_received
  general
}

model PushNotification {
  id           String               @id @default(cuid())
  campgroundId String
  userId       String?
  type         PushNotificationType
  title        String
  body         String
  data         Json?
  sentAt       DateTime?
  readAt       DateTime?
  clickedAt    DateTime?
  createdAt    DateTime             @default(now())

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  user       User?      @relation("PushNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([campgroundId, userId, createdAt])
}

model StaffPerformance {
  id              String   @id @default(cuid())
  campgroundId    String
  userId          String
  periodStart     DateTime @db.Date
  periodEnd       DateTime @db.Date
  tasksCompleted  Int      @default(0)
  tasksSlaOnTime  Int      @default(0)
  checkinsHandled Int      @default(0)
  avgTaskMinutes  Float?
  hoursWorked     Float?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  user       User       @relation("StaffPerformance", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, userId, periodStart, periodEnd])
  @@index([campgroundId, periodStart])
}

// --- Phase 3D: Analytics & Reporting ---

enum ReportScheduleFrequency {
  daily
  weekly
  monthly
  quarterly
}

model SavedReport {
  id           String                   @id @default(cuid())
  campgroundId String?
  orgId        String?
  createdById  String
  name         String
  description  String?
  reportType   String // revenue, occupancy, guests, custom
  config       Json // columns, filters, grouping
  isPublic     Boolean                  @default(false)
  scheduleFreq ReportScheduleFrequency?
  scheduleDay  Int? // day of week/month
  scheduleTime String? // HH:mm
  recipients   String[] // email addresses
  lastRunAt    DateTime?
  createdAt    DateTime                 @default(now())
  updatedAt    DateTime                 @updatedAt

  campground Campground? @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  createdBy  User        @relation("SavedReports", fields: [createdById], references: [id], onDelete: Cascade)
  runs       ReportRun[]

  @@index([campgroundId])
  @@index([createdById])
}

model ReportRun {
  id          String    @id @default(cuid())
  reportId    String
  status      String // pending, running, completed, failed
  startedAt   DateTime?
  completedAt DateTime?
  rowCount    Int?
  fileUrl     String? // S3/storage URL
  error       String?
  triggeredBy String? // schedule | manual | user_id
  createdAt   DateTime  @default(now())

  report SavedReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId, createdAt])
}

model CohortAnalysis {
  id              String   @id @default(cuid())
  campgroundId    String
  cohortType      String // first_booking_month, acquisition_channel, site_type
  cohortValue     String
  periodStart     DateTime @db.Date
  periodEnd       DateTime @db.Date
  guestCount      Int
  bookings        Int
  revenue         Int // cents
  repeatRate      Float?
  avgBookingValue Int?
  createdAt       DateTime @default(now())

  @@unique([campgroundId, cohortType, cohortValue, periodStart])
  @@index([campgroundId, cohortType])
}

// --- Phase 3E: Multi-Property & Portfolio ---

model PortfolioDashboard {
  id          String   @id @default(cuid())
  orgId       String
  name        String
  layout      Json // widget positions and configs
  isDefault   Boolean  @default(false)
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  createdBy    User         @relation("PortfolioDashboards", fields: [createdById], references: [id], onDelete: Cascade)

  @@index([orgId])
}

model PortfolioMetric {
  id            String   @id @default(cuid())
  orgId         String
  campgroundId  String?
  metricDate    DateTime @db.Date
  metricType    String // occupancy, revenue, adr, revpar, bookings
  value         Float
  previousValue Float?
  changePercent Float?
  createdAt     DateTime @default(now())

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  campground   Campground?  @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@unique([orgId, campgroundId, metricDate, metricType])
  @@index([orgId, metricDate])
}

model CentralizedRatePush {
  id            String    @id @default(cuid())
  orgId         String
  name          String
  rateConfig    Json // rate adjustments to push
  targetCampIds String[]
  status        String    @default("draft") // draft, pending, applied, failed
  appliedAt     DateTime?
  appliedBy     String?
  results       Json? // per-campground results
  createdBy     String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
}

// ---------------------------------------------------------------------------
// Phase 4: Stored Value / POS / Analytics Facts
// ---------------------------------------------------------------------------

enum StoredValueType {
  gift
  credit
}

enum StoredValueStatus {
  active
  frozen
  expired
}

enum StoredValueDirection {
  issue
  redeem
  adjust
  expire
  refund
  hold_create
  hold_capture
  hold_release
}

enum StoredValueHoldStatus {
  open
  captured
  released
  expired
}

model StoredValueAccount {
  id               String             @id @default(cuid())
  campgroundId     String
  type             StoredValueType
  currency         String
  status           StoredValueStatus  @default(active)
  issuedAt         DateTime
  expiresAt        DateTime?
  liabilityAccount String?
  createdBy        String?
  createdVia       String?
  metadata         Json?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  campground Campground          @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  codes      StoredValueCode[]
  ledger     StoredValueLedger[]
  holds      StoredValueHold[]

  @@index([campgroundId])
  @@index([status])
}

model StoredValueCode {
  id                   String   @id @default(cuid())
  accountId            String
  code                 String   @unique
  pinHash              String?
  active               Boolean  @default(true)
  redeemedByGuestId    String?
  createdAt            DateTime @default(now())

  account StoredValueAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  guest   Guest?             @relation(fields: [redeemedByGuestId], references: [id], onDelete: SetNull)

  @@index([accountId])
}

model StoredValueLedger {
  id                  String              @id @default(cuid())
  campgroundId        String
  accountId           String
  direction           StoredValueDirection
  amountCents         Int
  currency            String
  beforeBalanceCents  Int
  afterBalanceCents   Int
  referenceType       String
  referenceId         String
  idempotencyKey      String
  actorType           String?
  actorId             String?
  channel             String?
  reason              String?
  createdAt           DateTime            @default(now())

  campground Campground         @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  account    StoredValueAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([campgroundId, idempotencyKey])
  @@index([accountId, createdAt])
}

model StoredValueHold {
  id             String                 @id @default(cuid())
  accountId      String
  amountCents    Int
  status         StoredValueHoldStatus  @default(open)
  expiresAt      DateTime
  referenceType  String
  referenceId    String
  idempotencyKey String
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt

  account StoredValueAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId, status])
}

enum PosCartStatus {
  open
  checked_out
  void
}

enum PosPaymentMethod {
  card
  cash
  gift
  store_credit
  charge_to_site
}

enum PosPaymentStatus {
  pending
  succeeded
  failed
  refunded
}

enum TillSessionStatus {
  open
  closed
}

enum TillMovementType {
  cash_sale
  cash_refund
  paid_in
  paid_out
  adjustment
}

enum PosProviderType {
  clover
  square
  toast
  lightspeed
  shopify
  vend
}

enum PosProviderCapability {
  payments
  items_sync
  receipts
  inventory_push
  inventory_pull
  markdown_sync
  expiration_sync
}

enum PosIntegrationStatus {
  enabled
  disabled
  error
}

enum PosSyncTarget {
  catalog
  tenders
  payments
  inventory
  markdowns
}

enum PosSyncStatus {
  idle
  running
  succeeded
  failed
}

model PosTerminal {
  id             String   @id @default(cuid())
  campgroundId   String
  locationId     String?
  offlineCapable Boolean  @default(false)
  taxVersion     String?
  priceVersion   String?
  createdAt      DateTime @default(now())

  campground   Campground     @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  location     StoreLocation? @relation(fields: [locationId], references: [id], onDelete: SetNull)
  carts        PosCart[]
  tillSessions TillSession[]

  @@index([campgroundId])
  @@index([locationId])
}

model PosCart {
  id           String         @id @default(cuid())
  campgroundId String
  terminalId   String?
  status       PosCartStatus  @default(open)
  needsReview  Boolean        @default(false)
  netCents     Int            @default(0)
  taxCents     Int            @default(0)
  feeCents     Int            @default(0)
  grossCents   Int            @default(0)
  currency     String
  taxVersion   String?
  priceVersion String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  campground Campground      @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  terminal   PosTerminal?    @relation(fields: [terminalId], references: [id], onDelete: SetNull)
  items      PosCartItem[]
  payments   PosPayment[]
  returns    PosReturn[]     @relation("ReturnCart")
  movements  TillMovement[]  @relation("TillMovementCart")
  offlineReplays PosOfflineReplay[]

  @@index([campgroundId, status])
  @@index([terminalId])
}

model PosCartItem {
  id              String   @id @default(cuid())
  cartId          String
  productId       String
  qty             Int
  unitPriceCents  Int
  discountCents   Int      @default(0)
  taxCents        Int      @default(0)
  feeCents        Int      @default(0)
  totalCents      Int
  metadata        Json?

  // Expiration markdown tracking
  markdownApplied       Boolean @default(false) // Was an expiration markdown applied?
  markdownRuleId        String?                 // Which markdown rule was applied
  originalPriceCents    Int?                    // Original price before markdown
  markdownDiscountCents Int?                    // Amount discounted due to expiration
  batchId               String?                 // Which inventory batch this item came from

  cart    PosCart  @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([cartId])
  @@index([productId])
}

model PosPayment {
  id             String           @id @default(cuid())
  cartId         String
  method         PosPaymentMethod
  amountCents    Int
  currency       String
  status         PosPaymentStatus @default(pending)
  idempotencyKey String
  referenceType  String?
  referenceId    String?
  processorIds   Json?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  cart PosCart @relation(fields: [cartId], references: [id], onDelete: Cascade)

  @@index([cartId])
  @@index([idempotencyKey])
}

model PosOfflineReplay {
  id                String   @id @default(cuid())
  clientTxId        String?
  cartId            String?
  campgroundId      String?
  recordedTotalsHash String?
  expectedHash      String?
  payloadHash       String?
  status            String?
  reason            String?
  payload           Json?
  tender            Json?
  items             Json?
  expectedBreakdown Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  cart       PosCart?     @relation(fields: [cartId], references: [id], onDelete: SetNull)
  campground Campground?  @relation(fields: [campgroundId], references: [id], onDelete: SetNull)

  @@index([cartId])
  @@index([campgroundId])
  @@index([clientTxId])
}

model TillSession {
  id                 String            @id @default(cuid())
  campgroundId       String
  terminalId         String?
  status             TillSessionStatus @default(open)
  openingFloatCents  Int               @default(0)
  expectedCloseCents Int               @default(0)
  countedCloseCents  Int?
  overShortCents     Int               @default(0)
  currency           String
  notes              String?
  openedByUserId     String
  closedByUserId     String?
  openedAt           DateTime          @default(now())
  closedAt           DateTime?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  terminal   PosTerminal? @relation(fields: [terminalId], references: [id], onDelete: SetNull)
  openedBy   User         @relation("TillSessionOpenedBy", fields: [openedByUserId], references: [id], onDelete: Cascade)
  closedBy   User?        @relation("TillSessionClosedBy", fields: [closedByUserId], references: [id], onDelete: SetNull)
  movements  TillMovement[]

  @@index([campgroundId, status])
  @@index([terminalId, status])
}

model TillMovement {
  id            String           @id @default(cuid())
  sessionId     String
  type          TillMovementType
  amountCents   Int
  currency      String
  sourceCartId  String?
  actorUserId   String
  note          String?
  createdAt     DateTime @default(now())

  session TillSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  actor   User        @relation("TillMovementActor", fields: [actorUserId], references: [id], onDelete: Cascade)
  cart    PosCart?    @relation("TillMovementCart", fields: [sourceCartId], references: [id], onDelete: SetNull)

  @@index([sessionId, type])
  @@index([sourceCartId])
}

enum PosReturnStatus {
  pending
  completed
  failed
}

model PosReturn {
  id            String          @id @default(cuid())
  originalCartId String
  status        PosReturnStatus @default(pending)
  reasonCode    String?
  restock       Boolean         @default(false)
  netCents      Int             @default(0)
  taxCents      Int             @default(0)
  feeCents      Int             @default(0)
  grossCents    Int             @default(0)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  originalCart PosCart @relation("ReturnCart", fields: [originalCartId], references: [id], onDelete: Cascade)

  @@index([originalCartId])
}

model PosProviderIntegration {
  id             String                @id @default(cuid())
  campgroundId   String
  provider       PosProviderType
  displayName    String?
  status         PosIntegrationStatus  @default(enabled)
  capabilities   PosProviderCapability[]
  credentials    Json
  locations      Json?
  devices        Json?
  webhookSecret  String?
  lastValidatedAt DateTime?
  lastSyncAt     DateTime?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt

  campground Campground       @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  syncs      PosProviderSync[]

  @@unique([campgroundId, provider])
  @@index([campgroundId, status])
}

model PosProviderSync {
  id             String         @id @default(cuid())
  integrationId  String
  type           PosSyncTarget
  status         PosSyncStatus  @default(idle)
  lastRunAt      DateTime?
  lastError      String?
  metadata       Json?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  integration PosProviderIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@unique([integrationId, type])
  @@index([integrationId, type])
}

// Analytics daily facts
model FactReservationsDaily {
  id              String   @id @default(cuid())
  campgroundId    String
  metricDate      DateTime @db.Date
  roomsAvailable  Int
  roomsSold       Int
  roomRevenueCents Int
  taxesCents      Int       @default(0)
  feesCents       Int       @default(0)
  discountsCents  Int       @default(0)
  channel         String?
  createdAt       DateTime  @default(now())

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, metricDate, channel])
  @@index([campgroundId, metricDate])
}

model FactPosDaily {
  id             String   @id @default(cuid())
  campgroundId   String
  locationId     String?
  metricDate     DateTime @db.Date
  netCents       Int
  taxCents       Int      @default(0)
  feeCents       Int      @default(0)
  discountsCents Int      @default(0)
  categoryId     String?
  createdAt      DateTime @default(now())

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, metricDate, categoryId])
  @@index([campgroundId, metricDate])
}

model FactStoredValueDaily {
  id            String   @id @default(cuid())
  campgroundId  String
  metricDate    DateTime @db.Date
  issuedCents   Int      @default(0)
  redeemedCents Int      @default(0)
  expiredCents  Int      @default(0)
  createdAt     DateTime @default(now())

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, metricDate])
  @@index([campgroundId, metricDate])
}

// =============================================================================
// User Feedback / Support Tickets
// =============================================================================

model Ticket {
  id           String          @id @default(uuid())
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @default(now()) @updatedAt
  completedAt  DateTime?
  title        String
  notes        String?
  category     TicketCategory  @default(issue)
  area         String?
  url          String?
  path         String?
  pageTitle    String?
  selection    String?
  status       TicketState     @default(open)
  agentNotes   String?
  votes        Int             @default(0)
  submitter    Json?           // { id, name, email }
  upvoters     Json?           // [{ id, name, email }]
  client       Json?           // { userAgent, platform, language, deviceType }
  extra        Json?

  @@index([status])
  @@index([createdAt])
  @@index([category])
}

// =============================================================================
// Platform Admin Features
// =============================================================================

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  SYNC
  EXPORT
  IMPORT
}

model PlatformAuditLog {
  id          String      @id @default(cuid())
  createdAt   DateTime    @default(now())
  userId      String?
  userEmail   String?
  action      AuditAction
  resource    String      // e.g., "Campground", "User", "Reservation"
  resourceId  String?
  details     String?     // Human-readable description
  metadata    Json?       // Additional structured data
  ipAddress   String?
  userAgent   String?

  @@index([createdAt])
  @@index([userId])
  @@index([action])
  @@index([resource])
}

enum FeatureFlagScope {
  global
  campground
}

model FeatureFlag {
  id          String            @id @default(cuid())
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  key         String            @unique
  name        String
  description String?
  enabled     Boolean           @default(false)
  scope       FeatureFlagScope  @default(global)
  campgrounds String[]          // Array of campground IDs if scope is "campground"
  metadata    Json?             // Additional config

  @@index([key])
  @@index([enabled])
}

enum AnnouncementType {
  info
  warning
  success
}

enum AnnouncementTarget {
  all
  admins
  campground
}

enum AnnouncementStatus {
  draft
  scheduled
  sent
}

model Announcement {
  id           String              @id @default(cuid())
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  title        String
  message      String
  type         AnnouncementType    @default(info)
  target       AnnouncementTarget  @default(all)
  campgroundId String?             // If target is "campground"
  status       AnnouncementStatus  @default(draft)
  scheduledAt  DateTime?
  sentAt       DateTime?
  createdById  String
  createdByEmail String?

  @@index([status])
  @@index([createdAt])
  @@index([target])
}

// =============================================================================
// Report Subscriptions
// =============================================================================

enum ReportFrequency {
  daily
  weekly
  monthly
}

enum ReportType {
  occupancy_summary
  revenue_summary
  arrivals_departures
  maintenance_summary
  reservation_activity
  guest_activity
  financial_summary
}

model ReportSubscription {
  id           String           @id @default(cuid())
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  userId       String
  userEmail    String
  campgroundId String?          // null for platform-wide reports (admin only)
  reportType   ReportType
  frequency    ReportFrequency
  enabled      Boolean          @default(true)
  lastSentAt   DateTime?
  nextSendAt   DateTime?
  deliveryTime String           @default("08:00") // HH:MM in campground timezone
  dayOfWeek    Int?             // 0-6 for weekly (0=Sunday)
  dayOfMonth   Int?             // 1-31 for monthly

  @@unique([userId, campgroundId, reportType])
  @@index([userId])
  @@index([campgroundId])
  @@index([enabled, nextSendAt])
}

// ==================== AI FEATURES ====================

enum AiFeatureType {
  reply_assist
  booking_assist
  analytics
  forecasting
  anomaly_detection
  recommendations
}

model AiInteractionLog {
  id           String        @id @default(cuid())
  campgroundId String
  featureType  AiFeatureType
  promptHash   String        // SHA-256 of anonymized prompt (for audit, not content)
  responseHash String        // SHA-256 of response
  tokensUsed   Int
  latencyMs    Int
  userId       String?       // Staff user ID if applicable
  sessionId    String?       // Anonymous session for consumer interactions
  success      Boolean       @default(true)
  errorType    String?
  provider     String        @default("openai")
  modelUsed    String?       // e.g., gpt-4, claude-3
  costCents    Int?          // Estimated cost for billing
  createdAt    DateTime      @default(now())

  @@index([campgroundId, createdAt])
  @@index([featureType, createdAt])
  @@index([userId, createdAt])
}

enum AiConsentType {
  booking_assist
  personalization
  communications
  analytics
}

model AiConsentRecord {
  id           String        @id @default(cuid())
  campgroundId String
  guestId      String?       // Null for anonymous/session-based consent
  sessionId    String?       // For anonymous users
  consentType  AiConsentType
  granted      Boolean       @default(true)
  ipHash       String?       // Hashed IP for compliance
  userAgent    String?
  grantedAt    DateTime      @default(now())
  revokedAt    DateTime?
  source       String?       // e.g., booking_widget, chat, settings

  @@index([campgroundId, guestId])
  @@index([sessionId])
  @@index([consentType, granted])
}

// ==================== GUEST SEGMENTS ====================

enum SegmentScope {
  global       // Platform-wide template available to all
  organization // Shared across campgrounds in org
  campground   // Single campground only
}

enum SegmentStatus {
  active
  archived
}

model GuestSegment {
  id             String        @id @default(cuid())
  name           String
  description    String?
  scope          SegmentScope  @default(campground)
  status         SegmentStatus @default(active)
  criteria       Json          // Array of criteria objects
  isTemplate     Boolean       @default(false) // Global templates
  organizationId String?       // For org-level segments
  campgroundId   String?       // For campground-level segments (null for global)
  createdById    String        // User who created it
  createdByEmail String
  guestCount     Int           @default(0) // Cached count, updated periodically
  lastCalculated DateTime?     // When guestCount was last calculated
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @default(now()) @updatedAt

  campground  Campground?              @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  memberships GuestSegmentMembership[]

  @@index([scope, status])
  @@index([campgroundId, status])
  @@index([organizationId, status])
  @@index([isTemplate])
}

model GuestSegmentMembership {
  id         String   @id @default(cuid())
  segmentId  String
  guestId    String
  addedAt    DateTime @default(now())
  removedAt  DateTime?

  segment GuestSegment @relation(fields: [segmentId], references: [id], onDelete: Cascade)
  guest   Guest        @relation(fields: [guestId], references: [id], onDelete: Cascade)

  @@unique([segmentId, guestId])
  @@index([segmentId])
  @@index([guestId])
}

// ==================== ANALYTICS SHARING ====================

enum AnalyticsType {
  overview
  geographic
  demographics
  seasonal_trends
  travel_behavior
  full_report
  segment
}

enum ExportFormat {
  csv
  json
  pdf
}

enum ExportStatus {
  pending
  processing
  completed
  failed
}

enum ShareAccessLevel {
  view_only
  downloadable
}

// Shareable links for analytics reports
model AnalyticsShareLink {
  id             String           @id @default(cuid())
  token          String           @unique @default(cuid()) // Public access token
  analyticsType  AnalyticsType
  accessLevel    ShareAccessLevel @default(view_only)

  // Scope and filtering
  scope          SegmentScope     @default(campground)
  organizationId String?
  campgroundId   String?
  segmentId      String?          // For segment-specific shares
  dateRange      String?          // last_30_days, last_90_days, etc.
  filters        Json?            // Additional filters

  // Access control
  sharedBy       String           // User ID who created share
  sharedByEmail  String
  password       String?          // Optional password protection
  expiresAt      DateTime?        // Optional expiration
  maxViews       Int?             // Optional view limit
  viewCount      Int              @default(0)

  // Metadata
  name           String?          // Optional friendly name
  description    String?
  createdAt      DateTime         @default(now())
  revokedAt      DateTime?        // Soft revoke
  lastAccessedAt DateTime?

  campground     Campground?      @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([campgroundId])
  @@index([organizationId])
  @@index([sharedBy])
  @@index([expiresAt])
}

// Export job records for async/batch exports
model AnalyticsExport {
  id             String       @id @default(cuid())
  analyticsType  AnalyticsType
  format         ExportFormat
  status         ExportStatus @default(pending)

  // Scope and filtering
  scope          SegmentScope @default(campground)
  organizationId String?
  campgroundId   String?
  segmentId      String?
  dateRange      String?
  filters        Json?
  includePII     Boolean      @default(false) // Whether to include guest PII

  // Export details
  requestedBy    String       // User ID
  requestedByEmail String
  fileName       String?
  fileUrl        String?      // S3/storage URL when complete
  fileSize       Int?         // Bytes
  rowCount       Int?         // Number of records exported

  // Processing
  startedAt      DateTime?
  completedAt    DateTime?
  errorMessage   String?

  // Email delivery
  emailTo        String[]     @default([])
  emailSentAt    DateTime?

  // Metadata
  createdAt      DateTime     @default(now())
  expiresAt      DateTime?    // When download link expires

  campground     Campground?  @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([organizationId])
  @@index([requestedBy])
  @@index([status])
  @@index([createdAt])
}

// Platform Goals for tracking objectives
enum GoalStatus {
  on_track
  at_risk
  behind
  achieved
}

enum GoalCategory {
  revenue
  bookings
  guests
  satisfaction
}

enum GoalUnit {
  currency
  percentage
  number
  score
}

model PlatformGoal {
  id           String       @id @default(cuid())
  name         String
  description  String?
  metric       String       // e.g., "Total Revenue", "NPS Score"

  target       Float
  current      Float        @default(0)
  unit         GoalUnit

  period       String       // e.g., "Q4 2024", "2024"
  category     GoalCategory
  status       GoalStatus   @default(on_track)

  dueDate      DateTime
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  createdBy    String?      // User ID

  // Optional targeting
  campgroundId String?
  campground   Campground?  @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([status])
  @@index([dueDate])
  @@index([campgroundId])
}

// Campground Awards - Historical recognition
enum AwardType {
  campground_of_year
  rising_star
  world_class
  top_1_percent
  top_5_percent
  top_10_percent
}

model CampgroundAward {
  id           String     @id @default(cuid())
  campgroundId String
  awardType    AwardType
  year         Int        // Year the award was earned
  npsScore     Int?       // NPS score at time of award
  npsImprovement Int?     // For rising_star: points improved
  rank         Int?       // Ranking position if applicable

  createdAt    DateTime   @default(now())

  campground   Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, awardType, year])
  @@index([campgroundId])
  @@index([year])
  @@index([awardType])
}

// =============================================================================
// CHARITY ROUND-UP
// =============================================================================

enum DonationStatus {
  collected       // Payment received with reservation
  pending_payout  // Marked for next payout batch
  paid_out        // Sent to charity
  refunded        // Reservation cancelled, donation refunded
}

enum CharityPayoutStatus {
  pending
  processing
  completed
  failed
}

// Charity registry - platform-managed list of verified charities
model Charity {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  logoUrl     String?
  taxId       String?  // EIN for US charities (for tax receipts)
  website     String?
  category    String?  // environment, youth, veterans, animals, etc.
  isActive    Boolean  @default(true)
  isVerified  Boolean  @default(false) // Platform has verified legitimacy
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campgroundCharities CampgroundCharity[]
  donations           CharityDonation[]
  payouts             CharityPayout[]

  @@index([isActive])
  @@index([category])
}

// Campground's charity selection and round-up settings
model CampgroundCharity {
  id             String   @id @default(cuid())
  campgroundId   String   @unique // One charity per campground
  charityId      String
  isEnabled      Boolean  @default(true)
  customMessage  String?  @db.Text // "Help us support local veterans!"
  roundUpType    String   @default("nearest_dollar") // nearest_dollar, nearest_5, fixed
  roundUpOptions Json?    // { values: [1, 2, 5] } for fixed amounts
  defaultOptIn   Boolean  @default(false) // Pre-check the donation box?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  campground     Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  charity        Charity    @relation(fields: [charityId], references: [id])

  @@index([charityId])
}

// Individual donation records linked to reservations
model CharityDonation {
  id             String         @id @default(cuid())
  reservationId  String         @unique // One donation per reservation
  charityId      String
  campgroundId   String
  guestId        String?
  amountCents    Int
  status         DonationStatus @default(collected)
  payoutId       String?
  journalEntryId String?        // Link to ledger entry for accounting
  refundedAt     DateTime?
  createdAt      DateTime       @default(now())

  reservation    Reservation    @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  charity        Charity        @relation(fields: [charityId], references: [id])
  campground     Campground     @relation(fields: [campgroundId], references: [id])
  payout         CharityPayout? @relation(fields: [payoutId], references: [id])

  @@index([charityId])
  @@index([campgroundId])
  @@index([status])
  @@index([createdAt])
}

// Batch payouts to charities
model CharityPayout {
  id           String              @id @default(cuid())
  charityId    String
  amountCents  Int
  status       CharityPayoutStatus @default(pending)
  payoutDate   DateTime?
  payoutMethod String?             // check, ach, wire
  reference    String?             // Check number, wire reference
  notes        String?             @db.Text
  createdBy    String?             // Admin who initiated
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  charity      Charity             @relation(fields: [charityId], references: [id])
  donations    CharityDonation[]

  @@index([charityId])
  @@index([status])
}

// =============================================================================
// EARLY ACCESS PROGRAM
// =============================================================================

// Tracks which organizations enrolled in early access tiers
model EarlyAccessEnrollment {
  id               String          @id @default(cuid())
  organizationId   String          @unique
  tier             EarlyAccessTier
  enrolledAt       DateTime        @default(now())
  lockedBookingFee Int // cents - locked forever at enrollment rate
  monthlyFeeEndsAt DateTime? // When free/discounted monthly period ends (null = forever free)
  lockedMonthlyFee Int? // cents - if special rate applies after promo period

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([tier])
  @@index([enrolledAt])
}

// Tracks available spots per tier (singleton rows)
model EarlyAccessSpot {
  tier           EarlyAccessTier @id
  totalSpots     Int
  remainingSpots Int
  updatedAt      DateTime        @updatedAt
}

// =============================================================================
// ORGANIZATION BILLING (What Camp Everyday charges campgrounds)
// =============================================================================

enum OrgBillingPeriodStatus {
  open       // Currently accumulating charges
  processing // Being finalized
  invoiced   // Invoice sent to customer
  paid       // Payment received
  past_due   // Payment overdue
  void       // Cancelled/voided
}

enum OrgBillingLineItemType {
  subscription       // Monthly subscription fee
  booking_fee        // Per-booking fee
  sms_outbound       // Outbound SMS charges
  sms_inbound        // Inbound SMS charges
  ai_usage           // AI feature usage
  overage            // Any overage charges
  credit             // Credits/adjustments
  discount           // Promotional discounts
  early_access_discount // Early access tier discount
}

// Monthly billing period for an organization
model OrganizationBillingPeriod {
  id                 String                  @id @default(cuid())
  organizationId     String
  periodStart        DateTime                // Start of billing period
  periodEnd          DateTime                // End of billing period
  status             OrgBillingPeriodStatus  @default(open)

  // Totals (in cents)
  subtotalCents      Int                     @default(0)
  discountCents      Int                     @default(0)
  taxCents           Int                     @default(0)
  totalCents         Int                     @default(0)

  // Stripe integration
  stripeInvoiceId    String?                 @unique
  stripePaymentIntentId String?

  // Timing
  invoicedAt         DateTime?
  paidAt             DateTime?
  dueAt              DateTime?

  // Metadata
  notes              String?
  metadata           Json?

  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt

  organization       Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  lineItems          OrganizationBillingLineItem[]

  @@unique([organizationId, periodStart])
  @@index([organizationId])
  @@index([status])
  @@index([periodStart])
}

// Individual line items on an organization's bill
model OrganizationBillingLineItem {
  id               String                   @id @default(cuid())
  billingPeriodId  String
  type             OrgBillingLineItemType
  description      String

  // Quantity and pricing
  quantity         Int                      @default(1)
  unitCents        Int                      // Price per unit in cents
  totalCents       Int                      // quantity * unitCents

  // Optional references
  campgroundId     String?                  // If specific to a campground
  reservationId    String?                  // If tied to a specific reservation

  // Metadata for detail drill-down
  metadata         Json?                    // { reservationIds: [...], smsMessageIds: [...] }

  createdAt        DateTime                 @default(now())

  billingPeriod    OrganizationBillingPeriod @relation(fields: [billingPeriodId], references: [id], onDelete: Cascade)
  campground       Campground?              @relation(fields: [campgroundId], references: [id])

  @@index([billingPeriodId])
  @@index([type])
  @@index([campgroundId])
}

// Track individual usage events for billing
model UsageEvent {
  id               String    @id @default(cuid())
  organizationId   String
  campgroundId     String?
  eventType        String    // booking_created, sms_sent, sms_received, ai_tokens_used

  // Quantification
  quantity         Int       @default(1)
  unitCents        Int?      // Cost per unit (calculated at event time)

  // References
  referenceType    String?   // reservation, communication, ai_request
  referenceId      String?   // ID of the related entity

  // Billing linkage
  billingPeriodId  String?   // Linked when processed into billing
  billed           Boolean   @default(false)
  billedAt         DateTime?

  metadata         Json?
  createdAt        DateTime  @default(now())

  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  campground       Campground?  @relation(fields: [campgroundId], references: [id])

  @@index([organizationId])
  @@index([campgroundId])
  @@index([eventType])
  @@index([billed])
  @@index([createdAt])
  @@index([billingPeriodId])
}

// ============================================
// Setup Assistance Services
// ============================================

enum SetupServiceType {
  quick_start       // $249 - Site config, payment setup, training call
  data_import_500   // $299 - Up to 500 reservations
  data_import_2000  // $599 - 501-2,000 reservations
  data_import_5000  // $999 - 2,001-5,000 reservations
  data_import_custom // Custom quote for 5,000+
}

enum SetupServiceStatus {
  pending      // Purchased, awaiting work
  in_progress  // Work has started
  completed    // Work finished
  cancelled    // Cancelled/refunded
}

model SetupService {
  id                      String              @id @default(cuid())
  organizationId          String
  serviceType             SetupServiceType
  status                  SetupServiceStatus  @default(pending)

  // Pricing
  totalCents              Int                 // Full price (e.g., 24900 for $249)
  paidUpfrontCents        Int                 @default(0) // Amount paid at purchase
  balanceRemainingCents   Int                 @default(0) // Remaining to pay via bookings
  perBookingSurchargeCents Int                @default(100) // $1.00 per booking

  // For data imports
  reservationCount        Int?                // Estimated/actual reservation count
  importFileUrl           String?             // URL to uploaded export file
  importNotes             String?             // Notes from customer about the import

  // Stripe
  stripePaymentIntentId   String?             // If paid upfront
  stripeInvoiceId         String?

  // Tracking
  purchasedAt             DateTime            @default(now())
  startedAt               DateTime?
  completedAt             DateTime?
  completedBy             String?             // Staff user ID who completed it

  // Balance payoff tracking
  bookingsCharged         Int                 @default(0) // Number of bookings that paid $1 surcharge
  lastChargedAt           DateTime?
  paidOffAt               DateTime?           // When balance reached $0

  notes                   String?
  metadata                Json?

  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt

  organization            Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([status])
  @@index([balanceRemainingCents])
}

// ============================================
// Organization Referral Program (B2B)
// ============================================

enum OrgReferralStatus {
  clicked     // Link was clicked
  signed_up   // Referred org created an account
  converted   // Referred org received first booking
  credited    // Credit was applied to referrer
}

model OrgReferral {
  id                String            @id @default(cuid())
  referrerOrgId     String            // Organization that made the referral
  referredOrgId     String?           // Organization that was referred (after signup)
  referredEmail     String?           // Email used during signup (before org created)
  referralCode      String            // Code used for tracking

  status            OrgReferralStatus @default(clicked)
  creditAmountCents Int               @default(5000) // $50 default credit

  // Tracking
  clickedAt         DateTime          @default(now())
  signedUpAt        DateTime?
  convertedAt       DateTime?
  creditedAt        DateTime?

  // Metadata
  utmSource         String?
  utmMedium         String?
  utmCampaign       String?
  ipAddress         String?
  userAgent         String?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @default(now()) @updatedAt

  referrerOrg       Organization      @relation("ReferrerOrg", fields: [referrerOrgId], references: [id], onDelete: Cascade)
  referredOrg       Organization?     @relation("ReferredOrg", fields: [referredOrgId], references: [id], onDelete: SetNull)

  @@index([referrerOrgId])
  @@index([referredOrgId])
  @@index([referralCode])
  @@index([referredEmail])
  @@index([status])
}

// ============================================
// Multi-Location Store Management
// ============================================

model StoreLocation {
  id               String             @id @default(cuid())
  campgroundId     String
  name             String             // "Pool Bar", "Camp Store", "Snack Shack"
  code             String?            // Short code: "PB", "CS", "SS"
  type             StoreLocationType  @default(physical)
  isDefault        Boolean            @default(false)
  isActive         Boolean            @default(true)
  acceptsOnline    Boolean            @default(false) // Can fulfill online orders
  sortOrder        Int                @default(0)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @default(now()) @updatedAt

  campground        Campground             @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  locationInventory LocationInventory[]
  priceOverrides    LocationPriceOverride[]
  terminals         PosTerminal[]
  fulfillmentOrders StoreOrder[]           @relation("FulfillmentLocation")
  transfersOut      InventoryTransfer[]    @relation("TransferFrom")
  transfersIn       InventoryTransfer[]    @relation("TransferTo")
  inventoryMovements InventoryMovement[]
  inventoryBatches  InventoryBatch[]
  externalPosSales  ExternalPosSale[]

  @@unique([campgroundId, name])
  @@index([campgroundId])
  @@index([isActive])
}

model LocationInventory {
  id            String   @id @default(cuid())
  productId     String
  locationId    String
  stockQty      Int      @default(0)
  lowStockAlert Int?     // Alert when stock falls below this
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt

  product  Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  location StoreLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([productId, locationId])
  @@index([productId])
  @@index([locationId])
}

model LocationPriceOverride {
  id          String   @id @default(cuid())
  productId   String
  locationId  String
  priceCents  Int      // Override price for this location
  reason      String?  // "Pool bar markup", "Clearance", etc.
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  product  Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  location StoreLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([productId, locationId])
  @@index([productId])
  @@index([locationId])
  @@index([isActive])
}

model InventoryTransfer {
  id               String                  @id @default(cuid())
  campgroundId     String
  fromLocationId   String
  toLocationId     String
  status           InventoryTransferStatus @default(pending)
  notes            String?
  requestedById    String
  approvedById     String?
  completedById    String?
  requestedAt      DateTime                @default(now())
  approvedAt       DateTime?
  completedAt      DateTime?
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @default(now()) @updatedAt

  campground   Campground              @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  fromLocation StoreLocation           @relation("TransferFrom", fields: [fromLocationId], references: [id], onDelete: Cascade)
  toLocation   StoreLocation           @relation("TransferTo", fields: [toLocationId], references: [id], onDelete: Cascade)
  requestedBy  User                    @relation("TransferRequester", fields: [requestedById], references: [id])
  approvedBy   User?                   @relation("TransferApprover", fields: [approvedById], references: [id])
  completedBy  User?                   @relation("TransferCompleter", fields: [completedById], references: [id])
  items        InventoryTransferItem[]

  @@index([campgroundId])
  @@index([fromLocationId])
  @@index([toLocationId])
  @@index([status])
}

model InventoryTransferItem {
  id         String   @id @default(cuid())
  transferId String
  productId  String
  qty        Int
  createdAt  DateTime @default(now())

  transfer InventoryTransfer @relation(fields: [transferId], references: [id], onDelete: Cascade)
  product  Product           @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([transferId])
  @@index([productId])
}

model InventoryMovement {
  id            String    @id @default(cuid())
  campgroundId  String
  productId     String
  locationId    String?   // Null for shared-mode products
  batchId       String?   // Link to specific batch if batch tracking enabled
  movementType  String    // sale, return, transfer_out, transfer_in, adjustment, restock
  qty           Int       // Positive or negative
  previousQty   Int
  newQty        Int
  referenceType String?   // order, transfer, manual
  referenceId   String?   // ID of order/transfer/etc.
  notes         String?
  actorUserId   String
  createdAt     DateTime  @default(now())

  campground     Campground      @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  product        Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  location       StoreLocation?  @relation(fields: [locationId], references: [id], onDelete: SetNull)
  actor          User            @relation(fields: [actorUserId], references: [id])
  batchMovements BatchMovement[]

  @@index([campgroundId])
  @@index([productId])
  @@index([locationId])
  @@index([batchId])
  @@index([movementType])
  @@index([createdAt])
}

// ============================================================================
// INVENTORY BATCH & EXPIRATION TRACKING
// ============================================================================

// Batch/lot tracking for inventory with expiration dates
model InventoryBatch {
  id            String    @id @default(cuid())
  campgroundId  String
  productId     String
  locationId    String?   // Null for shared-mode products

  // Batch identification
  batchNumber   String?   // Optional lot/batch number from supplier
  supplierId    String?   // Optional supplier reference

  // Quantities
  qtyReceived   Int       // Original quantity received
  qtyRemaining  Int       // Current remaining quantity

  // Dates
  receivedDate   DateTime  // When batch was received
  expirationDate DateTime? // Null for non-perishable items

  // Cost tracking
  unitCostCents Int?      // Cost per unit for this batch (COGS)

  // Status
  isActive    Boolean   @default(true)  // False when fully depleted
  depletedAt  DateTime?                 // When qtyRemaining reached 0

  // Audit
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @default(now()) @updatedAt
  createdById String?

  // Relations
  campground           Campground            @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  product              Product               @relation(fields: [productId], references: [id], onDelete: Cascade)
  location             StoreLocation?        @relation(fields: [locationId], references: [id], onDelete: SetNull)
  movements            BatchMovement[]
  markdownApplications MarkdownApplication[]

  @@index([campgroundId])
  @@index([productId])
  @@index([locationId])
  @@index([expirationDate])
  @@index([isActive, expirationDate])
  @@index([productId, locationId, isActive, expirationDate]) // FEFO query optimization
}

// Track individual batch movements (for FIFO/FEFO audit)
model BatchMovement {
  id            String   @id @default(cuid())
  batchId       String
  movementId    String?  // Links to InventoryMovement for audit trail

  // Movement details
  qty           Int      // Quantity affected (negative for deductions)
  movementType  String   // sale, return, adjustment, disposal, transfer
  referenceType String?  // order, transfer, manual, disposal
  referenceId   String?  // ID of order/transfer/etc.

  // Disposal specific
  disposalReason BatchDisposalReason?
  disposalNotes  String?

  // Audit
  previousQty Int
  newQty      Int
  actorUserId String
  createdAt   DateTime @default(now())

  batch    InventoryBatch     @relation(fields: [batchId], references: [id], onDelete: Cascade)
  movement InventoryMovement? @relation(fields: [movementId], references: [id], onDelete: SetNull)
  actor    User               @relation("BatchMovementActor", fields: [actorUserId], references: [id])

  @@index([batchId])
  @@index([movementId])
  @@index([actorUserId])
  @@index([createdAt])
}

// Category-level expiration thresholds (defaults)
model CategoryExpirationConfig {
  id           String @id @default(cuid())
  campgroundId String
  categoryId   String

  // Threshold days before expiration
  warningDays  Int @default(7)  // Days before expiration for "warning" tier
  criticalDays Int @default(2)  // Days before expiration for "critical" tier

  // Slow-moving threshold
  slowMovingDays Int @default(30) // Days without sale to be considered slow-moving

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  campground Campground      @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  category   ProductCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, categoryId])
  @@index([campgroundId])
}

// Product-level expiration threshold overrides
model ProductExpirationConfig {
  id           String @id @default(cuid())
  campgroundId String
  productId    String

  // Threshold days before expiration (override category defaults)
  warningDays  Int?
  criticalDays Int?

  // Slow-moving threshold override
  slowMovingDays Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, productId])
  @@index([campgroundId])
}

// Auto-markdown rules for expiring inventory
model MarkdownRule {
  id           String @id @default(cuid())
  campgroundId String

  // Trigger condition
  daysUntilExpiration Int // Apply when X days until expiration

  // Discount
  discountType  MarkdownDiscountType
  discountValue Int // Percentage (1-100) or flat cents

  // Scope
  scope      MarkdownScope
  categoryId String? // If scope is 'category'
  productId  String? // If scope is 'product'

  // Priority (lower = higher priority, for overlapping rules)
  priority Int @default(100)

  // Status
  isActive Boolean @default(true)

  // Audit
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
  createdById String?

  campground   Campground           @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  category     ProductCategory?     @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  product      Product?             @relation(fields: [productId], references: [id], onDelete: SetNull)
  applications MarkdownApplication[]

  @@index([campgroundId])
  @@index([categoryId])
  @@index([productId])
  @@index([isActive, daysUntilExpiration])
}

// Track markdown applications for reporting
model MarkdownApplication {
  id             String @id @default(cuid())
  campgroundId   String
  markdownRuleId String
  batchId        String
  cartId         String? // POS cart where markdown was applied

  // Markdown details
  originalPriceCents Int
  markdownPriceCents Int
  discountCents      Int // Amount discounted
  qty                Int // Quantity sold at markdown

  // Reason tracking
  daysUntilExpiration Int // Days remaining at time of sale

  createdAt DateTime @default(now())

  campground   Campground     @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  markdownRule MarkdownRule   @relation(fields: [markdownRuleId], references: [id], onDelete: Cascade)
  batch        InventoryBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([markdownRuleId])
  @@index([batchId])
  @@index([createdAt])
}

// Expiration alerts log (for tracking sent notifications)
model ExpirationAlert {
  id           String @id @default(cuid())
  campgroundId String
  batchId      String

  // Alert details
  tier           ExpirationTier
  expirationDate DateTime
  daysRemaining  Int
  productName    String  // Snapshot for historical record
  locationName   String?
  qtyRemaining   Int

  // Notification tracking
  alertedAt       DateTime  @default(now())
  acknowledgedAt  DateTime?
  acknowledgedById String?

  campground     Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  acknowledgedBy User?      @relation("AlertAcknowledger", fields: [acknowledgedById], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([batchId])
  @@index([tier])
  @@index([alertedAt])
  @@index([acknowledgedById])
}

// ============================================================================
// HOTEL OPERATIONS EXTENSION - Phase 1-5
// ============================================================================

// Structure attributes for non-RV accommodations (cabins, hotel rooms, glamping)
model StructureAttributes {
  id                String   @id @default(cuid())
  siteId            String   @unique

  // Sleeping configuration
  bedConfiguration  Json?    // [{type: "king", count: 1}, {type: "bunk", count: 2}]
  bedroomCount      Int?

  // Facilities
  bathroomCount     Int?
  bathroomType      String?  // private, shared, none
  hasKitchen        Boolean  @default(false)
  kitchenType       String?  // full, kitchenette, none
  hasHeat           Boolean  @default(false)
  hasAC             Boolean  @default(false)
  hasFireplace      Boolean  @default(false)

  // Building location (for hotel rooms)
  floorNumber       Int?
  buildingName      String?
  squareFeet        Int?

  // Views & Features
  hasBalcony        Boolean  @default(false)
  hasPatio          Boolean  @default(false)
  viewType          String?  // lake, mountain, forest, pool, parking_lot

  // Linens & Supplies
  linensProvided    Boolean  @default(true)
  towelsProvided    Boolean  @default(true)

  // Hotel-specific features
  connectingRoomIds String[] @default([])
  isConnecting      Boolean  @default(false)
  minibar           Boolean  @default(false)
  roomService       Boolean  @default(false)
  safe              Boolean  @default(false)
  coffeemaker       Boolean  @default(false)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  site              Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([siteId])
}

// Cleaning task templates - configurable per property and site type
model CleaningTaskTemplate {
  id                 String    @id @default(cuid())
  campgroundId       String
  taskType           TaskType
  siteType           SiteType? // null = applies to all site types

  name               String
  estimatedMinutes   Int
  checklist          Json      // [{id, text, required, category}]
  suppliesNeeded     Json?     // [{item, quantity}]
  priority           Int       @default(100)
  slaMinutes         Int?      // Default SLA for this task type
  requiresInspection Boolean   @default(false)

  isActive           Boolean   @default(true)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  campground         Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([taskType])
  @@index([siteType])
}

// Inspection results for housekeeping quality control
model InspectionResult {
  id              String   @id @default(cuid())
  taskId          String
  inspectorId     String

  // Inspection data
  responses       Json     // [{itemId, passed, notes, photo}]
  overallResult   String   // passed, failed, partial
  score           Int?     // Percentage score (0-100)

  // Follow-up
  failedItems     String[] @default([])
  requiresReclean Boolean  @default(false)
  notes           String?
  photos          String[] @default([])

  completedAt     DateTime @default(now())

  task            Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  inspector       User     @relation("InspectionInspector", fields: [inspectorId], references: [id])

  @@index([taskId])
  @@index([inspectorId])
}

// Cleaning zones for organizing housekeeping by building/area
model CleaningZone {
  id              String   @id @default(cuid())
  campgroundId    String
  name            String   // "Building A Floor 2", "Lakeside Loop"
  zoneType        String   // building_floor, outdoor_loop, wing, section
  parentZoneId    String?  // Hierarchy support
  primaryTeamId   String?  // Default assigned team
  color           String?  // For dashboard visualization

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  campground      Campground    @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  parentZone      CleaningZone? @relation("ZoneHierarchy", fields: [parentZoneId], references: [id])
  childZones      CleaningZone[] @relation("ZoneHierarchy")

  @@index([campgroundId])
  @@index([parentZoneId])
}

// Flex check-in/check-out policy per campground
model FlexCheckPolicy {
  id                      String   @id @default(cuid())
  campgroundId            String   @unique

  // Early check-in
  earlyCheckInEnabled     Boolean  @default(false)
  earlyCheckInMinHours    Int?     // How many hours early allowed
  earlyCheckInPricing     Json?    // {type: "flat"|"hourly", amount: cents}
  earlyCheckInAutoApprove Boolean  @default(false)

  // Late checkout
  lateCheckoutEnabled     Boolean  @default(false)
  lateCheckoutMaxHours    Int?     // How many hours late allowed
  lateCheckoutPricing     Json?    // {type: "flat"|"hourly", amount: cents}
  lateCheckoutAutoApprove Boolean  @default(false)

  // VIP overrides
  vipEarlyFree            Boolean  @default(false)
  vipLateFree             Boolean  @default(false)

  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  campground              Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
}

// Room move/upgrade requests during a stay
model RoomMoveRequest {
  id                  String    @id @default(cuid())
  campgroundId        String
  reservationId       String
  fromSiteId          String
  toSiteId            String

  // Move details
  moveDate            DateTime
  moveReason          String    // guest_request, maintenance, upgrade, downgrade, overbooking
  isComplimentary     Boolean   @default(false)
  priceDifference     Int?      // Positive = guest pays, negative = refund

  // Status workflow
  status              String    @default("requested") // requested, approved, in_progress, completed, cancelled

  // Logistics
  luggageAssistance   Boolean   @default(false)
  newKeysIssued       Boolean   @default(false)

  // Audit
  requestedById       String
  approvedById        String?
  completedById       String?
  completedAt         DateTime?
  notes               String?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  campground          Campground  @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  reservation         Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  fromSite            Site        @relation("RoomMoveFrom", fields: [fromSiteId], references: [id])
  toSite              Site        @relation("RoomMoveTo", fields: [toSiteId], references: [id])
  requestedBy         User        @relation("RoomMoveRequester", fields: [requestedById], references: [id])
  approvedBy          User?       @relation("RoomMoveApprover", fields: [approvedById], references: [id])
  completedBy         User?       @relation("RoomMoveCompleter", fields: [completedById], references: [id])

  @@index([campgroundId])
  @@index([reservationId])
  @@index([status])
}

// Group bookings for multi-room coordination
model GroupBooking {
  id                  String   @id @default(cuid())
  campgroundId        String

  // Group info
  groupName           String
  primaryGuestId      String
  groupType           String   // family, corporate, wedding, reunion, tour, sports_team

  // Room preferences
  preferAdjacent      Boolean  @default(false)
  preferSameFloor     Boolean  @default(false)
  preferConnecting    Boolean  @default(false)
  preferredZone       String?  // Building/area preference

  // Assignment status
  assignmentStatus    String   @default("pending") // pending, partial, complete, confirmed

  // Billing
  billingType         String   @default("individual") // individual, master_folio, split
  masterFolioId       String?  // If using master folio billing

  // Coordination
  groupArrivalTime    String?  // Coordinated arrival time
  groupDepartureTime  String?  // Coordinated departure time
  welcomeAmenity      String?  // Special welcome setup
  groupNotes          String?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  campground          Campground    @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  primaryGuest        Guest         @relation("GroupPrimaryGuest", fields: [primaryGuestId], references: [id])
  reservations        Reservation[]

  @@index([campgroundId])
  @@index([primaryGuestId])
  @@index([assignmentStatus])
}

// =============================================================================
// 3RD PARTY POS INTEGRATION MODELS
// =============================================================================

// Records sales from external POS systems (via Partner API)
model ExternalPosSale {
  id                    String    @id @default(cuid())
  campgroundId          String
  externalTransactionId String
  provider              String?   // "partner_api" | "lightspeed" | "shopify" etc
  apiClientId           String?   // Which API client recorded this sale

  items                 Json      // Array of { sku, qty, priceCents, batchId?, markdownApplied? }
  totalCents            Int
  paymentMethod         String?
  locationId            String?

  inventoryDeducted     Boolean   @default(false)
  saleDate              DateTime
  metadata              Json?     // Additional provider-specific data

  createdAt             DateTime  @default(now())

  campground            Campground     @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  location              StoreLocation? @relation(fields: [locationId], references: [id], onDelete: SetNull)
  apiClient             ApiClient?     @relation(fields: [apiClientId], references: [id], onDelete: SetNull)

  @@unique([campgroundId, externalTransactionId])
  @@index([campgroundId, saleDate])
  @@index([apiClientId])
}

// Maps internal products to external POS system product IDs
model ProductExternalMapping {
  id             String    @id @default(cuid())
  campgroundId   String
  productId      String
  provider       PosProviderType
  externalId     String    // ID in external system
  externalSku    String?   // SKU in external system

  lastSyncedAt   DateTime?
  syncStatus     String?   // "synced" | "pending" | "error"
  syncError      String?
  metadata       Json?     // Provider-specific mapping data

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  campground     Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  product        Product    @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, provider, externalId])
  @@unique([campgroundId, provider, productId])
  @@index([campgroundId, provider])
  @@index([productId])
}
