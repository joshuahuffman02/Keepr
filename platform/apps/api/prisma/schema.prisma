// Prisma Client Generator - Cache bust: 2025-12-26-v6
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum ReservationStatus {
  pending
  confirmed
  checked_in
  checked_out
  cancelled
}

enum SiteType {
  // Outdoor/Camping
  rv
  tent
  cabin
  group
  glamping

  // Hotel/Lodge Types
  hotel_room
  suite
  lodge_room

  // Glamping Structures
  yurt
  treehouse
  tiny_house
  airstream
  safari_tent
  dome

  // Specialty
  boat_slip
}

enum MaintenanceStatus {
  open
  in_progress
  closed
}

enum MaintenancePriority {
  low
  medium
  high
  critical
}

enum CampaignStatus {
  draft
  scheduled
  sending
  sent
  cancelled
}

enum CampaignSendStatus {
  queued
  sent
  failed
  unsubscribed
}

enum SupportReportStatus {
  new
  triage
  in_progress
  resolved
  closed
}

enum ChannelType {
  email
  sms
  both
}

enum UserRole {
  owner
  manager
  front_desk
  maintenance
  finance
  marketing
  readonly
}

enum SenderType {
  guest
  staff
}

enum TaxRuleType {
  percentage
  flat
  exemption
}

enum RateType {
  nightly
  weekly
  monthly
  seasonal
}

enum StayType {
  standard
  weekly
  monthly
  seasonal
}

enum StayReasonPreset {
  vacation
  family_visit
  event
  work_remote
  stopover
  relocation
  other
}

enum ReferralIncentiveType {
  percent_discount
  amount_discount
  credit
}

enum PaymentSchedule {
  single
  weekly
  monthly
  as_you_stay
  offseason_installments
}

enum PricingStructure {
  per_night
  flat_week
  flat_month
  flat_season
}

enum ChargeStatus {
  pending
  paid
  failed
}

// Phase 2 housekeeping/maintenance/group bookings
enum TaskType {
  // Existing
  turnover
  inspection
  other

  // Hotel-level cleaning
  deep_clean
  touch_up
  make_ready
  checkout_express
  vip_prep
  pet_treatment
  linen_change
  restocking
}

// Hotel-level housekeeping status state machine
enum HousekeepingStatus {
  // Vacant states
  vacant_dirty
  cleaning_in_progress
  pending_inspection
  inspection_failed
  vacant_clean
  vacant_inspected

  // Occupied states
  occupied
  occupied_service // Can receive housekeeping service
  occupied_dnd // Do Not Disturb

  // Blocked states
  out_of_order // Maintenance issue
  out_of_inventory // Offline (renovations, seasonal)
}

enum TaskState {
  pending
  in_progress
  blocked
  done
  failed
  expired
}

enum SlaStatus {
  on_track
  at_risk
  breached
}

enum TicketState {
  open
  in_progress
  blocked
  resolved
  reopened
  closed
}

enum TicketCategory {
  issue
  question
  feature
  other
}

enum Severity {
  low
  med
  high
  critical
}

enum CheckInStatus {
  not_started
  pending_id
  pending_payment
  pending_waiver
  pending_site_ready
  completed
  failed
}

enum CheckOutStatus {
  not_started
  pending_review
  completed
  failed
}

enum IncidentStatus {
  open
  investigating
  resolved
  closed
}

enum IncidentType {
  injury
  property_damage
  safety
  security
  near_miss
  environmental
  other
}

enum IncidentTaskStatus {
  pending
  in_progress
  done
  cancelled
}

enum EvidenceType {
  photo
  document
  note
  audio
  video
  other
}

enum GroupRole {
  primary
  member
}

// ---------------------------------------------------------------------------
// Social Media Planner enums
// ---------------------------------------------------------------------------

enum SocialPlatform {
  facebook
  instagram
  tiktok
  email
  blog
}

enum SocialPostStatus {
  draft
  scheduled
  needs_image
  needs_approval
  ready
  completed
  dismissed
}

enum SocialContentCategory {
  amenities
  events
  offers
  reviews
  tips
  general
  promo
}

enum SocialTemplateStyle {
  short
  detailed
  story
  carousel
  announce
}

enum SocialAssetType {
  photo
  video
  logo
  template
  other
}

enum SocialSuggestionType {
  idea
  auto
  operator
  occupancy
  event
  deal
  seasonal
}

enum SocialSuggestionStatus {
  new
  accepted
  rejected
  published
}

enum ApprovalStatus {
  pending
  approved
  rejected
}

enum PermissionEffect {
  allow
  deny
}

enum PlatformRole {
  support_agent
  support_lead
  regional_support
  ops_engineer
  platform_admin
}

enum PiiClassification {
  basic
  sensitive
  payment
  secret
}

enum RedactionMode {
  mask
  remove
}

enum ConsentMethod {
  verbal
  written
  digital
}

enum SocialAlertCategory {
  weather
  occupancy
  events
  deals
  reviews
  inactivity
  inventory
}

enum OnboardingStatus {
  pending
  in_progress
  completed
  expired
  cancelled
}

enum OnboardingStep {
  // New step names
  park_profile
  operational_hours
  stripe_connect
  inventory_choice
  data_import
  site_classes
  sites_builder
  rate_periods
  rates_setup
  fees_and_addons
  tax_rules
  booking_rules
  deposit_policy
  cancellation_rules
  waivers_documents
  park_rules
  team_setup
  communication_setup
  integrations
  review_launch
  // Legacy step names (for backwards compatibility)
  account_profile
  payment_gateway
  taxes_and_fees
  inventory_sites
  rates_and_fees
  policies
  communications_templates
  pos_hardware
  imports
}

model User {
  id                 String        @id @default(cuid())
  email              String        @unique
  passwordHash       String
  firstName          String
  lastName           String
  region             String?
  platformRole       PlatformRole?
  platformRegion     String?
  platformActive     Boolean       @default(true)
  ownershipRoles     String[]      @default([])
  isActive           Boolean       @default(true)
  mustChangePassword Boolean       @default(false) // Force password change on first login

  // 2FA/MFA (TOTP)
  totpEnabled       Boolean   @default(false) // Is 2FA enabled
  totpSecret        String? // Encrypted TOTP secret
  totpPendingSecret String? // Temp secret during setup
  totpBackupCodes   Json? // Hashed backup codes
  totpEnabledAt     DateTime? // When 2FA was enabled

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  memberships                      CampgroundMembership[]
  maintenanceTickets               MaintenanceTicket[]
  internalMessages                 InternalMessage[]
  internalConversationParticipants InternalConversationParticipant[]
  inviteTokens                     InviteToken[]
  auditLogs                        AuditLog[]
  storeOrdersCompleted             StoreOrder[]                      @relation("OrderCompletedBy")
  storeOrdersAssigned              StoreOrder[]                      @relation("OrderAssignedBy")
  storeAdjustmentsCreated          StoreOrderAdjustment[]            @relation("StoreAdjustmentCreatedBy")
  supportReportsAuthored           SupportReport[]                   @relation("ReportAuthor")
  supportReportsAssigned           SupportReport[]                   @relation("ReportAssignee")
  uploadedAssets                   SocialContentAsset[]              @relation("AssetUploader")
  xpRulesCreated                   XpRule[]                          @relation("XpRuleCreator")
  xpBalances                       XpBalance[]
  xpEvents                         XpEvent[]
  pushSubscriptions                PushSubscription[]
  integrationExportJobs            IntegrationExportJob[]
  auditExports                     AuditExport[]
  piiFieldTags                     PiiFieldTag[]
  approvalPolicies                 ApprovalPolicy[]
  permissionRules                  PermissionRule[]
  approvedCommunicationTemplates   CommunicationTemplate[]           @relation("CommunicationTemplateApprovedBy")
  onboardingInvites                OnboardingInvite[]
  staffTimeEntries                 StaffTimeEntry[]                  @relation("StaffTimeEntries")
  staffTimeEntriesApproved         StaffTimeEntry[]                  @relation("StaffTimeEntryApprover")
  shiftApprovals                   ShiftApproval[]                   @relation("ShiftApprover")
  overrideRequestsRequested        OverrideRequest[]                 @relation("OverrideRequester")
  overrideRequestsApproved         OverrideRequest[]                 @relation("OverrideApprover")
  timeOffRequestsRequested         TimeOffRequest[]                  @relation("TimeOffRequester")
  timeOffRequestsReviewed          TimeOffRequest[]                  @relation("TimeOffReviewer")
  availabilityOverrides            AvailabilityOverride[]            @relation("AvailabilityOverrides")
  shiftSwapsRequested              ShiftSwapRequest[]                @relation("SwapRequester")
  shiftSwapsReceived               ShiftSwapRequest[]                @relation("SwapRecipient")
  shiftSwapsManaged                ShiftSwapRequest[]                @relation("SwapManager")
  scheduleTemplates                ScheduleTemplate[]                @relation("ScheduleTemplateCreator")
  payrollExportsRequested          PayrollExport[]                   @relation("PayrollExportRequester")
  payrollExportLines               PayrollExportLine[]               @relation("PayrollExportUser")

  // Phase 3 relations
  staffShifts         StaffShift[]         @relation("StaffShifts")
  staffAvailability   StaffAvailability[]  @relation("StaffAvailability")
  pushNotifications   PushNotification[]   @relation("PushNotifications")
  staffPerformance    StaffPerformance[]   @relation("StaffPerformance")
  savedReports        SavedReport[]        @relation("SavedReports")
  portfolioDashboards PortfolioDashboard[] @relation("PortfolioDashboards")
  tillSessionsOpened  TillSession[]        @relation("TillSessionOpenedBy")
  tillSessionsClosed  TillSession[]        @relation("TillSessionClosedBy")
  tillMovements       TillMovement[]       @relation("TillMovementActor")

  // Multi-location inventory relations
  transfersRequested InventoryTransfer[] @relation("TransferRequester")
  transfersApproved  InventoryTransfer[] @relation("TransferApprover")
  transfersCompleted InventoryTransfer[] @relation("TransferCompleter")
  inventoryMovements InventoryMovement[]

  // Inventory batch tracking relations
  batchMovements               BatchMovement[]   @relation("BatchMovementActor")
  expirationAlertsAcknowledged ExpirationAlert[] @relation("AlertAcknowledger")

  // Hotel operations relations
  inspectionsPerformed InspectionResult[] @relation("InspectionInspector")
  roomMovesRequested   RoomMoveRequest[]  @relation("RoomMoveRequester")
  roomMovesApproved    RoomMoveRequest[]  @relation("RoomMoveApprover")
  roomMovesCompleted   RoomMoveRequest[]  @relation("RoomMoveCompleter")

  // Unified Operations / Task Management relations
  opTeamMemberships      OpTeamMember[]     @relation("UserOpTeamMemberships")
  opTaskTemplatesDefault OpTaskTemplate[]   @relation("TemplateDefaultAssignee")
  opTaskTriggersAssigned OpTaskTrigger[]    @relation("TriggerAssignToUser")
  opRecurrenceAssigned   OpRecurrenceRule[] @relation("RecurrenceAssignToUser")
  opTasksAssigned        OpTask[]           @relation("OpTaskAssignedToUser")
  opTasksCompleted       OpTask[]           @relation("OpTaskCompletedBy")
  opTasksVerified        OpTask[]           @relation("OpTaskVerifiedBy")
  opTasksEscalated       OpTask[]           @relation("OpTaskEscalatedTo")
  opTasksCreated         OpTask[]           @relation("OpTaskCreatedBy")
  opTaskComments         OpTaskComment[]    @relation("OpTaskCommentAuthor")

  // Gamification relations
  opStaffStats OpStaffStats[]      @relation("UserOpStats")
  opDailyStats OpStaffDailyStats[] @relation("UserOpDailyStats")
  opBadges     OpStaffBadge[]      @relation("UserOpBadges")

  // Customizable menu configuration
  menuConfig      UserMenuConfig?
  featureProgress FeatureProgress[]
}

// User's customizable sidebar menu configuration
model UserMenuConfig {
  id                String   @id @default(cuid())
  userId            String   @unique
  pinnedPages       String[] @default([]) // hrefs pinned to sidebar
  sidebarCollapsed  Boolean  @default(false)
  migratedFromLocal Boolean  @default(false) // track localStorage migration
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Tracks which features a user has explored/tried
model FeatureProgress {
  id          String    @id @default(cuid())
  userId      String
  featureKey  String // matches page-registry key or feature identifier
  completed   Boolean   @default(false)
  completedAt DateTime?
  notes       String? // optional user notes
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, featureKey])
  @@index([userId])
}

model GuestEquipment {
  id          String   @id @default(cuid())
  guestId     String
  type        String // rv, trailer, tent, car
  make        String?
  model       String?
  length      Int? // in feet
  plateNumber String?
  plateState  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  guest Guest @relation(fields: [guestId], references: [id], onDelete: Cascade)

  @@index([guestId])
}

model CampgroundMembership {
  id           String   @id @default(cuid())
  userId       String
  campgroundId String
  role         UserRole
  createdAt    DateTime @default(now())

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  xpEvents   XpEvent[]

  @@unique([userId, campgroundId])
  @@index([campgroundId])
}

model SupportReport {
  id             String              @id @default(uuid())
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  description    String
  steps          String?
  contactEmail   String?
  path           String?
  userAgent      String?
  language       String?
  timezone       String?
  viewportWidth  Int?
  viewportHeight Int?
  roleFilter     String?
  pinnedIds      String[]
  recentIds      String[]
  rawContext     Json?
  status         SupportReportStatus @default(new)
  assigneeId     String?
  assignee       User?               @relation("ReportAssignee", fields: [assigneeId], references: [id])
  authorId       String?
  author         User?               @relation("ReportAuthor", fields: [authorId], references: [id])
  campgroundId   String?
  campground     Campground?         @relation("ReportCampground", fields: [campgroundId], references: [id])
}

model SiteClass {
  id                          String   @id @default(cuid())
  campgroundId                String
  name                        String
  description                 String?
  defaultRate                 Int      @default(0)
  siteType                    SiteType
  maxOccupancy                Int
  rigMaxLength                Int? // @deprecated - use Site.rigMaxLength instead
  hookupsPower                Boolean  @default(false)
  hookupsWater                Boolean  @default(false)
  hookupsSewer                Boolean  @default(false)
  // RV-specific configuration
  rvOrientation               String? // "back_in" | "pull_through"
  electricAmps                Int[]    @default([]) // Available amp options: 20, 30, 50, 100
  // Metered utilities defaults for sites in this class
  meteredEnabled              Boolean  @default(false)
  meteredType                 String? // power|water|sewer
  meteredBillingMode          String? // cycle|per_reading|annual|manual
  meteredBillTo               String? // reservation|guest
  meteredMultiplier           Decimal? @default(1.0)
  meteredRatePlanId           String?
  meteredAutoEmail            Boolean  @default(false)
  tags                        String[] @default([])
  amenityTags                 String[] @default([])
  glCode                      String?
  clientAccount               String?
  minNights                   Int?
  maxNights                   Int?
  sameDayBookingCutoffMinutes Int? // Minutes before office close to cut off same-day bookings. null = use default (0 for RV, 60 for cabin/lodging)
  petFriendly                 Boolean  @default(true)
  accessible                  Boolean  @default(false)
  photos                      String[] @default([])
  photoAttributions           Json?
  policyVersion               String?
  isActive                    Boolean  @default(true)

  // Rental type
  rentalType String @default("transient") // "transient" | "seasonal" | "flexible"

  // Equipment & dimensions
  equipmentTypes    String[] @default([])
  slideOutsAccepted String? // "both_sides" | "driver_side" | "passenger_side" | "none"

  // Guest pricing
  occupantsIncluded  Int  @default(2)
  extraAdultFeeCents Int?
  extraChildFeeCents Int?

  // Fees (per site class)
  petFeeEnabled    Boolean @default(false)
  petFeeCents      Int?
  bookingFeeCents  Int?
  siteLockFeeCents Int?

  // Monthly/seasonal rates
  monthlyRateCents Int?
  weeklyRateCents  Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  campground        Campground          @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  sites             Site[]
  pricingRules      PricingRule[]
  pricingRulesV2    PricingRuleV2[]
  seasonalRates     SeasonalRate[]
  otaMappings       OtaListingMapping[] @relation("SiteClassOtaMappings")
  analyticsEvents   AnalyticsEvent[]
  demandBands       DemandBand[]
  upsellItems       UpsellItem[]
  depositPolicies   DepositPolicy[]
  waitlistEntries   WaitlistEntry[]
  documentTemplates DocumentTemplate[]

  @@index([campgroundId])
}

enum SubscriptionTier {
  free
  starter
  professional
  enterprise
}

enum BillingPlan {
  ota_only // OTA-only, per-booking fee (default $3)
  standard // Core product, per-booking fee (default $2)
  enterprise // Flat monthly + low per-booking fee (default $1 + monthly)
}

enum EarlyAccessTier {
  founders_circle // 5 spots, $0/mo forever, $0.75/booking
  pioneer // 15 spots, $0/mo 12mo, $1.00/booking
  trailblazer // 25 spots, $14.50/mo 6mo, $1.25/booking
}

enum PaymentFeeMode {
  absorb // Platform fee is absorbed by campground (reduces payout)
  pass_through // Platform fee added to guest total
}

enum PaymentGatewayProvider {
  stripe
  adyen
  authorize_net
  other
}

enum PaymentGatewayMode {
  test
  prod
}

enum NpsSurveyStatus {
  draft
  active
  paused
  archived
}

enum NpsInviteStatus {
  queued
  sent
  bounced
  opened
  responded
  expired
}

enum ReviewStatus {
  pending
  approved
  rejected
  removed
}

enum ReviewSource {
  onsite
  email
  sms
  kiosk
  import
}

enum ReviewExposure {
  private
  public
}

enum ReviewVoteValue {
  helpful
  not_helpful
}

enum ReviewModerationStatus {
  pending
  approved
  rejected
}

// =============================================================================
// Analytics & Data Intelligence
// =============================================================================

enum AnalyticsEventName {
  page_view
  site_card_view
  image_viewed
  image_hovered
  image_clicked
  site_class_viewed
  availability_check
  add_to_stay
  reservation_start
  reservation_abandoned
  reservation_completed
  deal_viewed
  deal_applied
  email_signup
  review_viewed
  admin_pricing_change
  admin_image_reorder
}

enum AbTestStatus {
  draft
  active
  paused
  stopped
  completed
}

model AnalyticsEvent {
  id             String             @id @default(cuid())
  campgroundId   String?
  organizationId String?
  reservationId  String?
  siteId         String?
  siteClassId    String?
  promotionId    String?
  imageId        String?
  sessionId      String
  eventName      AnalyticsEventName
  page           String?
  referrer       String?
  referrerUrl    String?
  deviceType     String?
  region         String?
  abVariantId    String?
  metadata       Json?
  occurredAt     DateTime           @default(now())
  createdAt      DateTime           @default(now())

  campground   Campground?   @relation(fields: [campgroundId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  reservation  Reservation?  @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  site         Site?         @relation(fields: [siteId], references: [id], onDelete: SetNull)
  siteClass    SiteClass?    @relation(fields: [siteClassId], references: [id], onDelete: SetNull)
  promotion    Promotion?    @relation(fields: [promotionId], references: [id], onDelete: SetNull)
  abVariant    AbVariant?    @relation(fields: [abVariantId], references: [id], onDelete: SetNull)

  @@index([campgroundId, occurredAt])
  @@index([organizationId, occurredAt])
  @@index([sessionId, occurredAt])
  @@index([eventName, occurredAt])
  @@index([siteId])
  @@index([siteClassId])
  @@index([promotionId])
  @@index([abVariantId])
}

model AnalyticsDailyAggregate {
  id             String             @id @default(cuid())
  campgroundId   String?
  organizationId String?
  eventName      AnalyticsEventName
  date           DateTime
  count          Int                @default(0)
  uniqueSessions Int?               @default(0)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @default(now()) @updatedAt

  campground   Campground?   @relation(fields: [campgroundId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  @@unique([campgroundId, eventName, date])
  @@index([organizationId, eventName, date])
}

model AbTest {
  id             String       @id @default(cuid())
  campgroundId   String?
  organizationId String?
  key            String       @unique
  name           String
  description    String?
  status         AbTestStatus @default(draft)
  startedAt      DateTime?
  endedAt        DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now()) @updatedAt

  campground   Campground?    @relation(fields: [campgroundId], references: [id], onDelete: SetNull)
  organization Organization?  @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  variants     AbVariant[]
  enrollments  AbEnrollment[]

  @@index([campgroundId, status])
  @@index([organizationId, status])
}

model AbVariant {
  id          String   @id @default(cuid())
  testId      String
  name        String
  description String?
  weight      Int? // optional rollout weight
  createdAt   DateTime @default(now())

  test        AbTest           @relation(fields: [testId], references: [id], onDelete: Cascade)
  events      AnalyticsEvent[]
  enrollments AbEnrollment[]

  @@index([testId])
}

model AbEnrollment {
  id             String   @id @default(cuid())
  testId         String
  variantId      String
  campgroundId   String?
  organizationId String?
  sessionId      String
  enrolledAt     DateTime @default(now())

  test         AbTest        @relation(fields: [testId], references: [id], onDelete: Cascade)
  variant      AbVariant     @relation(fields: [variantId], references: [id], onDelete: Cascade)
  campground   Campground?   @relation(fields: [campgroundId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  @@unique([testId, sessionId])
  @@index([campgroundId])
  @@index([organizationId])
}

// =============================================================================
// Gamification
// =============================================================================

enum GamificationEventCategory {
  task
  maintenance
  check_in
  reservation_quality
  checklist
  review_mention
  on_time_assignment
  assist
  manual
  other
}

model Organization {
  id   String @id @default(cuid())
  name String

  // Billing & subscription
  subscriptionTier     SubscriptionTier @default(free)
  billingEmail         String?
  billingName          String?
  billingAddress1      String?
  billingAddress2      String?
  billingCity          String?
  billingState         String?
  billingPostalCode    String?
  billingCountry       String?
  stripeCustomerId     String?          @unique
  stripeSubscriptionId String?          @unique
  subscriptionStatus   String? // active, past_due, canceled, trialing
  billingTier          String?          @default("standard") // founders_circle, pioneer, trailblazer, standard
  billingStatus        String?          @default("active") // active, suspended, cancelled
  trialEndsAt          DateTime?
  dataRegion           String           @default("us-east-1")

  campgrounds              Campground[]
  analyticsEvents          AnalyticsEvent[]
  analyticsDailyAggregates AnalyticsDailyAggregate[]
  abTests                  AbTest[]
  abEnrollments            AbEnrollment[]
  integrationConnections   IntegrationConnection[]
  onboardingInvites        OnboardingInvite[]
  onboardingSessions       OnboardingSession[]

  // Phase 3 relations
  portfolioDashboards   PortfolioDashboard[]
  portfolioMetrics      PortfolioMetric[]
  centralizedRatePushes CentralizedRatePush[]

  // Early access program
  earlyAccessEnrollment EarlyAccessEnrollment?

  // Referral program
  referralCode      String?       @unique // Unique code for this org to share
  referralCredits   Int           @default(0) // Total credits earned in cents
  referralsGiven    OrgReferral[] @relation("ReferrerOrg")
  referralsReceived OrgReferral[] @relation("ReferredOrg")

  // Organization billing (what Camp Everyday charges them)
  billingPeriods OrganizationBillingPeriod[]
  usageEvents    UsageEvent[]
  setupServices  SetupService[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model Campground {
  id                String  @id @default(cuid())
  organizationId    String
  name              String
  slug              String  @unique
  isExternal        Boolean @default(false)
  isBookable        Boolean @default(true)
  externalUrl       String?
  nonBookableReason String?

  // Location
  city       String?
  state      String?
  country    String?
  address1   String?
  address2   String?
  postalCode String?
  latitude   Decimal? @db.Decimal(12, 8)
  longitude  Decimal? @db.Decimal(12, 8)
  timezone   String?  @default("UTC")
  currency   String   @default("USD") // ISO 4217 currency code
  taxId      String? // e.g. VAT number, EIN
  taxIdName  String   @default("Tax ID") // Label for the tax ID field (e.g. "VAT Reg No")

  // Contact
  phone                  String?
  email                  String?
  website                String?
  facebookUrl            String?
  instagramUrl           String?
  dataSource             String?
  dataSourceId           String?
  dataSourceUpdatedAt    DateTime?
  dataImportNotes        String?
  provenance             Json?
  gaMeasurementId        String?
  metaPixelId            String?
  // AI Features
  aiEnabled              Boolean   @default(false) // Master toggle for all AI features
  aiReplyAssistEnabled   Boolean   @default(false) // Staff reply suggestions
  aiBookingAssistEnabled Boolean   @default(false) // Consumer booking assistant
  aiAnalyticsEnabled     Boolean   @default(false) // AI-powered insights
  aiForecastingEnabled   Boolean   @default(false) // Demand forecasting
  aiAnonymizationLevel   String    @default("strict") // strict, moderate, minimal
  aiProvider             String    @default("openai") // openai, anthropic, local
  aiApiKey               String? // Encrypted API key for AI provider
  aiConsentCollected     Boolean   @default(false)
  aiConsentCollectedAt   DateTime?
  aiMonthlyBudgetCents   Int? // Optional spending cap
  aiTotalTokensUsed      Int       @default(0) // Running total for billing

  // NPS/Reviews
  npsAutoSendEnabled Boolean @default(false)
  npsSendHour        Int?    @default(7)
  npsTemplateId      String?
  npsSchedule        Json?   @default("[]")

  // Public listing
  description    String?   @db.Text
  tagline        String? // Short marketing tagline
  amenities      String[]  @default([])
  photos         String[]  @default([]) // Array of photo URLs
  photosMeta     Json?
  heroImageUrl   String? // Main hero image for public page
  isPublished    Boolean   @default(false) // Whether visible on public marketplace
  amenitySummary Json?
  faqs           Json? // Array of { question: string, answer: string, order: number }
  importedAt     DateTime?

  // Operations
  seasonStart           DateTime?
  seasonEnd             DateTime?
  checkInTime           String?   @default("15:00")
  checkOutTime          String?   @default("11:00")
  officeClosesAt        String?   @default("17:00") // HH:mm - when office closes, used for booking cutoffs
  parkTimeZone          String?
  slaMinutes            Int?      @default(30)
  senderDomain          String?
  senderDomainStatus    String? // verified | failed | pending | unknown
  senderDomainCheckedAt DateTime?
  senderDomainDmarc     String?
  senderDomainSpf       String?
  quietHoursStart       String? // HH:mm
  quietHoursEnd         String? // HH:mm
  routingAssigneeId     String?

  // Long-term settings
  longTermEnabled   Boolean @default(false)
  longTermMinNights Int?    @default(28)
  longTermAutoApply Boolean @default(true)

  // Booking tracking
  bookingSources String[] @default([])
  stayReasons    String[] @default([])

  // Branding
  logoUrl        String?
  primaryColor   String?
  accentColor    String?
  brandingNote   String?
  secondaryColor String?
  buttonColor    String?
  brandFont      String?
  emailHeader    String?
  receiptFooter  String?

  // Financial
  taxState                    Decimal?       @db.Decimal(10, 4)
  taxLocal                    Decimal?       @db.Decimal(10, 4)
  depositRule                 String? // e.g., none, full, half, first_night, first_night_fees, percentage
  depositPercentage           Int? // For percentage rule (0-100)
  depositConfig               Json?
  defaultDepositPolicyId      String?        @unique
  cancellationPolicyType      String? // flexible, moderate, strict, custom
  cancellationWindowHours     Int? // hours before arrival to allow refund
  cancellationFeeType         String? // flat, percent, first_night
  cancellationFeeFlatCents    Int?
  cancellationFeePercent      Int?
  cancellationNotes           String?        @db.Text
  storeOpenHour               Int? // 0-23
  storeCloseHour              Int? // 0-23
  orderWebhookUrl             String?
  stripeAccountId             String?        @unique
  applicationFeeFlatCents     Int?           @default(300) // Legacy per-booking fee in cents
  billingPlan                 BillingPlan    @default(ota_only)
  perBookingFeeCents          Int?           @default(300) // If null, fall back to plan default
  monthlyFeeCents             Int? // For enterprise plans (e.g., 50000 = $500)
  feeMode                     PaymentFeeMode @default(absorb)
  stripeCapabilities          Json?
  stripeCapabilitiesFetchedAt DateTime?
  reviewScore                 Decimal?       @db.Decimal(4, 2)
  reviewCount                 Int            @default(0)
  reviewSources               Json?
  reviewsUpdatedAt            DateTime?

  // Public booking page settings
  showPublicMap Boolean @default(false)

  // ADA Accessibility Certification
  adaCertificationLevel  String?   @default("none") // none, friendly, compliant, excellence
  adaAssessment          Json? // Stores checklist completion data
  adaAssessmentUpdatedAt DateTime?
  adaAccessibleSiteCount Int       @default(0) // Number of accessible sites
  adaTotalSiteCount      Int       @default(0) // Total sites for percentage calculation
  adaVerified            Boolean   @default(false) // Third-party verified
  adaVerifiedAt          DateTime?
  adaVerifiedBy          String? // Staff ID or "self-reported"

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  organization              Organization                    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  siteClasses               SiteClass[]
  sites                     Site[]
  reservations              Reservation[]
  maintenance               MaintenanceTicket[]
  incidents                 Incident[]
  certificatesOfInsurance   CertificateOfInsurance[]
  documentTemplates         DocumentTemplate[]
  billingCycles             BillingCycle[]
  invoices                  Invoice[]
  signatureRequests         SignatureRequest[]
  signatureArtifacts        SignatureArtifact[]
  coiUploads                CoiUpload[]
  pricingRules              PricingRule[]
  pricingRulesV2            PricingRuleV2[]
  demandBands               DemandBand[]                    @relation("CampgroundDemandBands")
  depositPolicies           DepositPolicy[]                 @relation("CampgroundDepositPolicies")
  payments                  Payment[]
  paymentGatewayConfig      CampgroundPaymentGatewayConfig?
  ledgerEntries             LedgerEntry[]
  glPeriods                 GlPeriod[]
  memberships               CampgroundMembership[]
  events                    Event[]
  productCategories         ProductCategory[]
  products                  Product[]
  addOnServices             AddOnService[]
  storeOrders               StoreOrder[]
  blackoutDates             BlackoutDate[]
  messages                  Message[]
  communications            Communication[]
  promotions                Promotion[]
  waitlistEntries           WaitlistEntry[]
  taxRules                  TaxRule[]
  seasonalRates             SeasonalRate[]
  defaultDepositPolicy      DepositPolicy?                  @relation("CampgroundDefaultDepositPolicy", fields: [defaultDepositPolicyId], references: [id], onDelete: SetNull)
  activities                Activity[]
  activityBundles           ActivityBundle[]
  membershipTypes           MembershipType[]
  operationalTasks          OperationalTask[]
  internalConversations     InternalConversation[]
  siteHolds                 SiteHold[]
  siteMapLayouts            SiteMapLayout[]
  siteMapShapes             SiteMapShape[]
  siteMapAssignments        SiteMapAssignment[]
  mapConfig                 CampgroundMapConfig?
  inviteTokens              InviteToken[]
  auditLogs                 AuditLog[]
  campaigns                 Campaign[]
  campaignTemplates         CampaignTemplate[]
  campaignSends             CampaignSend[]                  @relation("CampgroundCampaignSends")
  otaChannels               OtaChannel[]                    @relation("CampgroundOtaChannels")
  npsSurveys                NpsSurvey[]
  npsInvites                NpsInvite[]
  npsResponses              NpsResponse[]
  reviewRequests            ReviewRequest[]
  reviews                   Review[]
  reviewVotes               ReviewVote[]
  supportReports            SupportReport[]                 @relation("ReportCampground")
  formTemplates             FormTemplate[]
  payouts                   Payout[]
  disputes                  Dispute[]
  utilityRatePlans          UtilityRatePlan[]
  utilityMeters             UtilityMeter[]
  smartLocks                SmartLock[]
  qrCodes                   QRCode[]
  lockCodes                 LockCode[]
  stayRules                 StayRule[]
  lateFeeRules              LateFeeRule[]
  analyticsEvents           AnalyticsEvent[]
  analyticsDailyAggregates  AnalyticsDailyAggregate[]
  abTests                   AbTest[]
  abEnrollments             AbEnrollment[]
  referralPrograms          ReferralProgram[]
  onboardingInvites         OnboardingInvite[]
  onboardingSessions        OnboardingSession[]
  socialPosts               SocialPost[]
  socialTemplates           SocialTemplate[]
  socialContentAssets       SocialContentAsset[]
  socialSuggestions         SocialSuggestion[]
  socialWeeklyIdeas         SocialWeeklyIdea[]
  socialStrategies          SocialStrategy[]
  socialOpportunityAlerts   SocialOpportunityAlert[]
  upsellItems               UpsellItem[]
  upsellBundles             UpsellBundle[]
  socialPerformanceInputs   SocialPerformanceInput[]
  gamificationSetting       GamificationSetting?
  xpRules                   XpRule[]
  xpBalances                XpBalance[]
  xpEvents                  XpEvent[]
  pushSubscriptions         PushSubscription[]
  privacySetting            PrivacySetting?
  consentLogs               ConsentLog[]
  approvalRequests          ApprovalRequest[]
  auditExports              AuditExport[]
  approvalPolicies          ApprovalPolicy[]
  permissionRules           PermissionRule[]
  integrationConnections    IntegrationConnection[]
  integrationExportJobs     IntegrationExportJob[]
  apiClients                ApiClient[]
  webhookEndpoints          WebhookEndpoint[]
  communicationTemplates    CommunicationTemplate[]         @relation("CampgroundCommunicationTemplates")
  communicationPlaybooks    CommunicationPlaybook[]         @relation("CampgroundCommunicationPlaybooks")
  communicationPlaybookJobs CommunicationPlaybookJob[]      @relation("CampgroundCommunicationPlaybookJobs")
  storedValueAccounts       StoredValueAccount[]
  storedValueLedgers        StoredValueLedger[]
  posTerminals              PosTerminal[]
  posCarts                  PosCart[]
  posOfflineReplays         PosOfflineReplay[]
  tillSessions              TillSession[]
  vehicles                  Vehicle[]
  accessIntegrations        AccessIntegration[]
  accessGrants              AccessGrant[]
  accessCredentials         AccessCredential[]
  payrollExports            PayrollExport[]
  payrollConfig             PayrollConfig?
  posProviderIntegrations   PosProviderIntegration[]
  overrideRequests          OverrideRequest[]
  staffRoles                StaffRole[]
  factReservationsDaily     FactReservationsDaily[]
  factPosDaily              FactPosDaily[]
  factStoredValueDaily      FactStoredValueDaily[]

  // Phase 3 relations
  dynamicPricingRules    DynamicPricingRule[]
  occupancySnapshots     OccupancySnapshot[]
  revenueForecasts       RevenueForecast[]
  communicationWorkflows CommunicationWorkflow[]
  digitalWaivers         DigitalWaiver[]
  waiverTemplates        WaiverTemplate[]
  idVerifications        IdVerification[]
  staffShifts            StaffShift[]
  staffAvailability      StaffAvailability[]
  timeOffRequests        TimeOffRequest[]
  availabilityOverrides  AvailabilityOverride[]
  overtimeConfig         OvertimeConfig?
  shiftSwapRequests      ShiftSwapRequest[]
  scheduleTemplates      ScheduleTemplate[]
  pushNotifications      PushNotification[]
  staffPerformance       StaffPerformance[]
  savedReports           SavedReport[]
  portfolioMetrics       PortfolioMetric[]
  NotificationTrigger    NotificationTrigger[]
  ScheduledNotification  ScheduledNotification[]
  guestSegments          GuestSegment[]
  analyticsShareLinks    AnalyticsShareLink[]
  analyticsExports       AnalyticsExport[]
  platformGoals          PlatformGoal[]
  campgroundAwards       CampgroundAward[]
  charitySettings        CampgroundCharity?
  charityDonations       CharityDonation[]

  // AI Autopilot relations
  aiAutopilotConfig      AiAutopilotConfig?
  aiContextItems         AiCampgroundContext[]
  aiReplyDrafts          AiReplyDraft[]
  aiAnomalyAlerts        AiAnomalyAlert[]

  // Organization billing relations
  orgBillingLineItems OrganizationBillingLineItem[]
  usageEvents         UsageEvent[]

  // Multi-location store management
  storeLocations     StoreLocation[]
  inventoryTransfers InventoryTransfer[]
  inventoryMovements InventoryMovement[]

  // Hotel operations relations
  cleaningTaskTemplates CleaningTaskTemplate[]
  cleaningZones         CleaningZone[]
  flexCheckPolicy       FlexCheckPolicy?
  roomMoveRequests      RoomMoveRequest[]
  groupBookings         GroupBooking[]

  // Unified Operations / Task Management
  opTeams           OpTeam[]
  opTaskTemplates   OpTaskTemplate[]
  opTaskTriggers    OpTaskTrigger[]
  opRecurrenceRules OpRecurrenceRule[]
  opTasks           OpTask[]

  // Gamification
  opBadges          OpBadge[]           @relation("CampgroundOpBadges")
  opStaffBadges     OpStaffBadge[]      @relation("CampgroundOpStaffBadges")
  opStaffStats      OpStaffStats[]      @relation("CampgroundOpStaffStats")
  opStaffDailyStats OpStaffDailyStats[] @relation("CampgroundOpStaffDailyStats")

  // Inventory batch & expiration tracking relations
  inventoryBatches          InventoryBatch[]
  categoryExpirationConfigs CategoryExpirationConfig[]
  productExpirationConfigs  ProductExpirationConfig[]
  markdownRules             MarkdownRule[]
  markdownApplications      MarkdownApplication[]
  expirationAlerts          ExpirationAlert[]

  // 3rd party POS integration relations
  externalPosSales        ExternalPosSale[]
  productExternalMappings ProductExternalMapping[]

  // Kiosk device management
  kioskDevices      KioskDevice[]
  kioskPairingCodes KioskPairingCode[]

  // Value stack & lead capture
  guarantees        CampgroundGuarantee[]
  bonuses           CampgroundBonus[]
  leadCaptureConfig LeadCaptureConfig?
  publicLeads       PublicLead[]
  bookingPageConfig BookingPageConfig?

  // Seasonals Management
  seasonalRateCards         SeasonalRateCard[]        @relation("CampgroundSeasonalRateCards")
  seasonalGuests            SeasonalGuest[]           @relation("CampgroundSeasonalGuests")
  seasonalPayments          SeasonalPayment[]         @relation("CampgroundSeasonalPayments")
  seasonalCommunications    SeasonalCommunication[]   @relation("CampgroundSeasonalCommunications")

  // Soft delete
  deletedAt DateTime?
  deletedBy String?

  @@index([dataSource, dataSourceId])
  @@index([deletedAt])
}

model PushSubscription {
  id             String    @id @default(cuid())
  userId         String?
  campgroundId   String?
  endpoint       String    @unique
  keys           Json?
  subscription   Json?
  expirationTime DateTime?
  userAgent      String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user       User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  campground Campground? @relation(fields: [campgroundId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([campgroundId])
}

model FormTemplate {
  id           String           @id @default(cuid())
  campgroundId String
  title        String
  type         FormTemplateType @default(custom)
  description  String?
  fields       Json?
  isActive     Boolean          @default(true)
  version      Int              @default(1)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @default(now()) @updatedAt

  // Auto-attach settings
  autoAttachMode FormAutoAttachMode @default(manual)
  siteClassIds   String[]           @default([]) // Which site classes to auto-attach to

  // Display settings
  showAt            FormShowAt[] @default([during_booking])
  isRequired        Boolean      @default(true)
  allowSkipWithNote Boolean      @default(false)

  // Conditional display rules (JSON array of conditions)
  // Example: [{ "field": "pets", "operator": "greater_than", "value": 0 }]
  // Fields: pets, adults, children, rigType, siteClassId, addOns
  // Operators: equals, not_equals, greater_than, less_than, in, not_in, contains
  displayConditions Json?  @default("[]")
  conditionLogic    String @default("all") // "all" = AND, "any" = OR

  // Validity settings
  validityDays Int? // null = never expires, otherwise days until re-signing needed

  // Reminder settings
  sendReminder       Boolean @default(false)
  reminderDaysBefore Int?    @default(1)

  campground  Campground       @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  submissions FormSubmission[]
}

enum FormAutoAttachMode {
  manual // Only attach manually
  all_bookings // Auto-attach to all bookings
  site_classes // Auto-attach to specific site classes
}

enum FormShowAt {
  during_booking // Show during online booking flow
  at_checkin // Show when staff checks in guest
  after_booking // Send via email after booking confirmed
  on_demand // Only when manually requested
}

enum FormTemplateType {
  waiver
  vehicle
  intake
  custom
}

model FormSubmission {
  id             String               @id @default(cuid())
  formTemplateId String
  reservationId  String?
  guestId        String?
  status         FormSubmissionStatus @default(pending)
  responses      Json?
  signedAt       DateTime?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @default(now()) @updatedAt

  formTemplate FormTemplate @relation(fields: [formTemplateId], references: [id], onDelete: Cascade)
  reservation  Reservation? @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  guest        Guest?       @relation(fields: [guestId], references: [id], onDelete: Cascade)
}

enum FormSubmissionStatus {
  pending
  completed
  void
}

// Access control providers and credential types
enum AccessProviderType {
  kisi
  brivo
  cloudkey
}

enum AccessGrantStatus {
  pending
  active
  revoked
  blocked
  expired
  failed
}

enum AccessCredentialType {
  pin
  card
  fob
  mobile
  qr
}

model Campaign {
  id              String         @id @default(cuid())
  campgroundId    String
  name            String
  subject         String
  fromEmail       String
  fromName        String?
  html            String         @db.Text
  textBody        String?        @db.Text
  channel         ChannelType    @default(email)
  templateId      String?
  audienceJson    Json?
  suggestedReason String?
  variables       Json?
  status          CampaignStatus @default(draft)
  scheduledAt     DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @default(now()) @updatedAt

  campground Campground        @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  sends      CampaignSend[]
  template   CampaignTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([status])
}

model CampaignSend {
  id                String             @id @default(cuid())
  campaignId        String
  campgroundId      String
  guestId           String?
  email             String
  phone             String?
  channel           ChannelType        @default(email)
  status            CampaignSendStatus @default(queued)
  providerMessageId String?
  error             String?
  sentAt            DateTime?
  createdAt         DateTime           @default(now())

  campaign   Campaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  campground Campground @relation("CampgroundCampaignSends", fields: [campgroundId], references: [id], onDelete: Cascade)
  guest      Guest?     @relation(fields: [guestId], references: [id], onDelete: SetNull)

  @@index([campaignId])
  @@index([campgroundId])
  @@index([guestId])
  @@index([status])
}

model CampaignTemplate {
  id           String      @id @default(cuid())
  campgroundId String
  name         String
  channel      ChannelType @default(email)
  category     String?     @default("general")
  subject      String?
  html         String?     @db.Text
  textBody     String?     @db.Text
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @default(now()) @updatedAt

  campground          Campground            @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  campaigns           Campaign[]
  NotificationTrigger NotificationTrigger[]

  @@index([campgroundId])
  @@index([channel])
}

model TaxRule {
  id             String      @id @default(cuid())
  campgroundId   String
  name           String
  type           TaxRuleType
  rate           Decimal?    @db.Decimal(10, 4)
  minNights      Int?
  maxNights      Int?
  category       String      @default("general") // general, accommodation, goods, services
  requiresWaiver Boolean     @default(false)
  waiverText     String?
  isActive       Boolean     @default(true)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @default(now()) @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
}

// ---------------------------------------------------------------------------
// Social Media Planner models
// ---------------------------------------------------------------------------

model SocialPost {
  id             String                 @id @default(cuid())
  campgroundId   String
  title          String
  platform       SocialPlatform
  status         SocialPostStatus       @default(draft)
  category       SocialContentCategory?
  scheduledFor   DateTime?
  publishedFor   DateTime?
  caption        String?
  hashtags       String[]               @default([])
  imagePrompt    String?
  notes          String?
  templateId     String?
  assetUrls      String[]               @default([])
  tags           String[]               @default([])
  ideaParkingLot Boolean                @default(false)
  suggestionId   String?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt

  campground        Campground               @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  template          SocialTemplate?          @relation(fields: [templateId], references: [id], onDelete: SetNull)
  suggestion        SocialSuggestion?        @relation("PostSuggestion", fields: [suggestionId], references: [id], onDelete: SetNull)
  performanceInputs SocialPerformanceInput[]

  @@index([campgroundId])
  @@index([platform, status])
  @@index([scheduledFor])
}

model SocialTemplate {
  id             String                 @id @default(cuid())
  campgroundId   String
  name           String
  summary        String?
  category       SocialContentCategory?
  style          SocialTemplateStyle?
  defaultCaption String?
  captionFillIns String?
  imageGuidance  String?
  hashtagSet     String[]               @default([])
  bestTime       String?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt

  campground Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  posts      SocialPost[]

  @@index([campgroundId])
}

model SocialContentAsset {
  id           String          @id @default(cuid())
  campgroundId String
  title        String
  type         SocialAssetType
  url          String
  tags         String[]        @default([])
  notes        String?
  uploadedById String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  uploadedBy User?      @relation("AssetUploader", fields: [uploadedById], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([type])
}

model SocialSuggestion {
  id            String                 @id @default(cuid())
  campgroundId  String
  type          SocialSuggestionType
  status        SocialSuggestionStatus @default(new)
  message       String
  reason        Json?
  category      SocialContentCategory?
  platform      SocialPlatform?
  proposedDate  DateTime?
  opportunityAt DateTime?
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt

  campground Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  posts      SocialPost[] @relation("PostSuggestion")

  @@index([campgroundId])
  @@index([type, status])
  @@index([proposedDate])
}

model SocialWeeklyIdea {
  id           String   @id @default(cuid())
  campgroundId String
  generatedFor DateTime // Monday anchor date
  ideas        Json
  cadence      Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, generatedFor])
  @@index([generatedFor])
}

model SocialStrategy {
  id           String   @id @default(cuid())
  campgroundId String
  month        DateTime
  annual       Boolean  @default(false)
  plan         Json
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId, month])
}

model SocialOpportunityAlert {
  id           String              @id @default(cuid())
  campgroundId String
  category     SocialAlertCategory
  message      String
  startsAt     DateTime?
  endsAt       DateTime?
  dismissed    Boolean             @default(false)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([category])
}

model SocialPerformanceInput {
  id           String   @id @default(cuid())
  campgroundId String
  postId       String?
  likes        Int?
  reach        Int?
  comments     Int?
  saves        Int?
  shares       Int?
  notes        String?
  recordedAt   DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground Campground  @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  post       SocialPost? @relation(fields: [postId], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([postId])
  @@index([recordedAt])
}

model SeasonalRate {
  id           String    @id @default(cuid())
  campgroundId String
  siteClassId  String?
  name         String
  rateType     RateType
  amount       Int
  minNights    Int?
  startDate    DateTime?
  endDate      DateTime?
  isActive     Boolean   @default(true)

  // Payment & Pricing controls
  paymentSchedule   PaymentSchedule  @default(single)
  pricingStructure  PricingStructure @default(per_night)
  offseasonInterval Int? // months between payments (1 or 2)
  offseasonAmount   Int? // amount per offseason payment (cents)
  prorateExcess     Boolean          @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  campground   Campground    @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  siteClass    SiteClass?    @relation(fields: [siteClassId], references: [id], onDelete: SetNull)
  reservations Reservation[]

  @@index([campgroundId])
  @@index([siteClassId])
}

model Site {
  id                String   @id @default(cuid())
  campgroundId      String
  siteClassId       String?
  name              String
  siteNumber        String
  siteType          SiteType
  maxOccupancy      Int
  rigMaxLength      Int?
  rigMaxWidth       Int?
  rigMaxHeight      Int?
  pullThrough       Boolean  @default(false)
  hookupsPower      Boolean  @default(false)
  powerAmps         Int[]    @default([])
  hookupsWater      Boolean  @default(false)
  hookupsSewer      Boolean  @default(false)
  petFriendly       Boolean  @default(true)
  accessible        Boolean  @default(false)
  minNights         Int?
  maxNights         Int?
  photos            String[] @default([])
  photoAttributions Json?
  description       String?
  tags              String[] @default([])
  amenityTags       String[] @default([])
  vibeTags          String[] @default([])
  popularityScore   Int      @default(0)
  isActive          Boolean  @default(true)
  status            String? // e.g., available, out_of_service
  latitude          Decimal? @db.Decimal(12, 8)
  longitude         Decimal? @db.Decimal(12, 8)
  surfaceType       String?
  padSlopePercent   Int?
  mapLabel          String?

  // Hotel operations fields
  cleaningMinutes Int? // Standard cleaning time for this unit
  zone            String? // "Building A Floor 2", "Lakeside Loop"

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  campground          Campground           @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  siteClass           SiteClass?           @relation(fields: [siteClassId], references: [id], onDelete: SetNull)
  reservations        Reservation[]
  maintenance         MaintenanceTicket[]
  operationalTasks    OperationalTask[]
  housekeepingStatus  String               @default("vacant_clean") // Uses HousekeepingStatus enum values
  blackoutDates       BlackoutDate[]
  structureAttributes StructureAttributes? // Hotel room/cabin specific attributes
  holds               SiteHold[]
  otaMappings         OtaListingMapping[]  @relation("SiteOtaMappings")
  analyticsEvents     AnalyticsEvent[]
  waitlistEntries     WaitlistEntry[]
  mapLayout           SiteMapLayout?
  mapAssignment       SiteMapAssignment?
  utilityMeters       UtilityMeter[]
  accessGrants        AccessGrant[]
  documentTemplates   DocumentTemplate[]
  reservationSegments ReservationSegment[]
  smartLocks          SmartLock[]
  qrCodes             QRCode[]

  // Hotel operations relations
  roomMovesFrom RoomMoveRequest[] @relation("RoomMoveFrom")
  roomMovesTo   RoomMoveRequest[] @relation("RoomMoveTo")

  // Unified Operations / Task Management
  opTasks OpTask[] @relation("OpTaskSite")

  // Seasonals Management
  seasonalGuests SeasonalGuest[] @relation("SeasonalGuestCurrentSite")

  @@unique([campgroundId, name])
  @@index([campgroundId])
  @@index([siteType])
  @@index([siteClassId])
  @@index([campgroundId, isActive])
}

model SiteHold {
  id            String    @id @default(cuid())
  campgroundId  String
  siteId        String
  arrivalDate   DateTime
  departureDate DateTime
  expiresAt     DateTime?
  status        String    @default("active") // active, released, expired
  note          String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  site       Site       @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([siteId])
  @@index([expiresAt])
}

model SiteMapLayout {
  id           String   @id @default(cuid())
  campgroundId String
  siteId       String   @unique
  geometry     Json
  centroid     Json?
  label        String?
  rotation     Float?
  metadata     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  site       Site       @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
}

model SiteMapShape {
  id           String   @id @default(cuid())
  campgroundId String
  name         String?
  geometry     Json
  centroid     Json?
  metadata     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground  Campground          @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  assignments SiteMapAssignment[]

  @@index([campgroundId])
}

model SiteMapAssignment {
  id           String   @id @default(cuid())
  campgroundId String
  siteId       String   @unique
  shapeId      String   @unique
  label        String?
  rotation     Float?
  metadata     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  site       Site         @relation(fields: [siteId], references: [id], onDelete: Cascade)
  shape      SiteMapShape @relation(fields: [shapeId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([shapeId])
}

model CampgroundMapConfig {
  campgroundId  String   @id
  bounds        Json?
  defaultCenter Json?
  defaultZoom   Float?
  layers        Json?
  legend        Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
}

model Guest {
  id                String           @id @default(cuid())
  primaryFirstName  String
  primaryLastName   String
  email             String
  emailNormalized   String?
  phone             String?
  phoneNormalized   String?
  preferredContact  String?
  preferredLanguage String?
  address1          String?
  address2          String?
  city              String?
  state             String?
  postalCode        String?
  country           String?
  rigType           String?
  rigLength         Int?
  vehiclePlate      String?
  vehicleState      String?
  tags              String[]         @default([])
  vip               Boolean          @default(false)
  leadSource        String?
  marketingOptIn    Boolean          @default(false)
  repeatStays       Int              @default(0)
  notes             String?
  preferences       Json?
  insights          Json?
  equipment         GuestEquipment[]
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @default(now()) @updatedAt

  reservations              Reservation[]
  incidents                 Incident[]
  certificatesOfInsurance   CertificateOfInsurance[]
  storeOrders               StoreOrder[]
  account                   GuestAccount?
  messages                  Message[]
  communications            Communication[]
  campaignSends             CampaignSend[]
  npsInvites                NpsInvite[]
  npsResponses              NpsResponse[]
  reviewRequests            ReviewRequest[]
  reviews                   Review[]
  reviewVotes               ReviewVote[]
  formSubmissions           FormSubmission[]
  communicationPlaybookJobs CommunicationPlaybookJob[] @relation("GuestCommunicationPlaybookJobs")
  waitlistEntries           WaitlistEntry[]
  signatureRequests         SignatureRequest[]
  signatureArtifacts        SignatureArtifact[]
  coiUploads                CoiUpload[]
  storedValueCodes          StoredValueCode[]
  walletAccounts            StoredValueAccount[]       @relation("GuestWallet")
  loyaltyProfile            LoyaltyProfile?
  activityBookings          ActivityBooking[]
  memberships               GuestMembership[]
  vehicles                  Vehicle[]

  // Phase 3 relations
  digitalWaivers     DigitalWaiver[]
  idVerifications    IdVerification[]
  segmentMemberships GuestSegmentMembership[]

  // Hotel operations relations
  groupBookings GroupBooking[] @relation("GroupPrimaryGuest")

  // Seasonals
  seasonalRecords SeasonalGuest[] @relation("GuestSeasonalRecords")

  // Soft delete
  deletedAt DateTime?
  deletedBy String?

  @@unique([email])
  @@index([emailNormalized])
  @@index([phoneNormalized])
  @@index([deletedAt])
}

model LoyaltyProfile {
  id            String   @id @default(cuid())
  guestId       String   @unique
  pointsBalance Int      @default(0)
  tier          String   @default("Bronze") // Bronze, Silver, Gold, Platinum
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt

  guest        Guest               @relation(fields: [guestId], references: [id], onDelete: Cascade)
  transactions PointsTransaction[]

  @@index([guestId])
}

model PointsTransaction {
  id        String   @id @default(cuid())
  profileId String
  amount    Int // Positive for earning, negative for spending
  reason    String // e.g., "Reservation #123", "Redemption"
  createdAt DateTime @default(now())

  profile LoyaltyProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
}

model GuestAccount {
  id             String    @id @default(cuid())
  guestId        String    @unique
  email          String    @unique
  passwordHash   String?
  magicLinkToken String?   @unique
  tokenExpiry    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @default(now()) @updatedAt

  guest Guest @relation(fields: [guestId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([magicLinkToken])
}

model Reservation {
  id                       String                 @id @default(cuid())
  campgroundId             String
  siteId                   String
  siteLocked               Boolean                @default(false)
  guestId                  String
  arrivalDate              DateTime
  departureDate            DateTime
  adults                   Int
  children                 Int                    @default(0)
  petCount                 Int?                   @default(0)
  petTypes                 Json?
  status                   ReservationStatus      @default(pending)
  totalAmount              Int                    @default(0)
  paidAmount               Int                    @default(0)
  balanceAmount            Int                    @default(0)
  depositAmount            Int                    @default(0)
  depositDueDate           DateTime?
  pricingRuleVersion       String?
  depositPolicyVersion     String?
  nextAutoCollectAttemptAt DateTime?
  paymentStatus            String                 @default("unpaid")
  baseSubtotal             Int                    @default(0)
  feesAmount               Int                    @default(0)
  taxesAmount              Int                    @default(0)
  discountsAmount          Int                    @default(0)
  promoCode                String?
  source                   String?
  policyVersion            String?
  checkInWindowStart       String?
  checkInWindowEnd         String?
  vehiclePlate             String?
  vehicleState             String?
  rigType                  String?
  rigLength                Int?
  stayReasonPreset         StayReasonPreset?
  stayReasonOther          String?
  referralProgramId        String?
  referralCode             String?
  referralSource           String?
  referralChannel          String?
  referralIncentiveType    ReferralIncentiveType?
  referralIncentiveValue   Int?                   @default(0)
  createdBy                String?
  updatedBy                String?
  checkInAt                DateTime?
  checkOutAt               DateTime?
  notes                    String?
  stayType                 StayType               @default(standard)
  taxExempt                Boolean                @default(false)
  taxWaiverSigned          Boolean                @default(false)
  taxWaiverDate            DateTime?
  seasonalRateId           String?
  billingCadence           String                 @default("monthly") // weekly|monthly
  billingAnchorDate        DateTime?
  utilityMeterIds          Json?

  // Booking metadata
  leadTimeDays     Int? // Days between booking date and arrival date
  bookedAt         DateTime? // Exact timestamp when booking was made
  additionalGuests Json? // Array of { firstName, lastName, email?, phone? }
  childrenDetails  Json? // Array of { name?, gender?, age? }

  groupId                String?
  groupRole              GroupRole?
  checkInStatus          CheckInStatus  @default(not_started)
  checkOutStatus         CheckOutStatus @default(not_started)
  idVerificationRequired Boolean        @default(false)
  waiverRequired         Boolean        @default(false)
  paymentRequired        Boolean        @default(true)
  lateArrivalFlag        Boolean        @default(false)
  siteReady              Boolean        @default(false)
  siteReadyAt            DateTime?
  selfCheckInAt          DateTime?
  selfCheckOutAt         DateTime?

  // Hotel operations: Flex check-in/check-out
  earlyCheckInRequested DateTime?
  earlyCheckInApproved  Boolean?
  earlyCheckInCharge    Int? // Cents charged for early check-in
  lateCheckoutRequested DateTime?
  lateCheckoutApproved  Boolean?
  lateCheckoutCharge    Int? // Cents charged for late checkout

  // Hotel operations: Group booking link
  groupBookingId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  // Soft delete
  deletedAt DateTime?
  deletedBy String?

  campground      Campground       @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  site            Site             @relation(fields: [siteId], references: [id], onDelete: Cascade)
  guest           Guest            @relation(fields: [guestId], references: [id], onDelete: Cascade)
  referralProgram ReferralProgram? @relation(fields: [referralProgramId], references: [id], onDelete: SetNull)
  payments        Payment[]
  ledger          LedgerEntry[]
  storeOrders     StoreOrder[]
  messages        Message[]
  communications  Communication[]

  repeatCharges             RepeatCharge[]
  seasonalRate              SeasonalRate?              @relation(fields: [seasonalRateId], references: [id], onDelete: SetNull)
  activityBookings          ActivityBooking[]
  otaImports                OtaReservationImport[]     @relation("ReservationOtaImports")
  formSubmissions           FormSubmission[]
  npsInvites                NpsInvite[]
  npsResponses              NpsResponse[]
  reviewRequests            ReviewRequest[]
  reviews                   Review[]
  payoutLines               PayoutLine[]
  disputes                  Dispute[]
  analyticsEvents           AnalyticsEvent[]
  communicationPlaybookJobs CommunicationPlaybookJob[] @relation("ReservationCommunicationPlaybookJobs")
  upsells                   ReservationUpsell[]
  vehicles                  Vehicle[]
  accessGrants              AccessGrant[]
  accessCredentials         AccessCredential[]
  incidents                 Incident[]
  certificatesOfInsurance   CertificateOfInsurance[]
  billingCycles             BillingCycle[]
  invoices                  Invoice[]

  // Phase 3 relations
  digitalWaivers     DigitalWaiver[]
  idVerifications    IdVerification[]
  signatureRequests  SignatureRequest[]
  signatureArtifacts SignatureArtifact[]
  coiUploads         CoiUpload[]

  // Split booking segments (when a stay spans multiple sites)
  segments ReservationSegment[]

  // Charity donation (if guest opted to round up)
  charityDonation CharityDonation?

  // QR codes for check-in
  qrCodes QRCode[]

  // Hotel operations relations
  roomMoves    RoomMoveRequest[]
  groupBooking GroupBooking?     @relation(fields: [groupBookingId], references: [id], onDelete: SetNull)

  // Unified Operations / Task Management
  opTasks OpTask[] @relation("OpTaskReservation")

  // Link to Seasonal Guest (if converted from reservation)
  seasonalGuestId String?
  seasonalGuest   SeasonalGuest? @relation("SeasonalGuestReservations", fields: [seasonalGuestId], references: [id], onDelete: SetNull)

  // AI Autopilot: No-show risk prediction
  aiNoShowRisk AiNoShowRisk?

  @@index([campgroundId])
  @@index([seasonalGuestId])
  @@index([groupBookingId])
  @@index([siteId])
  @@index([guestId])
  @@index([seasonalRateId])
  @@index([groupId])
  @@index([referralCode])
  @@index([referralProgramId])
  // Critical composite indexes for common queries
  @@index([campgroundId, status])
  @@index([campgroundId, arrivalDate, departureDate])
  @@index([siteId, arrivalDate, departureDate])
  @@index([campgroundId, status, arrivalDate])
  @@index([status, arrivalDate])
  @@index([deletedAt])
}

// Split booking segment - represents a portion of a reservation on a specific site
model ReservationSegment {
  id            String   @id @default(cuid())
  reservationId String
  siteId        String
  startDate     DateTime
  endDate       DateTime
  subtotalCents Int      @default(0) // Price for this segment based on site rates
  sortOrder     Int      @default(0) // Order of segments in the stay
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt

  reservation Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  site        Site        @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([reservationId])
  @@index([siteId])
  @@index([startDate])
}

model MaintenanceTicket {
  id               String              @id @default(cuid())
  campgroundId     String
  siteId           String?
  title            String
  description      String?
  status           MaintenanceStatus   @default(open)
  priority         MaintenancePriority @default(medium)
  dueDate          DateTime?
  assignedTo       String?
  assignedToTeamId String?
  isBlocking       Boolean             @default(false)
  outOfOrder       Boolean             @default(false)
  outOfOrderReason String?
  outOfOrderUntil  DateTime?
  lockId           String?             @unique
  checklist        Json?
  photos           Json?
  notes            String?
  resolvedAt       DateTime?
  reopenedAt       DateTime?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @default(now()) @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  site       Site?      @relation(fields: [siteId], references: [id], onDelete: SetNull)
  assignee   User?      @relation(fields: [assignedTo], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([status])
  @@index([dueDate])
  @@index([assignedTo])
}

model Incident {
  id            String         @id @default(cuid())
  campgroundId  String
  reservationId String?
  guestId       String?
  type          IncidentType
  status        IncidentStatus @default(open)
  severity      Severity?
  notes         String?
  photos        Json?
  witnesses     Json? // [{ name, contact, statement }]
  occurredAt    DateTime?
  closedAt      DateTime?
  claimId       String?
  reminderAt    DateTime?
  metadata      Json?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @default(now()) @updatedAt

  campground  Campground               @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  reservation Reservation?             @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  guest       Guest?                   @relation(fields: [guestId], references: [id], onDelete: SetNull)
  tasks       IncidentTask[]
  evidence    IncidentEvidence[]
  cois        CertificateOfInsurance[]

  @@index([campgroundId])
  @@index([reservationId])
  @@index([guestId])
  @@index([status])
  @@index([type])
}

model IncidentTask {
  id          String             @id @default(cuid())
  incidentId  String
  title       String
  status      IncidentTaskStatus @default(pending)
  dueAt       DateTime?
  reminderAt  DateTime?
  assignedTo  String?
  completedAt DateTime?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @default(now()) @updatedAt

  incident Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  @@index([incidentId])
  @@index([status])
  @@index([dueAt])
}

model IncidentEvidence {
  id          String       @id @default(cuid())
  incidentId  String
  type        EvidenceType @default(photo)
  url         String?
  storageKey  String?
  description String?
  uploadedBy  String?
  uploadedAt  DateTime     @default(now())
  metadata    Json?

  incident Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  @@index([incidentId])
  @@index([type])
}

model CertificateOfInsurance {
  id            String    @id @default(cuid())
  campgroundId  String
  guestId       String?
  reservationId String?
  incidentId    String?
  provider      String?
  policyNumber  String?
  coverageType  String?
  fileUrl       String
  effectiveDate DateTime?
  expiresAt     DateTime?
  uploadedBy    String?
  uploadedAt    DateTime  @default(now())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt

  campground  Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  guest       Guest?       @relation(fields: [guestId], references: [id], onDelete: SetNull)
  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  incident    Incident?    @relation(fields: [incidentId], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([guestId])
  @@index([reservationId])
  @@index([incidentId])
  @@index([expiresAt])
}

model PricingRule {
  id            String    @id @default(cuid())
  campgroundId  String
  siteClassId   String?
  label         String?
  ruleType      String // flat, percent, seasonal, dow
  startDate     DateTime?
  endDate       DateTime?
  dayOfWeek     Int?
  percentAdjust Decimal?  @db.Decimal(6, 4)
  flatAdjust    Int?
  minNights     Int?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  siteClass  SiteClass? @relation(fields: [siteClassId], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([siteClassId])
}

model GatewayFeePreset {
  id                 String                 @id @default(cuid())
  gateway            PaymentGatewayProvider
  mode               PaymentGatewayMode
  percentBasisPoints Int                    @default(0)
  flatFeeCents       Int                    @default(0)
  label              String?
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @default(now()) @updatedAt

  campgroundConfigs CampgroundPaymentGatewayConfig[]

  @@unique([gateway, mode])
  @@index([gateway, mode])
}

model CampgroundPaymentGatewayConfig {
  id                        String                 @id @default(cuid())
  campgroundId              String                 @unique
  gateway                   PaymentGatewayProvider
  mode                      PaymentGatewayMode     @default(test)
  feeMode                   PaymentFeeMode         @default(absorb)
  feePercentBasisPoints     Int?
  feeFlatCents              Int?
  feePresetId               String?
  publishableKeySecretId    String?
  secretKeySecretId         String?
  merchantAccountIdSecretId String?
  webhookSecretId           String?
  additionalConfig          Json?
  createdAt                 DateTime               @default(now())
  updatedAt                 DateTime               @default(now()) @updatedAt

  campground Campground        @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  feePreset  GatewayFeePreset? @relation(fields: [feePresetId], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([gateway, mode])
}

model Payment {
  id                         String    @id @default(cuid())
  campgroundId               String
  reservationId              String
  amountCents                Int
  method                     String    @default("card")
  direction                  String    @default("charge") // charge or refund
  note                       String?
  stripePaymentIntentId      String?
  stripeChargeId             String?
  stripeBalanceTransactionId String?
  stripePayoutId             String?
  applicationFeeCents        Int?
  stripeFeeCents             Int?
  methodType                 String? // card, ach, wallet, etc.
  capturedAt                 DateTime?
  createdAt                  DateTime  @default(now())

  reservation Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  campground  Campground  @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([reservationId])
  @@index([stripePaymentIntentId])
  @@index([stripeChargeId])
  @@index([stripePayoutId])
}

model RepeatCharge {
  id            String       @id @default(cuid())
  reservationId String
  amount        Int // cents
  dueDate       DateTime
  status        ChargeStatus @default(pending)
  paidAt        DateTime?
  failedAt      DateTime?
  failureReason String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @default(now()) @updatedAt

  reservation Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)

  @@index([reservationId])
  @@index([status])
  @@index([dueDate])
}

// ---------------------------------------------------------------------------
// Billing cycles, invoices, utilities, late fees
// ---------------------------------------------------------------------------

model BillingCycle {
  id            String    @id @default(cuid())
  campgroundId  String
  reservationId String
  cadence       String // weekly|monthly
  periodStart   DateTime
  periodEnd     DateTime
  status        String    @default("open") // open|closed
  generatedAt   DateTime?
  closedAt      DateTime?

  invoices    Invoice[]
  reservation Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  campground  Campground  @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId, reservationId, periodStart, periodEnd])
}

model Invoice {
  id             String    @id @default(cuid())
  billingCycleId String
  campgroundId   String
  reservationId  String
  number         String    @unique
  dueDate        DateTime
  status         String    @default("open") // open|paid|void|written_off
  subtotalCents  Int       @default(0)
  taxCents       Int       @default(0)
  totalCents     Int       @default(0)
  balanceCents   Int       @default(0)
  createdAt      DateTime  @default(now())
  closedAt       DateTime?

  lines        InvoiceLine[]
  billingCycle BillingCycle    @relation(fields: [billingCycleId], references: [id], onDelete: Cascade)
  reservation  Reservation     @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  campground   Campground      @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  arLedger     ArLedgerEntry[]

  @@index([reservationId, status])
  @@index([campgroundId])
}

model InvoiceLine {
  id          String  @id @default(cuid())
  invoiceId   String
  type        String // rent|utility|late_fee|adjustment
  description String
  quantity    Decimal @default(1)
  unitCents   Int
  amountCents Int
  meta        Json?

  invoice  Invoice         @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  arLedger ArLedgerEntry[]

  @@index([invoiceId, type])
}

model UtilityRatePlan {
  id             String    @id @default(cuid())
  campgroundId   String
  type           String // power|water|sewer
  pricingMode    String // flat|tiered|time_of_use
  baseRateCents  Int
  tiers          Json?
  demandFeeCents Int?
  minimumCents   Int?
  effectiveFrom  DateTime
  effectiveTo    DateTime?

  meters     UtilityMeter[]
  campground Campground     @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId, type, effectiveFrom])
}

model UtilityMeter {
  id               String    @id @default(cuid())
  campgroundId     String
  siteId           String
  type             String // power|water|sewer
  serialNumber     String?
  active           Boolean   @default(true)
  installedAt      DateTime  @default(now())
  removedAt        DateTime?
  ratePlanId       String?
  billingMode      String    @default("cycle") // cycle|per_reading|annual|manual
  billTo           String    @default("reservation") // reservation|guest
  multiplier       Decimal   @default(1.0)
  autoEmail        Boolean   @default(false)
  lastBilledReadAt DateTime?
  metadata         Json?

  reads      UtilityMeterRead[]
  ratePlan   UtilityRatePlan?   @relation(fields: [ratePlanId], references: [id], onDelete: SetNull)
  campground Campground         @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  site       Site               @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([siteId, type])
}

model SmartLock {
  id           String   @id @default(cuid())
  campgroundId String
  siteId       String?
  name         String?
  vendor       String // e.g. "kisi", "remotelock"
  externalId   String? // ID in vendor system
  status       String   @default("locked") // locked, unlocked, offline
  batteryLevel Int? // 0-100
  metadata     Json? // Simulation config
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  site       Site?      @relation(fields: [siteId], references: [id])

  @@index([campgroundId])
  @@index([siteId])
}

// QR Codes for check-in, site identification, amenities, etc.
model QRCode {
  id            String    @id @default(cuid())
  campgroundId  String
  reservationId String?
  siteId        String?
  type          String // checkin, checkout, site, amenity, store, event, wifi, emergency
  code          String    @unique // The unique code embedded in the QR
  expiresAt     DateTime? // Null for permanent codes (like site QRs)
  usedAt        DateTime? // For single-use codes
  scanCount     Int       @default(0)
  lastScannedAt DateTime?
  metadata      Json? // Additional data (wifi credentials, event info, etc.)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  campground  Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  site        Site?        @relation(fields: [siteId], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([type])
  @@index([reservationId])
  @@index([siteId])
  @@index([expiresAt])
}

model UtilityMeterRead {
  id           String   @id @default(cuid())
  meterId      String
  readingValue Decimal
  readAt       DateTime
  source       String // manual|import|api
  note         String?
  readBy       String?
  createdAt    DateTime @default(now())

  meter UtilityMeter @relation(fields: [meterId], references: [id], onDelete: Cascade)

  @@index([meterId, readAt])
}

model LateFeeRule {
  id              String    @id @default(cuid())
  campgroundId    String
  cadence         String // weekly|monthly
  graceDays       Int       @default(3)
  feeType         String // flat|percent
  feeCents        Int?
  feePercentBp    Int?
  applyPerInvoice Boolean   @default(true)
  maxOccurrences  Int?
  active          Boolean   @default(true)
  effectiveFrom   DateTime
  effectiveTo     DateTime?

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId, cadence, active])
}

model ArLedgerEntry {
  id            String   @id @default(cuid())
  ledgerEntryId String   @unique
  invoiceId     String?
  invoiceLineId String?
  type          String // ar_open|ar_settlement|writeoff|reclass
  createdAt     DateTime @default(now())

  ledgerEntry LedgerEntry  @relation(fields: [ledgerEntryId], references: [id], onDelete: Cascade)
  invoice     Invoice?     @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  invoiceLine InvoiceLine? @relation(fields: [invoiceLineId], references: [id], onDelete: SetNull)

  @@index([invoiceId])
  @@index([invoiceLineId])
}

model LedgerEntry {
  id            String   @id @default(cuid())
  campgroundId  String
  reservationId String?
  periodId      String?
  glCode        String?
  account       String?
  description   String?
  amountCents   Int
  direction     String   @default("debit")
  occurredAt    DateTime @default(now())
  createdAt     DateTime @default(now())
  externalRef   String?
  dedupeKey     String?

  reservation   Reservation?   @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  campground    Campground     @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  arLedgerEntry ArLedgerEntry?
  glPeriod      GlPeriod?      @relation(fields: [periodId], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([reservationId])
  @@index([glCode])
  @@index([periodId])
  @@index([dedupeKey])
}

enum GlPeriodStatus {
  open
  closed
  locked
}

model GlPeriod {
  id           String         @id @default(cuid())
  campgroundId String
  name         String?
  startDate    DateTime
  endDate      DateTime
  status       GlPeriodStatus @default(open)
  closedAt     DateTime?
  lockedAt     DateTime?
  closedBy     String?
  lockedBy     String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @default(now()) @updatedAt

  campground  Campground    @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  ledgerPosts LedgerEntry[]

  @@index([campgroundId, startDate, endDate])
  @@index([campgroundId, status])
}

enum PayoutStatus {
  pending
  in_transit
  paid
  failed
  canceled
}

model Payout {
  id                  String       @id @default(cuid())
  campgroundId        String
  stripePayoutId      String       @unique
  stripeAccountId     String
  amountCents         Int
  feeCents            Int?
  currency            String       @default("usd")
  status              PayoutStatus @default(pending)
  arrivalDate         DateTime?
  paidAt              DateTime?
  statementDescriptor String?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @default(now()) @updatedAt

  lines    PayoutLine[]
  disputes Dispute[]

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([stripeAccountId])
  @@index([status])
}

model PayoutLine {
  id                   String   @id @default(cuid())
  payoutId             String
  type                 String // charge, refund, fee, adjustment, dispute, payout
  amountCents          Int
  currency             String   @default("usd")
  description          String?
  reservationId        String?
  paymentIntentId      String?
  chargeId             String?
  balanceTransactionId String?
  createdAt            DateTime @default(now())

  payout      Payout       @relation(fields: [payoutId], references: [id], onDelete: Cascade)
  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)

  @@index([payoutId])
  @@index([reservationId])
  @@index([paymentIntentId])
  @@index([chargeId])
  @@index([balanceTransactionId])
}

enum DisputeStatus {
  warning_needs_response
  warning_under_review
  needs_response
  under_review
  charge_refunded
  won
  lost
}

model Dispute {
  id                    String        @id @default(cuid())
  campgroundId          String
  reservationId         String?
  payoutId              String?
  stripeDisputeId       String        @unique
  stripeChargeId        String?
  stripePaymentIntentId String?
  amountCents           Int
  currency              String        @default("usd")
  reason                String?
  status                DisputeStatus @default(needs_response)
  evidenceDueBy         DateTime?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @default(now()) @updatedAt
  notes                 String?

  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  payout      Payout?      @relation(fields: [payoutId], references: [id], onDelete: SetNull)
  campground  Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([reservationId])
  @@index([payoutId])
  @@index([stripeDisputeId])
  @@index([stripeChargeId])
  @@index([stripePaymentIntentId])
  @@index([status])
}

enum EventType {
  activity // Kayaking, hiking tours, etc.
  workshop // Crafts, cooking classes
  entertainment // Live music, movies
  holiday // Special holiday events (parent)
  recurring // Weekly potlucks, etc.
  ongoing // Multi-day continuous (craft station, open swim)
  themed // Themed weekends (Pirate Weekend, Halloween)
}

model Event {
  id           String @id @default(cuid())
  campgroundId String

  // Basic info
  title       String
  description String?   @db.Text
  eventType   EventType @default(activity)

  // Scheduling
  startDate      DateTime
  endDate        DateTime?
  startTime      String? // "14:00"
  endTime        String? // "16:00"
  isAllDay       Boolean   @default(false)
  isRecurring    Boolean   @default(false)
  recurrenceRule String? // iCal RRULE format

  // Location
  location String? // "Main pavilion", "Pool area", etc.

  // Capacity & pricing
  capacity       Int? // Max attendees
  currentSignups Int     @default(0)
  priceCents     Int     @default(0) // 0 = free
  isGuestOnly    Boolean @default(true) // Only campground guests can attend

  // Media
  imageUrl String?

  // Status
  isPublished        Boolean   @default(false)
  isCancelled        Boolean   @default(false)
  cancelledAt        DateTime?
  cancellationReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  // Recurrence enhancements
  recurrenceEndDate DateTime? // When recurring pattern stops
  recurrenceDays    Int[] // [0]=Sun, [5]=Fri, [6]=Sat

  // Parent event (for holiday/themed grouping)
  parentEventId String?
  parent        Event?  @relation("EventChildren", fields: [parentEventId], references: [id], onDelete: SetNull)
  children      Event[] @relation("EventChildren")

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([startDate])
  @@index([eventType])
  @@index([parentEventId])
}

// =============================================================================
// STORE & ADD-ONS
// =============================================================================

enum AddOnPricingType {
  flat // One-time fee (e.g., late checkout)
  per_night // Per night of stay (e.g., extra vehicle)
  per_person // Per person (e.g., extra guest fee)
}

enum OrderStatus {
  pending
  ready
  delivered
  completed
  cancelled
  refunded
}

enum PaymentMethod {
  card
  cash
  charge_to_site
}

enum OrderChannel {
  pos
  online
  kiosk
  portal
  internal
}

enum FulfillmentType {
  pickup
  curbside
  delivery
  table_service
}

enum ChannelInventoryMode {
  shared
  split
}

// Multi-location inventory management
enum ProductInventoryMode {
  shared // Single stock pool across all locations
  per_location // Separate stock tracked per location
}

enum StoreLocationType {
  physical // Physical store location
  virtual // Virtual location (e.g., online-only warehouse)
}

enum InventoryTransferStatus {
  pending // Transfer requested
  in_transit // Items picked up, moving to destination
  completed // Transfer complete
  cancelled // Transfer cancelled
}

enum FulfillmentAssignmentStatus {
  unassigned // No location assigned yet
  assigned // Assigned to a location
  preparing // Location is preparing the order
  ready // Ready for pickup/delivery
  completed // Fulfilled
}

// ---------------------------------------------------------------------------
// Inventory Batch & Expiration Tracking enums
// ---------------------------------------------------------------------------

enum ExpirationTier {
  fresh // Beyond warning threshold
  warning // Within warning threshold
  critical // Within critical threshold
  expired // Past expiration date
}

enum MarkdownDiscountType {
  percentage // Discount as percentage (1-100)
  flat // Fixed amount off in cents
}

enum MarkdownScope {
  all // Applies to all products
  category // Applies to specific category
  product // Applies to specific product
}

enum BatchDisposalReason {
  expired // Past expiration date
  damaged // Physical damage
  quality_issue // Quality degradation
  recall // Product recall
  theft_loss // Theft or unexplained loss
  donation // Donated to charity
  sample // Used as sample
  other // Other reason
}

model ProductCategory {
  id           String   @id @default(cuid())
  campgroundId String
  name         String
  description  String?
  sortOrder    Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt

  // Expiration tracking defaults for this category
  defaultWarningDays    Int @default(7) // Days before expiration for "warning" tier
  defaultCriticalDays   Int @default(2) // Days before expiration for "critical" tier
  defaultSlowMovingDays Int @default(30) // Days without sale to flag as slow-moving

  campground        Campground                 @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  products          Product[]
  expirationConfigs CategoryExpirationConfig[]
  markdownRules     MarkdownRule[]

  @@unique([campgroundId, name])
  @@index([campgroundId])
}

model Product {
  id                   String               @id @default(cuid())
  campgroundId         String
  categoryId           String?
  name                 String
  description          String?
  priceCents           Int
  imageUrl             String?
  sku                  String?
  stockQty             Int                  @default(0)
  onlineStockQty       Int? // DEPRECATED: Use LocationInventory instead
  posStockQty          Int? // DEPRECATED: Use LocationInventory instead
  channelInventoryMode ChannelInventoryMode @default(shared) // DEPRECATED
  inventoryMode        ProductInventoryMode @default(shared) // NEW: shared or per_location
  availableLocations   String[]             @default([]) // Location IDs (empty = all locations)
  lowStockAlert        Int? // Alert when stock falls below this
  trackInventory       Boolean              @default(true)
  afterHoursAllowed    Boolean              @default(false)
  isActive             Boolean              @default(true)
  sortOrder            Int                  @default(0)
  glCode               String? // For ledger integration
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @default(now()) @updatedAt

  // Batch tracking & expiration
  useBatchTracking Boolean   @default(false) // Enable FEFO batch tracking for this product
  lastSaleDate     DateTime? // Updated on each sale (for slow-moving detection)

  campground        Campground              @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  category          ProductCategory?        @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  orderItems        StoreOrderItem[]
  posCartItems      PosCartItem[]
  locationInventory LocationInventory[]
  priceOverrides    LocationPriceOverride[]
  transferItems     InventoryTransferItem[]
  movements         InventoryMovement[]

  // Batch tracking relations
  inventoryBatches  InventoryBatch[]
  expirationConfigs ProductExpirationConfig[]
  markdownRules     MarkdownRule[]

  // 3rd party POS integration
  externalMappings ProductExternalMapping[]

  @@index([campgroundId])
  @@index([categoryId])
}

model AddOnService {
  id           String           @id @default(cuid())
  campgroundId String
  name         String // "Late Checkout", "Early Check-in", "Extra Vehicle"
  description  String?
  priceCents   Int
  pricingType  AddOnPricingType @default(flat)
  isActive     Boolean          @default(true)
  sortOrder    Int              @default(0)
  glCode       String? // For ledger integration
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @default(now()) @updatedAt

  campground Campground       @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  orderItems StoreOrderItem[]

  @@index([campgroundId])
}

model StoreOrder {
  id                    String                      @id @default(cuid())
  campgroundId          String
  reservationId         String? // If charged to site
  guestId               String?
  siteNumber            String? // For delivery reference
  channel               OrderChannel                @default(pos)
  fulfillmentType       String? // pickup, delivery, dine_in
  deliveryInstructions  String?
  promisedAt            DateTime?
  prepTimeMinutes       Int?
  status                OrderStatus                 @default(pending)
  paymentMethod         PaymentMethod               @default(card)
  paymentIntentId       String? // Stripe payment intent ID for card refunds
  subtotalCents         Int                         @default(0)
  taxCents              Int                         @default(0)
  totalCents            Int                         @default(0)
  notes                 String?
  createdBy             String? // Staff user ID
  // Status timestamps
  seenAt                DateTime? // When staff first viewed the order
  readyAt               DateTime? // When order was marked ready for pickup/delivery
  deliveredAt           DateTime? // When order was delivered to customer
  completedAt           DateTime?
  completedById         String?
  // Multi-location fulfillment
  fulfillmentLocationId String?
  fulfillmentStatus     FulfillmentAssignmentStatus @default(unassigned)
  assignedAt            DateTime?
  assignedById          String?
  createdAt             DateTime                    @default(now())
  updatedAt             DateTime                    @default(now()) @updatedAt

  campground          Campground              @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  reservation         Reservation?            @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  guest               Guest?                  @relation(fields: [guestId], references: [id], onDelete: SetNull)
  completedBy         User?                   @relation("OrderCompletedBy", fields: [completedById], references: [id], onDelete: SetNull)
  fulfillmentLocation StoreLocation?          @relation("FulfillmentLocation", fields: [fulfillmentLocationId], references: [id], onDelete: SetNull)
  assignedBy          User?                   @relation("OrderAssignedBy", fields: [assignedById], references: [id], onDelete: SetNull)
  items               StoreOrderItem[]
  adjustments         StoreOrderAdjustment[]

  @@index([campgroundId])
  @@index([reservationId])
  @@index([guestId])
  @@index([status])
  @@index([fulfillmentLocationId])
  @@index([fulfillmentStatus])
  @@index([seenAt])
}

model StoreOrderItem {
  id         String   @id @default(cuid())
  orderId    String
  productId  String?
  addOnId    String?
  name       String // Snapshot of product/addon name at time of order
  qty        Int      @default(1)
  unitCents  Int
  totalCents Int
  createdAt  DateTime @default(now())

  order   StoreOrder    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product?      @relation(fields: [productId], references: [id], onDelete: SetNull)
  addOn   AddOnService? @relation(fields: [addOnId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([productId])
  @@index([addOnId])
}

enum StoreAdjustmentType {
  refund
  exchange
  discount
}

model StoreOrderAdjustment {
  id                 String              @id @default(cuid())
  orderId            String
  type               StoreAdjustmentType @default(refund)
  amountCents        Int
  note               String?
  items              Json? // Array of affected items: [{itemId, name, qty, amountCents}]
  createdById        String?
  // Payment processor refund tracking
  stripeRefundId     String? // Stripe refund ID if processed via Stripe
  refundStatus       String? // pending, succeeded, failed
  refundError        String? // Error message if refund failed
  // Inventory restoration
  inventoryRestored  Boolean @default(false) // Whether inventory was restocked
  // Guest notification
  notificationSent   Boolean @default(false) // Whether guest was notified
  createdAt          DateTime            @default(now())

  order     StoreOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  createdBy User?      @relation("StoreAdjustmentCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([type])
  @@index([createdAt])
}

model BlackoutDate {
  id           String   @id @default(cuid())
  campgroundId String
  siteId       String? // If null, applies to entire campground
  startDate    DateTime
  endDate      DateTime
  reason       String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  site       Site?      @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([siteId])
  @@index([startDate])
  @@index([endDate])
}

enum PromotionType {
  percentage
  flat
}

model Promotion {
  id           String        @id @default(cuid())
  campgroundId String
  code         String // e.g., "SUMMER20"
  type         PromotionType @default(percentage)
  value        Int // Percentage (0-100) or flat cents
  validFrom    DateTime?
  validTo      DateTime?
  usageLimit   Int? // Max total uses
  usageCount   Int           @default(0)
  isActive     Boolean       @default(true)
  description  String? // Internal note
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @default(now()) @updatedAt

  campground      Campground       @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  analyticsEvents AnalyticsEvent[]

  @@unique([campgroundId, code])
  @@index([campgroundId])
  @@index([code])
}

model ReferralProgram {
  id             String                @id @default(cuid())
  campgroundId   String
  code           String
  linkSlug       String?
  source         String?
  channel        String?
  incentiveType  ReferralIncentiveType @default(percent_discount)
  incentiveValue Int                   @default(0) // percent or cents depending on type
  isActive       Boolean               @default(true)
  notes          String?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @default(now()) @updatedAt

  campground   Campground    @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  reservations Reservation[]

  @@unique([campgroundId, code])
  @@unique([campgroundId, linkSlug])
  @@index([campgroundId, isActive])
}

model Message {
  id            String     @id @default(cuid())
  campgroundId  String
  reservationId String
  guestId       String
  senderType    SenderType
  content       String     @db.Text
  readAt        DateTime?
  createdAt     DateTime   @default(now())

  campground  Campground  @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  reservation Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  guest       Guest       @relation(fields: [guestId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([reservationId])
  @@index([guestId])
}

enum WaitlistStatus {
  active
  fulfilled
  expired
  cancelled
}

enum WaitlistType {
  regular
  seasonal
}

model WaitlistEntry {
  id             String         @id @default(cuid())
  campgroundId   String
  guestId        String? // Optional - can be null for staff-added entries
  siteId         String? // Specific site preference
  siteTypeId     String? // Or just a type preference (e.g. any RV site)
  arrivalDate    DateTime? // Optional for seasonal (just want "next season")
  departureDate  DateTime? // Optional for seasonal
  status         WaitlistStatus @default(active)
  type           WaitlistType   @default(regular)
  // Contact fields for staff-added entries (when no guest profile exists)
  contactName    String?
  contactEmail   String?
  contactPhone   String?
  notes          String? // Staff notes
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @default(now()) @updatedAt
  lastNotifiedAt DateTime?
  notifiedCount  Int            @default(0)

  // Phase 4: Priority and auto-offer fields
  priority               Int       @default(50) // 0-100, higher = more priority
  autoOffer              Boolean   @default(false) // Auto-reserve when match found
  maxPrice               Int? // Max price willing to pay (cents)
  flexibleDates          Boolean   @default(false) // Accept +/- days from requested
  flexibleDays           Int       @default(0) // How many days flexible
  convertedReservationId String? // If converted to a reservation
  convertedAt            DateTime? // When converted
  throttleBucket         String?
  cooldownUntil          DateTime?
  lastOfferSentAt        DateTime?
  lastOfferStatus        String?
  offerCount             Int       @default(0)

  campground Campground              @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  guest      Guest?                  @relation(fields: [guestId], references: [id], onDelete: Cascade)
  site       Site?                   @relation(fields: [siteId], references: [id], onDelete: SetNull)
  siteClass  SiteClass?              @relation(fields: [siteTypeId], references: [id], onDelete: SetNull)
  offers     WaitlistOffer[]
  holds      WaitlistInventoryHold[]
  aiScore    AiWaitlistScore?

  @@index([campgroundId])
  @@index([guestId])
  @@index([status])
  @@index([type])
  @@index([arrivalDate])
  @@index([priority])
}

enum WaitlistOfferStatus {
  pending
  sent
  accepted
  declined
  expired
  failed
}

model WaitlistOffer {
  id              String              @id @default(cuid())
  entryId         String
  inventoryRef    String
  offerExpiresAt  DateTime
  sentAt          DateTime?
  acceptedAt      DateTime?
  declinedAt      DateTime?
  autoExpiredAt   DateTime?
  status          WaitlistOfferStatus @default(pending)
  commsTemplateId String?
  idempotencyKey  String
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  entry WaitlistEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)

  @@index([entryId, status])
  @@index([idempotencyKey])
  @@index([inventoryRef])
}

model WaitlistInventoryHold {
  id            String   @id @default(cuid())
  inventoryRef  String
  entryId       String?
  status        String   @default("held") // held, released, captured, expired
  holdExpiresAt DateTime
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  entry WaitlistEntry? @relation(fields: [entryId], references: [id], onDelete: SetNull)

  @@index([inventoryRef, status])
  @@index([entryId])
}

// ---------------------------------------------------------------------------
// Phase 4: Notification Triggers
// ---------------------------------------------------------------------------

model NotificationTrigger {
  id           String   @id @default(cuid())
  campgroundId String
  event        String // reservation_created, payment_received, checkin_reminder, etc.
  channel      String // email, sms, both
  enabled      Boolean  @default(true)
  templateId   String? // Link to a CampaignTemplate
  delayMinutes Int      @default(0) // 0 = immediate, >0 = scheduled
  conditions   Json? // Conditional rules (e.g. { "source": "online" })
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground             Campground              @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  template               CampaignTemplate?       @relation(fields: [templateId], references: [id], onDelete: SetNull)
  scheduledNotifications ScheduledNotification[]

  @@index([campgroundId])
  @@index([event])
  @@index([enabled])
}

model ScheduledNotification {
  id           String    @id @default(cuid())
  campgroundId String
  triggerId    String
  event        String
  channel      String
  payload      Json // TriggerPayload data
  sendAt       DateTime
  status       String    @default("pending") // pending, sent, failed, cancelled
  sentAt       DateTime?
  error        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  campground Campground          @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  trigger    NotificationTrigger @relation(fields: [triggerId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([status, sendAt])
}

model InternalConversation {
  id           String   @id @default(cuid())
  name         String? // Required for Channels, Null for DMs
  type         String // "channel" or "dm"
  campgroundId String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground   Campground                        @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  messages     InternalMessage[]
  participants InternalConversationParticipant[]

  @@index([campgroundId])
}

model InternalConversationParticipant {
  id             String   @id @default(cuid())
  conversationId String
  userId         String
  joinedAt       DateTime @default(now())

  conversation InternalConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
}

model InternalMessage {
  id             String   @id @default(cuid())
  content        String
  senderId       String
  conversationId String
  createdAt      DateTime @default(now())

  sender       User                 @relation(fields: [senderId], references: [id], onDelete: Cascade)
  conversation InternalConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([conversationId])
  @@index([createdAt])
}

model AuditLog {
  id           String    @id @default(cuid())
  campgroundId String
  actorId      String?
  action       String
  entity       String
  entityId     String
  before       Json?
  after        Json?
  ip           String?
  userAgent    String?
  chainHash    String    @default("")
  prevHash     String?
  version      Int       @default(1)
  retentionAt  DateTime?
  createdAt    DateTime  @default(now())

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  actor      User?      @relation(fields: [actorId], references: [id], onDelete: SetNull)

  @@index([campgroundId, createdAt])
  @@index([campgroundId, chainHash])
}

model AuditExport {
  id            String   @id @default(cuid())
  campgroundId  String
  requestedById String
  format        String // csv | json
  filters       Json?
  recordCount   Int
  createdAt     DateTime @default(now())

  campground  Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  requestedBy User       @relation(fields: [requestedById], references: [id], onDelete: Cascade)

  @@index([campgroundId, createdAt])
  @@index([requestedById, createdAt])
}

model PrivacySetting {
  id                  String   @id @default(cuid())
  campgroundId        String   @unique
  redactPII           Boolean  @default(true)
  consentRequired     Boolean  @default(true)
  backupRetentionDays Int      @default(30)
  keyRotationDays     Int      @default(90)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
}

model ConsentLog {
  id           String        @id @default(cuid())
  campgroundId String
  subject      String
  consentType  String
  grantedBy    String
  method       ConsentMethod @default(digital)
  purpose      String?
  expiresAt    DateTime?
  revokedAt    DateTime?
  metadata     Json?
  grantedAt    DateTime      @default(now())

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId, grantedAt])
}

model PiiFieldTag {
  id             String            @id @default(cuid())
  resource       String
  field          String
  classification PiiClassification
  redactionMode  RedactionMode     @default(mask)
  createdById    String?
  createdAt      DateTime          @default(now())

  createdBy User? @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@unique([resource, field])
  @@index([createdById])
  @@index([classification])
}

model ApprovalPolicy {
  id              String     @id @default(cuid())
  campgroundId    String?
  name            String
  action          String // "refund", "payout", "config_change"
  appliesTo       String[] // Array of action types this policy covers
  thresholdCents  Int? // Amount threshold in cents (e.g., 25000 = $250)
  currency        String     @default("USD")
  approversNeeded Int        @default(1)
  description     String?
  isActive        Boolean    @default(true)
  approverRoles   UserRole[]
  createdById     String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  campground Campground?       @relation(fields: [campgroundId], references: [id], onDelete: SetNull)
  createdBy  User?             @relation(fields: [createdById], references: [id], onDelete: SetNull)
  requests   ApprovalRequest[] @relation("ApprovalPolicy_campground_action")

  @@unique([campgroundId, action])
  @@index([campgroundId, action])
  @@index([campgroundId, isActive])
}

model ApprovalRequest {
  id                String         @id @default(cuid())
  campgroundId      String?
  action            String // "refund", "payout", "config_change"
  requestedBy       String
  requesterName     String?
  amount            Int            @default(0) // Amount in cents
  currency          String         @default("USD")
  reason            String?
  resource          String?
  targetId          String?
  payload           Json?
  status            ApprovalStatus @default(pending)
  requiredApprovals Int            @default(1)
  approvals         Json? // Array of {approver, at} objects
  decidedBy         String?
  decidedAt         DateTime?
  policyId          String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  campground Campground?     @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  policy     ApprovalPolicy? @relation("ApprovalPolicy_campground_action", fields: [campgroundId, action], references: [campgroundId, action], onDelete: SetNull, onUpdate: Cascade, map: "ApprovalPolicy_campground_action")

  @@index([campgroundId, status])
  @@index([policyId])
}

model PermissionRule {
  id           String           @id @default(cuid())
  campgroundId String?
  role         UserRole
  resource     String
  action       String
  fields       String[]
  effect       PermissionEffect @default(allow)
  createdById  String?
  createdAt    DateTime         @default(now())

  campground Campground? @relation(fields: [campgroundId], references: [id], onDelete: SetNull)
  createdBy  User?       @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@unique([campgroundId, role, resource, action])
  @@index([resource, action])
}

model InviteToken {
  id           String    @id @default(cuid())
  token        String    @unique
  userId       String
  campgroundId String
  expiresAt    DateTime
  redeemedAt   DateTime?
  createdAt    DateTime  @default(now())

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([userId, campgroundId])
  @@index([campgroundId, createdAt])
}

model OnboardingInvite {
  id             String    @id @default(cuid())
  token          String    @unique
  email          String
  organizationId String?
  campgroundId   String?
  invitedById    String?
  expiresAt      DateTime
  redeemedAt     DateTime?
  lastSentAt     DateTime?
  createdAt      DateTime  @default(now())

  session      OnboardingSession? @relation("InviteSessions")
  organization Organization?      @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  campground   Campground?        @relation(fields: [campgroundId], references: [id], onDelete: SetNull)
  invitedBy    User?              @relation(fields: [invitedById], references: [id], onDelete: SetNull)

  @@index([token])
  @@index([organizationId, createdAt])
  @@index([campgroundId, createdAt])
}

model OnboardingSession {
  id             String           @id @default(cuid())
  inviteId       String           @unique
  organizationId String?
  campgroundId   String?
  status         OnboardingStatus @default(pending)
  currentStep    OnboardingStep   @default(account_profile)
  completedSteps OnboardingStep[] @default([])
  data           Json?
  progress       Json?
  expiresAt      DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  invite       OnboardingInvite @relation("InviteSessions", fields: [inviteId], references: [id], onDelete: Cascade)
  organization Organization?    @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  campground   Campground?      @relation(fields: [campgroundId], references: [id], onDelete: SetNull)

  @@index([inviteId])
  @@index([organizationId])
  @@index([campgroundId])
}

// Activity scheduling mode
enum ActivitySchedulingMode {
  scheduled // Staff-led, specific session times (yoga class, guided hike)
  open_availability // Self-service, operating hours (kayak rental, bike rental)
}

// Recurrence pattern type
enum RecurrencePatternType {
  none
  daily
  weekly
  biweekly
  monthly
}

model Activity {
  id           String   @id @default(cuid())
  campgroundId String
  name         String
  description  String?
  images       String[] @default([])
  price        Int // in cents
  duration     Int // in minutes
  capacity     Int // max participants per session
  isActive     Boolean  @default(true)

  // Scheduling mode
  schedulingMode ActivitySchedulingMode @default(scheduled)

  // Open availability settings (for rentals)
  operatingHours Json? // { "mon": { "start": "09:00", "end": "17:00" }, ... }
  slotDuration   Int? // Time slot duration in minutes for open availability
  maxConcurrent  Int? // Max simultaneous rentals/bookings

  // Pricing options
  weekendPremium    Int? // Extra charge in cents for weekend sessions
  holidayPremium    Int? // Extra charge in cents for holiday sessions
  earlyBirdDiscount Int? // Discount in cents for booking X days ahead
  earlyBirdDays     Int? // Number of days ahead for early bird discount

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campground         Campground                  @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  sessions           ActivitySession[]
  recurrencePatterns ActivityRecurrencePattern[]
  bundleItems        ActivityBundleItem[]
}

// Recurrence pattern for generating sessions
model ActivityRecurrencePattern {
  id          String                @id @default(cuid())
  activityId  String
  patternType RecurrencePatternType
  daysOfWeek  Int[] // 0=Sun, 1=Mon, ... 6=Sat (for weekly/biweekly)
  dayOfMonth  Int? // For monthly (e.g., 15 = 15th of each month)
  weekOfMonth Int? // For monthly (e.g., 2 = second week)
  startTime   String // "09:00" format
  endTime     String // "10:30" format
  validFrom   DateTime // When this pattern starts
  validUntil  DateTime? // When this pattern ends (null = indefinite)
  capacity    Int? // Override activity capacity for sessions from this pattern
  isActive    Boolean               @default(true)
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt

  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@index([activityId, isActive])
}

model ActivitySession {
  id                  String   @id @default(cuid())
  activityId          String
  recurrencePatternId String? // Which pattern generated this session (null = manually created)
  startTime           DateTime
  endTime             DateTime
  capacity            Int // Override activity capacity if needed
  bookedCount         Int      @default(0)
  status              String   @default("scheduled") // scheduled, cancelled, completed
  priceOverride       Int? // Override price for this specific session (holidays, etc.)

  activity Activity          @relation(fields: [activityId], references: [id], onDelete: Cascade)
  bookings ActivityBooking[]

  @@index([activityId, startTime])
  @@index([startTime, status])
}

model ActivityBooking {
  id            String   @id @default(cuid())
  sessionId     String
  guestId       String
  reservationId String? // Optional link to a stay
  quantity      Int
  totalAmount   Int
  status        String   @default("confirmed") // confirmed, cancelled
  createdAt     DateTime @default(now())

  session     ActivitySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  guest       Guest           @relation(fields: [guestId], references: [id], onDelete: Cascade)
  reservation Reservation?    @relation(fields: [reservationId], references: [id])
}

// Activity bundles/packages for upselling
model ActivityBundle {
  id            String    @id @default(cuid())
  campgroundId  String
  name          String // e.g., "Adventure Package", "Family Fun Bundle"
  description   String?
  price         Int // Bundle price in cents (should be less than sum of activities)
  discountType  String    @default("fixed") // "fixed" = set price, "percent" = % off total
  discountValue Int? // For percent type, the percentage discount
  isActive      Boolean   @default(true)
  validFrom     DateTime?
  validUntil    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  campground Campground           @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  items      ActivityBundleItem[]

  @@index([campgroundId, isActive])
}

// Items in a bundle
model ActivityBundleItem {
  id         String @id @default(cuid())
  bundleId   String
  activityId String
  quantity   Int    @default(1) // How many sessions of this activity are included

  bundle   ActivityBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  activity Activity       @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@unique([bundleId, activityId])
}

model MembershipType {
  id              String  @id @default(cuid())
  campgroundId    String
  name            String
  description     String?
  price           Int // in cents
  durationDays    Int // 365 for annual
  discountPercent Int // e.g., 10 for 10% off
  isActive        Boolean @default(true)

  campground  Campground        @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  memberships GuestMembership[]
}

model GuestMembership {
  id               String   @id @default(cuid())
  membershipTypeId String
  guestId          String
  startDate        DateTime
  endDate          DateTime
  status           String   @default("active") // active, expired, cancelled
  purchaseAmount   Int

  membershipType MembershipType @relation(fields: [membershipTypeId], references: [id])
  guest          Guest          @relation(fields: [guestId], references: [id], onDelete: Cascade)
}

model OperationalTask {
  id           String    @id @default(cuid())
  campgroundId String
  title        String
  description  String?
  type         String // housekeeping, maintenance, inspection
  status       String    @default("pending") // pending, in_progress, completed, verified
  priority     String    @default("medium") // low, medium, high, urgent
  assignedTo   String? // User ID
  dueDate      DateTime?
  completedAt  DateTime?

  // Relations
  siteId     String?
  site       Site?      @relation(fields: [siteId], references: [id])
  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Communication {
  id                String    @id @default(cuid())
  campgroundId      String
  organizationId    String?
  guestId           String?
  reservationId     String?
  type              String // email | sms | note | call
  direction         String // inbound | outbound
  subject           String?
  body              String?
  preview           String?
  status            String // sent | delivered | failed | queued | received
  provider          String?
  providerMessageId String?
  toAddress         String?
  fromAddress       String?
  sentAt            DateTime?
  receivedAt        DateTime?
  metadata          Json?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @default(now()) @updatedAt

  guest       Guest?       @relation(fields: [guestId], references: [id], onDelete: SetNull)
  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  campground  Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId, createdAt])
  @@index([guestId, createdAt])
  @@index([reservationId, createdAt])
  @@index([type, direction])
}

model CommunicationTemplate {
  id           String    @id @default(cuid())
  campgroundId String
  name         String
  subject      String?
  bodyHtml     String?
  status       String    @default("draft") // draft | pending | approved | rejected
  version      Int       @default(1)
  approvedById String?
  approvedAt   DateTime?
  auditLog     Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  campground Campground              @relation("CampgroundCommunicationTemplates", fields: [campgroundId], references: [id], onDelete: Cascade)
  approvedBy User?                   @relation("CommunicationTemplateApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)
  playbooks  CommunicationPlaybook[] @relation("PlaybookTemplate")

  @@index([campgroundId])
  @@index([status])
}

model CommunicationPlaybook {
  id                String   @id @default(cuid())
  campgroundId      String
  type              String // arrival | unpaid | upsell | abandoned_cart
  enabled           Boolean  @default(false)
  templateId        String?
  channel           String? // email | sms
  offsetMinutes     Int? // relative to event (e.g., -120 for arrival-2h)
  quietHoursStart   String? // HH:mm
  quietHoursEnd     String? // HH:mm
  throttlePerMinute Int?
  routingAssigneeId String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  campground Campground                 @relation("CampgroundCommunicationPlaybooks", fields: [campgroundId], references: [id], onDelete: Cascade)
  template   CommunicationTemplate?     @relation("PlaybookTemplate", fields: [templateId], references: [id], onDelete: SetNull)
  jobs       CommunicationPlaybookJob[] @relation("PlaybookJobs")

  @@index([campgroundId, type])
  @@index([templateId])
}

model CommunicationPlaybookJob {
  id            String   @id @default(cuid())
  playbookId    String
  campgroundId  String
  reservationId String?
  guestId       String?
  status        String   @default("pending") // pending | processing | sent | failed | skipped
  scheduledAt   DateTime
  attempts      Int      @default(0)
  lastError     String?
  metadata      Json?    @default("{}")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  playbook    CommunicationPlaybook @relation("PlaybookJobs", fields: [playbookId], references: [id], onDelete: Cascade)
  campground  Campground            @relation("CampgroundCommunicationPlaybookJobs", fields: [campgroundId], references: [id], onDelete: Cascade)
  reservation Reservation?          @relation("ReservationCommunicationPlaybookJobs", fields: [reservationId], references: [id], onDelete: SetNull)
  guest       Guest?                @relation("GuestCommunicationPlaybookJobs", fields: [guestId], references: [id], onDelete: SetNull)

  @@index([playbookId, status, scheduledAt])
  @@index([campgroundId])
  @@index([reservationId])
}

model OtaChannel {
  id                         String    @id @default(cuid())
  campgroundId               String
  name                       String
  provider                   String
  status                     String    @default("disabled") // disabled | pull | two_way
  rateMultiplier             Float     @default(1.0)
  defaultStatus              String    @default("confirmed") // confirmed | pending
  sendEmailNotifications     Boolean   @default(false)
  ignoreSiteRestrictions     Boolean   @default(false)
  ignoreCategoryRestrictions Boolean   @default(false)
  feeMode                    String    @default("absorb") // absorb | pass_through
  webhookSecret              String?
  lastSyncAt                 DateTime?
  createdAt                  DateTime  @default(now())
  updatedAt                  DateTime  @updatedAt

  campground Campground             @relation("CampgroundOtaChannels", fields: [campgroundId], references: [id], onDelete: Cascade)
  mappings   OtaListingMapping[]
  syncLogs   OtaSyncLog[]
  imports    OtaReservationImport[]

  @@index([campgroundId])
  @@index([provider, campgroundId])
}

model OtaListingMapping {
  id          String    @id @default(cuid())
  channelId   String
  siteId      String?
  siteClassId String?
  externalId  String
  status      String    @default("mapped") // mapped | disabled
  lastSyncAt  DateTime?
  lastError   String?
  icalToken   String?   @unique
  icalUrl     String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  channel   OtaChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  site      Site?      @relation("SiteOtaMappings", fields: [siteId], references: [id], onDelete: SetNull)
  siteClass SiteClass? @relation("SiteClassOtaMappings", fields: [siteClassId], references: [id], onDelete: SetNull)

  @@unique([channelId, externalId], name: "channelId_externalId")
  @@index([channelId, siteId])
  @@index([channelId, siteClassId])
}

model OtaSyncLog {
  id        String   @id @default(cuid())
  channelId String
  direction String // push | pull
  eventType String // availability | pricing | reservation
  status    String // success | failed
  message   String?
  payload   Json?
  createdAt DateTime @default(now())

  channel OtaChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([channelId, createdAt])
  @@index([channelId, direction, eventType])
}

model OtaReservationImport {
  id                    String   @id @default(cuid())
  channelId             String
  externalReservationId String
  status                String // pending | imported | failed
  message               String?
  reservationId         String?
  createdAt             DateTime @default(now())

  channel     OtaChannel   @relation(fields: [channelId], references: [id], onDelete: Cascade)
  reservation Reservation? @relation("ReservationOtaImports", fields: [reservationId], references: [id], onDelete: SetNull)

  @@unique([channelId, externalReservationId])
  @@index([reservationId])
}

// =============================================================================
// NPS
// =============================================================================

model NpsSurvey {
  id              String          @id @default(cuid())
  campgroundId    String
  name            String
  question        String?
  status          NpsSurveyStatus @default(draft)
  channels        String[]        @default(["inapp", "email"])
  locales         String[]        @default(["en"])
  cooldownDays    Int? // minimum days between invites per guest
  samplingPercent Int? // 0-100
  metadata        Json?
  activeFrom      DateTime?
  activeTo        DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @default(now()) @updatedAt

  campground Campground    @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  rules      NpsRule[]
  invites    NpsInvite[]
  responses  NpsResponse[]

  @@index([campgroundId, status])
}

model NpsRule {
  id           String   @id @default(cuid())
  surveyId     String
  trigger      String // post_checkout | post_booking | manual
  percentage   Int? // sampling percent override
  cooldownDays Int? // override per rule
  segmentJson  Json?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt

  survey NpsSurvey @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  @@index([surveyId, isActive])
}

model NpsInvite {
  id             String          @id @default(cuid())
  surveyId       String
  campgroundId   String
  organizationId String?
  guestId        String?
  reservationId  String?
  channel        String // email | sms | inapp
  status         NpsInviteStatus @default(queued)
  token          String          @unique
  expiresAt      DateTime?
  sentAt         DateTime?
  openedAt       DateTime?
  respondedAt    DateTime?
  metadata       Json?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @default(now()) @updatedAt

  survey      NpsSurvey    @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  campground  Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  guest       Guest?       @relation(fields: [guestId], references: [id], onDelete: SetNull)
  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  response    NpsResponse?
  events      NpsEvent[]

  @@index([campgroundId, status])
  @@index([guestId])
  @@index([reservationId])
}

model NpsResponse {
  id            String   @id @default(cuid())
  surveyId      String
  inviteId      String?
  campgroundId  String
  guestId       String?
  reservationId String?
  score         Int
  comment       String?
  tags          String[] @default([])
  sentiment     String?
  createdAt     DateTime @default(now())

  // Follow-up tracking
  followedUp   Boolean   @default(false)
  followUpAt   DateTime?
  followUpNote String?   @db.Text
  followUpBy   String?   // User ID who did the follow-up

  // Resolution tracking
  resolved      Boolean   @default(false)
  resolvedAt    DateTime?
  resolvedBy    String?   // User ID who resolved
  resolvedNote  String?   @db.Text

  survey      NpsSurvey    @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  invite      NpsInvite?   @relation(fields: [inviteId], references: [id], onDelete: SetNull)
  campground  Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  guest       Guest?       @relation(fields: [guestId], references: [id], onDelete: SetNull)
  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)

  @@unique([inviteId])
  @@index([campgroundId, createdAt])
  @@index([surveyId])
  @@index([guestId])
  @@index([reservationId])
  @@index([followedUp])
  @@index([resolved])
}

model NpsEvent {
  id        String   @id @default(cuid())
  inviteId  String
  type      String // open | click | unsub
  payload   Json?
  createdAt DateTime @default(now())

  invite NpsInvite @relation(fields: [inviteId], references: [id], onDelete: Cascade)

  @@index([inviteId, type])
}

// =============================================================================
// Reviews
// =============================================================================

model ReviewRequest {
  id             String    @id @default(cuid())
  campgroundId   String
  organizationId String?
  guestId        String?
  reservationId  String?
  channel        String // email | sms | inapp | kiosk
  status         String    @default("queued")
  token          String    @unique
  expiresAt      DateTime?
  sentAt         DateTime?
  respondedAt    DateTime?
  metadata       Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @default(now()) @updatedAt

  campground  Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  guest       Guest?       @relation(fields: [guestId], references: [id], onDelete: SetNull)
  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  review      Review?

  @@index([campgroundId, status])
  @@index([guestId])
  @@index([reservationId])
}

model Review {
  id             String         @id @default(cuid())
  campgroundId   String
  organizationId String?
  guestId        String?
  reservationId  String?
  requestId      String?
  rating         Int
  title          String?
  body           String?        @db.Text
  photos         String[]       @default([])
  tags           String[]       @default([])
  sentiment      String?
  source         ReviewSource   @default(onsite)
  status         ReviewStatus   @default(pending)
  exposure       ReviewExposure @default(private)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @default(now()) @updatedAt

  campground  Campground        @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  guest       Guest?            @relation(fields: [guestId], references: [id], onDelete: SetNull)
  reservation Reservation?      @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  request     ReviewRequest?    @relation(fields: [requestId], references: [id], onDelete: SetNull)
  moderation  ReviewModeration?
  votes       ReviewVote[]
  replies     ReviewReply[]

  @@unique([requestId])
  @@index([campgroundId, status, createdAt])
  @@index([guestId])
  @@index([reservationId])
  @@index([source])
}

model ReviewModeration {
  id        String                 @id @default(cuid())
  reviewId  String                 @unique
  status    ReviewModerationStatus @default(pending)
  reasons   String[]               @default([])
  decidedBy String?
  decidedAt DateTime?
  notes     String?

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
}

model ReviewVote {
  id           String          @id @default(cuid())
  reviewId     String
  guestId      String?
  ipHash       String?
  value        ReviewVoteValue
  createdAt    DateTime        @default(now())
  campgroundId String

  review     Review     @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  guest      Guest?     @relation(fields: [guestId], references: [id], onDelete: SetNull)
  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@unique([reviewId, guestId])
  @@index([reviewId])
  @@index([ipHash])
  @@index([campgroundId])
}

model ReviewReply {
  id         String   @id @default(cuid())
  reviewId   String
  authorType String // staff | guest
  authorId   String?
  body       String   @db.Text
  createdAt  DateTime @default(now())

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([reviewId])
}

// =============================================================================
// GAMIFICATION
// =============================================================================

model GamificationSetting {
  id           String     @id @default(cuid())
  campgroundId String     @unique
  enabled      Boolean    @default(false)
  enabledRoles UserRole[] @default([])
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
}

model LevelDefinition {
  id        String   @id @default(cuid())
  level     Int      @unique
  name      String
  minXp     Int
  perks     Json?
  createdAt DateTime @default(now())
}

model XpRule {
  id           String                    @id @default(cuid())
  campgroundId String
  category     GamificationEventCategory
  minXp        Int                       @default(0)
  maxXp        Int                       @default(0)
  defaultXp    Int                       @default(0)
  isActive     Boolean                   @default(true)
  createdById  String?
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @default(now()) @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  createdBy  User?      @relation("XpRuleCreator", fields: [createdById], references: [id], onDelete: SetNull)

  @@unique([campgroundId, category])
  @@index([campgroundId])
  @@index([createdById])
}

model XpBalance {
  id           String    @id @default(cuid())
  campgroundId String
  userId       String
  totalXp      Int       @default(0)
  currentLevel Int       @default(1)
  lastEventAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @default(now()) @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, userId])
  @@index([campgroundId])
  @@index([userId])
}

model XpEvent {
  id           String                    @id @default(cuid())
  campgroundId String
  userId       String
  membershipId String?
  category     GamificationEventCategory
  xp           Int
  reason       String?
  sourceType   String?
  sourceId     String?
  eventKey     String?                   @unique
  metadata     Json?
  occurredAt   DateTime                  @default(now())
  createdAt    DateTime                  @default(now())

  campground Campground            @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  user       User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  membership CampgroundMembership? @relation(fields: [membershipId], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([userId])
  @@index([campgroundId, userId])
  @@index([membershipId])
  @@index([category])
}

// =============================================================================
// Integrations & Ecosystem
// =============================================================================

model IntegrationConnection {
  id             String    @id @default(cuid())
  campgroundId   String?
  organizationId String?
  type           String // accounting | access_control | crm | export
  provider       String // qbo | xero | hubspot | intercom | zendesk | sftp | api
  status         String    @default("disconnected") // disconnected | connected | error | pending
  authType       String? // oauth | api_key | basic | sftp
  credentials    Json?
  settings       Json?
  webhookSecret  String?
  lastSyncAt     DateTime?
  lastSyncStatus String?
  lastError      String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  campground   Campground?               @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  organization Organization?             @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  logs         IntegrationSyncLog[]
  webhooks     IntegrationWebhookEvent[]
  exportJobs   IntegrationExportJob[]

  @@unique([campgroundId, type, provider])
  @@index([campgroundId, type, provider])
}

model IntegrationSyncLog {
  id           String   @id @default(cuid())
  connectionId String
  direction    String // pull | push | webhook | export
  scope        String // accounting | access_control | crm | export
  status       String // success | failed | queued
  message      String?
  payload      Json?
  occurredAt   DateTime @default(now())
  createdAt    DateTime @default(now())

  connection IntegrationConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@index([connectionId, occurredAt])
  @@index([status])
}

model IntegrationWebhookEvent {
  id             String   @id @default(cuid())
  connectionId   String?
  provider       String
  eventType      String?
  status         String   @default("received") // received | ignored | failed
  signatureValid Boolean?
  message        String?
  payload        Json?
  receivedAt     DateTime @default(now())

  connection IntegrationConnection? @relation(fields: [connectionId], references: [id], onDelete: SetNull)

  @@index([provider, receivedAt])
  @@index([connectionId, receivedAt])
}

model IntegrationExportJob {
  id            String    @id @default(cuid())
  connectionId  String?
  campgroundId  String?
  type          String // api | sftp
  resource      String? // ledger | reservations | guests | activities
  status        String    @default("queued") // queued | processing | success | failed
  location      String?
  requestedById String?
  filters       Json?
  startedAt     DateTime?
  completedAt   DateTime?
  lastError     String?
  createdAt     DateTime  @default(now())

  connection  IntegrationConnection? @relation(fields: [connectionId], references: [id], onDelete: SetNull)
  campground  Campground?            @relation(fields: [campgroundId], references: [id], onDelete: SetNull)
  requestedBy User?                  @relation(fields: [requestedById], references: [id], onDelete: SetNull)

  @@index([campgroundId, status])
  @@index([connectionId, status])
  @@index([requestedById])
}

// =============================================================================
// Developer Ecosystem: Public API + Webhooks
// =============================================================================

model ApiClient {
  id               String   @id @default(cuid())
  campgroundId     String
  name             String
  clientId         String   @unique
  clientSecretHash String
  scopes           String[]
  isActive         Boolean  @default(true)
  rateLimit        Int      @default(1000) // requests per hour
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  campground       Campground        @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  tokens           ApiToken[]
  webhookEndpoints WebhookEndpoint[]
  apiUsage         ApiUsage[]
  externalPosSales ExternalPosSale[]

  @@index([campgroundId])
}

model ApiToken {
  id               String    @id @default(cuid())
  apiClientId      String
  accessTokenHash  String    @unique
  refreshTokenHash String?
  scopes           String[]
  expiresAt        DateTime
  revokedAt        DateTime?
  createdAt        DateTime  @default(now())

  apiClient ApiClient @relation(fields: [apiClientId], references: [id], onDelete: Cascade)

  @@index([apiClientId])
  @@index([expiresAt])
}

model WebhookEndpoint {
  id           String    @id @default(cuid())
  campgroundId String
  apiClientId  String?
  url          String
  secret       String
  eventTypes   String[] // e.g., reservation.created, payment.created, event.updated
  description  String?
  isActive     Boolean   @default(true)
  disabledAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  campground Campground        @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  apiClient  ApiClient?        @relation(fields: [apiClientId], references: [id], onDelete: SetNull)
  deliveries WebhookDelivery[]

  @@index([campgroundId, isActive])
  @@index([apiClientId])
}

model WebhookDelivery {
  id                String    @id @default(cuid())
  webhookEndpointId String
  eventType         String
  status            String // pending | delivered | failed | retrying
  payload           Json
  responseStatus    Int?
  responseBody      String?
  attempt           Int       @default(1)
  signature         String?
  createdAt         DateTime  @default(now())
  deliveredAt       DateTime?
  errorMessage      String?
  replayOfId        String?
  nextRetryAt       DateTime? // For exponential backoff retry scheduling

  webhookEndpoint WebhookEndpoint @relation(fields: [webhookEndpointId], references: [id], onDelete: Cascade)

  @@index([webhookEndpointId, createdAt])
  @@index([eventType])
  @@index([status])
  @@index([status, nextRetryAt]) // For retry processing
}

// API Usage Tracking - for rate limiting and analytics
model ApiUsage {
  id           String   @id @default(cuid())
  apiClientId  String
  endpoint     String // e.g., "GET /api/v1/reservations"
  method       String // GET, POST, PUT, DELETE
  statusCode   Int
  responseTime Int // milliseconds
  requestSize  Int? // bytes
  responseSize Int? // bytes
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())

  apiClient ApiClient @relation(fields: [apiClientId], references: [id], onDelete: Cascade)

  @@index([apiClientId, createdAt])
  @@index([createdAt])
  @@index([endpoint])
}

// =============================================================================
// Phase 1: Dynamic pricing, deposits, upsells, idempotency, audit
// =============================================================================

enum PricingRuleType {
  season
  weekend
  holiday
  event
  demand
}

enum PricingStackMode {
  additive
  max
  override
}

enum AdjustmentType {
  percent
  flat
}

enum DepositStrategy {
  first_night
  percent
  fixed
}

enum DepositApplyTo {
  lodging_only
  lodging_plus_fees
}

enum DepositDueTiming {
  at_booking
  before_arrival
}

enum BackoffStrategy {
  fixed
  linear
  exponential
}

enum UpsellPriceType {
  flat
  per_night
  per_guest
  per_site
}

enum UpsellChargeType {
  pay_now
  add_to_reservation
}

enum UpsellStatus {
  pending_charge
  charged
  canceled
}

enum IdempotencyStatus {
  pending
  inflight
  succeeded
  failed
}

model PricingRuleV2 {
  id              String           @id @default(cuid())
  campgroundId    String
  siteClassId     String?
  name            String
  type            PricingRuleType
  priority        Int
  stackMode       PricingStackMode
  adjustmentType  AdjustmentType
  adjustmentValue Decimal          @db.Decimal(8, 4)
  startDate       DateTime?
  endDate         DateTime?
  dowMask         Int[]
  calendarRefId   String?
  demandBandId    String?
  minRateCap      Int?
  maxRateCap      Int?
  active          Boolean          @default(true)
  createdBy       String?
  updatedBy       String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  siteClass  SiteClass? @relation(fields: [siteClassId], references: [id], onDelete: SetNull)
}

model DemandBand {
  id              String         @id @default(cuid())
  campgroundId    String
  siteClassId     String?
  thresholdPct    Int // 0-100 occupancy threshold
  adjustmentType  AdjustmentType
  adjustmentValue Decimal        @db.Decimal(8, 4)
  priority        Int
  active          Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  campground Campground @relation("CampgroundDemandBands", fields: [campgroundId], references: [id], onDelete: Cascade)
  siteClass  SiteClass? @relation(fields: [siteClassId], references: [id], onDelete: SetNull)
}

model DepositPolicy {
  id           String               @id @default(cuid())
  campgroundId String
  siteClassId  String?
  name         String
  strategy     DepositStrategy
  value        Int
  minCap       Int?
  maxCap       Int?
  applyTo      DepositApplyTo
  dueTiming    DepositDueTiming
  retryPlanId  String?
  active       Boolean              @default(true)
  version      Int                  @default(1)
  createdBy    String?
  updatedBy    String?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  schedule     AutoCollectSchedule?

  campground           Campground  @relation("CampgroundDepositPolicies", fields: [campgroundId], references: [id], onDelete: Cascade)
  siteClass            SiteClass?  @relation(fields: [siteClassId], references: [id], onDelete: SetNull)
  defaultForCampground Campground? @relation("CampgroundDefaultDepositPolicy")
}

model AutoCollectSchedule {
  id                       String          @id @default(cuid())
  depositPolicyId          String          @unique
  attemptOffsetsDays       Int[]
  cutoffHoursBeforeArrival Int
  backoffStrategy          BackoffStrategy
  maxAttempts              Int
  notifyTemplateIds        Json?
  createdAt                DateTime        @default(now())
  updatedAt                DateTime        @updatedAt

  policy DepositPolicy @relation(fields: [depositPolicyId], references: [id], onDelete: Cascade)
}

model UpsellItem {
  id                String             @id @default(cuid())
  campgroundId      String
  siteClassId       String?
  name              String
  description       String?
  priceType         UpsellPriceType
  priceCents        Int
  taxCode           String?
  inventoryTracking Boolean            @default(false)
  active            Boolean            @default(true)
  version           Int                @default(1)
  createdBy         String?
  updatedBy         String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  bundles           UpsellBundleItem[]

  campground         Campground          @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  siteClass          SiteClass?          @relation(fields: [siteClassId], references: [id], onDelete: SetNull)
  reservationUpsells ReservationUpsell[]
}

model UpsellBundle {
  id           String             @id @default(cuid())
  campgroundId String
  name         String
  priceMode    String // "bundle" or "sum"
  bundlePrice  Int?
  active       Boolean            @default(true)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  items        UpsellBundleItem[]

  campground         Campground          @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  reservationUpsells ReservationUpsell[]
}

model UpsellBundleItem {
  id       String       @id @default(cuid())
  bundleId String
  itemId   String
  required Boolean      @default(true)
  quantity Int          @default(1)
  bundle   UpsellBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  item     UpsellItem   @relation(fields: [itemId], references: [id], onDelete: Cascade)
}

model ReservationUpsell {
  id              String           @id @default(cuid())
  reservationId   String
  itemId          String?
  bundleId        String?
  quantity        Int              @default(1)
  priceSnapshot   Json
  taxCodeSnapshot String?
  chargeType      UpsellChargeType
  status          UpsellStatus     @default(pending_charge)
  attemptNo       Int              @default(0)
  idempotencyKey  String?
  createdBy       String?
  updatedBy       String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  reservation Reservation   @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  item        UpsellItem?   @relation(fields: [itemId], references: [id], onDelete: SetNull)
  bundle      UpsellBundle? @relation(fields: [bundleId], references: [id], onDelete: SetNull)
}

model IdempotencyKey {
  id           String            @id @default(cuid())
  campgroundId String?
  key          String            @unique
  requestHash  String
  responseJson Json?
  status       IdempotencyStatus @default(pending)
  resourceRef  String?
  lastSeenAt   DateTime          @default(now())
  createdAt    DateTime          @default(now())
}

// Phase 4: shared idempotency records for POST/replay dedupe
model IdempotencyRecord {
  id             String            @id @default(cuid())
  scope          String
  tenantId       String?
  campgroundId   String?
  endpoint       String
  idempotencyKey String
  requestHash    String
  checksum       String?
  requestBody    Json?
  responseJson   Json?
  status         IdempotencyStatus @default(pending)
  sequence       String?
  expiresAt      DateTime?
  lastSeenAt     DateTime          @default(now())
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  metadata       Json?

  @@unique([scope, idempotencyKey])
  @@index([scope, endpoint, sequence])
  @@index([expiresAt])
}

model AccessIntegration {
  id            String             @id @default(cuid())
  campgroundId  String
  provider      AccessProviderType
  displayName   String?
  status        String?            @default("enabled")
  credentials   Json
  webhookSecret String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  campground        Campground         @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  grants            AccessGrant[]
  credentialsRecord AccessCredential[]

  @@unique([campgroundId, provider])
  @@index([campgroundId])
}

model Vehicle {
  id            String   @id @default(cuid())
  campgroundId  String
  reservationId String?
  guestId       String?
  plate         String?
  state         String?
  rigType       String?
  rigLength     Int?
  description   String?
  color         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  campground   Campground         @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  reservation  Reservation?       @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  guest        Guest?             @relation(fields: [guestId], references: [id], onDelete: SetNull)
  credentials  AccessCredential[]
  accessGrants AccessGrant[]

  @@unique([reservationId])
  @@index([campgroundId])
  @@index([plate, state])
}

model AccessCredential {
  id            String               @id @default(cuid())
  campgroundId  String
  reservationId String?
  vehicleId     String?
  integrationId String?
  provider      AccessProviderType
  type          AccessCredentialType
  maskedValue   String?
  secretHash    String?
  label         String?
  metadata      Json?
  status        AccessGrantStatus    @default(pending)
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt

  campground  Campground         @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  reservation Reservation?       @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  vehicle     Vehicle?           @relation(fields: [vehicleId], references: [id], onDelete: SetNull)
  integration AccessIntegration? @relation(fields: [integrationId], references: [id], onDelete: SetNull)
  grants      AccessGrant[]

  @@index([campgroundId])
  @@index([reservationId])
  @@index([vehicleId])
}

model AccessGrant {
  id               String             @id @default(cuid())
  campgroundId     String
  reservationId    String
  siteId           String?
  vehicleId        String?
  credentialId     String?
  integrationId    String?
  provider         AccessProviderType
  status           AccessGrantStatus  @default(pending)
  providerAccessId String?
  startsAt         DateTime?
  endsAt           DateTime?
  blockedReason    String?
  idempotencyKey   String?
  lastSyncAt       DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  campground  Campground         @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  reservation Reservation        @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  site        Site?              @relation(fields: [siteId], references: [id], onDelete: SetNull)
  vehicle     Vehicle?           @relation(fields: [vehicleId], references: [id], onDelete: SetNull)
  credential  AccessCredential?  @relation(fields: [credentialId], references: [id], onDelete: SetNull)
  integration AccessIntegration? @relation(fields: [integrationId], references: [id], onDelete: SetNull)

  @@unique([reservationId, provider])
  @@index([campgroundId])
  @@index([reservationId])
  @@index([siteId])
  @@index([provider, idempotencyKey])
  @@index([endsAt])
}

// Phase 2: housekeeping/maintenance/groups/blocks
model Task {
  id               String    @id @default(cuid())
  tenantId         String
  type             TaskType
  state            TaskState
  priority         String?
  siteId           String
  reservationId    String?
  assignedToUserId String?
  assignedToTeamId String?
  slaDueAt         DateTime?
  slaStatus        SlaStatus @default(on_track)
  checklist        Json?
  photos           Json?
  notes            String?
  source           String?
  createdBy        String
  templateId       String? // Reference to CleaningTaskTemplate used
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Hotel operations relation
  inspectionResults InspectionResult[]

  @@index([tenantId, siteId, state])
  @@index([tenantId, slaStatus])
}

// Inventory blocks and groups
model InventoryBlock {
  blockId     String   @id @default(cuid())
  tenantId    String
  sites       Json
  windowStart DateTime
  windowEnd   DateTime
  reason      String
  state       String
  lockId      String   @unique
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
}

model Group {
  id                   String   @id @default(cuid())
  tenantId             String
  sharedPayment        Boolean  @default(false)
  sharedComm           Boolean  @default(false)
  primaryReservationId String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

// ============================================================
// PHASE 3: Revenue, Channels, Comms, Staff, Analytics, Portfolio
// ============================================================

// --- Phase 3A: Revenue & Channel Management ---

enum DynamicPricingTrigger {
  occupancy_high
  occupancy_low
  demand_surge
  last_minute
  advance_booking
  event_proximity
  weather
  manual
}

model DynamicPricingRule {
  id              String                @id @default(cuid())
  campgroundId    String
  name            String
  trigger         DynamicPricingTrigger
  conditions      Json // { occupancyMin, occupancyMax, daysOut, etc }
  adjustmentType  String // percent | flat
  adjustmentValue Float
  priority        Int                   @default(100)
  siteClassIds    String[] // empty = all classes
  isActive        Boolean               @default(true)
  validFrom       DateTime?
  validTo         DateTime?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId, isActive])
}

model OccupancySnapshot {
  id           String     @id @default(cuid())
  campgroundId String
  date         DateTime   @db.Date
  totalSites   Int
  occupied     Int
  blocked      Int
  available    Int
  occupancyPct Float
  revenueCents Int        @default(0)
  createdAt    DateTime   @default(now())
  Campground   Campground @relation(fields: [campgroundId], references: [id])

  @@unique([campgroundId, date])
  @@index([campgroundId, date])
}

model RevenueForecast {
  id           String     @id @default(cuid())
  campgroundId String
  forecastDate DateTime   @db.Date
  projectedRev Int // cents
  actualRev    Int? // cents, filled in after the fact
  occupancyPct Float
  confidence   Float? // 0-1
  factors      Json? // what drove the forecast
  createdAt    DateTime   @default(now())
  Campground   Campground @relation(fields: [campgroundId], references: [id])

  @@unique([campgroundId, forecastDate])
  @@index([campgroundId, forecastDate])
}

// --- Phase 3B: Communications & Guest Experience ---

enum WorkflowTrigger {
  reservation_created
  reservation_confirmed
  days_before_arrival
  check_in
  days_after_checkin
  check_out
  days_after_checkout
  payment_received
  payment_failed
  review_received
  birthday
  anniversary
  manual
}

enum WorkflowStatus {
  active
  paused
  draft
  archived
}

model CommunicationWorkflow {
  id           String          @id @default(cuid())
  campgroundId String
  name         String
  description  String?
  trigger      WorkflowTrigger
  triggerValue Int? // e.g., days before/after
  conditions   Json? // additional filters
  status       WorkflowStatus  @default(draft)
  priority     Int             @default(100)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  campground Campground          @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  steps      WorkflowStep[]
  executions WorkflowExecution[]

  @@index([campgroundId, status])
}

model WorkflowStep {
  id         String  @id @default(cuid())
  workflowId String
  stepOrder  Int
  actionType String // send_email | send_sms | wait | condition | webhook
  config     Json // template, delay, conditions, etc.
  isActive   Boolean @default(true)

  workflow CommunicationWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId, stepOrder])
}

enum WorkflowExecutionStatus {
  pending
  running
  completed
  failed
  cancelled
}

model WorkflowExecution {
  id            String                  @id @default(cuid())
  workflowId    String
  reservationId String?
  guestId       String?
  status        WorkflowExecutionStatus @default(pending)
  currentStep   Int                     @default(0)
  context       Json? // runtime data
  startedAt     DateTime?
  completedAt   DateTime?
  error         String?
  createdAt     DateTime                @default(now())

  workflow CommunicationWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId, status])
  @@index([reservationId])
}

enum WaiverStatus {
  pending
  signed
  expired
  declined
}

model DigitalWaiver {
  id            String       @id @default(cuid())
  campgroundId  String
  reservationId String?
  guestId       String
  templateId    String?
  status        WaiverStatus @default(pending)
  signedAt      DateTime?
  signatureData Json? // base64 signature image
  ipAddress     String?
  userAgent     String?
  pdfUrl        String?
  expiresAt     DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  campground  Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  guest       Guest        @relation(fields: [guestId], references: [id], onDelete: Cascade)
  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)

  @@index([campgroundId, status])
  @@index([reservationId])
  @@index([guestId])
}

model WaiverTemplate {
  id           String   @id @default(cuid())
  campgroundId String
  name         String
  content      String   @db.Text
  version      Int      @default(1)
  isDefault    Boolean  @default(false)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
}

// --- Signatures & COI ---

enum SignatureDocumentType {
  long_term_stay
  seasonal // Seasonal contract
  monthly // Monthly rental contract
  park_rules
  deposit
  waiver
  coi
  other
}

enum SignatureRequestStatus {
  preview // Available for preview but not signing yet
  draft
  sent
  viewed
  signed
  signed_paper // Signed via paper copy
  waived // Signature requirement waived
  declined
  voided
  expired
}

enum SignatureDeliveryChannel {
  email
  sms
  email_and_sms
}

enum SignatureMethod {
  digital
  paper
  waived
}

enum WaiverReason {
  returning_same_terms
  corporate_agreement
  grandfathered
  family_member
  owner_discretion
  other
}

enum CoiStatus {
  pending
  active
  expired
  voided
}

model DocumentTemplate {
  id           String                @id @default(cuid())
  campgroundId String
  siteClassId  String?
  siteId       String?
  name         String
  description  String?
  type         SignatureDocumentType
  version      Int                   @default(1)
  content      String                @db.Text
  policyConfig Json?
  isActive     Boolean               @default(true)
  autoSend     Boolean               @default(false)
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt

  campground Campground         @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  siteClass  SiteClass?         @relation(fields: [siteClassId], references: [id], onDelete: SetNull)
  site       Site?              @relation(fields: [siteId], references: [id], onDelete: SetNull)
  requests   SignatureRequest[]

  @@unique([campgroundId, name, version])
  @@index([campgroundId, type])
  @@index([campgroundId, siteClassId])
  @@index([campgroundId, siteId])
}

model SignatureRequest {
  id              String                   @id @default(cuid())
  campgroundId    String
  reservationId   String?
  guestId         String?
  templateId      String?
  documentType    SignatureDocumentType
  status          SignatureRequestStatus   @default(draft)
  deliveryChannel SignatureDeliveryChannel @default(email)
  token           String                   @unique
  subject         String?
  message         String?
  recipientName   String?
  recipientEmail  String?
  recipientPhone  String?
  sentAt          DateTime?
  viewedAt        DateTime?
  signedAt        DateTime?
  declinedAt      DateTime?
  voidedAt        DateTime?
  expiresAt       DateTime?
  reminderAt      DateTime?
  reminderCount   Int                      @default(0)
  metadata        Json?
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt

  // Signature method - how the contract was/will be signed
  signatureMethod SignatureMethod @default(digital)

  // Paper signing fields
  paperSignedAt    DateTime?
  paperReceivedBy  String? // Staff user ID who received paper copy
  paperArtifactUrl String? // Scanned copy upload URL

  // Signature waiver fields
  signatureWaived Boolean       @default(false)
  waiverReason    WaiverReason?
  waiverNotes     String?
  waivedBy        String? // Staff user ID who waived
  waivedAt        DateTime?

  // Preview/Early access fields
  previewAvailableAt    DateTime? // When guests can preview (but not sign)
  availableForSigningAt DateTime? // When guests can start signing

  // Seasonal/Renewal tracking
  renewsContractId String? // Previous contract this renews
  seasonYear       Int? // e.g., 2025, 2026

  campground  Campground         @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  reservation Reservation?       @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  guest       Guest?             @relation(fields: [guestId], references: [id], onDelete: SetNull)
  template    DocumentTemplate?  @relation(fields: [templateId], references: [id], onDelete: SetNull)
  artifact    SignatureArtifact?

  @@index([campgroundId, status])
  @@index([reservationId])
  @@index([guestId])
  @@index([expiresAt])
  @@index([campgroundId, seasonYear])
  @@index([renewsContractId])
}

model SignatureArtifact {
  id            String    @id @default(cuid())
  requestId     String    @unique
  campgroundId  String
  reservationId String?
  guestId       String?
  pdfUrl        String
  storageKey    String?
  checksum      String?
  metadata      Json?
  completedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  request     SignatureRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  campground  Campground       @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  reservation Reservation?     @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  guest       Guest?           @relation(fields: [guestId], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([reservationId])
  @@index([guestId])
}

model CoiUpload {
  id            String    @id @default(cuid())
  campgroundId  String
  reservationId String?
  guestId       String?
  fileUrl       String
  storageKey    String?
  status        CoiStatus @default(active)
  expiresAt     DateTime?
  reminderAt    DateTime?
  reminderCount Int       @default(0)
  uploadedAt    DateTime  @default(now())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  notes         String?

  campground  Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  guest       Guest?       @relation(fields: [guestId], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([reservationId])
  @@index([guestId])
  @@index([expiresAt])
}

enum IdVerificationStatus {
  pending
  verified
  failed
  expired
}

model IdVerification {
  id            String               @id @default(cuid())
  campgroundId  String
  guestId       String
  reservationId String?
  status        IdVerificationStatus @default(pending)
  provider      String? // e.g., stripe_identity, jumio
  providerRef   String?
  verifiedAt    DateTime?
  expiresAt     DateTime?
  documentType  String? // passport, drivers_license, etc
  metadata      Json?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt

  campground  Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  guest       Guest        @relation(fields: [guestId], references: [id], onDelete: Cascade)
  reservation Reservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([guestId])
  @@index([reservationId])
}

// --- Phase 3C: Staff Operations ---

enum ShiftStatus {
  scheduled
  in_progress
  submitted
  approved
  rejected
}

enum ShiftApprovalStatus {
  pending
  approved
  rejected
}

enum TimeEntryStatus {
  open
  submitted
  approved
  rejected
  corrected
}

enum TimeEntrySource {
  kiosk
  mobile
  web
  manual
}

enum OverrideType {
  comp
  void
  discount
}

enum OverrideStatus {
  pending
  approved
  rejected
  cancelled
}

enum TimeOffType {
  vacation
  sick
  personal
  bereavement
  jury_duty
  unpaid
  other
}

enum TimeOffStatus {
  pending
  approved
  rejected
  cancelled
}

enum BreakType {
  paid
  unpaid
  meal
  rest
}

enum SwapStatus {
  pending_recipient // Waiting for recipient to accept
  pending_manager // Recipient accepted, waiting for manager
  approved // Manager approved
  rejected // Manager rejected
  declined // Recipient declined
  cancelled // Requester cancelled
}

enum PayrollProvider {
  generic
  onpay
  gusto
  adp
}

enum PayrollExportStatus {
  pending
  generated
  failed
}

enum PayrollExportFormat {
  csv
  json
}

model StaffShift {
  id               String      @id @default(cuid())
  campgroundId     String
  userId           String
  roleId           String?
  shiftDate        DateTime    @db.Date
  startTime        DateTime
  endTime          DateTime
  role             String? // legacy friendly label
  status           ShiftStatus @default(scheduled)
  scheduledMinutes Int?
  actualMinutes    Int?
  notes            String?
  clockedInAt      DateTime?
  clockedOutAt     DateTime?
  approvedById     String?
  approvedAt       DateTime?
  approvalNote     String?
  createdBy        String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  campground         Campground          @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  user               User                @relation("StaffShifts", fields: [userId], references: [id], onDelete: Cascade)
  roleRef            StaffRole?          @relation(fields: [roleId], references: [id], onDelete: SetNull)
  approvals          ShiftApproval[]
  timeEntries        StaffTimeEntry[]
  payrollExportLines PayrollExportLine[]
  swapRequests       ShiftSwapRequest[]  @relation("SwapRequesterShift")

  @@index([campgroundId, shiftDate])
  @@index([userId, shiftDate])
  @@index([roleId])
  @@index([status])
}

model StaffRole {
  id           String   @id @default(cuid())
  campgroundId String
  code         String
  name         String
  hourlyRate   Decimal? @db.Decimal(10, 2)
  earningCode  String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground Campground   @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  shifts     StaffShift[]

  @@unique([campgroundId, code])
  @@index([campgroundId, isActive])
}

model StaffTimeEntry {
  id           String          @id @default(cuid())
  shiftId      String
  campgroundId String
  userId       String
  clockInAt    DateTime
  clockOutAt   DateTime?
  source       TimeEntrySource @default(web)
  status       TimeEntryStatus @default(open)
  note         String?
  approvedById String?
  approvedAt   DateTime?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  shift              StaffShift          @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  user               User                @relation("StaffTimeEntries", fields: [userId], references: [id], onDelete: Cascade)
  approvedBy         User?               @relation("StaffTimeEntryApprover", fields: [approvedById], references: [id])
  payrollExportLines PayrollExportLine[]
  breaks             StaffBreak[]

  @@index([campgroundId, userId, status])
  @@index([shiftId])
}

model StaffBreak {
  id           String    @id @default(cuid())
  timeEntryId  String
  type         BreakType
  startedAt    DateTime
  endedAt      DateTime?
  durationMins Int?
  note         String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  timeEntry StaffTimeEntry @relation(fields: [timeEntryId], references: [id], onDelete: Cascade)

  @@index([timeEntryId])
}

model OvertimeConfig {
  id                   String   @id @default(cuid())
  campgroundId         String   @unique
  weeklyThreshold      Int      @default(40) // Hours per week before OT kicks in
  dailyThreshold       Int? // Hours per day before daily OT (optional)
  overtimeMultiplier   Decimal  @default(1.5) @db.Decimal(3, 2)
  doubleTimeThreshold  Int? // Hours for double time (optional)
  doubleTimeMultiplier Decimal? @db.Decimal(3, 2)
  weekStartDay         Int      @default(0) // 0=Sunday, 1=Monday, etc.
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
}

model ShiftSwapRequest {
  id                   String     @id @default(cuid())
  campgroundId         String
  requesterShiftId     String
  requesterId          String
  recipientUserId      String
  status               SwapStatus @default(pending_recipient)
  requesterNote        String?
  recipientNote        String?
  managerId            String?
  managerNote          String?
  recipientRespondedAt DateTime?
  managerRespondedAt   DateTime?
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt

  campground     Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  requesterShift StaffShift @relation("SwapRequesterShift", fields: [requesterShiftId], references: [id], onDelete: Cascade)
  requester      User       @relation("SwapRequester", fields: [requesterId], references: [id])
  recipient      User       @relation("SwapRecipient", fields: [recipientUserId], references: [id])
  manager        User?      @relation("SwapManager", fields: [managerId], references: [id])

  @@index([campgroundId, status])
  @@index([requesterId])
  @@index([recipientUserId])
  @@index([requesterShiftId])
}

model ScheduleTemplate {
  id                  String    @id @default(cuid())
  campgroundId        String
  name                String
  description         String?
  shifts              Json // Array of template shift definitions
  createdById         String
  isActive            Boolean   @default(true)
  // Recurring scheduling
  isRecurring         Boolean   @default(false)
  recurringDay        Int? // Day of week to auto-apply (0=Sun, 1=Mon, etc.)
  recurringWeeksAhead Int?      @default(1) // How many weeks ahead to schedule
  lastAppliedAt       DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  createdBy  User       @relation("ScheduleTemplateCreator", fields: [createdById], references: [id])

  @@index([campgroundId, isActive])
  @@index([isRecurring, recurringDay]) // For cron job queries
}

model ShiftApproval {
  id         String              @id @default(cuid())
  shiftId    String
  approverId String
  status     ShiftApprovalStatus @default(pending)
  note       String?
  approvedAt DateTime?
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt

  shift    StaffShift @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  approver User       @relation("ShiftApprover", fields: [approverId], references: [id])

  @@index([shiftId, status])
  @@index([approverId])
}

model StaffAvailability {
  id           String   @id @default(cuid())
  campgroundId String
  userId       String
  dayOfWeek    Int // 0=Sunday, 6=Saturday
  startTime    String // HH:mm
  endTime      String // HH:mm
  isAvailable  Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  user       User       @relation("StaffAvailability", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, userId, dayOfWeek])
}

model OverrideRequest {
  id           String         @id @default(cuid())
  campgroundId String
  userId       String
  approverId   String?
  type         OverrideType
  reason       String?
  status       OverrideStatus @default(pending)
  targetEntity String?
  targetId     String?
  deltaAmount  Decimal?       @db.Decimal(10, 2)
  metadata     Json?
  approvedAt   DateTime?
  rejectedAt   DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  user       User       @relation("OverrideRequester", fields: [userId], references: [id])
  approver   User?      @relation("OverrideApprover", fields: [approverId], references: [id])

  @@index([campgroundId, status, type])
  @@index([targetEntity, targetId])
}

model TimeOffRequest {
  id             String        @id @default(cuid())
  campgroundId   String
  userId         String
  type           TimeOffType
  status         TimeOffStatus @default(pending)
  startDate      DateTime      @db.Date
  endDate        DateTime      @db.Date
  hoursRequested Float?
  reason         String?
  reviewerId     String?
  reviewerNote   String?
  reviewedAt     DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  user       User       @relation("TimeOffRequester", fields: [userId], references: [id], onDelete: Cascade)
  reviewer   User?      @relation("TimeOffReviewer", fields: [reviewerId], references: [id])

  @@index([campgroundId, status])
  @@index([userId, startDate])
  @@index([reviewerId])
}

model AvailabilityOverride {
  id           String   @id @default(cuid())
  campgroundId String
  userId       String
  date         DateTime @db.Date
  isAvailable  Boolean  @default(false)
  startTime    String? // HH:mm - if partially available
  endTime      String? // HH:mm
  reason       String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  user       User       @relation("AvailabilityOverrides", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, userId, date])
  @@index([campgroundId, date])
}

model PayrollEarningCode {
  id           String          @id @default(cuid())
  campgroundId String
  roleCode     String
  provider     PayrollProvider @default(generic)
  earningCode  String
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  @@unique([campgroundId, roleCode, provider])
  @@index([campgroundId, provider])
}

model PayrollExport {
  id            String              @id @default(cuid())
  campgroundId  String
  periodStart   DateTime            @db.Date
  periodEnd     DateTime            @db.Date
  provider      PayrollProvider     @default(generic)
  format        PayrollExportFormat @default(csv)
  status        PayrollExportStatus @default(pending)
  requestedById String
  rowCount      Int?
  totalHours    Float?
  fileKey       String?
  failureReason String?
  createdAt     DateTime            @default(now())
  completedAt   DateTime?

  campground  Campground          @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  requestedBy User                @relation("PayrollExportRequester", fields: [requestedById], references: [id], onDelete: Cascade)
  lines       PayrollExportLine[]

  @@index([campgroundId, periodStart, periodEnd])
  @@index([provider, status])
}

model PayrollExportLine {
  id          String   @id @default(cuid())
  exportId    String
  userId      String
  shiftId     String?
  timeEntryId String?
  hours       Float
  earningCode String?
  rate        Decimal? @db.Decimal(10, 2)
  roleCode    String?
  notes       String?
  createdAt   DateTime @default(now())

  export    PayrollExport   @relation(fields: [exportId], references: [id], onDelete: Cascade)
  user      User            @relation("PayrollExportUser", fields: [userId], references: [id], onDelete: Cascade)
  shift     StaffShift?     @relation(fields: [shiftId], references: [id], onDelete: SetNull)
  timeEntry StaffTimeEntry? @relation(fields: [timeEntryId], references: [id], onDelete: SetNull)

  @@index([exportId])
  @@index([userId])
}

model PayrollConfig {
  id           String          @id @default(cuid())
  campgroundId String          @unique
  provider     PayrollProvider @default(generic)
  companyId    String? // Provider-specific company/employer ID
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
}

enum PushNotificationType {
  arrival
  departure
  task_assigned
  task_sla_warning
  maintenance_urgent
  payment_received
  payment_failed
  message_received
  general
}

model PushNotification {
  id           String               @id @default(cuid())
  campgroundId String
  userId       String?
  type         PushNotificationType
  title        String
  body         String
  data         Json?
  sentAt       DateTime?
  readAt       DateTime?
  clickedAt    DateTime?
  createdAt    DateTime             @default(now())

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  user       User?      @relation("PushNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([campgroundId, userId, createdAt])
}

model StaffPerformance {
  id              String   @id @default(cuid())
  campgroundId    String
  userId          String
  periodStart     DateTime @db.Date
  periodEnd       DateTime @db.Date
  tasksCompleted  Int      @default(0)
  tasksSlaOnTime  Int      @default(0)
  checkinsHandled Int      @default(0)
  avgTaskMinutes  Float?
  hoursWorked     Float?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  user       User       @relation("StaffPerformance", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, userId, periodStart, periodEnd])
  @@index([campgroundId, periodStart])
}

// --- Phase 3D: Analytics & Reporting ---

enum ReportScheduleFrequency {
  daily
  weekly
  monthly
  quarterly
}

model SavedReport {
  id           String                   @id @default(cuid())
  campgroundId String?
  orgId        String?
  createdById  String
  name         String
  description  String?
  reportType   String // revenue, occupancy, guests, custom
  config       Json // columns, filters, grouping
  isPublic     Boolean                  @default(false)
  scheduleFreq ReportScheduleFrequency?
  scheduleDay  Int? // day of week/month
  scheduleTime String? // HH:mm
  recipients   String[] // email addresses
  lastRunAt    DateTime?
  createdAt    DateTime                 @default(now())
  updatedAt    DateTime                 @updatedAt

  campground Campground? @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  createdBy  User        @relation("SavedReports", fields: [createdById], references: [id], onDelete: Cascade)
  runs       ReportRun[]

  @@index([campgroundId])
  @@index([createdById])
}

model ReportRun {
  id          String    @id @default(cuid())
  reportId    String
  status      String // pending, running, completed, failed
  startedAt   DateTime?
  completedAt DateTime?
  rowCount    Int?
  fileUrl     String? // S3/storage URL
  error       String?
  triggeredBy String? // schedule | manual | user_id
  createdAt   DateTime  @default(now())

  report SavedReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId, createdAt])
}

model CohortAnalysis {
  id              String   @id @default(cuid())
  campgroundId    String
  cohortType      String // first_booking_month, acquisition_channel, site_type
  cohortValue     String
  periodStart     DateTime @db.Date
  periodEnd       DateTime @db.Date
  guestCount      Int
  bookings        Int
  revenue         Int // cents
  repeatRate      Float?
  avgBookingValue Int?
  createdAt       DateTime @default(now())

  @@unique([campgroundId, cohortType, cohortValue, periodStart])
  @@index([campgroundId, cohortType])
}

// --- Phase 3E: Multi-Property & Portfolio ---

model PortfolioDashboard {
  id          String   @id @default(cuid())
  orgId       String
  name        String
  layout      Json // widget positions and configs
  isDefault   Boolean  @default(false)
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  createdBy    User         @relation("PortfolioDashboards", fields: [createdById], references: [id], onDelete: Cascade)

  @@index([orgId])
}

model PortfolioMetric {
  id            String   @id @default(cuid())
  orgId         String
  campgroundId  String?
  metricDate    DateTime @db.Date
  metricType    String // occupancy, revenue, adr, revpar, bookings
  value         Float
  previousValue Float?
  changePercent Float?
  createdAt     DateTime @default(now())

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  campground   Campground?  @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@unique([orgId, campgroundId, metricDate, metricType])
  @@index([orgId, metricDate])
}

model CentralizedRatePush {
  id            String    @id @default(cuid())
  orgId         String
  name          String
  rateConfig    Json // rate adjustments to push
  targetCampIds String[]
  status        String    @default("draft") // draft, pending, applied, failed
  appliedAt     DateTime?
  appliedBy     String?
  results       Json? // per-campground results
  createdBy     String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
}

// ---------------------------------------------------------------------------
// Phase 4: Stored Value / POS / Analytics Facts
// ---------------------------------------------------------------------------

enum StoredValueType {
  gift
  credit
}

enum StoredValueScopeType {
  campground
  organization
  global
}

enum StoredValueStatus {
  active
  frozen
  expired
}

enum StoredValueDirection {
  issue
  redeem
  adjust
  expire
  refund
  hold_create
  hold_capture
  hold_release
}

enum StoredValueHoldStatus {
  open
  captured
  released
  expired
}

model StoredValueAccount {
  id               String               @id @default(cuid())
  campgroundId     String
  scopeType        StoredValueScopeType @default(campground)
  scopeId          String?
  type             StoredValueType
  currency         String
  status           StoredValueStatus    @default(active)
  issuedAt         DateTime
  expiresAt        DateTime?
  liabilityAccount String?
  createdBy        String?
  createdVia       String?
  metadata         Json?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  // Guest wallet - when guestId is set, this is a guest's personal wallet
  // Null guestId = gift card/store credit; non-null = guest wallet
  guestId String?

  campground Campground          @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  guest      Guest?              @relation("GuestWallet", fields: [guestId], references: [id], onDelete: SetNull)
  codes      StoredValueCode[]
  ledger     StoredValueLedger[]
  holds      StoredValueHold[]

  @@index([campgroundId])
  @@index([scopeType, scopeId])
  @@index([guestId])
  @@index([status])
}

model StoredValueCode {
  id                String   @id @default(cuid())
  accountId         String
  code              String   @unique
  pinHash           String?
  active            Boolean  @default(true)
  redeemedByGuestId String?
  createdAt         DateTime @default(now())

  account StoredValueAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  guest   Guest?             @relation(fields: [redeemedByGuestId], references: [id], onDelete: SetNull)

  @@index([accountId])
}

model StoredValueLedger {
  id                 String               @id @default(cuid())
  campgroundId       String
  issuerCampgroundId String?
  scopeType          StoredValueScopeType @default(campground)
  scopeId            String?
  accountId          String
  direction          StoredValueDirection
  amountCents        Int
  currency           String
  beforeBalanceCents Int
  afterBalanceCents  Int
  referenceType      String
  referenceId        String
  idempotencyKey     String
  actorType          String?
  actorId            String?
  channel            String?
  reason             String?
  createdAt          DateTime             @default(now())

  campground Campground         @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  account    StoredValueAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([campgroundId, idempotencyKey])
  @@index([issuerCampgroundId])
  @@index([scopeType, scopeId])
  @@index([accountId, createdAt])
}

model StoredValueHold {
  id             String                @id @default(cuid())
  accountId      String
  amountCents    Int
  status         StoredValueHoldStatus @default(open)
  expiresAt      DateTime
  referenceType  String
  referenceId    String
  idempotencyKey String
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt

  account StoredValueAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId, status])
}

enum PosCartStatus {
  open
  checked_out
  void
}

enum PosPaymentMethod {
  card
  cash
  gift
  store_credit
  charge_to_site
}

enum PosPaymentStatus {
  pending
  succeeded
  failed
  refunded
}

enum TillSessionStatus {
  open
  closed
}

enum TillMovementType {
  cash_sale
  cash_refund
  paid_in
  paid_out
  adjustment
}

enum PosProviderType {
  clover
  square
  toast
  lightspeed
  shopify
  vend
}

enum PosProviderCapability {
  payments
  items_sync
  receipts
  inventory_push
  inventory_pull
  markdown_sync
  expiration_sync
}

enum PosIntegrationStatus {
  enabled
  disabled
  error
}

enum PosSyncTarget {
  catalog
  tenders
  payments
  inventory
  markdowns
}

enum PosSyncStatus {
  idle
  running
  succeeded
  failed
}

model PosTerminal {
  id             String   @id @default(cuid())
  campgroundId   String
  locationId     String?
  offlineCapable Boolean  @default(false)
  taxVersion     String?
  priceVersion   String?
  createdAt      DateTime @default(now())

  campground   Campground     @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  location     StoreLocation? @relation(fields: [locationId], references: [id], onDelete: SetNull)
  carts        PosCart[]
  tillSessions TillSession[]

  @@index([campgroundId])
  @@index([locationId])
}

model PosCart {
  id           String        @id @default(cuid())
  campgroundId String
  terminalId   String?
  status       PosCartStatus @default(open)
  needsReview  Boolean       @default(false)
  netCents     Int           @default(0)
  taxCents     Int           @default(0)
  feeCents     Int           @default(0)
  grossCents   Int           @default(0)
  currency     String
  taxVersion   String?
  priceVersion String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  campground     Campground         @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  terminal       PosTerminal?       @relation(fields: [terminalId], references: [id], onDelete: SetNull)
  items          PosCartItem[]
  payments       PosPayment[]
  returns        PosReturn[]        @relation("ReturnCart")
  movements      TillMovement[]     @relation("TillMovementCart")
  offlineReplays PosOfflineReplay[]

  @@index([campgroundId, status])
  @@index([terminalId])
}

model PosCartItem {
  id             String @id @default(cuid())
  cartId         String
  productId      String
  qty            Int
  unitPriceCents Int
  discountCents  Int    @default(0)
  taxCents       Int    @default(0)
  feeCents       Int    @default(0)
  totalCents     Int
  metadata       Json?

  // Expiration markdown tracking
  markdownApplied       Boolean @default(false) // Was an expiration markdown applied?
  markdownRuleId        String? // Which markdown rule was applied
  originalPriceCents    Int? // Original price before markdown
  markdownDiscountCents Int? // Amount discounted due to expiration
  batchId               String? // Which inventory batch this item came from

  cart    PosCart  @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([cartId])
  @@index([productId])
}

model PosPayment {
  id             String           @id @default(cuid())
  cartId         String
  method         PosPaymentMethod
  amountCents    Int
  currency       String
  status         PosPaymentStatus @default(pending)
  idempotencyKey String
  referenceType  String?
  referenceId    String?
  processorIds   Json?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  cart PosCart @relation(fields: [cartId], references: [id], onDelete: Cascade)

  @@index([cartId])
  @@index([idempotencyKey])
}

model PosOfflineReplay {
  id                 String   @id @default(cuid())
  clientTxId         String?
  cartId             String?
  campgroundId       String?
  recordedTotalsHash String?
  expectedHash       String?
  payloadHash        String?
  status             String?
  reason             String?
  payload            Json?
  tender             Json?
  items              Json?
  expectedBreakdown  Json?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  cart       PosCart?    @relation(fields: [cartId], references: [id], onDelete: SetNull)
  campground Campground? @relation(fields: [campgroundId], references: [id], onDelete: SetNull)

  @@index([cartId])
  @@index([campgroundId])
  @@index([clientTxId])
}

model TillSession {
  id                 String            @id @default(cuid())
  campgroundId       String
  terminalId         String?
  status             TillSessionStatus @default(open)
  openingFloatCents  Int               @default(0)
  expectedCloseCents Int               @default(0)
  countedCloseCents  Int?
  overShortCents     Int               @default(0)
  currency           String
  notes              String?
  openedByUserId     String
  closedByUserId     String?
  openedAt           DateTime          @default(now())
  closedAt           DateTime?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  campground Campground     @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  terminal   PosTerminal?   @relation(fields: [terminalId], references: [id], onDelete: SetNull)
  openedBy   User           @relation("TillSessionOpenedBy", fields: [openedByUserId], references: [id], onDelete: Cascade)
  closedBy   User?          @relation("TillSessionClosedBy", fields: [closedByUserId], references: [id], onDelete: SetNull)
  movements  TillMovement[]

  @@index([campgroundId, status])
  @@index([terminalId, status])
}

model TillMovement {
  id           String           @id @default(cuid())
  sessionId    String
  type         TillMovementType
  amountCents  Int
  currency     String
  sourceCartId String?
  actorUserId  String
  note         String?
  createdAt    DateTime         @default(now())

  session TillSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  actor   User        @relation("TillMovementActor", fields: [actorUserId], references: [id], onDelete: Cascade)
  cart    PosCart?    @relation("TillMovementCart", fields: [sourceCartId], references: [id], onDelete: SetNull)

  @@index([sessionId, type])
  @@index([sourceCartId])
}

enum PosReturnStatus {
  pending
  completed
  failed
}

model PosReturn {
  id             String          @id @default(cuid())
  originalCartId String
  status         PosReturnStatus @default(pending)
  reasonCode     String?
  restock        Boolean         @default(false)
  netCents       Int             @default(0)
  taxCents       Int             @default(0)
  feeCents       Int             @default(0)
  grossCents     Int             @default(0)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  originalCart PosCart @relation("ReturnCart", fields: [originalCartId], references: [id], onDelete: Cascade)

  @@index([originalCartId])
}

model PosProviderIntegration {
  id              String                  @id @default(cuid())
  campgroundId    String
  provider        PosProviderType
  displayName     String?
  status          PosIntegrationStatus    @default(enabled)
  capabilities    PosProviderCapability[]
  credentials     Json
  locations       Json?
  devices         Json?
  webhookSecret   String?
  lastValidatedAt DateTime?
  lastSyncAt      DateTime?
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt

  campground Campground        @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  syncs      PosProviderSync[]

  @@unique([campgroundId, provider])
  @@index([campgroundId, status])
}

model PosProviderSync {
  id            String        @id @default(cuid())
  integrationId String
  type          PosSyncTarget
  status        PosSyncStatus @default(idle)
  lastRunAt     DateTime?
  lastError     String?
  metadata      Json?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  integration PosProviderIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@unique([integrationId, type])
  @@index([integrationId, type])
}

// Analytics daily facts
model FactReservationsDaily {
  id               String   @id @default(cuid())
  campgroundId     String
  metricDate       DateTime @db.Date
  roomsAvailable   Int
  roomsSold        Int
  roomRevenueCents Int
  taxesCents       Int      @default(0)
  feesCents        Int      @default(0)
  discountsCents   Int      @default(0)
  channel          String?
  createdAt        DateTime @default(now())

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, metricDate, channel])
  @@index([campgroundId, metricDate])
}

model FactPosDaily {
  id             String   @id @default(cuid())
  campgroundId   String
  locationId     String?
  metricDate     DateTime @db.Date
  netCents       Int
  taxCents       Int      @default(0)
  feeCents       Int      @default(0)
  discountsCents Int      @default(0)
  categoryId     String?
  createdAt      DateTime @default(now())

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, metricDate, categoryId])
  @@index([campgroundId, metricDate])
}

model FactStoredValueDaily {
  id            String   @id @default(cuid())
  campgroundId  String
  metricDate    DateTime @db.Date
  issuedCents   Int      @default(0)
  redeemedCents Int      @default(0)
  expiredCents  Int      @default(0)
  createdAt     DateTime @default(now())

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, metricDate])
  @@index([campgroundId, metricDate])
}

// =============================================================================
// User Feedback / Support Tickets
// =============================================================================

model Ticket {
  id          String         @id @default(uuid())
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @default(now()) @updatedAt
  completedAt DateTime?
  title       String
  notes       String?
  category    TicketCategory @default(issue)
  area        String?
  url         String?
  path        String?
  pageTitle   String?
  selection   String?
  status      TicketState    @default(open)
  agentNotes  String?
  votes       Int            @default(0)
  submitter   Json? // { id, name, email }
  upvoters    Json? // [{ id, name, email }]
  client      Json? // { userAgent, platform, language, deviceType }
  extra       Json?

  @@index([status])
  @@index([createdAt])
  @@index([category])
}

// =============================================================================
// Platform Admin Features
// =============================================================================

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  SYNC
  EXPORT
  IMPORT
}

model PlatformAuditLog {
  id         String      @id @default(cuid())
  createdAt  DateTime    @default(now())
  userId     String?
  userEmail  String?
  action     AuditAction
  resource   String // e.g., "Campground", "User", "Reservation"
  resourceId String?
  details    String? // Human-readable description
  metadata   Json? // Additional structured data
  ipAddress  String?
  userAgent  String?

  @@index([createdAt])
  @@index([userId])
  @@index([action])
  @@index([resource])
}

enum FeatureFlagScope {
  global
  campground
}

model FeatureFlag {
  id          String           @id @default(cuid())
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  key         String           @unique
  name        String
  description String?
  enabled     Boolean          @default(false)
  scope       FeatureFlagScope @default(global)
  campgrounds String[] // Array of campground IDs if scope is "campground"
  metadata    Json? // Additional config

  @@index([key])
  @@index([enabled])
}

enum AnnouncementType {
  info
  warning
  success
}

enum AnnouncementTarget {
  all
  admins
  campground
}

enum AnnouncementStatus {
  draft
  scheduled
  sent
}

model Announcement {
  id             String             @id @default(cuid())
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  title          String
  message        String
  type           AnnouncementType   @default(info)
  target         AnnouncementTarget @default(all)
  campgroundId   String? // If target is "campground"
  status         AnnouncementStatus @default(draft)
  scheduledAt    DateTime?
  sentAt         DateTime?
  createdById    String
  createdByEmail String?

  @@index([status])
  @@index([createdAt])
  @@index([target])
}

// =============================================================================
// Report Subscriptions
// =============================================================================

enum ReportFrequency {
  daily
  weekly
  monthly
}

enum ReportType {
  occupancy_summary
  revenue_summary
  arrivals_departures
  maintenance_summary
  reservation_activity
  guest_activity
  financial_summary
}

model ReportSubscription {
  id           String          @id @default(cuid())
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  userId       String
  userEmail    String
  campgroundId String? // null for platform-wide reports (admin only)
  reportType   ReportType
  frequency    ReportFrequency
  enabled      Boolean         @default(true)
  lastSentAt   DateTime?
  nextSendAt   DateTime?
  deliveryTime String          @default("08:00") // HH:MM in campground timezone
  dayOfWeek    Int? // 0-6 for weekly (0=Sunday)
  dayOfMonth   Int? // 1-31 for monthly

  @@unique([userId, campgroundId, reportType])
  @@index([userId])
  @@index([campgroundId])
  @@index([enabled, nextSendAt])
}

// ==================== AI FEATURES ====================

enum AiFeatureType {
  reply_assist
  booking_assist
  analytics
  forecasting
  anomaly_detection
  recommendations
}

model AiInteractionLog {
  id           String        @id @default(cuid())
  campgroundId String
  featureType  AiFeatureType
  promptHash   String // SHA-256 of anonymized prompt (for audit, not content)
  responseHash String // SHA-256 of response
  tokensUsed   Int
  latencyMs    Int
  userId       String? // Staff user ID if applicable
  sessionId    String? // Anonymous session for consumer interactions
  success      Boolean       @default(true)
  errorType    String?
  provider     String        @default("openai")
  modelUsed    String? // e.g., gpt-4, claude-3
  costCents    Int? // Estimated cost for billing
  createdAt    DateTime      @default(now())

  @@index([campgroundId, createdAt])
  @@index([featureType, createdAt])
  @@index([userId, createdAt])
}

enum AiConsentType {
  booking_assist
  personalization
  communications
  analytics
}

model AiConsentRecord {
  id           String        @id @default(cuid())
  campgroundId String
  guestId      String? // Null for anonymous/session-based consent
  sessionId    String? // For anonymous users
  consentType  AiConsentType
  granted      Boolean       @default(true)
  ipHash       String? // Hashed IP for compliance
  userAgent    String?
  grantedAt    DateTime      @default(now())
  revokedAt    DateTime?
  source       String? // e.g., booking_widget, chat, settings

  @@index([campgroundId, guestId])
  @@index([sessionId])
  @@index([consentType, granted])
}

// ==================== GUEST SEGMENTS ====================

enum SegmentScope {
  global // Platform-wide template available to all
  organization // Shared across campgrounds in org
  campground // Single campground only
}

enum SegmentStatus {
  active
  archived
}

model GuestSegment {
  id             String        @id @default(cuid())
  name           String
  description    String?
  scope          SegmentScope  @default(campground)
  status         SegmentStatus @default(active)
  criteria       Json // Array of criteria objects
  isTemplate     Boolean       @default(false) // Global templates
  organizationId String? // For org-level segments
  campgroundId   String? // For campground-level segments (null for global)
  createdById    String // User who created it
  createdByEmail String
  guestCount     Int           @default(0) // Cached count, updated periodically
  lastCalculated DateTime? // When guestCount was last calculated
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @default(now()) @updatedAt

  campground  Campground?              @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  memberships GuestSegmentMembership[]

  @@index([scope, status])
  @@index([campgroundId, status])
  @@index([organizationId, status])
  @@index([isTemplate])
}

model GuestSegmentMembership {
  id        String    @id @default(cuid())
  segmentId String
  guestId   String
  addedAt   DateTime  @default(now())
  removedAt DateTime?

  segment GuestSegment @relation(fields: [segmentId], references: [id], onDelete: Cascade)
  guest   Guest        @relation(fields: [guestId], references: [id], onDelete: Cascade)

  @@unique([segmentId, guestId])
  @@index([segmentId])
  @@index([guestId])
}

// ==================== ANALYTICS SHARING ====================

enum AnalyticsType {
  overview
  geographic
  demographics
  seasonal_trends
  travel_behavior
  full_report
  segment
}

enum ExportFormat {
  csv
  json
  pdf
}

enum ExportStatus {
  pending
  processing
  completed
  failed
}

enum ShareAccessLevel {
  view_only
  downloadable
}

// Shareable links for analytics reports
model AnalyticsShareLink {
  id            String           @id @default(cuid())
  token         String           @unique @default(cuid()) // Public access token
  analyticsType AnalyticsType
  accessLevel   ShareAccessLevel @default(view_only)

  // Scope and filtering
  scope          SegmentScope @default(campground)
  organizationId String?
  campgroundId   String?
  segmentId      String? // For segment-specific shares
  dateRange      String? // last_30_days, last_90_days, etc.
  filters        Json? // Additional filters

  // Access control
  sharedBy      String // User ID who created share
  sharedByEmail String
  password      String? // Optional password protection
  expiresAt     DateTime? // Optional expiration
  maxViews      Int? // Optional view limit
  viewCount     Int       @default(0)

  // Metadata
  name           String? // Optional friendly name
  description    String?
  createdAt      DateTime  @default(now())
  revokedAt      DateTime? // Soft revoke
  lastAccessedAt DateTime?

  campground Campground? @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([campgroundId])
  @@index([organizationId])
  @@index([sharedBy])
  @@index([expiresAt])
}

// Export job records for async/batch exports
model AnalyticsExport {
  id            String        @id @default(cuid())
  analyticsType AnalyticsType
  format        ExportFormat
  status        ExportStatus  @default(pending)

  // Scope and filtering
  scope          SegmentScope @default(campground)
  organizationId String?
  campgroundId   String?
  segmentId      String?
  dateRange      String?
  filters        Json?
  includePII     Boolean      @default(false) // Whether to include guest PII

  // Export details
  requestedBy      String // User ID
  requestedByEmail String
  fileName         String?
  fileUrl          String? // S3/storage URL when complete
  fileSize         Int? // Bytes
  rowCount         Int? // Number of records exported

  // Processing
  startedAt    DateTime?
  completedAt  DateTime?
  errorMessage String?

  // Email delivery
  emailTo     String[]  @default([])
  emailSentAt DateTime?

  // Metadata
  createdAt DateTime  @default(now())
  expiresAt DateTime? // When download link expires

  campground Campground? @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([organizationId])
  @@index([requestedBy])
  @@index([status])
  @@index([createdAt])
}

// Platform Goals for tracking objectives
enum GoalStatus {
  on_track
  at_risk
  behind
  achieved
}

enum GoalCategory {
  revenue
  bookings
  guests
  satisfaction
}

enum GoalUnit {
  currency
  percentage
  number
  score
}

model PlatformGoal {
  id          String  @id @default(cuid())
  name        String
  description String?
  metric      String // e.g., "Total Revenue", "NPS Score"

  target  Float
  current Float    @default(0)
  unit    GoalUnit

  period   String // e.g., "Q4 2024", "2024"
  category GoalCategory
  status   GoalStatus   @default(on_track)

  dueDate   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String? // User ID

  // Optional targeting
  campgroundId String?
  campground   Campground? @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([status])
  @@index([dueDate])
  @@index([campgroundId])
}

// Campground Awards - Historical recognition
enum AwardType {
  campground_of_year
  rising_star
  world_class
  top_1_percent
  top_5_percent
  top_10_percent
}

model CampgroundAward {
  id             String    @id @default(cuid())
  campgroundId   String
  awardType      AwardType
  year           Int // Year the award was earned
  npsScore       Int? // NPS score at time of award
  npsImprovement Int? // For rising_star: points improved
  rank           Int? // Ranking position if applicable

  createdAt DateTime @default(now())

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, awardType, year])
  @@index([campgroundId])
  @@index([year])
  @@index([awardType])
}

// =============================================================================
// CHARITY ROUND-UP
// =============================================================================

enum DonationStatus {
  collected // Payment received with reservation
  pending_payout // Marked for next payout batch
  paid_out // Sent to charity
  refunded // Reservation cancelled, donation refunded
}

enum CharityPayoutStatus {
  pending
  processing
  completed
  failed
}

// Charity registry - platform-managed list of verified charities
model Charity {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  logoUrl     String?
  taxId       String? // EIN for US charities (for tax receipts)
  website     String?
  category    String? // environment, youth, veterans, animals, etc.
  isActive    Boolean  @default(true)
  isVerified  Boolean  @default(false) // Platform has verified legitimacy
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campgroundCharities CampgroundCharity[]
  donations           CharityDonation[]
  payouts             CharityPayout[]

  @@index([isActive])
  @@index([category])
}

// Campground's charity selection and round-up settings
model CampgroundCharity {
  id             String   @id @default(cuid())
  campgroundId   String   @unique // One charity per campground
  charityId      String
  isEnabled      Boolean  @default(true)
  customMessage  String?  @db.Text // "Help us support local veterans!"
  roundUpType    String   @default("nearest_dollar") // nearest_dollar, nearest_5, fixed
  roundUpOptions Json? // { values: [1, 2, 5] } for fixed amounts
  defaultOptIn   Boolean  @default(false) // Pre-check the donation box?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  charity    Charity    @relation(fields: [charityId], references: [id])

  @@index([charityId])
}

// Individual donation records linked to reservations
model CharityDonation {
  id             String         @id @default(cuid())
  reservationId  String         @unique // One donation per reservation
  charityId      String
  campgroundId   String
  guestId        String?
  amountCents    Int
  status         DonationStatus @default(collected)
  payoutId       String?
  journalEntryId String? // Link to ledger entry for accounting
  refundedAt     DateTime?
  createdAt      DateTime       @default(now())

  reservation Reservation    @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  charity     Charity        @relation(fields: [charityId], references: [id])
  campground  Campground     @relation(fields: [campgroundId], references: [id])
  payout      CharityPayout? @relation(fields: [payoutId], references: [id])

  @@index([charityId])
  @@index([campgroundId])
  @@index([status])
  @@index([createdAt])
}

// Batch payouts to charities
model CharityPayout {
  id           String              @id @default(cuid())
  charityId    String
  amountCents  Int
  status       CharityPayoutStatus @default(pending)
  payoutDate   DateTime?
  payoutMethod String? // check, ach, wire
  reference    String? // Check number, wire reference
  notes        String?             @db.Text
  createdBy    String? // Admin who initiated
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  charity   Charity           @relation(fields: [charityId], references: [id])
  donations CharityDonation[]

  @@index([charityId])
  @@index([status])
}

// =============================================================================
// EARLY ACCESS PROGRAM
// =============================================================================

// Tracks which organizations enrolled in early access tiers
model EarlyAccessEnrollment {
  id               String          @id @default(cuid())
  organizationId   String          @unique
  tier             EarlyAccessTier
  enrolledAt       DateTime        @default(now())
  lockedBookingFee Int // cents - locked forever at enrollment rate
  monthlyFeeEndsAt DateTime? // When free/discounted monthly period ends (null = forever free)
  lockedMonthlyFee Int? // cents - if special rate applies after promo period

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([tier])
  @@index([enrolledAt])
}

// Tracks available spots per tier (singleton rows)
model EarlyAccessSpot {
  tier           EarlyAccessTier @id
  totalSpots     Int
  remainingSpots Int
  updatedAt      DateTime        @updatedAt
}

// =============================================================================
// ORGANIZATION BILLING (What Camp Everyday charges campgrounds)
// =============================================================================

enum OrgBillingPeriodStatus {
  open // Currently accumulating charges
  processing // Being finalized
  invoiced // Invoice sent to customer
  paid // Payment received
  past_due // Payment overdue
  void // Cancelled/voided
}

enum OrgBillingLineItemType {
  subscription // Monthly subscription fee
  booking_fee // Per-booking fee
  sms_outbound // Outbound SMS charges
  sms_inbound // Inbound SMS charges
  ai_usage // AI feature usage
  overage // Any overage charges
  credit // Credits/adjustments
  discount // Promotional discounts
  early_access_discount // Early access tier discount
}

// Monthly billing period for an organization
model OrganizationBillingPeriod {
  id             String                 @id @default(cuid())
  organizationId String
  periodStart    DateTime // Start of billing period
  periodEnd      DateTime // End of billing period
  status         OrgBillingPeriodStatus @default(open)

  // Totals (in cents)
  subtotalCents Int @default(0)
  discountCents Int @default(0)
  taxCents      Int @default(0)
  totalCents    Int @default(0)

  // Stripe integration
  stripeInvoiceId       String? @unique
  stripePaymentIntentId String?

  // Timing
  invoicedAt DateTime?
  paidAt     DateTime?
  dueAt      DateTime?

  // Metadata
  notes    String?
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization                  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  lineItems    OrganizationBillingLineItem[]

  @@unique([organizationId, periodStart])
  @@index([organizationId])
  @@index([status])
  @@index([periodStart])
}

// Individual line items on an organization's bill
model OrganizationBillingLineItem {
  id              String                 @id @default(cuid())
  billingPeriodId String
  type            OrgBillingLineItemType
  description     String

  // Quantity and pricing
  quantity   Int @default(1)
  unitCents  Int // Price per unit in cents
  totalCents Int // quantity * unitCents

  // Optional references
  campgroundId  String? // If specific to a campground
  reservationId String? // If tied to a specific reservation

  // Metadata for detail drill-down
  metadata Json? // { reservationIds: [...], smsMessageIds: [...] }

  createdAt DateTime @default(now())

  billingPeriod OrganizationBillingPeriod @relation(fields: [billingPeriodId], references: [id], onDelete: Cascade)
  campground    Campground?               @relation(fields: [campgroundId], references: [id])

  @@index([billingPeriodId])
  @@index([type])
  @@index([campgroundId])
}

// Track individual usage events for billing
model UsageEvent {
  id             String  @id @default(cuid())
  organizationId String
  campgroundId   String?
  eventType      String // booking_created, sms_sent, sms_received, ai_tokens_used

  // Quantification
  quantity  Int  @default(1)
  unitCents Int? // Cost per unit (calculated at event time)

  // References
  referenceType String? // reservation, communication, ai_request
  referenceId   String? // ID of the related entity

  // Billing linkage
  billingPeriodId String? // Linked when processed into billing
  billed          Boolean   @default(false)
  billedAt        DateTime?

  metadata  Json?
  createdAt DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  campground   Campground?  @relation(fields: [campgroundId], references: [id])

  @@index([organizationId])
  @@index([campgroundId])
  @@index([eventType])
  @@index([billed])
  @@index([createdAt])
  @@index([billingPeriodId])
}

// ============================================
// Setup Assistance Services
// ============================================

enum SetupServiceType {
  quick_start // $249 - Site config, payment setup, training call
  data_import_500 // $299 - Up to 500 reservations
  data_import_2000 // $599 - 501-2,000 reservations
  data_import_5000 // $999 - 2,001-5,000 reservations
  data_import_custom // Custom quote for 5,000+
}

enum SetupServiceStatus {
  pending // Purchased, awaiting work
  in_progress // Work has started
  completed // Work finished
  cancelled // Cancelled/refunded
}

model SetupService {
  id             String             @id @default(cuid())
  organizationId String
  serviceType    SetupServiceType
  status         SetupServiceStatus @default(pending)

  // Pricing
  totalCents               Int // Full price (e.g., 24900 for $249)
  paidUpfrontCents         Int @default(0) // Amount paid at purchase
  balanceRemainingCents    Int @default(0) // Remaining to pay via bookings
  perBookingSurchargeCents Int @default(100) // $1.00 per booking

  // For data imports
  reservationCount Int? // Estimated/actual reservation count
  importFileUrl    String? // URL to uploaded export file
  importNotes      String? // Notes from customer about the import

  // Stripe
  stripePaymentIntentId String? // If paid upfront
  stripeInvoiceId       String?

  // Tracking
  purchasedAt DateTime  @default(now())
  startedAt   DateTime?
  completedAt DateTime?
  completedBy String? // Staff user ID who completed it

  // Balance payoff tracking
  bookingsCharged Int       @default(0) // Number of bookings that paid $1 surcharge
  lastChargedAt   DateTime?
  paidOffAt       DateTime? // When balance reached $0

  notes    String?
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([status])
  @@index([balanceRemainingCents])
}

// ============================================
// Organization Referral Program (B2B)
// ============================================

enum OrgReferralStatus {
  clicked // Link was clicked
  signed_up // Referred org created an account
  converted // Referred org received first booking
  credited // Credit was applied to referrer
}

model OrgReferral {
  id            String  @id @default(cuid())
  referrerOrgId String // Organization that made the referral
  referredOrgId String? // Organization that was referred (after signup)
  referredEmail String? // Email used during signup (before org created)
  referralCode  String // Code used for tracking

  status            OrgReferralStatus @default(clicked)
  creditAmountCents Int               @default(5000) // $50 default credit

  // Tracking
  clickedAt   DateTime  @default(now())
  signedUpAt  DateTime?
  convertedAt DateTime?
  creditedAt  DateTime?

  // Metadata
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  ipAddress   String?
  userAgent   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  referrerOrg Organization  @relation("ReferrerOrg", fields: [referrerOrgId], references: [id], onDelete: Cascade)
  referredOrg Organization? @relation("ReferredOrg", fields: [referredOrgId], references: [id], onDelete: SetNull)

  @@index([referrerOrgId])
  @@index([referredOrgId])
  @@index([referralCode])
  @@index([referredEmail])
  @@index([status])
}

// ============================================
// Multi-Location Store Management
// ============================================

model StoreLocation {
  id            String            @id @default(cuid())
  campgroundId  String
  name          String // "Pool Bar", "Camp Store", "Snack Shack"
  code          String? // Short code: "PB", "CS", "SS"
  type          StoreLocationType @default(physical)
  isDefault     Boolean           @default(false)
  isActive      Boolean           @default(true)
  acceptsOnline Boolean           @default(false) // Can fulfill online orders
  sortOrder     Int               @default(0)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @default(now()) @updatedAt

  campground         Campground              @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  locationInventory  LocationInventory[]
  priceOverrides     LocationPriceOverride[]
  terminals          PosTerminal[]
  fulfillmentOrders  StoreOrder[]            @relation("FulfillmentLocation")
  transfersOut       InventoryTransfer[]     @relation("TransferFrom")
  transfersIn        InventoryTransfer[]     @relation("TransferTo")
  inventoryMovements InventoryMovement[]
  inventoryBatches   InventoryBatch[]
  externalPosSales   ExternalPosSale[]

  @@unique([campgroundId, name])
  @@index([campgroundId])
  @@index([isActive])
}

model LocationInventory {
  id            String   @id @default(cuid())
  productId     String
  locationId    String
  stockQty      Int      @default(0)
  lowStockAlert Int? // Alert when stock falls below this
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt

  product  Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  location StoreLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([productId, locationId])
  @@index([productId])
  @@index([locationId])
}

model LocationPriceOverride {
  id         String   @id @default(cuid())
  productId  String
  locationId String
  priceCents Int // Override price for this location
  reason     String? // "Pool bar markup", "Clearance", etc.
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  product  Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  location StoreLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([productId, locationId])
  @@index([productId])
  @@index([locationId])
  @@index([isActive])
}

model InventoryTransfer {
  id             String                  @id @default(cuid())
  campgroundId   String
  fromLocationId String
  toLocationId   String
  status         InventoryTransferStatus @default(pending)
  notes          String?
  requestedById  String
  approvedById   String?
  completedById  String?
  requestedAt    DateTime                @default(now())
  approvedAt     DateTime?
  completedAt    DateTime?
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @default(now()) @updatedAt

  campground   Campground              @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  fromLocation StoreLocation           @relation("TransferFrom", fields: [fromLocationId], references: [id], onDelete: Cascade)
  toLocation   StoreLocation           @relation("TransferTo", fields: [toLocationId], references: [id], onDelete: Cascade)
  requestedBy  User                    @relation("TransferRequester", fields: [requestedById], references: [id])
  approvedBy   User?                   @relation("TransferApprover", fields: [approvedById], references: [id])
  completedBy  User?                   @relation("TransferCompleter", fields: [completedById], references: [id])
  items        InventoryTransferItem[]

  @@index([campgroundId])
  @@index([fromLocationId])
  @@index([toLocationId])
  @@index([status])
}

model InventoryTransferItem {
  id         String   @id @default(cuid())
  transferId String
  productId  String
  qty        Int
  createdAt  DateTime @default(now())

  transfer InventoryTransfer @relation(fields: [transferId], references: [id], onDelete: Cascade)
  product  Product           @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([transferId])
  @@index([productId])
}

model InventoryMovement {
  id            String   @id @default(cuid())
  campgroundId  String
  productId     String
  locationId    String? // Null for shared-mode products
  batchId       String? // Link to specific batch if batch tracking enabled
  movementType  String // sale, return, transfer_out, transfer_in, adjustment, restock
  qty           Int // Positive or negative
  previousQty   Int
  newQty        Int
  referenceType String? // order, transfer, manual
  referenceId   String? // ID of order/transfer/etc.
  notes         String?
  actorUserId   String
  createdAt     DateTime @default(now())

  campground     Campground      @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  product        Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  location       StoreLocation?  @relation(fields: [locationId], references: [id], onDelete: SetNull)
  actor          User            @relation(fields: [actorUserId], references: [id])
  batchMovements BatchMovement[]

  @@index([campgroundId])
  @@index([productId])
  @@index([locationId])
  @@index([batchId])
  @@index([movementType])
  @@index([createdAt])
}

// ============================================================================
// INVENTORY BATCH & EXPIRATION TRACKING
// ============================================================================

// Batch/lot tracking for inventory with expiration dates
model InventoryBatch {
  id           String  @id @default(cuid())
  campgroundId String
  productId    String
  locationId   String? // Null for shared-mode products

  // Batch identification
  batchNumber String? // Optional lot/batch number from supplier
  supplierId  String? // Optional supplier reference

  // Quantities
  qtyReceived  Int // Original quantity received
  qtyRemaining Int // Current remaining quantity

  // Dates
  receivedDate   DateTime // When batch was received
  expirationDate DateTime? // Null for non-perishable items

  // Cost tracking
  unitCostCents Int? // Cost per unit for this batch (COGS)

  // Status
  isActive   Boolean   @default(true) // False when fully depleted
  depletedAt DateTime? // When qtyRemaining reached 0

  // Audit
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
  createdById String?

  // Relations
  campground           Campground            @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  product              Product               @relation(fields: [productId], references: [id], onDelete: Cascade)
  location             StoreLocation?        @relation(fields: [locationId], references: [id], onDelete: SetNull)
  movements            BatchMovement[]
  markdownApplications MarkdownApplication[]

  @@index([campgroundId])
  @@index([productId])
  @@index([locationId])
  @@index([expirationDate])
  @@index([isActive, expirationDate])
  @@index([productId, locationId, isActive, expirationDate]) // FEFO query optimization
}

// Track individual batch movements (for FIFO/FEFO audit)
model BatchMovement {
  id         String  @id @default(cuid())
  batchId    String
  movementId String? // Links to InventoryMovement for audit trail

  // Movement details
  qty           Int // Quantity affected (negative for deductions)
  movementType  String // sale, return, adjustment, disposal, transfer
  referenceType String? // order, transfer, manual, disposal
  referenceId   String? // ID of order/transfer/etc.

  // Disposal specific
  disposalReason BatchDisposalReason?
  disposalNotes  String?

  // Audit
  previousQty Int
  newQty      Int
  actorUserId String
  createdAt   DateTime @default(now())

  batch    InventoryBatch     @relation(fields: [batchId], references: [id], onDelete: Cascade)
  movement InventoryMovement? @relation(fields: [movementId], references: [id], onDelete: SetNull)
  actor    User               @relation("BatchMovementActor", fields: [actorUserId], references: [id])

  @@index([batchId])
  @@index([movementId])
  @@index([actorUserId])
  @@index([createdAt])
}

// Category-level expiration thresholds (defaults)
model CategoryExpirationConfig {
  id           String @id @default(cuid())
  campgroundId String
  categoryId   String

  // Threshold days before expiration
  warningDays  Int @default(7) // Days before expiration for "warning" tier
  criticalDays Int @default(2) // Days before expiration for "critical" tier

  // Slow-moving threshold
  slowMovingDays Int @default(30) // Days without sale to be considered slow-moving

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  campground Campground      @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  category   ProductCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, categoryId])
  @@index([campgroundId])
}

// Product-level expiration threshold overrides
model ProductExpirationConfig {
  id           String @id @default(cuid())
  campgroundId String
  productId    String

  // Threshold days before expiration (override category defaults)
  warningDays  Int?
  criticalDays Int?

  // Slow-moving threshold override
  slowMovingDays Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, productId])
  @@index([campgroundId])
}

// Auto-markdown rules for expiring inventory
model MarkdownRule {
  id           String @id @default(cuid())
  campgroundId String

  // Trigger condition
  daysUntilExpiration Int // Apply when X days until expiration

  // Discount
  discountType  MarkdownDiscountType
  discountValue Int // Percentage (1-100) or flat cents

  // Scope
  scope      MarkdownScope
  categoryId String? // If scope is 'category'
  productId  String? // If scope is 'product'

  // Priority (lower = higher priority, for overlapping rules)
  priority Int @default(100)

  // Status
  isActive Boolean @default(true)

  // Audit
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
  createdById String?

  campground   Campground            @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  category     ProductCategory?      @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  product      Product?              @relation(fields: [productId], references: [id], onDelete: SetNull)
  applications MarkdownApplication[]

  @@index([campgroundId])
  @@index([categoryId])
  @@index([productId])
  @@index([isActive, daysUntilExpiration])
}

// Track markdown applications for reporting
model MarkdownApplication {
  id             String  @id @default(cuid())
  campgroundId   String
  markdownRuleId String
  batchId        String
  cartId         String? // POS cart where markdown was applied

  // Markdown details
  originalPriceCents Int
  markdownPriceCents Int
  discountCents      Int // Amount discounted
  qty                Int // Quantity sold at markdown

  // Reason tracking
  daysUntilExpiration Int // Days remaining at time of sale

  createdAt DateTime @default(now())

  campground   Campground     @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  markdownRule MarkdownRule   @relation(fields: [markdownRuleId], references: [id], onDelete: Cascade)
  batch        InventoryBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([markdownRuleId])
  @@index([batchId])
  @@index([createdAt])
}

// Expiration alerts log (for tracking sent notifications)
model ExpirationAlert {
  id           String @id @default(cuid())
  campgroundId String
  batchId      String

  // Alert details
  tier           ExpirationTier
  expirationDate DateTime
  daysRemaining  Int
  productName    String // Snapshot for historical record
  locationName   String?
  qtyRemaining   Int

  // Notification tracking
  alertedAt        DateTime  @default(now())
  acknowledgedAt   DateTime?
  acknowledgedById String?

  campground     Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  acknowledgedBy User?      @relation("AlertAcknowledger", fields: [acknowledgedById], references: [id], onDelete: SetNull)

  @@index([campgroundId])
  @@index([batchId])
  @@index([tier])
  @@index([alertedAt])
  @@index([acknowledgedById])
}

// ============================================================================
// HOTEL OPERATIONS EXTENSION - Phase 1-5
// ============================================================================

// Structure attributes for non-RV accommodations (cabins, hotel rooms, glamping)
model StructureAttributes {
  id     String @id @default(cuid())
  siteId String @unique

  // Sleeping configuration
  bedConfiguration Json? // [{type: "king", count: 1}, {type: "bunk", count: 2}]
  bedroomCount     Int?

  // Facilities
  bathroomCount Int?
  bathroomType  String? // private, shared, none
  hasKitchen    Boolean @default(false)
  kitchenType   String? // full, kitchenette, none
  hasHeat       Boolean @default(false)
  hasAC         Boolean @default(false)
  hasFireplace  Boolean @default(false)

  // Building location (for hotel rooms)
  floorNumber  Int?
  buildingName String?
  squareFeet   Int?

  // Views & Features
  hasBalcony Boolean @default(false)
  hasPatio   Boolean @default(false)
  viewType   String? // lake, mountain, forest, pool, parking_lot

  // Linens & Supplies
  linensProvided Boolean @default(true)
  towelsProvided Boolean @default(true)

  // Hotel-specific features
  connectingRoomIds String[] @default([])
  isConnecting      Boolean  @default(false)
  minibar           Boolean  @default(false)
  roomService       Boolean  @default(false)
  safe              Boolean  @default(false)
  coffeemaker       Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([siteId])
}

// Cleaning task templates - configurable per property and site type
model CleaningTaskTemplate {
  id           String    @id @default(cuid())
  campgroundId String
  taskType     TaskType
  siteType     SiteType? // null = applies to all site types

  name               String
  estimatedMinutes   Int
  checklist          Json // [{id, text, required, category}]
  suppliesNeeded     Json? // [{item, quantity}]
  priority           Int     @default(100)
  slaMinutes         Int? // Default SLA for this task type
  requiresInspection Boolean @default(false)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([taskType])
  @@index([siteType])
}

// Inspection results for housekeeping quality control
model InspectionResult {
  id          String @id @default(cuid())
  taskId      String
  inspectorId String

  // Inspection data
  responses     Json // [{itemId, passed, notes, photo}]
  overallResult String // passed, failed, partial
  score         Int? // Percentage score (0-100)

  // Follow-up
  failedItems     String[] @default([])
  requiresReclean Boolean  @default(false)
  notes           String?
  photos          String[] @default([])

  completedAt DateTime @default(now())

  task      Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  inspector User @relation("InspectionInspector", fields: [inspectorId], references: [id])

  @@index([taskId])
  @@index([inspectorId])
}

// Cleaning zones for organizing housekeeping by building/area
model CleaningZone {
  id            String  @id @default(cuid())
  campgroundId  String
  name          String // "Building A Floor 2", "Lakeside Loop"
  zoneType      String // building_floor, outdoor_loop, wing, section
  parentZoneId  String? // Hierarchy support
  primaryTeamId String? // Default assigned team
  color         String? // For dashboard visualization

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campground Campground     @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  parentZone CleaningZone?  @relation("ZoneHierarchy", fields: [parentZoneId], references: [id])
  childZones CleaningZone[] @relation("ZoneHierarchy")

  @@index([campgroundId])
  @@index([parentZoneId])
}

// Flex check-in/check-out policy per campground
model FlexCheckPolicy {
  id           String @id @default(cuid())
  campgroundId String @unique

  // Early check-in
  earlyCheckInEnabled     Boolean @default(false)
  earlyCheckInMinHours    Int? // How many hours early allowed
  earlyCheckInPricing     Json? // {type: "flat"|"hourly", amount: cents}
  earlyCheckInAutoApprove Boolean @default(false)

  // Late checkout
  lateCheckoutEnabled     Boolean @default(false)
  lateCheckoutMaxHours    Int? // How many hours late allowed
  lateCheckoutPricing     Json? // {type: "flat"|"hourly", amount: cents}
  lateCheckoutAutoApprove Boolean @default(false)

  // VIP overrides
  vipEarlyFree Boolean @default(false)
  vipLateFree  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
}

// Room move/upgrade requests during a stay
model RoomMoveRequest {
  id            String @id @default(cuid())
  campgroundId  String
  reservationId String
  fromSiteId    String
  toSiteId      String

  // Move details
  moveDate        DateTime
  moveReason      String // guest_request, maintenance, upgrade, downgrade, overbooking
  isComplimentary Boolean  @default(false)
  priceDifference Int? // Positive = guest pays, negative = refund

  // Status workflow
  status String @default("requested") // requested, approved, in_progress, completed, cancelled

  // Logistics
  luggageAssistance Boolean @default(false)
  newKeysIssued     Boolean @default(false)

  // Audit
  requestedById String
  approvedById  String?
  completedById String?
  completedAt   DateTime?
  notes         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campground  Campground  @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  reservation Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  fromSite    Site        @relation("RoomMoveFrom", fields: [fromSiteId], references: [id])
  toSite      Site        @relation("RoomMoveTo", fields: [toSiteId], references: [id])
  requestedBy User        @relation("RoomMoveRequester", fields: [requestedById], references: [id])
  approvedBy  User?       @relation("RoomMoveApprover", fields: [approvedById], references: [id])
  completedBy User?       @relation("RoomMoveCompleter", fields: [completedById], references: [id])

  @@index([campgroundId])
  @@index([reservationId])
  @@index([status])
}

// Group bookings for multi-room coordination
model GroupBooking {
  id           String @id @default(cuid())
  campgroundId String

  // Group info
  groupName      String
  primaryGuestId String
  groupType      String // family, corporate, wedding, reunion, tour, sports_team

  // Room preferences
  preferAdjacent   Boolean @default(false)
  preferSameFloor  Boolean @default(false)
  preferConnecting Boolean @default(false)
  preferredZone    String? // Building/area preference

  // Assignment status
  assignmentStatus String @default("pending") // pending, partial, complete, confirmed

  // Billing
  billingType   String  @default("individual") // individual, master_folio, split
  masterFolioId String? // If using master folio billing

  // Coordination
  groupArrivalTime   String? // Coordinated arrival time
  groupDepartureTime String? // Coordinated departure time
  welcomeAmenity     String? // Special welcome setup
  groupNotes         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campground   Campground    @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  primaryGuest Guest         @relation("GroupPrimaryGuest", fields: [primaryGuestId], references: [id])
  reservations Reservation[]

  @@index([campgroundId])
  @@index([primaryGuestId])
  @@index([assignmentStatus])
}

// =============================================================================
// 3RD PARTY POS INTEGRATION MODELS
// =============================================================================

// Records sales from external POS systems (via Partner API)
model ExternalPosSale {
  id                    String  @id @default(cuid())
  campgroundId          String
  externalTransactionId String
  provider              String? // "partner_api" | "lightspeed" | "shopify" etc
  apiClientId           String? // Which API client recorded this sale

  items         Json // Array of { sku, qty, priceCents, batchId?, markdownApplied? }
  totalCents    Int
  paymentMethod String?
  locationId    String?

  inventoryDeducted Boolean  @default(false)
  saleDate          DateTime
  metadata          Json? // Additional provider-specific data

  createdAt DateTime @default(now())

  campground Campground     @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  location   StoreLocation? @relation(fields: [locationId], references: [id], onDelete: SetNull)
  apiClient  ApiClient?     @relation(fields: [apiClientId], references: [id], onDelete: SetNull)

  @@unique([campgroundId, externalTransactionId])
  @@index([campgroundId, saleDate])
  @@index([apiClientId])
}

// Maps internal products to external POS system product IDs
model ProductExternalMapping {
  id           String          @id @default(cuid())
  campgroundId String
  productId    String
  provider     PosProviderType
  externalId   String // ID in external system
  externalSku  String? // SKU in external system

  lastSyncedAt DateTime?
  syncStatus   String? // "synced" | "pending" | "error"
  syncError    String?
  metadata     Json? // Provider-specific mapping data

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, provider, externalId])
  @@unique([campgroundId, provider, productId])
  @@index([campgroundId, provider])
  @@index([productId])
}

// =============================================================================
// KIOSK DEVICE MANAGEMENT
// =============================================================================

// Paired kiosk devices (iPads, tablets at check-in stations)
model KioskDevice {
  id           String @id @default(cuid())
  campgroundId String

  name        String // "Front Gate Kiosk", "Lobby iPad", etc.
  deviceToken String @unique // Secret token for API auth

  status     String    @default("active") // active, disabled, revoked
  lastSeenAt DateTime?
  userAgent  String? // Browser/device info

  // Features enabled for this kiosk
  allowWalkIns  Boolean @default(true)
  allowCheckIn  Boolean @default(true)
  allowPayments Boolean @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  revokedAt DateTime?

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([deviceToken])
}

// Temporary pairing codes for kiosk setup
model KioskPairingCode {
  id           String @id @default(cuid())
  campgroundId String

  code      String // 6-digit code like "847291"
  expiresAt DateTime

  usedAt         DateTime?
  usedByDeviceId String? // Which device used this code

  createdAt   DateTime @default(now())
  createdById String? // Staff user who generated it

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, code])
  @@index([campgroundId])
  @@index([code])
}

// =============================================================================
// VALUE STACK: GUARANTEES, BONUSES & LEAD CAPTURE
// =============================================================================

enum GuaranteeType {
  unconditional // Money back, no questions
  conditional // Money back if you do X
  performance // We keep working until you get result
  satisfaction // First night/day satisfaction guarantee
  weather // Rain/weather guarantee
  best_price // Best rate guarantee
}

// Campground guarantees displayed on public booking page
model CampgroundGuarantee {
  id           String        @id @default(cuid())
  campgroundId String
  type         GuaranteeType
  title        String // "Rain Guarantee"
  description  String        @db.Text // "If it rains 3+ days..."
  iconName     String? // Lucide icon name: "cloud-rain", "shield-check"
  sortOrder    Int           @default(0)
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([isActive])
}

// Bonus items included with booking (value stack)
model CampgroundBonus {
  id             String   @id @default(cuid())
  campgroundId   String
  name           String // "Free Firewood Bundle"
  description    String? // "Includes 6 logs..."
  valueCents     Int // Perceived value: 1500 = $15
  iconName       String? // Lucide icon name
  siteClassIds   String[] @default([]) // Empty = applies to all, otherwise specific site classes
  isAutoIncluded Boolean  @default(true) // Always included vs optional add-on
  sortOrder      Int      @default(0)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@index([campgroundId])
  @@index([isActive])
}

// Lead capture settings for public pages
model LeadCaptureConfig {
  id           String @id @default(cuid())
  campgroundId String @unique

  // Events empty state lead capture
  eventsEnabled    Boolean @default(true)
  eventsHeadline   String  @default("Something exciting is coming...")
  eventsSubtext    String  @default("Sign up to be the first to know about special events and deals")
  eventsButtonText String  @default("Notify Me")

  // General newsletter capture
  newsletterEnabled    Boolean @default(true)
  newsletterHeadline   String  @default("Get the inside scoop")
  newsletterSubtext    String  @default("Exclusive deals, event announcements, and camping tips")
  newsletterButtonText String  @default("Subscribe")

  // First booking incentive
  firstBookingEnabled  Boolean @default(true)
  firstBookingDiscount Int     @default(10) // Percentage off
  firstBookingHeadline String  @default("First time? Get 10% off")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
}

// Captured leads from public pages
model PublicLead {
  id           String  @id @default(cuid())
  campgroundId String
  email        String
  source       String // "events_notify", "newsletter", "first_booking"
  ipAddress    String?
  userAgent    String?

  // Marketing preferences
  marketingOptIn Boolean @default(true)

  // Conversion tracking
  convertedAt DateTime?
  guestId     String? // If they became a guest

  createdAt DateTime @default(now())

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  @@unique([campgroundId, email, source])
  @@index([campgroundId])
  @@index([email])
  @@index([source])
}

// Booking page copy/messaging configuration
model BookingPageConfig {
  id           String @id @default(cuid())
  campgroundId String @unique

  // Hero section
  heroHeadline String? // Override default headline
  heroSubline  String? // Override tagline

  // Value proposition (dream outcome)
  dreamOutcome String? @db.Text // "Wake up to the sound of the river..."

  // Social proof
  showReviewCount Boolean @default(true)
  showTrustBadges Boolean @default(true)
  showScarcity    Boolean @default(true)
  showLiveViewers Boolean @default(false) // "3 people viewing"

  // Urgency elements
  showLimitedAvail Boolean @default(true)

  // Custom messaging
  bookButtonText String @default("Book Now")
  checkAvailText String @default("Check availability")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campground Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
}

// =============================================================================
// UNIFIED OPERATIONS / TASK MANAGEMENT SYSTEM
// =============================================================================
// Consolidates: MaintenanceTicket, OperationalTask, Task, CleaningTaskTemplate
// into a unified system with recurring tasks, event triggers, and SLA tracking.

// Task categories (what type of work)
enum OpTaskCategory {
  turnover // Site turnover/make-ready after checkout
  housekeeping // Routine cleaning (daily bathroom cleaning, etc.)
  maintenance // Repairs and maintenance work
  inspection // Quality inspections
  grounds // Landscaping, trash, outdoor maintenance
  pool // Pool/hot tub maintenance
  front_desk // Front desk tasks (check-in prep, etc.)
  custom // Custom/other tasks
}

// Task states (workflow)
enum OpTaskState {
  pending // Not started
  assigned // Assigned to someone but not started
  in_progress // Work in progress
  blocked // Blocked by issue or dependency
  completed // Work finished
  verified // Inspected/verified by supervisor
  cancelled // Task cancelled
}

// Task priority levels
enum OpTaskPriority {
  low
  medium
  high
  urgent // Requires immediate attention
}

// SLA status for tracking deadlines
enum OpSlaStatus {
  on_track // Ahead of schedule
  at_risk // Approaching deadline
  breached // Past deadline
}

// What triggers automatic task creation
enum OpTriggerEvent {
  reservation_checkout // Guest checks out
  reservation_checkin // Guest checks in
  reservation_created // New reservation booked
  reservation_cancelled // Reservation cancelled
  reservation_modified // Reservation changed
  maintenance_reported // Maintenance issue reported
  inspection_failed // Failed inspection creates follow-up
  site_status_changed // Site status changed (e.g., out of order)
  manual // Manually created
}

// Recurrence patterns
enum OpRecurrencePattern {
  daily // Every day
  weekly // Specific days of week
  biweekly // Every two weeks
  monthly // Specific days of month
  seasonal // Only during season (based on campground season dates)
}

// Staff team for task assignment
model OpTeam {
  id           String   @id @default(cuid())
  campgroundId String
  name         String // "Housekeeping", "Maintenance", "Grounds Crew"
  description  String?
  color        String? // Hex color for UI
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campground      Campground         @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  members         OpTeamMember[]
  tasks           OpTask[]           @relation("TaskAssignedToTeam")
  templates       OpTaskTemplate[]   @relation("TemplateDefaultTeam")
  triggers        OpTaskTrigger[]    @relation("TriggerAssignToTeam")
  recurrenceRules OpRecurrenceRule[] @relation("RecurrenceAssignToTeam")

  @@unique([campgroundId, name])
  @@index([campgroundId])
}

// Team membership
model OpTeamMember {
  id       String   @id @default(cuid())
  teamId   String
  userId   String
  role     String   @default("member") // lead, member
  joinedAt DateTime @default(now())

  team OpTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User   @relation("UserOpTeamMemberships", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

// ============================================================
// GAMIFICATION - Staff performance tracking and badges
// ============================================================

// Badge definitions
model OpBadge {
  id           String          @id @default(cuid())
  campgroundId String? // null = system-wide badge
  code         String // unique identifier like "speed_demon", "perfect_week"
  name         String // "Speed Demon", "Perfect Week"
  description  String // "Complete 10 tasks under SLA in a single day"
  icon         String // emoji or icon name
  category     OpBadgeCategory
  tier         OpBadgeTier     @default(bronze)

  // Earning criteria (JSON)
  // { type: "task_count" | "streak" | "sla_compliance" | "special", threshold: number, timeframe?: "day" | "week" | "month" }
  criteria Json

  // Points awarded when earned
  points Int @default(10)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  campground Campground?    @relation("CampgroundOpBadges", fields: [campgroundId], references: [id], onDelete: Cascade)
  earnedBy   OpStaffBadge[]

  @@unique([campgroundId, code])
  @@index([campgroundId])
  @@index([category])
}

enum OpBadgeCategory {
  speed // Fast task completion
  volume // High task count
  quality // SLA compliance, no re-opens
  streak // Consecutive days/weeks
  teamwork // Helping others, team goals
  milestone // 100 tasks, 1 year, etc.
  special // Seasonal, event-based
}

enum OpBadgeTier {
  bronze
  silver
  gold
  platinum
}

// Badges earned by staff members
model OpStaffBadge {
  id           String @id @default(cuid())
  userId       String
  badgeId      String
  campgroundId String

  earnedAt DateTime @default(now())

  // Context when badge was earned
  context Json? // { taskCount: 15, streak: 7, etc. }

  user       User       @relation("UserOpBadges", fields: [userId], references: [id], onDelete: Cascade)
  badge      OpBadge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  campground Campground @relation("CampgroundOpStaffBadges", fields: [campgroundId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId, campgroundId])
  @@index([userId])
  @@index([badgeId])
  @@index([campgroundId])
  @@index([earnedAt])
}

// Daily stats snapshot for staff (for streaks and historical tracking)
model OpStaffDailyStats {
  id           String   @id @default(cuid())
  userId       String
  campgroundId String
  date         DateTime @db.Date

  // Task counts
  tasksCompleted Int @default(0)
  tasksOnTime    Int @default(0)
  tasksLate      Int @default(0)

  // Time metrics (in minutes)
  totalWorkMinutes  Int  @default(0)
  avgCompletionTime Int? // Average minutes per task
  fastestTask       Int? // Fastest completion in minutes
  fastCompletions   Int  @default(0) // Tasks completed in under 30 minutes

  // Points earned today
  pointsEarned Int @default(0)

  // Streak tracking
  isWorkDay Boolean @default(true) // Did they complete at least 1 task?

  user       User       @relation("UserOpDailyStats", fields: [userId], references: [id], onDelete: Cascade)
  campground Campground @relation("CampgroundOpStaffDailyStats", fields: [campgroundId], references: [id], onDelete: Cascade)

  @@unique([userId, campgroundId, date])
  @@index([userId])
  @@index([campgroundId])
  @@index([date])
}

// Aggregate staff stats (updated periodically)
model OpStaffStats {
  id           String @id @default(cuid())
  userId       String
  campgroundId String

  // Lifetime stats
  totalTasksCompleted Int @default(0)
  totalTasksOnTime    Int @default(0)
  totalTasksLate      Int @default(0)
  totalPoints         Int @default(0)

  // Current streaks
  currentStreak        Int @default(0) // Consecutive work days
  longestStreak        Int @default(0)
  currentPerfectStreak Int @default(0) // Consecutive days with 100% SLA
  longestPerfectStreak Int @default(0)

  // This week
  weekTasksCompleted  Int @default(0)
  weekTasksOnTime     Int @default(0)
  weekPoints          Int @default(0)
  weekFastCompletions Int @default(0) // Fast tasks this week (under 30 min)

  // This month
  monthTasksCompleted Int @default(0)
  monthTasksOnTime    Int @default(0)
  monthPoints         Int @default(0)

  // Performance metrics
  avgCompletionTime    Int?  @default(0) // Minutes
  slaComplianceRate    Float @default(100) // Percentage
  totalFastCompletions Int   @default(0) // Total fast completions (under 30 min)

  // Ranking (updated periodically)
  weeklyRank  Int?
  monthlyRank Int?
  allTimeRank Int?

  lastTaskAt DateTime?
  updatedAt  DateTime  @updatedAt

  user       User       @relation("UserOpStats", fields: [userId], references: [id], onDelete: Cascade)
  campground Campground @relation("CampgroundOpStaffStats", fields: [campgroundId], references: [id], onDelete: Cascade)

  @@unique([userId, campgroundId])
  @@index([campgroundId])
  @@index([totalPoints])
  @@index([weekPoints])
  @@index([monthPoints])
}

// Task template - defines what a task looks like (checklists, SLA, etc.)
model OpTaskTemplate {
  id           String         @id @default(cuid())
  campgroundId String
  name         String // "Cabin Deep Clean", "RV Site Turnover", "Bathroom Daily"
  description  String?
  category     OpTaskCategory
  priority     OpTaskPriority @default(medium)

  // Checklist template
  // JSON array: [{ id, text, required, category?, estimatedMinutes? }]
  checklistTemplate Json?

  // Supplies needed
  // JSON array: [{ item, quantity?, notes? }]
  suppliesNeeded Json?

  // Time estimates
  estimatedMinutes Int? // Expected duration
  slaMinutes       Int? // SLA deadline from task creation

  // Assignment defaults
  defaultTeamId     String?
  defaultAssigneeId String?

  // Scope - which sites this applies to
  siteClassIds String[] @default([]) // Empty = all site classes
  siteIds      String[] @default([]) // Empty = all sites (within site classes)

  // Gamification
  xpValue Int @default(10) // XP earned on completion

  // Status
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campground      Campground         @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  defaultTeam     OpTeam?            @relation("TemplateDefaultTeam", fields: [defaultTeamId], references: [id], onDelete: SetNull)
  defaultAssignee User?              @relation("TemplateDefaultAssignee", fields: [defaultAssigneeId], references: [id], onDelete: SetNull)
  tasks           OpTask[]           @relation("TaskFromTemplate")
  triggers        OpTaskTrigger[]
  recurrenceRules OpRecurrenceRule[]

  @@index([campgroundId, category])
  @@index([campgroundId, isActive])
}

// Event trigger - automatically creates tasks based on events
model OpTaskTrigger {
  id           String         @id @default(cuid())
  campgroundId String
  name         String // "Checkout Cleaning", "Check-in Prep"
  triggerEvent OpTriggerEvent
  templateId   String

  // Conditions (JSON)
  // e.g., { "siteClassIds": ["cabin"], "minNights": 3 }
  conditions Json?

  // SLA offset - when is task due relative to event
  // Negative = before event, Positive = after event
  // e.g., -120 means due 2 hours before check-in
  slaOffsetMinutes Int @default(0)

  // Assignment override
  assignToTeamId String?
  assignToUserId String?

  // Status
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campground   Campground     @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  template     OpTaskTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  assignToTeam OpTeam?        @relation("TriggerAssignToTeam", fields: [assignToTeamId], references: [id], onDelete: SetNull)
  assignToUser User?          @relation("TriggerAssignToUser", fields: [assignToUserId], references: [id], onDelete: SetNull)
  tasks        OpTask[]       @relation("TaskFromTrigger")

  @@index([campgroundId, triggerEvent])
  @@index([campgroundId, isActive])
}

// Recurrence rule - generates recurring tasks on schedule
model OpRecurrenceRule {
  id           String              @id @default(cuid())
  campgroundId String
  name         String // "Daily Bathroom Cleaning", "Weekly Deep Clean"
  templateId   String
  pattern      OpRecurrencePattern

  // Schedule details (depends on pattern)
  // daily: null (runs every day)
  // weekly: daysOfWeek [0-6] where 0=Sunday
  // biweekly: daysOfWeek + startDate for week alignment
  // monthly: daysOfMonth [1-31]
  // seasonal: same as above but respects campground.seasonStart/End
  daysOfWeek  Int[] @default([]) // 0=Sun, 1=Mon, ..., 6=Sat
  daysOfMonth Int[] @default([]) // 1-31

  // Time of day to create tasks (in campground timezone)
  generateAtHour   Int @default(6) // 6 AM
  generateAtMinute Int @default(0)

  // Which sites to create tasks for
  siteClassIds   String[] @default([]) // Empty = all
  siteIds        String[] @default([]) // Empty = all (within classes)
  locationFilter String? // "bathhouse", "pool", etc. for non-site tasks

  // Assignment
  assignToTeamId String?
  assignToUserId String?

  // Last generation tracking
  lastGeneratedAt  DateTime?
  nextGenerationAt DateTime?

  // Status
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campground   Campground     @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  template     OpTaskTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  assignToTeam OpTeam?        @relation("RecurrenceAssignToTeam", fields: [assignToTeamId], references: [id], onDelete: SetNull)
  assignToUser User?          @relation("RecurrenceAssignToUser", fields: [assignToUserId], references: [id], onDelete: SetNull)
  tasks        OpTask[]       @relation("TaskFromRecurrence")

  @@index([campgroundId, pattern])
  @@index([campgroundId, isActive])
  @@index([nextGenerationAt])
}

// Unified task model - the actual work items
model OpTask {
  id           String @id @default(cuid())
  campgroundId String

  // Classification
  category OpTaskCategory
  state    OpTaskState    @default(pending)
  priority OpTaskPriority @default(medium)

  // Content
  title       String
  description String?

  // Checklist progress
  // JSON array: [{ id, text, completed, completedAt?, completedBy?, required }]
  checklist         Json?
  checklistProgress Int   @default(0) // Percentage complete (0-100)

  // Photos/attachments
  // JSON array: [{ url, caption?, uploadedAt, uploadedBy }]
  photos Json?

  // Location
  siteId              String?
  reservationId       String?
  locationDescription String? // For non-site tasks: "Bathhouse A", "Pool Area"

  // Assignment
  assignedToUserId String?
  assignedToTeamId String?

  // SLA tracking
  slaDueAt         DateTime?
  slaStatus        OpSlaStatus @default(on_track)
  slaEscalatedAt   DateTime? // When it was escalated
  slaEscalatedToId String? // User who was notified of escalation

  // Source tracking - where did this task come from?
  templateId       String? // Template used
  triggerId        String? // Trigger that created it
  recurrenceRuleId String? // Recurrence rule that created it
  sourceEvent      OpTriggerEvent? // Event that triggered creation

  // Work tracking
  startedAt     DateTime?
  completedAt   DateTime?
  completedById String?
  verifiedAt    DateTime?
  verifiedById  String?

  // For maintenance-style tasks
  isBlocking       Boolean   @default(false) // Blocks site availability
  outOfOrder       Boolean   @default(false) // Site out of order
  outOfOrderReason String?
  outOfOrderUntil  DateTime?

  // Notes and communication
  notes String? @db.Text

  // Gamification
  xpAwarded Int @default(0)

  // Audit
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  campground     Campground        @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  site           Site?             @relation("OpTaskSite", fields: [siteId], references: [id], onDelete: SetNull)
  reservation    Reservation?      @relation("OpTaskReservation", fields: [reservationId], references: [id], onDelete: SetNull)
  assignedToUser User?             @relation("OpTaskAssignedToUser", fields: [assignedToUserId], references: [id], onDelete: SetNull)
  assignedToTeam OpTeam?           @relation("TaskAssignedToTeam", fields: [assignedToTeamId], references: [id], onDelete: SetNull)
  completedBy    User?             @relation("OpTaskCompletedBy", fields: [completedById], references: [id], onDelete: SetNull)
  verifiedBy     User?             @relation("OpTaskVerifiedBy", fields: [verifiedById], references: [id], onDelete: SetNull)
  slaEscalatedTo User?             @relation("OpTaskEscalatedTo", fields: [slaEscalatedToId], references: [id], onDelete: SetNull)
  createdBy      User              @relation("OpTaskCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  template       OpTaskTemplate?   @relation("TaskFromTemplate", fields: [templateId], references: [id], onDelete: SetNull)
  trigger        OpTaskTrigger?    @relation("TaskFromTrigger", fields: [triggerId], references: [id], onDelete: SetNull)
  recurrenceRule OpRecurrenceRule? @relation("TaskFromRecurrence", fields: [recurrenceRuleId], references: [id], onDelete: SetNull)
  comments       OpTaskComment[]

  @@index([campgroundId, state])
  @@index([campgroundId, category])
  @@index([campgroundId, slaDueAt])
  @@index([campgroundId, slaStatus])
  @@index([assignedToUserId])
  @@index([assignedToTeamId])
  @@index([siteId])
  @@index([reservationId])
}

// Task comments/discussion
model OpTaskComment {
  id      String @id @default(cuid())
  taskId  String
  userId  String
  content String @db.Text

  // For status changes
  isSystemMessage Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  task OpTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User   @relation("OpTaskCommentAuthor", fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId, createdAt])
}

// ==================== SEASONALS MANAGEMENT ====================

enum SeasonalBillingFrequency {
  monthly
  biweekly              // Every 2 weeks
  semi_monthly          // 1st and 15th of month
  quarterly
  semi_annual
  seasonal              // One payment for whole season
  deposit_plus_monthly  // Deposit upfront + monthly payments
  offseason_installments // Pay during off-season months
  custom                // Manually defined schedule
}

enum SeasonalStatus {
  active
  pending_renewal
  not_renewing
  departed
  waitlist
}

enum RenewalIntent {
  committed // Definitely returning
  likely // Probably returning
  undecided // Haven't decided
  not_renewing // Confirmed leaving
}

enum SeasonalDiscountCondition {
  metered_utilities // Guest is on metered electric/water
  pay_in_full // Paying entire season upfront
  payment_method // Specific payment method (check, cash, ACH)
  early_bird // Commits/pays before deadline
  returning_guest // Has previous seasons
  tenure_years // X+ years as seasonal
  site_class // Specific site types
  referral // Referred by existing seasonal
  military // Military/veteran
  senior // Age-based
  custom // Custom condition (uses conditionValue JSON)
}

enum SeasonalDiscountType {
  fixed_amount // $100 off
  percentage // 10% off
  per_month // $25/month off
}

enum SeasonalIncentiveType {
  guest_passes // X guest day passes
  store_credit // $X store credit
  free_nights // X free nights for next season
  early_site_selection // Priority site selection
  rate_lock // Lock in this year's rate for next year
  amenity_access // Free pool/golf cart/etc
  custom // Custom reward
}

enum SeasonalPaymentStatus {
  scheduled
  due
  past_due
  paid
  partial
  waived
}

enum SeasonalPaymentMethod {
  check
  cash
  card
  ach
  autopay
}

// Rate card configuration per campground/season
model SeasonalRateCard {
  id           String     @id @default(cuid())
  campgroundId String
  campground   Campground @relation("CampgroundSeasonalRateCards", fields: [campgroundId], references: [id], onDelete: Cascade)

  name       String // "2025 Season", "Premium Waterfront 2025"
  seasonYear Int

  // Base pricing
  baseRate         Decimal                  @db.Decimal(10, 2) // $2,400
  billingFrequency SeasonalBillingFrequency @default(monthly)

  // What's included
  description       String? // "Includes water, sewer, WiFi"
  includedUtilities String[] @default([]) // ["water", "sewer", "wifi"]

  // Date boundaries
  seasonStartDate DateTime
  seasonEndDate   DateTime

  // Validity
  validFrom  DateTime  @default(now())
  validUntil DateTime?
  isActive   Boolean   @default(true)
  isDefault  Boolean   @default(false) // Default rate card for new seasonals

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  discounts      SeasonalDiscount[]
  incentives     SeasonalIncentive[]
  seasonalGuests SeasonalGuestPricing[]

  @@unique([campgroundId, name, seasonYear])
  @@index([campgroundId, isActive])
  @@index([campgroundId, seasonYear])
}

// Conditional discounts
model SeasonalDiscount {
  id         String           @id @default(cuid())
  rateCardId String
  rateCard   SeasonalRateCard @relation(fields: [rateCardId], references: [id], onDelete: Cascade)

  name        String // "Metered Electric Discount"
  description String? // "Discount for guests on metered utilities"

  // Condition - when does this apply?
  conditionType  SeasonalDiscountCondition
  conditionValue String? // JSON for complex conditions

  // Discount amount
  discountType   SeasonalDiscountType
  discountAmount Decimal              @db.Decimal(10, 2) // $200 or 10 (for percentage)

  // Stacking
  stackable Boolean @default(true) // Can combine with other discounts?
  priority  Int     @default(0) // Apply order (higher = first)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([rateCardId, isActive])
}

// Bonuses/incentives for behaviors
model SeasonalIncentive {
  id         String           @id @default(cuid())
  rateCardId String
  rateCard   SeasonalRateCard @relation(fields: [rateCardId], references: [id], onDelete: Cascade)

  name        String // "Pay in Full Guest Pass Bonus"
  description String?

  // Condition - when does this trigger?
  conditionType  SeasonalDiscountCondition // Reuse same conditions
  conditionValue String?

  // Reward
  incentiveType    SeasonalIncentiveType
  incentiveValue   Decimal               @db.Decimal(10, 2) // Amount or quantity
  incentiveDetails String? // JSON for complex rewards

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([rateCardId, isActive])
}

// Core seasonal guest record
model SeasonalGuest {
  id           String     @id @default(cuid())
  campgroundId String
  campground   Campground @relation("CampgroundSeasonalGuests", fields: [campgroundId], references: [id], onDelete: Cascade)
  guestId      String
  guest        Guest      @relation("GuestSeasonalRecords", fields: [guestId], references: [id], onDelete: Cascade)

  // Tenure
  firstSeasonYear Int
  totalSeasons    Int @default(1)
  seniorityRank   Int? // 1 = most senior

  // Current Assignment
  currentSiteId  String?
  currentSite    Site?    @relation("SeasonalGuestCurrentSite", fields: [currentSiteId], references: [id], onDelete: SetNull)
  preferredSites String[] @default([]) // Site IDs in preference order

  // Status
  status          SeasonalStatus @default(active)
  renewalIntent   RenewalIntent?
  renewalIntentAt DateTime?
  renewalNotes    String?

  // Billing preferences
  preferredPaymentMethod SeasonalPaymentMethod?
  paysInFull             Boolean                @default(false)
  autoPayEnabled         Boolean                @default(false)
  paymentDay             Int                    @default(1) // Day of month payment is due

  // Utilities
  isMetered       Boolean @default(false) // On metered electric/water
  meteredElectric Boolean @default(false)
  meteredWater    Boolean @default(false)

  // Compliance
  coiExpiresAt     DateTime? // Certificate of Insurance expiry
  coiDocumentUrl   String?
  vehiclePlates    String[] @default([]) // Multiple vehicles
  petCount         Int      @default(0)
  petNotes         String?
  emergencyContact String?
  emergencyPhone   String?

  // Balances (cached for quick access)
  guestPassBalance   Decimal @default(0) @db.Decimal(10, 2)
  storeCreditBalance Decimal @default(0) @db.Decimal(10, 2)

  notes String?
  tags  String[] @default([])

  // Conversion tracking
  originReservationId String? // The reservation this seasonal was converted from
  convertedAt         DateTime? // When conversion happened
  convertedBy         String? // User ID who converted

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  // Relations
  pricing        SeasonalGuestPricing[]
  payments       SeasonalPayment[]
  communications SeasonalCommunication[]
  reservations   Reservation[] @relation("SeasonalGuestReservations") // All linked reservations

  @@unique([guestId, campgroundId])
  @@index([campgroundId, status])
  @@index([campgroundId, renewalIntent])
  @@index([campgroundId, currentSiteId])
}

// Track what a specific seasonal guest is getting for a season
model SeasonalGuestPricing {
  id              String        @id @default(cuid())
  seasonalGuestId String
  seasonalGuest   SeasonalGuest @relation(fields: [seasonalGuestId], references: [id], onDelete: Cascade)
  rateCardId      String
  rateCard        SeasonalRateCard @relation(fields: [rateCardId], references: [id], onDelete: Restrict)

  seasonYear Int

  // Calculated pricing
  baseRate      Decimal @db.Decimal(10, 2)
  totalDiscount Decimal @default(0) @db.Decimal(10, 2)
  finalRate     Decimal @db.Decimal(10, 2)

  // Applied discounts - JSON array: [{discountId, name, amount, condition}]
  appliedDiscounts Json @default("[]")

  // Earned incentives - JSON array: [{incentiveId, name, type, value, status, awardedAt}]
  earnedIncentives Json @default("[]")

  // Payment schedule - JSON array: [{dueDate, amount, description}]
  paymentSchedule Json @default("[]")

  // Billing
  billingFrequency SeasonalBillingFrequency

  // Overrides (for special cases)
  manualAdjustment Decimal? @db.Decimal(10, 2) // +/- manual adjustment
  adjustmentReason String?
  adjustmentBy     String? // User ID who made adjustment

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([seasonalGuestId, seasonYear])
  @@index([seasonalGuestId])
  @@index([rateCardId])
}

// Individual payments for seasonal guests
model SeasonalPayment {
  id              String        @id @default(cuid())
  seasonalGuestId String
  seasonalGuest   SeasonalGuest @relation(fields: [seasonalGuestId], references: [id], onDelete: Cascade)
  campgroundId    String
  campground      Campground    @relation("CampgroundSeasonalPayments", fields: [campgroundId], references: [id], onDelete: Cascade)

  // Period
  seasonYear  Int
  periodStart DateTime
  periodEnd   DateTime
  description String? // "May 2025", "Season 2025 - Full Payment"

  // Amount
  amount     Decimal               @db.Decimal(10, 2)
  dueDate    DateTime
  status     SeasonalPaymentStatus @default(scheduled)

  // Payment details
  paidAmount    Decimal?              @db.Decimal(10, 2)
  paidAt        DateTime?
  paymentMethod SeasonalPaymentMethod?
  transactionId String? // Stripe/processor reference
  checkNumber   String?
  receiptUrl    String?

  // Late fees
  lateFee       Decimal? @db.Decimal(10, 2)
  lateFeeWaived Boolean  @default(false)
  lateFeeWaivedBy String?
  lateFeeWaivedAt DateTime?

  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  recordedBy String? // Staff user who recorded manual payment

  @@index([seasonalGuestId, seasonYear])
  @@index([campgroundId, dueDate])
  @@index([campgroundId, status])
}

// Communication log for seasonal guests
model SeasonalCommunication {
  id              String        @id @default(cuid())
  seasonalGuestId String
  seasonalGuest   SeasonalGuest @relation(fields: [seasonalGuestId], references: [id], onDelete: Cascade)
  campgroundId    String
  campground      Campground    @relation("CampgroundSeasonalCommunications", fields: [campgroundId], references: [id], onDelete: Cascade)

  // Message details
  channel   String // email, sms
  direction String // outbound, inbound
  subject   String?
  body      String  @db.Text
  status    String // sent, delivered, failed, bounced

  // Tracking
  sentAt      DateTime?
  deliveredAt DateTime?
  openedAt    DateTime?
  clickedAt   DateTime?
  bouncedAt   DateTime?
  failReason  String?

  // Campaign reference (if from bulk send)
  campaignId   String?
  campaignName String?

  // Sender
  sentBy String? // User ID

  createdAt DateTime @default(now())

  @@index([seasonalGuestId, createdAt])
  @@index([campgroundId, createdAt])
  @@index([campaignId])
}

// ==================== LOCK CODES ====================

enum LockCodeType {
  gate
  cabin
  amenity
  wifi
  master
}

enum LockCodeRotationSchedule {
  none
  daily
  weekly
  monthly
  per_guest
}

model LockCode {
  id           String                   @id @default(cuid())
  campgroundId String
  campground   Campground               @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  name               String
  code               String // Encrypted in production
  type               LockCodeType
  rotationSchedule   LockCodeRotationSchedule @default(none)
  showOnConfirmation Boolean                  @default(true)
  showAtCheckin      Boolean                  @default(true)
  appliesTo          String[]                 @default([]) // Site IDs or "all"
  isActive           Boolean                  @default(true)
  lastRotatedAt      DateTime?
  notes              String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([campgroundId])
  @@index([campgroundId, type])
}

// ==================== STAY RULES ====================

model StayRule {
  id           String     @id @default(cuid())
  campgroundId String
  campground   Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  name            String
  minNights       Int       @default(1)
  maxNights       Int       @default(28)
  siteClasses     String[]  @default([]) // Empty = applies to all
  dateRanges      Json      @default("[]") // Array of {start, end} date strings
  ignoreDaysBefore Int      @default(0) // Allow last-minute bookings to bypass min
  isActive        Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([campgroundId])
  @@index([campgroundId, isActive])
}

// ==================== AI AUTOPILOT ====================

// Master configuration per campground for AI Autopilot features
model AiAutopilotConfig {
  id           String     @id @default(cuid())
  campgroundId String     @unique
  campground   Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  // Auto-Reply Settings
  autoReplyEnabled            Boolean @default(false)
  autoReplyMode               String  @default("draft") // "draft" | "auto"
  autoReplyConfidenceThreshold Float  @default(0.8)
  autoReplyDelayMinutes       Int     @default(5)
  autoReplyExcludeCategories  String[] @default([]) // Categories to skip

  // Smart Waitlist Settings
  smartWaitlistEnabled    Boolean @default(false)
  smartWaitlistMode       String  @default("suggest") // "suggest" | "auto"
  waitlistGuestValueWeight Float  @default(0.3)
  waitlistLikelihoodWeight Float  @default(0.3)
  waitlistSeasonalWeight   Float  @default(0.2)

  // Anomaly Detection Settings
  anomalyDetectionEnabled Boolean @default(false)
  anomalyAlertMode        String  @default("digest") // "realtime" | "digest" | "both"
  anomalyDigestSchedule   String  @default("daily") // "daily" | "weekly"
  anomalyDigestTime       String  @default("08:00")
  anomalySensitivity      String  @default("medium") // "low" | "medium" | "high"

  // No-Show Prediction Settings
  noShowPredictionEnabled Boolean @default(false)
  noShowThreshold         Float   @default(0.7)
  noShowAutoReminder      Boolean @default(false)
  noShowReminderDaysBefore Int    @default(2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Campground knowledge base for AI context (FAQs, policies, training examples)
model AiCampgroundContext {
  id           String     @id @default(cuid())
  campgroundId String
  campground   Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  type      String  // "faq" | "policy" | "training_example" | "common_question"
  question  String? @db.Text // For FAQs and training examples
  answer    String  @db.Text // The content/response
  category  String? // "check_in" | "amenities" | "pets" | "cancellation" | etc.
  priority  Int     @default(0)
  isActive  Boolean @default(true)
  source    String? // "auto_import" | "manual" - track where it came from

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([campgroundId])
  @@index([campgroundId, type])
  @@index([campgroundId, category])
  @@index([campgroundId, isActive])
}

// AI reply drafts pending review or auto-sent
model AiReplyDraft {
  id              String     @id @default(cuid())
  campgroundId    String
  campground      Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)
  communicationId String // Reference to inbound Communication
  guestId         String?
  reservationId   String?

  inboundSubject  String? // Original message subject
  inboundPreview  String? @db.Text // Preview of inbound message
  draftContent    String  @db.Text
  confidence      Float // 0-1 confidence score
  detectedIntent  String? // "question" | "complaint" | "change_request" | "cancellation" | etc.
  detectedTone    String? // "friendly" | "neutral" | "upset"
  usedContextIds  String[] @default([]) // IDs of AiCampgroundContext used
  usedContextSummary String? @db.Text // Human-readable summary of what was used

  status          String   @default("pending") // "pending" | "approved" | "edited" | "rejected" | "sent" | "auto_sent"
  reviewedById    String?
  reviewedAt      DateTime?
  editedContent   String?  @db.Text
  rejectionReason String?
  sentAt          DateTime?
  autoSendScheduledAt DateTime? // When auto-send is scheduled for

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([campgroundId])
  @@index([campgroundId, status])
  @@index([communicationId])
  @@index([autoSendScheduledAt, status])
}

// AI waitlist scoring for smart matching
model AiWaitlistScore {
  id              String        @id @default(cuid())
  waitlistEntryId String
  waitlistEntry   WaitlistEntry @relation(fields: [waitlistEntryId], references: [id], onDelete: Cascade)
  campgroundId    String

  // Component scores (0-100 each)
  baseScore          Int // From existing priority calculation
  guestLtvScore      Int // Lifetime value score
  bookingLikelihood  Int // Probability to book if offered
  seasonalFitScore   Int // How well dates match demand patterns
  communicationScore Int @default(50) // Guest responsiveness

  // Final weighted score and explanation
  aiScore   Float
  aiReason  String? @db.Text // Explanation of scoring

  calculatedAt DateTime @default(now())

  @@unique([waitlistEntryId])
  @@index([campgroundId])
  @@index([campgroundId, aiScore])
}

// Anomaly alerts detected by AI
model AiAnomalyAlert {
  id           String     @id @default(cuid())
  campgroundId String
  campground   Campground @relation(fields: [campgroundId], references: [id], onDelete: Cascade)

  type          String // "revenue_drop" | "revenue_spike" | "occupancy_drop" | "booking_velocity_change" | etc.
  severity      String // "low" | "medium" | "high" | "critical"
  title         String
  summary       String  @db.Text
  aiAnalysis    String? @db.Text // AI-generated explanation
  suggestedAction String? @db.Text

  metric        String
  currentValue  Float
  expectedValue Float
  deviation     Float // Percentage deviation
  comparisonPeriod String? // "last_week" | "last_month" | "last_year"

  status           String    @default("new") // "new" | "acknowledged" | "resolved" | "dismissed"
  acknowledgedById String?
  acknowledgedAt   DateTime?
  resolvedAt       DateTime?
  dismissedReason  String?

  detectedAt      DateTime
  digestIncluded  Boolean  @default(false)
  digestSentAt    DateTime?

  metadata Json? // Additional context data

  createdAt DateTime @default(now())

  @@index([campgroundId])
  @@index([campgroundId, status])
  @@index([campgroundId, detectedAt])
  @@index([campgroundId, severity])
}

// No-show risk scores for reservations
model AiNoShowRisk {
  id            String      @id @default(cuid())
  reservationId String      @unique
  reservation   Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  campgroundId  String

  riskScore Float // 0-1 probability of no-show

  // Factor scores (0-100 each, higher = more risk)
  paymentStatusScore   Int // Unpaid = higher risk
  leadTimeScore        Int // Very early or last-minute = pattern dependent
  guestHistoryScore    Int // Past no-shows = higher risk
  communicationScore   Int // No communication = higher risk
  bookingPatternScore  Int // Unusual patterns = higher risk

  factors Json? // Detailed breakdown for UI display

  flagged          Boolean   @default(false) // Above threshold
  staffNotifiedAt  DateTime?
  reminderSentAt   DateTime?
  guestConfirmedAt DateTime?
  outcome          String?   // "showed" | "no_show" | "cancelled" | null (pending)

  calculatedAt DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([campgroundId])
  @@index([campgroundId, riskScore])
  @@index([campgroundId, flagged])
  @@index([reservationId])
}


// Demo/sales lead requests from marketing website
model DemoRequest {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String?
  campgroundName String
  siteCount String
  message   String? @db.Text
  
  status    String   @default("new") // "new" | "contacted" | "scheduled" | "completed" | "closed"
  notes     String?  @db.Text
  assignedTo String?
  
  source    String   @default("website") // "website" | "referral" | etc.
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([status])
  @@index([createdAt])
}
