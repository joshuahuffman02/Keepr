openapi: 3.0.3
info:
  title: Keepr Phase3
  version: 0.1.0
servers:
  - url: https://api.example.com
components:
  securitySchemes:
    HmacSig:
      type: apiKey
      in: header
      name: X-Signature
  parameters:
    Idem:
      in: header
      name: Idempotency-Key
      required: true
      schema:
        type: string
        format: uuid
    Channel:
      in: path
      name: channel
      required: true
      schema:
        type: string
    Version:
      in: header
      name: X-Version
      required: true
      schema:
        type: integer
    Timestamp:
      in: header
      name: X-Timestamp
      required: true
      schema:
        type: string
        format: date-time
paths:
  /webhooks/channel/{channel}/availability:
    post:
      summary: Channel availability webhook
      parameters:
        - $ref: "#/components/parameters/Idem"
        - $ref: "#/components/parameters/Channel"
        - $ref: "#/components/parameters/Version"
        - $ref: "#/components/parameters/Timestamp"
      security:
        - HmacSig: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [parkId, unitTypeId, tz, version, dates]
              properties:
                parkId: { type: string }
                unitTypeId: { type: string }
                tz: { type: string }
                version: { type: integer }
                source: { type: string }
                dates:
                  type: array
                  items:
                    type: object
                    required: [date, inventory]
                    properties:
                      date: { type: string, format: date }
                      inventory: { type: integer, minimum: 0 }
                      minStay: { type: integer, minimum: 1 }
                      closedForArrival: { type: boolean }
                      closedForDeparture: { type: boolean }
      responses:
        "202": { description: accepted }
        "409": { description: stale or conflict }
        "422": { description: invalid payload }
  /webhooks/channel/{channel}/rates:
    post:
      summary: Channel rate webhook
      parameters:
        - $ref: "#/components/parameters/Idem"
        - $ref: "#/components/parameters/Channel"
        - $ref: "#/components/parameters/Version"
        - $ref: "#/components/parameters/Timestamp"
      security:
        - HmacSig: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [parkId, ratePlanId, unitTypeId, currency, version, dates]
              properties:
                parkId: { type: string }
                ratePlanId: { type: string }
                unitTypeId: { type: string }
                currency: { type: string }
                taxInclusive: { type: boolean }
                version: { type: integer }
                dates:
                  type: array
                  items:
                    type: object
                    required: [date, price]
                    properties:
                      date: { type: string, format: date }
                      price: { type: number }
                      restrictions: { type: object }
      responses:
        "202": { description: accepted }
        "409": { description: stale or conflict }
        "422": { description: invalid payload }
  /webhooks/channel/{channel}/reservations:
    post:
      summary: Channel reservation webhook
      parameters:
        - $ref: "#/components/parameters/Idem"
        - $ref: "#/components/parameters/Channel"
        - $ref: "#/components/parameters/Version"
        - $ref: "#/components/parameters/Timestamp"
      security:
        - HmacSig: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                [
                  otaReservationId,
                  channel,
                  parkId,
                  unitTypeId,
                  status,
                  otaUpdatedAt,
                  version,
                  stay,
                  price,
                ]
              properties:
                otaReservationId: { type: string }
                channel: { type: string }
                parkId: { type: string }
                unitTypeId: { type: string }
                status: { type: string, enum: [pending, confirmed, cancelled, modified] }
                otaUpdatedAt: { type: string, format: date-time }
                version: { type: integer }
                checksum: { type: string }
                stay:
                  type: object
                  required: [arrival, departure, tz]
                  properties:
                    arrival: { type: string, format: date }
                    departure: { type: string, format: date }
                    tz: { type: string }
                guests: { type: object }
                price:
                  type: object
                  required: [currency, total]
                  properties:
                    currency: { type: string }
                    total: { type: number }
                    nights: { type: array, items: { type: object } }
                    paid: { type: number }
                payments: { type: array, items: { type: object } }
                customer: { type: object }
                specialRequests: { type: string }
      responses:
        "200": { description: ok }
        "409": { description: stale, conflict, or overbook }
        "422": { description: invalid payload }
  /channels/{channel}/availability:
    get:
      summary: Pull availability (reconcile)
      parameters:
        - $ref: "#/components/parameters/Channel"
        - { in: query, name: parkId, required: true, schema: { type: string } }
        - { in: query, name: from, required: true, schema: { type: string, format: date } }
        - { in: query, name: to, required: true, schema: { type: string, format: date } }
      responses:
        "200": { description: ok }
  /channels/{channel}/rates:
    get:
      summary: Pull rates (reconcile)
      parameters:
        - $ref: "#/components/parameters/Channel"
        - { in: query, name: parkId, required: true, schema: { type: string } }
        - { in: query, name: from, required: true, schema: { type: string, format: date } }
        - { in: query, name: to, required: true, schema: { type: string, format: date } }
      responses:
        "200": { description: ok }
  /channels/{channel}/reservations:
    get:
      summary: Pull reservations since cursor
      parameters:
        - $ref: "#/components/parameters/Channel"
        - { in: query, name: sinceCursor, schema: { type: string } }
      responses:
        "200": { description: ok }
  /channels/{channel}/logs:
    get:
      summary: Sync logs
      parameters:
        - $ref: "#/components/parameters/Channel"
        - { in: query, name: parkId, schema: { type: string } }
        - { in: query, name: from, schema: { type: string, format: date-time } }
        - { in: query, name: to, schema: { type: string, format: date-time } }
        - { in: query, name: status, schema: { type: string } }
        - { in: query, name: direction, schema: { type: string } }
        - { in: query, name: type, schema: { type: string } }
      responses:
        "200": { description: ok }
  /channels/{channel}/pause:
    post:
      summary: Pause a channel for a park
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [parkId]
              properties:
                parkId: { type: string }
      responses:
        "200": { description: paused }
  /channels/{channel}/resume:
    post:
      summary: Resume a channel for a park
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [parkId]
              properties:
                parkId: { type: string }
      responses:
        "200": { description: resumed }
  /channels/{channel}/reconcile:
    post:
      summary: Trigger reconciliation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [parkId]
              properties:
                parkId: { type: string }
                from: { type: string, format: date }
                to: { type: string, format: date }
                sinceCursor: { type: string }
      responses:
        "202": { description: started }
  /pricing/quote:
    post:
      summary: Price quote with discounts
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [parkId, unitTypeId, dates, guests]
              properties:
                parkId: { type: string }
                unitTypeId: { type: string }
                dates:
                  type: object
                  required: [arrival, departure]
                  properties:
                    arrival: { type: string, format: date }
                    departure: { type: string, format: date }
                guests: { type: object }
                promoCode: { type: string }
                membershipId: { type: string }
                customerId: { type: string }
      responses:
        "200": { description: ok }
  /public/parks/{parkId}/pages/{slug}:
    get:
      summary: Public page
      parameters:
        - { in: path, name: parkId, required: true, schema: { type: string } }
        - { in: path, name: slug, required: true, schema: { type: string } }
      responses:
        "200": { description: ok }
  /public/parks/{parkId}/preview/{slug}:
    get:
      summary: Draft preview (tokenized)
      parameters:
        - { in: path, name: parkId, required: true, schema: { type: string } }
        - { in: path, name: slug, required: true, schema: { type: string } }
        - { in: query, name: token, required: true, schema: { type: string } }
      responses:
        "200": { description: ok }
  /public/parks/{parkId}/publish:
    post:
      summary: Publish a page
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [slug]
              properties:
                slug: { type: string }
      responses:
        "200": { description: published }
  /public/parks/{parkId}/sitemap:
    get:
      summary: Sitemap
      parameters:
        - { in: path, name: parkId, required: true, schema: { type: string } }
      responses:
        "200": { description: xml sitemap }
