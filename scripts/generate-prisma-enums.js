#!/usr/bin/env node
/**
 * Generate TypeScript enum declarations from Prisma schema
 *
 * Prisma 7 exports enums as const objects instead of TypeScript enums.
 * This script generates a module augmentation file that re-exports them
 * as proper TypeScript enums for full type safety.
 *
 * Usage: node scripts/generate-prisma-enums.js
 */

const fs = require('fs');
const path = require('path');

const SCHEMA_PATH = path.join(__dirname, '../platform/apps/api/prisma/schema.prisma');
const OUTPUT_PATH = path.join(__dirname, '../platform/apps/api/src/types/prisma.d.ts');

function parseEnumsFromSchema(schemaContent) {
  const enums = [];
  const enumRegex = /enum\s+(\w+)\s*\{([^}]+)\}/g;

  let match;
  while ((match = enumRegex.exec(schemaContent)) !== null) {
    const enumName = match[1];
    const enumBody = match[2];

    // Parse enum values (one per line, ignore comments)
    const values = enumBody
      .split('\n')
      .map(line => line.trim())
      .filter(line => line && !line.startsWith('//') && !line.startsWith('@@'))
      .map(line => line.replace(/\/\/.*$/, '').trim()); // Remove inline comments

    if (values.length > 0) {
      enums.push({ name: enumName, values });
    }
  }

  return enums;
}

function generateEnumDeclaration(enumDef) {
  const entries = enumDef.values
    .map(value => `    ${value} = "${value}",`)
    .join('\n');

  return `  export enum ${enumDef.name} {\n${entries}\n  }`;
}

function generatePrismaDeclarations(enums) {
  const enumDeclarations = enums.map(generateEnumDeclaration).join('\n\n');

  return `/**
 * AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
 *
 * Generated by: scripts/generate-prisma-enums.js
 *
 * This file provides TypeScript enum declarations for Prisma 7 enums.
 * Prisma 7 exports enums as const objects, but our codebase expects
 * TypeScript enums. This module augmentation provides the expected types.
 *
 * Regenerate after schema changes:
 *   node scripts/generate-prisma-enums.js
 */

declare module "@prisma/client" {
${enumDeclarations}

  // Prisma namespace augmentations for transaction client
  export namespace Prisma {
    export type TransactionClient = any;
    export type InputJsonValue = any;
  }

  // Re-export PrismaClient for compatibility
  export class PrismaClient {
    [key: string]: any;
  }
}
`;
}

function main() {
  console.log('Reading Prisma schema...');
  const schemaContent = fs.readFileSync(SCHEMA_PATH, 'utf-8');

  console.log('Parsing enums...');
  const enums = parseEnumsFromSchema(schemaContent);
  console.log(`Found ${enums.length} enums`);

  console.log('Generating TypeScript declarations...');
  const declarations = generatePrismaDeclarations(enums);

  // Ensure output directory exists
  const outputDir = path.dirname(OUTPUT_PATH);
  if (!fs.existsSync(outputDir)) {
    fs.mkdirSync(outputDir, { recursive: true });
  }

  console.log(`Writing to ${OUTPUT_PATH}...`);
  fs.writeFileSync(OUTPUT_PATH, declarations);

  console.log(`Successfully generated declarations for ${enums.length} enums`);
}

main();
