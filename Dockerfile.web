FROM node:25.3.0-alpine AS base
ARG CACHEBUST=3
# Node 25 alpine doesn't include corepack by default, install it first
RUN npm install -g --force corepack && corepack enable && corepack prepare pnpm@7.33.6 --activate
WORKDIR /app
ENV PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1
ENV NEXT_TELEMETRY_DISABLED=1

# Install dependencies
FROM base AS deps
COPY package.json pnpm-workspace.yaml pnpm-lock.yaml* ./
COPY scripts ./scripts
COPY platform/packages/shared/package.json ./platform/packages/shared/
COPY platform/apps/api/package.json ./platform/apps/api/
COPY platform/apps/web/package.json ./platform/apps/web/
RUN pnpm install --frozen-lockfile --prefer-offline

# Build shared package
FROM deps AS shared
COPY platform/packages/shared ./platform/packages/shared
RUN pnpm --filter @keepr/shared build

# Build web app
FROM shared AS web-builder
# Accept build arguments for Next.js environment variables
ARG NEXT_PUBLIC_API_BASE
ARG AUTH_URL
ARG AUTH_SECRET
ARG AUTH_TRUST_HOST
# Set them as environment variables for the build
ENV NEXT_PUBLIC_API_BASE=$NEXT_PUBLIC_API_BASE
ENV AUTH_URL=$AUTH_URL
ENV AUTH_SECRET=$AUTH_SECRET
ENV AUTH_TRUST_HOST=$AUTH_TRUST_HOST
COPY platform/apps/web ./platform/apps/web
COPY content ./content
RUN echo "Building with NEXT_PUBLIC_API_BASE=$NEXT_PUBLIC_API_BASE" && \
    pnpm --filter @keepr/web build

# Production image for web
FROM base AS web
COPY --from=deps /app/node_modules ./node_modules
COPY --from=deps /app/platform ./platform
COPY --from=shared /app/platform/packages/shared/dist ./platform/packages/shared/dist
COPY --from=web-builder /app/platform/apps/web/.next ./platform/apps/web/.next
COPY --from=web-builder /app/platform/apps/web/public ./platform/apps/web/public
COPY --from=web-builder /app/platform/apps/web/package.json ./platform/apps/web/
COPY content ./content
COPY package.json pnpm-workspace.yaml ./

WORKDIR /app/platform/apps/web
EXPOSE 3000
# CRITICAL: Use pnpm exec to resolve next binary (pnpm doesn't hoist like npm/yarn)
# Must bind to 0.0.0.0 for Railway to reach the container
CMD ["pnpm", "exec", "next", "start", "-H", "0.0.0.0", "-p", "3000"]
